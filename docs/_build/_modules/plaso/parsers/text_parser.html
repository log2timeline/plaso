<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>plaso.parsers.text_parser &mdash; Plaso 1.4.1_20160603 documentation</title>
    
    <link rel="stylesheet" href="../../../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '1.4.1_20160603',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <link rel="top" title="Plaso 1.4.1_20160603 documentation" href="../../../index.html" />
    <link rel="up" title="plaso" href="../../plaso.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">Plaso 1.4.1_20160603 documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &raquo;</li>
          <li class="nav-item nav-item-2"><a href="../../plaso.html" accesskey="U">plaso</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for plaso.parsers.text_parser</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;This file contains a class to provide a parsing framework to plaso.</span>

<span class="sd">This class contains a base framework class for parsing fileobjects, and</span>
<span class="sd">also some implementations that extend it to provide a more comprehensive</span>
<span class="sd">parser.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">abc</span>
<span class="kn">import</span> <span class="nn">csv</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="kn">from</span> <span class="nn">dfvfs.helpers</span> <span class="kn">import</span> <span class="n">text_file</span>
<span class="kn">import</span> <span class="nn">pyparsing</span>

<span class="kn">from</span> <span class="nn">plaso.containers</span> <span class="kn">import</span> <span class="n">events</span>
<span class="kn">from</span> <span class="nn">plaso.containers</span> <span class="kn">import</span> <span class="n">text_events</span>
<span class="kn">from</span> <span class="nn">plaso.lib</span> <span class="kn">import</span> <span class="n">errors</span>
<span class="kn">from</span> <span class="nn">plaso.lib</span> <span class="kn">import</span> <span class="n">lexer</span>
<span class="kn">from</span> <span class="nn">plaso.lib</span> <span class="kn">import</span> <span class="n">timelib</span>
<span class="kn">from</span> <span class="nn">plaso.lib</span> <span class="kn">import</span> <span class="n">utils</span>
<span class="kn">from</span> <span class="nn">plaso.parsers</span> <span class="kn">import</span> <span class="n">interface</span>

<span class="kn">import</span> <span class="nn">pytz</span>  <span class="c1"># pylint: disable=wrong-import-order</span>

<span class="c1"># Pylint complains about some functions not being implemented that shouldn&#39;t</span>
<span class="c1"># be since they need to be implemented by children.</span>
<span class="c1"># pylint: disable=abstract-method</span>


<div class="viewcode-block" id="SlowLexicalTextParser"><a class="viewcode-back" href="../../../plaso.parsers.html#plaso.parsers.skydrivelog.SlowLexicalTextParser">[docs]</a><span class="k">class</span> <span class="nc">SlowLexicalTextParser</span><span class="p">(</span>
    <span class="n">interface</span><span class="o">.</span><span class="n">FileObjectParser</span><span class="p">,</span> <span class="n">lexer</span><span class="o">.</span><span class="n">SelfFeederMixIn</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Generic text based parser that uses lexer to assist with parsing.</span>

<span class="sd">  This text parser is based on a rather slow lexer, which makes the</span>
<span class="sd">  use of this interface highly discouraged. Parsers that already</span>
<span class="sd">  implement it will most likely all be rewritten to support faster</span>
<span class="sd">  text parsing implementations.</span>

<span class="sd">  This text based parser needs to be extended to provide an accurate</span>
<span class="sd">  list of tokens that define the structure of the log file that the</span>
<span class="sd">  parser is designed for.</span>
<span class="sd">  &quot;&quot;&quot;</span>

  <span class="n">_INITIAL_FILE_OFFSET</span> <span class="o">=</span> <span class="bp">None</span>

  <span class="c1"># Define the max number of lines before we determine this is</span>
  <span class="c1"># not the correct parser.</span>
  <span class="n">MAX_LINES</span> <span class="o">=</span> <span class="mi">15</span>

  <span class="c1"># List of tokens that describe the structure of the log file.</span>
  <span class="n">tokens</span> <span class="o">=</span> <span class="p">[</span>
      <span class="n">lexer</span><span class="o">.</span><span class="n">Token</span><span class="p">(</span><span class="s1">u&#39;INITIAL&#39;</span><span class="p">,</span> <span class="s1">r&#39;(.+)\n&#39;</span><span class="p">,</span> <span class="s1">u&#39;ParseString&#39;</span><span class="p">,</span> <span class="s1">u&#39;&#39;</span><span class="p">),</span>
      <span class="p">]</span>

  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">local_zone</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Initializes a parser object.</span>

<span class="sd">    Args:</span>
<span class="sd">      local_zone: a boolean value that determines if the entries</span>
<span class="sd">                  in the log file are stored in the local time</span>
<span class="sd">                  zone of the computer that stored it or in a fixed</span>
<span class="sd">                  timezone, like UTC.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># TODO: remove the multiple inheritance.</span>
    <span class="n">lexer</span><span class="o">.</span><span class="n">SelfFeederMixIn</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
    <span class="n">interface</span><span class="o">.</span><span class="n">FileObjectParser</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_file_verified</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">attributes</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">u&#39;body&#39;</span><span class="p">:</span> <span class="s1">u&#39;&#39;</span><span class="p">,</span>
        <span class="s1">u&#39;iyear&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s1">u&#39;imonth&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s1">u&#39;iday&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s1">u&#39;time&#39;</span><span class="p">:</span> <span class="s1">u&#39;&#39;</span><span class="p">,</span>
        <span class="s1">u&#39;hostname&#39;</span><span class="p">:</span> <span class="s1">u&#39;&#39;</span><span class="p">,</span>
        <span class="s1">u&#39;username&#39;</span><span class="p">:</span> <span class="s1">u&#39;&#39;</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">entry_offset</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">line_ready</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">local_zone</span> <span class="o">=</span> <span class="n">local_zone</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">next_entry_offset</span> <span class="o">=</span> <span class="mi">0</span>

<div class="viewcode-block" id="SlowLexicalTextParser.ClearValues"><a class="viewcode-back" href="../../../plaso.parsers.html#plaso.parsers.skydrivelog.SlowLexicalTextParser.ClearValues">[docs]</a>  <span class="k">def</span> <span class="nf">ClearValues</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Clears all the values inside the attributes dict.</span>

<span class="sd">    All values that start with the letter &#39;i&#39; are considered</span>
<span class="sd">    to be an integer, otherwise string value is assumed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">line_ready</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">attributes</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">attr</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">u&#39;i&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="s1">u&#39;&#39;</span></div>

<div class="viewcode-block" id="SlowLexicalTextParser.CreateEvent"><a class="viewcode-back" href="../../../plaso.parsers.html#plaso.parsers.skydrivelog.SlowLexicalTextParser.CreateEvent">[docs]</a>  <span class="k">def</span> <span class="nf">CreateEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">attributes</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Creates an event.</span>

<span class="sd">       This function should be overwritten by text parsers that required</span>
<span class="sd">       the generation of specific event object type, the default event</span>
<span class="sd">       type is TextEvent.</span>

<span class="sd">    Args:</span>
<span class="sd">      timestamp: the timestamp time value. The timestamp contains the</span>
<span class="sd">                 number of microseconds since Jan 1, 1970 00:00:00 UTC.</span>
<span class="sd">      offset: the offset of the event.</span>
<span class="sd">      attributes: a dictionary that contains the event&#39;s attributes.</span>

<span class="sd">    Returns:</span>
<span class="sd">      An event object (instance of TextEvent).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">text_events</span><span class="o">.</span><span class="n">TextEvent</span><span class="p">(</span><span class="n">timestamp</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">attributes</span><span class="p">)</span></div>

<div class="viewcode-block" id="SlowLexicalTextParser.ParseIncomplete"><a class="viewcode-back" href="../../../plaso.parsers.html#plaso.parsers.skydrivelog.SlowLexicalTextParser.ParseIncomplete">[docs]</a>  <span class="k">def</span> <span class="nf">ParseIncomplete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">match</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">unused_kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Parse a partial line match and append to the body attribute.</span>

<span class="sd">    Args:</span>
<span class="sd">      match: optional regular expression match object (instance of SRE_Match).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">match</span><span class="p">:</span>
      <span class="k">return</span>

    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s1">u&#39;body&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">UnicodeDecodeError</span><span class="p">:</span>
      <span class="c1"># TODO: Support other encodings than UTF-8 here, read from the</span>
      <span class="c1"># knowledge base or parse from the file itself.</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s1">u&#39;body&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="s1">u&#39;{0:s}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
          <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">u&#39;utf-8&#39;</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s1">u&#39;replace&#39;</span><span class="p">))</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">line_ready</span> <span class="o">=</span> <span class="bp">True</span></div>

<div class="viewcode-block" id="SlowLexicalTextParser.ParseMessage"><a class="viewcode-back" href="../../../plaso.parsers.html#plaso.parsers.skydrivelog.SlowLexicalTextParser.ParseMessage">[docs]</a>  <span class="k">def</span> <span class="nf">ParseMessage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">unused_kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Signal that a line is ready to be parsed.&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">line_ready</span> <span class="o">=</span> <span class="bp">True</span></div>

<div class="viewcode-block" id="SlowLexicalTextParser.ParseFileObject"><a class="viewcode-back" href="../../../plaso.parsers.html#plaso.parsers.skydrivelog.SlowLexicalTextParser.ParseFileObject">[docs]</a>  <span class="k">def</span> <span class="nf">ParseFileObject</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parser_mediator</span><span class="p">,</span> <span class="n">file_object</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Parses a text file-like object using a lexer.</span>

<span class="sd">    Args:</span>
<span class="sd">      parser_mediator: a parser mediator object (instance of ParserMediator).</span>
<span class="sd">      file_object: a file-like object.</span>

<span class="sd">    Raises:</span>
<span class="sd">      UnableToParseFile: when the file cannot be parsed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">file_entry</span> <span class="o">=</span> <span class="n">parser_mediator</span><span class="o">.</span><span class="n">GetFileEntry</span><span class="p">()</span>
    <span class="n">path_spec_printable</span> <span class="o">=</span> <span class="s1">u&#39;{0:s}:{1:s}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">file_entry</span><span class="o">.</span><span class="n">path_spec</span><span class="o">.</span><span class="n">type_indicator</span><span class="p">,</span> <span class="n">file_entry</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

    <span class="c1"># TODO: this is necessary since we inherit from lexer.SelfFeederMixIn.</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">file_object</span> <span class="o">=</span> <span class="n">file_object</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_file_verified</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="c1"># Start by checking, is this a text file or not? Before we proceed</span>
    <span class="c1"># any further.</span>
    <span class="n">file_object</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">SEEK_SET</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">utils</span><span class="o">.</span><span class="n">IsText</span><span class="p">(</span><span class="n">file_object</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">40</span><span class="p">)):</span>
      <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">UnableToParseFile</span><span class="p">(</span><span class="s1">u&#39;Not a text file, unable to proceed.&#39;</span><span class="p">)</span>

    <span class="n">file_object</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">SEEK_SET</span><span class="p">)</span>

    <span class="n">error_count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="c1"># We need to clear out few values in the Lexer before continuing.</span>
    <span class="c1"># There might be some leftovers from previous run.</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">error</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span> <span class="o">=</span> <span class="n">b</span><span class="s1">&#39;&#39;</span>

    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
      <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">NextToken</span><span class="p">()</span>

      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="s1">u&#39;INITIAL&#39;</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">entry_offset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">next_entry_offset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">next_entry_offset</span> <span class="o">=</span> <span class="n">file_object</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="p">)</span>

      <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file_verified</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">error</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">MAX_LINES</span> <span class="o">*</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s1">u&#39;Lexer error count: {0:d} and current state {1:s}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">))</span>
        <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">UnableToParseFile</span><span class="p">(</span>
            <span class="s1">u&#39;[{0:s}] unsupported file: {1:s}.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">NAME</span><span class="p">,</span> <span class="n">path_spec_printable</span><span class="p">))</span>

      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">line_ready</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">ParseLine</span><span class="p">(</span><span class="n">parser_mediator</span><span class="p">)</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">_file_verified</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="k">except</span> <span class="n">errors</span><span class="o">.</span><span class="n">TimestampError</span> <span class="k">as</span> <span class="n">exception</span><span class="p">:</span>
          <span class="n">error_count</span> <span class="o">+=</span> <span class="mi">1</span>
          <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file_verified</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s1">u&#39;[{0:s} VERIFIED] Error count: {1:d} and ERROR: {2:d}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">path_spec_printable</span><span class="p">,</span> <span class="n">error_count</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">))</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s1">u&#39;[{0:s}] Unable to parse timestamp with error: {1:s}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">NAME</span><span class="p">,</span> <span class="n">exception</span><span class="p">))</span>

          <span class="k">else</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">((</span>
                <span class="s1">u&#39;[{0:s} EVALUATING] Error count: {1:d} and ERROR: &#39;</span>
                <span class="s1">u&#39;{2:d})&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path_spec_printable</span><span class="p">,</span> <span class="n">error_count</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">error_count</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">MAX_LINES</span><span class="p">:</span>
              <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">UnableToParseFile</span><span class="p">(</span>
                  <span class="s1">u&#39;[{0:s}] unsupported file: {1:s}.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                      <span class="bp">self</span><span class="o">.</span><span class="n">NAME</span><span class="p">,</span> <span class="n">path_spec_printable</span><span class="p">))</span>

        <span class="k">finally</span><span class="p">:</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">ClearValues</span><span class="p">()</span>

      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Empty</span><span class="p">():</span>
        <span class="c1"># Try to fill the buffer to prevent the parser from ending prematurely.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Feed</span><span class="p">()</span>

      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Empty</span><span class="p">():</span>
        <span class="k">break</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file_verified</span><span class="p">:</span>
      <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">UnableToParseFile</span><span class="p">(</span>
          <span class="s1">u&#39;[{0:s}] unable to parse file: {1:s}.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
              <span class="bp">self</span><span class="o">.</span><span class="n">NAME</span><span class="p">,</span> <span class="n">path_spec_printable</span><span class="p">))</span>

    <span class="n">file_offset</span> <span class="o">=</span> <span class="n">file_object</span><span class="o">.</span><span class="n">get_offset</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">file_offset</span> <span class="o">&lt;</span> <span class="n">file_object</span><span class="o">.</span><span class="n">get_size</span><span class="p">():</span>
      <span class="n">parser_mediator</span><span class="o">.</span><span class="n">ProduceParseError</span><span class="p">((</span>
          <span class="s1">u&#39;{0:s} prematurely terminated parsing: {1:s} at offset: &#39;</span>
          <span class="s1">u&#39;0x{2:08x}.&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
              <span class="bp">self</span><span class="o">.</span><span class="n">NAME</span><span class="p">,</span> <span class="n">path_spec_printable</span><span class="p">,</span> <span class="n">file_offset</span><span class="p">))</span></div>

<div class="viewcode-block" id="SlowLexicalTextParser.ParseString"><a class="viewcode-back" href="../../../plaso.parsers.html#plaso.parsers.skydrivelog.SlowLexicalTextParser.ParseString">[docs]</a>  <span class="k">def</span> <span class="nf">ParseString</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">match</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">unused_kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return a string with combined values from the lexer.</span>

<span class="sd">    Args:</span>
<span class="sd">      match: optional regular expression match object (instance of SRE_Match).</span>

<span class="sd">    Returns:</span>
<span class="sd">      A string that combines the values that are so far</span>
<span class="sd">      saved from the lexer.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s1">u&#39;body&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">u&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s1">u&#39;body&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">u&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="SlowLexicalTextParser.PrintLine"><a class="viewcode-back" href="../../../plaso.parsers.html#plaso.parsers.skydrivelog.SlowLexicalTextParser.PrintLine">[docs]</a>  <span class="k">def</span> <span class="nf">PrintLine</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;&quot;Return a string with combined values from the lexer.&quot;&quot;&quot;</span>
    <span class="n">year</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attributes</span><span class="p">,</span> <span class="s1">u&#39;iyear&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
    <span class="n">month</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attributes</span><span class="p">,</span> <span class="s1">u&#39;imonth&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
    <span class="n">day</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attributes</span><span class="p">,</span> <span class="s1">u&#39;iday&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

    <span class="k">if</span> <span class="bp">None</span> <span class="ow">in</span> <span class="p">[</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">day</span><span class="p">]:</span>
      <span class="n">date_string</span> <span class="o">=</span> <span class="s1">u&#39;[DATE NOT SET]&#39;</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">try</span><span class="p">:</span>
        <span class="n">year</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
        <span class="n">month</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">month</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
        <span class="n">day</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">day</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>

        <span class="n">date_string</span> <span class="o">=</span> <span class="s1">u&#39;{0:04d}-{1:02d}-{2:02d}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">day</span><span class="p">)</span>
      <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="n">date_string</span> <span class="o">=</span> <span class="s1">u&#39;[DATE INVALID]&#39;</span>

    <span class="n">time_string</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attributes</span><span class="p">,</span> <span class="s1">u&#39;time&#39;</span><span class="p">,</span> <span class="s1">u&#39;[TIME NOT SET]&#39;</span><span class="p">)</span>
    <span class="n">hostname_string</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attributes</span><span class="p">,</span> <span class="s1">u&#39;hostname&#39;</span><span class="p">,</span> <span class="s1">u&#39;HOSTNAME NOT SET&#39;</span><span class="p">)</span>
    <span class="n">reporter_string</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attributes</span><span class="p">,</span> <span class="s1">u&#39;reporter&#39;</span><span class="p">,</span> <span class="s1">u&#39;[REPORTER NOT SET]&#39;</span><span class="p">)</span>
    <span class="n">body_string</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attributes</span><span class="p">,</span> <span class="s1">u&#39;body&#39;</span><span class="p">,</span> <span class="s1">u&#39;[BODY NOT SET]&#39;</span><span class="p">)</span>

    <span class="c1"># TODO: this is a work in progress. The reason for the try-catch is that</span>
    <span class="c1"># the text parser is handed a non-text file and must deal with converting</span>
    <span class="c1"># arbitrary binary data.</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="n">line</span> <span class="o">=</span> <span class="s1">u&#39;{0:s} {1:s} [{2:s}] {3:s} =&gt; {4:s}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
          <span class="n">date_string</span><span class="p">,</span> <span class="n">time_string</span><span class="p">,</span> <span class="n">hostname_string</span><span class="p">,</span> <span class="n">reporter_string</span><span class="p">,</span>
          <span class="n">body_string</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">UnicodeError</span><span class="p">:</span>
      <span class="n">line</span> <span class="o">=</span> <span class="s1">u&#39;Unable to print line - due to encoding error.&#39;</span>

    <span class="k">return</span> <span class="n">line</span></div>

<div class="viewcode-block" id="SlowLexicalTextParser.ParseLine"><a class="viewcode-back" href="../../../plaso.parsers.html#plaso.parsers.skydrivelog.SlowLexicalTextParser.ParseLine">[docs]</a>  <span class="k">def</span> <span class="nf">ParseLine</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parser_mediator</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Parses the current log line for events.</span>

<span class="sd">    Args:</span>
<span class="sd">      parser_mediator: a parser mediator object (instance of ParserMediator).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">year_string</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">u&#39;iyear&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">year_string</span><span class="p">:</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file_verified</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">UnableToParseFile</span><span class="p">()</span>
      <span class="n">parser_mediator</span><span class="o">.</span><span class="n">ProduceParseError</span><span class="p">(</span>
          <span class="s1">u&#39;year missing in log line: {0:s}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">PrintLine</span><span class="p">()))</span>
      <span class="k">return</span>

    <span class="n">time_string</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">u&#39;time&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">time_string</span><span class="p">:</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file_verified</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">UnableToParseFile</span><span class="p">()</span>
      <span class="n">parser_mediator</span><span class="o">.</span><span class="n">ProduceParseError</span><span class="p">(</span>
          <span class="s1">u&#39;time values missing in log line: {0:s}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">PrintLine</span><span class="p">()))</span>
      <span class="k">return</span>

    <span class="n">time_values</span> <span class="o">=</span> <span class="n">time_string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">u&#39;:&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">time_values</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file_verified</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">UnableToParseFile</span><span class="p">()</span>
      <span class="n">parser_mediator</span><span class="o">.</span><span class="n">ProduceParseError</span><span class="p">(</span>
          <span class="s1">u&#39;unsupported time format in log line: {0:s}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
              <span class="bp">self</span><span class="o">.</span><span class="n">PrintLine</span><span class="p">()))</span>
      <span class="k">return</span>

    <span class="n">seconds_values</span> <span class="o">=</span> <span class="n">time_values</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">u&#39;.&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">seconds_values</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
      <span class="n">seconds_string</span><span class="p">,</span> <span class="n">microseconds_string</span> <span class="o">=</span> <span class="n">seconds_values</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">seconds_string</span> <span class="o">=</span> <span class="n">time_values</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
      <span class="n">microseconds_string</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">try</span><span class="p">:</span>
      <span class="c1"># TODO: fix the need to convert non string values into integers and</span>
      <span class="c1"># string to integer conversion without an explicit base.</span>
      <span class="n">year</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">year_string</span><span class="p">)</span>
      <span class="n">hours</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time_values</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
      <span class="n">minutes</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time_values</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
      <span class="n">seconds</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">seconds_string</span><span class="p">)</span>
      <span class="n">microseconds</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">microseconds_string</span><span class="p">)</span>

    <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">exception</span><span class="p">:</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file_verified</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">UnableToParseFile</span><span class="p">()</span>
      <span class="n">parser_mediator</span><span class="o">.</span><span class="n">ProduceParseError</span><span class="p">(</span>
          <span class="s1">u&#39;unable to parse log line: {0:s} with error: {1:s}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
              <span class="bp">self</span><span class="o">.</span><span class="n">PrintLine</span><span class="p">(),</span> <span class="n">exception</span><span class="p">))</span>
      <span class="k">return</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_zone</span><span class="p">:</span>
      <span class="n">timezone</span> <span class="o">=</span> <span class="n">parser_mediator</span><span class="o">.</span><span class="n">timezone</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">timezone</span> <span class="o">=</span> <span class="n">pytz</span><span class="o">.</span><span class="n">UTC</span>

    <span class="k">try</span><span class="p">:</span>
      <span class="n">timestamp</span> <span class="o">=</span> <span class="n">timelib</span><span class="o">.</span><span class="n">Timestamp</span><span class="o">.</span><span class="n">FromTimeParts</span><span class="p">(</span>
          <span class="n">year</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s1">u&#39;imonth&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s1">u&#39;iday&#39;</span><span class="p">],</span>
          <span class="n">hours</span><span class="p">,</span> <span class="n">minutes</span><span class="p">,</span> <span class="n">seconds</span><span class="p">,</span> <span class="n">microseconds</span><span class="o">=</span><span class="n">microseconds</span><span class="p">,</span>
          <span class="n">timezone</span><span class="o">=</span><span class="n">timezone</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">errors</span><span class="o">.</span><span class="n">TimestampError</span> <span class="k">as</span> <span class="n">exception</span><span class="p">:</span>
      <span class="n">timestamp</span> <span class="o">=</span> <span class="n">timelib</span><span class="o">.</span><span class="n">Timestamp</span><span class="o">.</span><span class="n">NONE_TIMESTAMP</span>
      <span class="n">parser_mediator</span><span class="o">.</span><span class="n">ProduceParseError</span><span class="p">(</span>
          <span class="s1">u&#39;unable to determine timestamp with error: {0:s}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
              <span class="n">exception</span><span class="p">))</span>

    <span class="n">event_object</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">CreateEvent</span><span class="p">(</span>
        <span class="n">timestamp</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">u&#39;entry_offset&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">attributes</span><span class="p">)</span>
    <span class="n">parser_mediator</span><span class="o">.</span><span class="n">ProduceEvent</span><span class="p">(</span><span class="n">event_object</span><span class="p">)</span></div>

<div class="viewcode-block" id="SlowLexicalTextParser.SetDay"><a class="viewcode-back" href="../../../plaso.parsers.html#plaso.parsers.skydrivelog.SlowLexicalTextParser.SetDay">[docs]</a>  <span class="k">def</span> <span class="nf">SetDay</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">match</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">unused_kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Parses the day of the month.</span>

<span class="sd">       This is a callback function for the text parser (lexer) and is</span>
<span class="sd">       called by the corresponding lexer state.</span>

<span class="sd">    Args:</span>
<span class="sd">      match: optional regular expression match object (instance of SRE_Match).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s1">u&#39;iday&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span></div>
<div class="viewcode-block" id="SlowLexicalTextParser.SetMonth"><a class="viewcode-back" href="../../../plaso.parsers.html#plaso.parsers.skydrivelog.SlowLexicalTextParser.SetMonth">[docs]</a>  <span class="k">def</span> <span class="nf">SetMonth</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">match</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">unused_kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Parses the month.</span>

<span class="sd">       This is a callback function for the text parser (lexer) and is</span>
<span class="sd">       called by the corresponding lexer state.</span>

<span class="sd">    Args:</span>
<span class="sd">      match: optional regular expression match object (instance of SRE_Match).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s1">u&#39;imonth&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
        <span class="n">timelib</span><span class="o">.</span><span class="n">MONTH_DICT</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="mi">1</span><span class="p">))</span></div>

<div class="viewcode-block" id="SlowLexicalTextParser.SetTime"><a class="viewcode-back" href="../../../plaso.parsers.html#plaso.parsers.skydrivelog.SlowLexicalTextParser.SetTime">[docs]</a>  <span class="k">def</span> <span class="nf">SetTime</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">match</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">unused_kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Set the time attribute.</span>

<span class="sd">    Args:</span>
<span class="sd">      match: optional regular expression match object (instance of SRE_Match).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s1">u&#39;time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span></div>

<div class="viewcode-block" id="SlowLexicalTextParser.SetYear"><a class="viewcode-back" href="../../../plaso.parsers.html#plaso.parsers.skydrivelog.SlowLexicalTextParser.SetYear">[docs]</a>  <span class="k">def</span> <span class="nf">SetYear</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">match</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">unused_kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Parses the year.</span>

<span class="sd">       This is a callback function for the text parser (lexer) and is</span>
<span class="sd">       called by the corresponding lexer state.</span>

<span class="sd">    Args:</span>
<span class="sd">      match: optional regular expression match object (instance of SRE_Match).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s1">u&#39;iyear&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span></div></div>


<div class="viewcode-block" id="TextCSVParser"><a class="viewcode-back" href="../../../plaso.parsers.html#plaso.parsers.skydrivelog.TextCSVParser">[docs]</a><span class="k">class</span> <span class="nc">TextCSVParser</span><span class="p">(</span><span class="n">interface</span><span class="o">.</span><span class="n">FileObjectParser</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;An implementation of a simple CSV line-per-entry log files.</span>

<span class="sd">  Attributes:</span>
<span class="sd">    encoding: The encoding used in the CSV file, or None, if the encoding is</span>
<span class="sd">              unknown.</span>
<span class="sd">  &quot;&quot;&quot;</span>

  <span class="c1"># A list that contains the names of all the fields in the log file.</span>
  <span class="n">COLUMNS</span> <span class="o">=</span> <span class="p">[]</span>

  <span class="c1"># A CSV file is comma separated, but this can be overwritten to include</span>
  <span class="c1"># tab, pipe or other character separation. Note this must be a byte string</span>
  <span class="c1"># otherwise TypeError: &quot;delimiter&quot; must be an 1-character string is raised.</span>
  <span class="n">VALUE_SEPARATOR</span> <span class="o">=</span> <span class="n">b</span><span class="s1">&#39;,&#39;</span>

  <span class="c1"># If there is a header before the lines start it can be defined here, and</span>
  <span class="c1"># the number of header lines that need to be skipped before the parsing</span>
  <span class="c1"># starts.</span>
  <span class="n">NUMBER_OF_HEADER_LINES</span> <span class="o">=</span> <span class="mi">0</span>

  <span class="c1"># If there is a special quote character used inside the structured text</span>
  <span class="c1"># it can be defined here.</span>
  <span class="n">QUOTE_CHAR</span> <span class="o">=</span> <span class="n">b</span><span class="s1">&#39;&quot;&#39;</span>

  <span class="c1"># Value that should not appear inside the file, made to test the actual</span>
  <span class="c1"># file to see if it confirms to standards.</span>
  <span class="n">MAGIC_TEST_STRING</span> <span class="o">=</span> <span class="n">b</span><span class="s1">&#39;RegnThvotturMeistarans&#39;</span>

  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Initializes a parser object.</span>

<span class="sd">    Args:</span>
<span class="sd">      encoding: optional encoding used in the CSV file. If None, the system</span>
<span class="sd">                codepage set in the parser mediator will be used.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">super</span><span class="p">(</span><span class="n">TextCSVParser</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">encoding</span> <span class="o">=</span> <span class="n">encoding</span>

  <span class="k">def</span> <span class="nf">_ConvertRowToUnicode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parser_mediator</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Converts all strings in a CSV row dict to Unicode.</span>

<span class="sd">    Args:</span>
<span class="sd">      parser_mediator: a parser mediator object (instance of ParserMediator).</span>
<span class="sd">      row: a single row from the CSV file. Strings in this dict are binary</span>
<span class="sd">           strings.</span>

<span class="sd">    Returns:</span>
<span class="sd">      A dict containing data from the CSV file, with all strings converted to</span>
<span class="sd">      Unicode.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoding</span><span class="p">:</span>
      <span class="c1"># If no encoding is set, we default to the system codepage.</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">encoding</span> <span class="o">=</span> <span class="n">parser_mediator</span><span class="o">.</span><span class="n">codepage</span>

    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">iter</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
      <span class="k">try</span><span class="p">:</span>
        <span class="n">row</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span>
      <span class="k">except</span> <span class="ne">UnicodeDecodeError</span><span class="p">:</span>
        <span class="n">replaced_value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">encoding</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s1">u&#39;replace&#39;</span><span class="p">)</span>
        <span class="n">parser_mediator</span><span class="o">.</span><span class="n">ProduceParseError</span><span class="p">(</span>
            <span class="s1">u&#39;Error decoding string as {0:s}, characters have been &#39;</span>
            <span class="s1">u&#39;replaced in {1:s}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">encoding</span><span class="p">,</span> <span class="n">replaced_value</span><span class="p">))</span>
        <span class="n">row</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">replaced_value</span>
    <span class="k">return</span> <span class="n">row</span>

<div class="viewcode-block" id="TextCSVParser.ParseRow"><a class="viewcode-back" href="../../../plaso.parsers.html#plaso.parsers.skydrivelog.TextCSVParser.ParseRow">[docs]</a>  <span class="k">def</span> <span class="nf">ParseRow</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parser_mediator</span><span class="p">,</span> <span class="n">row_offset</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Parse a line of the log file and extract event objects.</span>

<span class="sd">    Args:</span>
<span class="sd">      parser_mediator: a parser mediator object (instance of ParserMediator).</span>
<span class="sd">      row_offset: the offset of the row.</span>
<span class="sd">      row: a dictionary containing all the fields as denoted in the</span>
<span class="sd">           COLUMNS class list. Strings in this dict are Unicode strings.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># TODO: replace EventObject with a CSV specific event object.</span>
    <span class="n">event_object</span> <span class="o">=</span> <span class="n">events</span><span class="o">.</span><span class="n">EventObject</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">row_offset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
      <span class="n">event_object</span><span class="o">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">row_offset</span>
    <span class="n">event_object</span><span class="o">.</span><span class="n">row_dict</span> <span class="o">=</span> <span class="n">row</span>
    <span class="n">parser_mediator</span><span class="o">.</span><span class="n">ProduceEvent</span><span class="p">(</span><span class="n">event_object</span><span class="p">)</span></div>

<div class="viewcode-block" id="TextCSVParser.ParseFileObject"><a class="viewcode-back" href="../../../plaso.parsers.html#plaso.parsers.skydrivelog.TextCSVParser.ParseFileObject">[docs]</a>  <span class="k">def</span> <span class="nf">ParseFileObject</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parser_mediator</span><span class="p">,</span> <span class="n">file_object</span><span class="p">,</span> <span class="o">**</span><span class="n">unused_kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Parses a CSV text file-like object.</span>

<span class="sd">    Args:</span>
<span class="sd">      parser_mediator: a parser mediator object (instance of ParserMediator).</span>
<span class="sd">      file_object: a file-like object.</span>

<span class="sd">    Raises:</span>
<span class="sd">      UnableToParseFile: when the file cannot be parsed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">file_entry</span> <span class="o">=</span> <span class="n">parser_mediator</span><span class="o">.</span><span class="n">GetFileEntry</span><span class="p">()</span>
    <span class="n">path_spec_printable</span> <span class="o">=</span> <span class="n">file_entry</span><span class="o">.</span><span class="n">path_spec</span><span class="o">.</span><span class="n">comparable</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">u&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">u&#39;;&#39;</span><span class="p">)</span>

    <span class="n">text_file_object</span> <span class="o">=</span> <span class="n">text_file</span><span class="o">.</span><span class="n">TextFile</span><span class="p">(</span><span class="n">file_object</span><span class="p">)</span>

    <span class="c1"># If we specifically define a number of lines we should skip, do that here.</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NUMBER_OF_HEADER_LINES</span><span class="p">):</span>
      <span class="n">_</span> <span class="o">=</span> <span class="n">text_file_object</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>

    <span class="n">reader</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">DictReader</span><span class="p">(</span>
        <span class="n">text_file_object</span><span class="p">,</span> <span class="n">fieldnames</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">COLUMNS</span><span class="p">,</span>
        <span class="n">restkey</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">MAGIC_TEST_STRING</span><span class="p">,</span> <span class="n">restval</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">MAGIC_TEST_STRING</span><span class="p">,</span>
        <span class="n">delimiter</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">VALUE_SEPARATOR</span><span class="p">,</span> <span class="n">quotechar</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">QUOTE_CHAR</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
      <span class="n">row</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
    <span class="k">except</span> <span class="p">(</span><span class="n">csv</span><span class="o">.</span><span class="n">Error</span><span class="p">,</span> <span class="ne">StopIteration</span><span class="p">):</span>
      <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">UnableToParseFile</span><span class="p">(</span>
          <span class="s1">u&#39;[{0:s}] Unable to parse CSV file: {1:s}.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
              <span class="bp">self</span><span class="o">.</span><span class="n">NAME</span><span class="p">,</span> <span class="n">path_spec_printable</span><span class="p">))</span>

    <span class="n">number_of_columns</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">COLUMNS</span><span class="p">)</span>
    <span class="n">number_of_records</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">number_of_records</span> <span class="o">!=</span> <span class="n">number_of_columns</span><span class="p">:</span>
      <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">UnableToParseFile</span><span class="p">((</span>
          <span class="s1">u&#39;[{0:s}] Unable to parse CSV file: {1:s}. Wrong number of &#39;</span>
          <span class="s1">u&#39;records (expected: {2:d}, got: {3:d})&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
              <span class="bp">self</span><span class="o">.</span><span class="n">NAME</span><span class="p">,</span> <span class="n">path_spec_printable</span><span class="p">,</span> <span class="n">number_of_columns</span><span class="p">,</span>
              <span class="n">number_of_records</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">row</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
      <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">MAGIC_TEST_STRING</span> <span class="ow">or</span> <span class="n">value</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">MAGIC_TEST_STRING</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">UnableToParseFile</span><span class="p">((</span>
            <span class="s1">u&#39;[{0:s}] Unable to parse CSV file: {1:s}. Signature &#39;</span>
            <span class="s1">u&#39;mismatch.&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NAME</span><span class="p">,</span> <span class="n">path_spec_printable</span><span class="p">))</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">VerifyRow</span><span class="p">(</span><span class="n">parser_mediator</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
      <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">UnableToParseFile</span><span class="p">((</span>
          <span class="s1">u&#39;[{0:s}] Unable to parse CSV file: {1:s}. Verification &#39;</span>
          <span class="s1">u&#39;failed.&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NAME</span><span class="p">,</span> <span class="n">path_spec_printable</span><span class="p">))</span>

    <span class="n">row</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ConvertRowToUnicode</span><span class="p">(</span><span class="n">parser_mediator</span><span class="p">,</span> <span class="n">row</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ParseRow</span><span class="p">(</span><span class="n">parser_mediator</span><span class="p">,</span> <span class="n">text_file_object</span><span class="o">.</span><span class="n">tell</span><span class="p">(),</span> <span class="n">row</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">reader</span><span class="p">:</span>
      <span class="n">row</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ConvertRowToUnicode</span><span class="p">(</span><span class="n">parser_mediator</span><span class="p">,</span> <span class="n">row</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">ParseRow</span><span class="p">(</span><span class="n">parser_mediator</span><span class="p">,</span> <span class="n">text_file_object</span><span class="o">.</span><span class="n">tell</span><span class="p">(),</span> <span class="n">row</span><span class="p">)</span></div>

<div class="viewcode-block" id="TextCSVParser.VerifyRow"><a class="viewcode-back" href="../../../plaso.parsers.html#plaso.parsers.skydrivelog.TextCSVParser.VerifyRow">[docs]</a>  <span class="k">def</span> <span class="nf">VerifyRow</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">unused_parser_mediator</span><span class="p">,</span> <span class="n">unused_row</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return a bool indicating whether or not this is the correct parser.</span>

<span class="sd">    Args:</span>
<span class="sd">      parser_mediator: a parser mediator object (instance of ParserMediator).</span>
<span class="sd">      row: a single row from the CSV file. Strings in this dict are binary</span>
<span class="sd">           strings, to aid in file verification.</span>

<span class="sd">    Returns:</span>
<span class="sd">      True if this is the correct parser, False otherwise.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">pass</span></div></div>


<div class="viewcode-block" id="PyParseRangeCheck"><a class="viewcode-back" href="../../../plaso.parsers.html#plaso.parsers.skydrivelog.PyParseRangeCheck">[docs]</a><span class="k">def</span> <span class="nf">PyParseRangeCheck</span><span class="p">(</span><span class="n">lower_bound</span><span class="p">,</span> <span class="n">upper_bound</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Verify that a number is within a defined range.</span>

<span class="sd">  This is a callback method for pyparsing setParseAction</span>
<span class="sd">  that verifies that a read number is within a certain range.</span>

<span class="sd">  To use this method it needs to be defined as a callback method</span>
<span class="sd">  in setParseAction with the upper and lower bound set as parameters.</span>

<span class="sd">  Args:</span>
<span class="sd">    lower_bound: an integer representing the lower bound of the range.</span>
<span class="sd">    upper_bound: an integer representing the upper bound of the range.</span>

<span class="sd">  Returns:</span>
<span class="sd">    A callback method that can be used by pyparsing setParseAction.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="k">def</span> <span class="nf">CheckRange</span><span class="p">(</span><span class="n">unused_string</span><span class="p">,</span> <span class="n">unused_location</span><span class="p">,</span> <span class="n">tokens</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Parse the arguments.&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="n">check_number</span> <span class="o">=</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
      <span class="n">check_number</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

    <span class="k">if</span> <span class="n">check_number</span> <span class="o">&lt;</span> <span class="n">lower_bound</span><span class="p">:</span>
      <span class="k">raise</span> <span class="n">pyparsing</span><span class="o">.</span><span class="n">ParseException</span><span class="p">(</span>
          <span class="s1">u&#39;Value: {0:d} precedes lower bound: {1:d}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
              <span class="n">check_number</span><span class="p">,</span> <span class="n">lower_bound</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">check_number</span> <span class="o">&gt;</span> <span class="n">upper_bound</span><span class="p">:</span>
      <span class="k">raise</span> <span class="n">pyparsing</span><span class="o">.</span><span class="n">ParseException</span><span class="p">(</span>
          <span class="s1">u&#39;Value: {0:d} exceeds upper bound: {1:d}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
              <span class="n">check_number</span><span class="p">,</span> <span class="n">upper_bound</span><span class="p">))</span>

  <span class="c1"># Since callback methods for pyparsing need to accept certain parameters</span>
  <span class="c1"># and there is no way to define conditions, like upper and lower bounds</span>
  <span class="c1"># we need to return here a method that accepts those pyparsing parameters.</span>
  <span class="k">return</span> <span class="n">CheckRange</span></div>


<div class="viewcode-block" id="PyParseIntCast"><a class="viewcode-back" href="../../../plaso.parsers.html#plaso.parsers.skydrivelog.PyParseIntCast">[docs]</a><span class="k">def</span> <span class="nf">PyParseIntCast</span><span class="p">(</span><span class="n">unused_string</span><span class="p">,</span> <span class="n">unused_location</span><span class="p">,</span> <span class="n">tokens</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Return an integer from a string.</span>

<span class="sd">  This is a pyparsing callback method that converts the matched</span>
<span class="sd">  string into an integer.</span>

<span class="sd">  The method modifies the content of the tokens list and converts</span>
<span class="sd">  them all to an integer value.</span>

<span class="sd">  Args:</span>
<span class="sd">    unused_string: the original parsed string.</span>
<span class="sd">    unused_location: the location within the string where the match was made.</span>
<span class="sd">    tokens: A list of extracted tokens (where the string to be converted is</span>
<span class="sd">    stored).</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="c1"># Cast the regular tokens.</span>
  <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">token</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tokens</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="n">tokens</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
      <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">u&#39;Unable to cast [{0:s}] to an int, setting to 0&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
          <span class="n">token</span><span class="p">))</span>
      <span class="n">tokens</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

  <span class="c1"># We also need to cast the dictionary built tokens.</span>
  <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">tokens</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="n">tokens</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">tokens</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="mi">10</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
      <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
          <span class="s1">u&#39;Unable to cast [{0:s} = {1:d}] to an int, setting to 0&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
              <span class="n">key</span><span class="p">,</span> <span class="n">tokens</span><span class="p">[</span><span class="n">key</span><span class="p">]))</span>
      <span class="n">tokens</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span></div>


<div class="viewcode-block" id="PyParseJoinList"><a class="viewcode-back" href="../../../plaso.parsers.html#plaso.parsers.skydrivelog.PyParseJoinList">[docs]</a><span class="k">def</span> <span class="nf">PyParseJoinList</span><span class="p">(</span><span class="n">unused_string</span><span class="p">,</span> <span class="n">unused_location</span><span class="p">,</span> <span class="n">tokens</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Return a joined token from a list of tokens.</span>

<span class="sd">  This is a callback method for pyparsing setParseAction that modifies</span>
<span class="sd">  the returned token list to join all the elements in the list to a single</span>
<span class="sd">  token.</span>

<span class="sd">  Args:</span>
<span class="sd">    unused_string: the original parsed string.</span>
<span class="sd">    unused_location: the location within the string where the match was made.</span>
<span class="sd">    tokens: a list of extracted tokens. This is the list that should be joined</span>
<span class="sd">    together and stored as a single token.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">join_list</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">tokens</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="n">join_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">token</span><span class="p">))</span>
    <span class="k">except</span> <span class="ne">UnicodeDecodeError</span><span class="p">:</span>
      <span class="n">join_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">token</span><span class="p">))</span>

  <span class="n">tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="s1">u&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">join_list</span><span class="p">)</span>
  <span class="k">del</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span></div>


<div class="viewcode-block" id="PyparsingConstants"><a class="viewcode-back" href="../../../plaso.parsers.html#plaso.parsers.skydrivelog.PyparsingConstants">[docs]</a><span class="k">class</span> <span class="nc">PyparsingConstants</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;A class that maintains constants for pyparsing.&quot;&quot;&quot;</span>

  <span class="c1"># Numbers.</span>
  <span class="n">INTEGER</span> <span class="o">=</span> <span class="n">pyparsing</span><span class="o">.</span><span class="n">Word</span><span class="p">(</span><span class="n">pyparsing</span><span class="o">.</span><span class="n">nums</span><span class="p">)</span><span class="o">.</span><span class="n">setParseAction</span><span class="p">(</span><span class="n">PyParseIntCast</span><span class="p">)</span>
  <span class="n">IPV4_OCTET</span> <span class="o">=</span> <span class="n">pyparsing</span><span class="o">.</span><span class="n">Word</span><span class="p">(</span><span class="n">pyparsing</span><span class="o">.</span><span class="n">nums</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">setParseAction</span><span class="p">(</span>
      <span class="n">PyParseIntCast</span><span class="p">,</span> <span class="n">PyParseRangeCheck</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">))</span>
  <span class="n">IPV4_ADDRESS</span> <span class="o">=</span> <span class="p">(</span><span class="n">IPV4_OCTET</span> <span class="o">+</span> <span class="p">(</span><span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">IPV4_OCTET</span><span class="p">)</span> <span class="o">*</span> <span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">setParseAction</span><span class="p">(</span>
      <span class="n">PyParseJoinList</span><span class="p">)</span>

  <span class="c1"># TODO: Fix the IPv6 address specification to be more accurate (8 :, correct</span>
  <span class="c1"># size, etc).</span>
  <span class="n">IPV6_ADDRESS</span> <span class="o">=</span> <span class="n">pyparsing</span><span class="o">.</span><span class="n">Word</span><span class="p">(</span><span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="n">pyparsing</span><span class="o">.</span><span class="n">hexnums</span><span class="p">)</span><span class="o">.</span><span class="n">setParseAction</span><span class="p">(</span>
      <span class="n">PyParseJoinList</span><span class="p">)</span>

  <span class="c1"># Common words.</span>
  <span class="n">MONTH</span> <span class="o">=</span> <span class="n">pyparsing</span><span class="o">.</span><span class="n">Word</span><span class="p">(</span>
      <span class="n">pyparsing</span><span class="o">.</span><span class="n">string</span><span class="o">.</span><span class="n">uppercase</span><span class="p">,</span> <span class="n">pyparsing</span><span class="o">.</span><span class="n">string</span><span class="o">.</span><span class="n">lowercase</span><span class="p">,</span>
      <span class="n">exact</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

  <span class="c1"># Define date structures.</span>
  <span class="n">HYPHEN</span> <span class="o">=</span> <span class="n">pyparsing</span><span class="o">.</span><span class="n">Literal</span><span class="p">(</span><span class="s1">u&#39;-&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">suppress</span><span class="p">()</span>
  <span class="n">YEAR</span> <span class="o">=</span> <span class="n">pyparsing</span><span class="o">.</span><span class="n">Word</span><span class="p">(</span><span class="n">pyparsing</span><span class="o">.</span><span class="n">nums</span><span class="p">,</span> <span class="n">exact</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">setParseAction</span><span class="p">(</span>
      <span class="n">PyParseIntCast</span><span class="p">)</span>
  <span class="n">TWO_DIGITS</span> <span class="o">=</span> <span class="n">pyparsing</span><span class="o">.</span><span class="n">Word</span><span class="p">(</span><span class="n">pyparsing</span><span class="o">.</span><span class="n">nums</span><span class="p">,</span> <span class="n">exact</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">setParseAction</span><span class="p">(</span>
      <span class="n">PyParseIntCast</span><span class="p">)</span>
  <span class="n">ONE_OR_TWO_DIGITS</span> <span class="o">=</span> <span class="n">pyparsing</span><span class="o">.</span><span class="n">Word</span><span class="p">(</span>
      <span class="n">pyparsing</span><span class="o">.</span><span class="n">nums</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">setParseAction</span><span class="p">(</span><span class="n">PyParseIntCast</span><span class="p">)</span>
  <span class="n">DATE</span> <span class="o">=</span> <span class="n">pyparsing</span><span class="o">.</span><span class="n">Group</span><span class="p">(</span>
      <span class="n">YEAR</span> <span class="o">+</span> <span class="n">pyparsing</span><span class="o">.</span><span class="n">Suppress</span><span class="p">(</span><span class="s1">u&#39;-&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">TWO_DIGITS</span> <span class="o">+</span>
      <span class="n">pyparsing</span><span class="o">.</span><span class="n">Suppress</span><span class="p">(</span><span class="s1">u&#39;-&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">TWO_DIGITS</span><span class="p">)</span>
  <span class="n">DATE_REV</span> <span class="o">=</span> <span class="n">pyparsing</span><span class="o">.</span><span class="n">Group</span><span class="p">(</span>
      <span class="n">TWO_DIGITS</span> <span class="o">+</span> <span class="n">pyparsing</span><span class="o">.</span><span class="n">Suppress</span><span class="p">(</span><span class="s1">u&#39;-&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">TWO_DIGITS</span> <span class="o">+</span>
      <span class="n">pyparsing</span><span class="o">.</span><span class="n">Suppress</span><span class="p">(</span><span class="s1">u&#39;-&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">YEAR</span><span class="p">)</span>
  <span class="n">TIME</span> <span class="o">=</span> <span class="n">pyparsing</span><span class="o">.</span><span class="n">Group</span><span class="p">(</span>
      <span class="n">TWO_DIGITS</span> <span class="o">+</span> <span class="n">pyparsing</span><span class="o">.</span><span class="n">Suppress</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">TWO_DIGITS</span> <span class="o">+</span>
      <span class="n">pyparsing</span><span class="o">.</span><span class="n">Suppress</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">TWO_DIGITS</span><span class="p">)</span>
  <span class="n">TIME_MSEC</span> <span class="o">=</span> <span class="n">TIME</span> <span class="o">+</span> <span class="n">pyparsing</span><span class="o">.</span><span class="n">Suppress</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">INTEGER</span>
  <span class="n">DATE_TIME</span> <span class="o">=</span> <span class="n">DATE</span> <span class="o">+</span> <span class="n">TIME</span>
  <span class="n">DATE_TIME_MSEC</span> <span class="o">=</span> <span class="n">DATE</span> <span class="o">+</span> <span class="n">TIME_MSEC</span>

  <span class="n">COMMENT_LINE_HASH</span> <span class="o">=</span> <span class="n">pyparsing</span><span class="o">.</span><span class="n">Literal</span><span class="p">(</span><span class="s1">u&#39;#&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">pyparsing</span><span class="o">.</span><span class="n">SkipTo</span><span class="p">(</span>
      <span class="n">pyparsing</span><span class="o">.</span><span class="n">LineEnd</span><span class="p">())</span>
  <span class="c1"># TODO: Add more commonly used structs that can be used by parsers.</span>
  <span class="n">PID</span> <span class="o">=</span> <span class="n">pyparsing</span><span class="o">.</span><span class="n">Word</span><span class="p">(</span>
      <span class="n">pyparsing</span><span class="o">.</span><span class="n">nums</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">setParseAction</span><span class="p">(</span><span class="n">PyParseIntCast</span><span class="p">)</span></div>


<div class="viewcode-block" id="PyparsingSingleLineTextParser"><a class="viewcode-back" href="../../../plaso.parsers.html#plaso.parsers.skydrivelog.PyparsingSingleLineTextParser">[docs]</a><span class="k">class</span> <span class="nc">PyparsingSingleLineTextParser</span><span class="p">(</span><span class="n">interface</span><span class="o">.</span><span class="n">FileObjectParser</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Single line text parser based on the pyparsing library.&quot;&quot;&quot;</span>

  <span class="c1"># The actual structure, this needs to be defined by each parser.</span>
  <span class="c1"># This is defined as a list of tuples so that more then a single line</span>
  <span class="c1"># structure can be defined. That way the parser can support more than a</span>
  <span class="c1"># single type of log entry, despite them all having in common the constraint</span>
  <span class="c1"># that each log entry is a single line.</span>
  <span class="c1"># The tuple should have two entries, a key and a structure. This is done to</span>
  <span class="c1"># keep the structures in an order of priority/preference.</span>
  <span class="c1"># The key is a comment or an identification that is passed to the ParseRecord</span>
  <span class="c1"># function so that the developer can identify which structure got parsed.</span>
  <span class="c1"># The value is the actual pyparsing structure.</span>
  <span class="n">LINE_STRUCTURES</span> <span class="o">=</span> <span class="p">[]</span>

  <span class="c1"># In order for the tool to not read too much data into a buffer to evaluate</span>
  <span class="c1"># whether or not the parser is the right one for this file or not we</span>
  <span class="c1"># specifically define a maximum amount of bytes a single line can occupy. This</span>
  <span class="c1"># constant can be overwritten by implementations if their format might have a</span>
  <span class="c1"># longer line than 400 bytes.</span>
  <span class="n">MAX_LINE_LENGTH</span> <span class="o">=</span> <span class="mi">400</span>

  <span class="c1"># Define an encoding. If a file is encoded using specific encoding it is</span>
  <span class="c1"># advised to include it here. If this class constant is set all lines wil be</span>
  <span class="c1"># decoded prior to being sent to parsing by pyparsing, if not properly set it</span>
  <span class="c1"># could negatively affect parsing of the file.</span>
  <span class="c1"># If this value needs to be calculated on the fly (not a fixed constant for</span>
  <span class="c1"># this particular file type) it can be done by modifying the self.encoding</span>
  <span class="c1"># attribute.</span>
  <span class="n">_ENCODING</span> <span class="o">=</span> <span class="s1">u&#39;ascii&#39;</span>

  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Initializes a parser object.&quot;&quot;&quot;</span>
    <span class="nb">super</span><span class="p">(</span><span class="n">PyparsingSingleLineTextParser</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_current_offset</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="c1"># TODO: self._line_structures is a work-around and this needs</span>
    <span class="c1"># a structural fix.</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_line_structures</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">LINE_STRUCTURES</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">encoding</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ENCODING</span>

  <span class="k">def</span> <span class="nf">_ReadLine</span><span class="p">(</span>
      <span class="bp">self</span><span class="p">,</span> <span class="n">parser_mediator</span><span class="p">,</span> <span class="n">text_file_object</span><span class="p">,</span> <span class="n">max_len</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Read a single line from a text file and return it back.</span>

<span class="sd">    Args:</span>
<span class="sd">      parser_mediator: a parser mediator object (instance of ParserMediator).</span>
<span class="sd">      text_file_object: a text file object (instance of dfvfs.TextFile).</span>
<span class="sd">      max_len: optional maximum number of bytes a single line can take.</span>
<span class="sd">      quiet: optional boolean value to indicate parse warning should not be</span>
<span class="sd">             displayed.</span>
<span class="sd">      depth: optional number of new lines the parser can encounter before</span>
<span class="sd">             bailing out.</span>

<span class="sd">    Returns:</span>
<span class="sd">      A single line read from the file-like object, or the maximum number of</span>
<span class="sd">      characters (if max_len defined and line longer than the defined size).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">max_len</span><span class="p">:</span>
      <span class="n">line</span> <span class="o">=</span> <span class="n">text_file_object</span><span class="o">.</span><span class="n">readline</span><span class="p">(</span><span class="n">max_len</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">line</span> <span class="o">=</span> <span class="n">text_file_object</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span>
      <span class="k">return</span>

    <span class="c1"># If line is empty, skip it and go on.</span>
    <span class="k">if</span> <span class="n">line</span> <span class="ow">in</span> <span class="p">[</span><span class="n">b</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">b</span><span class="s1">&#39;</span><span class="se">\r\n</span><span class="s1">&#39;</span><span class="p">]:</span>
      <span class="c1"># Max 40 new lines in a row before we bail out.</span>
      <span class="k">if</span> <span class="n">depth</span> <span class="o">==</span> <span class="mi">40</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">u&#39;&#39;</span>

      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ReadLine</span><span class="p">(</span>
          <span class="n">parser_mediator</span><span class="p">,</span> <span class="n">text_file_object</span><span class="p">,</span> <span class="n">max_len</span><span class="o">=</span><span class="n">max_len</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="n">depth</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoding</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

    <span class="k">try</span><span class="p">:</span>
      <span class="n">decoded_line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">decoded_line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">UnicodeDecodeError</span><span class="p">:</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
        <span class="n">display_name</span> <span class="o">=</span> <span class="n">parser_mediator</span><span class="o">.</span><span class="n">GetDisplayName</span><span class="p">()</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">((</span>
            <span class="s1">u&#39;Unable to decode line [{0:s}...] with encoding: {1:s} in &#39;</span>
            <span class="s1">u&#39;file: {2:s}&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="nb">repr</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">30</span><span class="p">]),</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoding</span><span class="p">,</span> <span class="n">display_name</span><span class="p">))</span>
      <span class="k">return</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

<div class="viewcode-block" id="PyparsingSingleLineTextParser.ParseFileObject"><a class="viewcode-back" href="../../../plaso.parsers.html#plaso.parsers.skydrivelog.PyparsingSingleLineTextParser.ParseFileObject">[docs]</a>  <span class="k">def</span> <span class="nf">ParseFileObject</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parser_mediator</span><span class="p">,</span> <span class="n">file_object</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Parses a text file-like object using a pyparsing definition.</span>

<span class="sd">    Args:</span>
<span class="sd">      parser_mediator: a parser mediator object (instance of ParserMediator).</span>
<span class="sd">      file_object: a file-like object.</span>

<span class="sd">    Raises:</span>
<span class="sd">      UnableToParseFile: when the file cannot be parsed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># TODO: self._line_structures is a work-around and this needs</span>
    <span class="c1"># a structural fix.</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_line_structures</span><span class="p">:</span>
      <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">UnableToParseFile</span><span class="p">(</span>
          <span class="s1">u&#39;Line structure undeclared, unable to proceed.&#39;</span><span class="p">)</span>

    <span class="n">text_file_object</span> <span class="o">=</span> <span class="n">text_file</span><span class="o">.</span><span class="n">TextFile</span><span class="p">(</span><span class="n">file_object</span><span class="p">)</span>

    <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ReadLine</span><span class="p">(</span>
        <span class="n">parser_mediator</span><span class="p">,</span> <span class="n">text_file_object</span><span class="p">,</span> <span class="n">max_len</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">MAX_LINE_LENGTH</span><span class="p">,</span>
        <span class="n">quiet</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span>
      <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">UnableToParseFile</span><span class="p">(</span><span class="s1">u&#39;Not a text file.&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">MAX_LINE_LENGTH</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span>
        <span class="n">line</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">MAX_LINE_LENGTH</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
      <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">((</span>
          <span class="s1">u&#39;Trying to read a line and reached the maximum allowed length of &#39;</span>
          <span class="s1">u&#39;{0:d}. The last few bytes of the line are: {1:s} [parser &#39;</span>
          <span class="s1">u&#39;{2:s}]&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
              <span class="bp">self</span><span class="o">.</span><span class="n">MAX_LINE_LENGTH</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="o">-</span><span class="mi">10</span><span class="p">:]),</span> <span class="bp">self</span><span class="o">.</span><span class="n">NAME</span><span class="p">))</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">utils</span><span class="o">.</span><span class="n">IsText</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
      <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">UnableToParseFile</span><span class="p">(</span><span class="s1">u&#39;Not a text file, unable to proceed.&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">VerifyStructure</span><span class="p">(</span><span class="n">parser_mediator</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
      <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">UnableToParseFile</span><span class="p">(</span><span class="s1">u&#39;Wrong file structure.&#39;</span><span class="p">)</span>

    <span class="c1"># Set the offset to the beginning of the file.</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_current_offset</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="c1"># Read every line in the text file.</span>
    <span class="k">while</span> <span class="n">line</span><span class="p">:</span>
      <span class="n">parsed_structure</span> <span class="o">=</span> <span class="bp">None</span>
      <span class="n">use_key</span> <span class="o">=</span> <span class="bp">None</span>
      <span class="c1"># Try to parse the line using all the line structures.</span>
      <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">structure</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">LINE_STRUCTURES</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
          <span class="n">parsed_structure</span> <span class="o">=</span> <span class="n">structure</span><span class="o">.</span><span class="n">parseString</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">pyparsing</span><span class="o">.</span><span class="n">ParseException</span><span class="p">:</span>
          <span class="k">pass</span>
        <span class="k">if</span> <span class="n">parsed_structure</span><span class="p">:</span>
          <span class="n">use_key</span> <span class="o">=</span> <span class="n">key</span>
          <span class="k">break</span>

      <span class="k">if</span> <span class="n">parsed_structure</span><span class="p">:</span>
        <span class="n">parsed_event</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ParseRecord</span><span class="p">(</span>
            <span class="n">parser_mediator</span><span class="p">,</span> <span class="n">use_key</span><span class="p">,</span> <span class="n">parsed_structure</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">parsed_event</span><span class="p">:</span>
          <span class="n">parsed_event</span><span class="o">.</span><span class="n">offset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_offset</span>
          <span class="n">parser_mediator</span><span class="o">.</span><span class="n">ProduceEvent</span><span class="p">(</span><span class="n">parsed_event</span><span class="p">)</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">80</span><span class="p">:</span>
          <span class="n">line</span> <span class="o">=</span> <span class="s1">u&#39;{0:s}...&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">77</span><span class="p">])</span>
        <span class="n">parser_mediator</span><span class="o">.</span><span class="n">ProduceParseError</span><span class="p">(</span>
            <span class="s1">u&#39;Unable to parse log line: {0:s} at offset {1:d}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="nb">repr</span><span class="p">(</span><span class="n">line</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_offset</span><span class="p">))</span>

      <span class="bp">self</span><span class="o">.</span><span class="n">_current_offset</span> <span class="o">=</span> <span class="n">text_file_object</span><span class="o">.</span><span class="n">get_offset</span><span class="p">()</span>
      <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ReadLine</span><span class="p">(</span><span class="n">parser_mediator</span><span class="p">,</span> <span class="n">text_file_object</span><span class="p">)</span></div>

  <span class="nd">@abc.abstractmethod</span>
<div class="viewcode-block" id="PyparsingSingleLineTextParser.ParseRecord"><a class="viewcode-back" href="../../../plaso.parsers.html#plaso.parsers.skydrivelog.PyparsingSingleLineTextParser.ParseRecord">[docs]</a>  <span class="k">def</span> <span class="nf">ParseRecord</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parser_mediator</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">structure</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Parses a log record structure and produces events.</span>

<span class="sd">    This function takes as an input a parsed pyparsing structure</span>
<span class="sd">    and produces an EventObject if possible from that structure.</span>

<span class="sd">    Args:</span>
<span class="sd">      parser_mediator: a parser mediator object (instance of ParserMediator).</span>
<span class="sd">      key: an identification string indicating the name of the parsed</span>
<span class="sd">           structure.</span>
<span class="sd">      structure: a pyparsing.ParseResults object from a line in the</span>
<span class="sd">                 log file.</span>

<span class="sd">    Returns:</span>
<span class="sd">      An event object (instance of EventObject) or None.</span>
<span class="sd">    &quot;&quot;&quot;</span></div>

  <span class="nd">@abc.abstractmethod</span>
<div class="viewcode-block" id="PyparsingSingleLineTextParser.VerifyStructure"><a class="viewcode-back" href="../../../plaso.parsers.html#plaso.parsers.skydrivelog.PyparsingSingleLineTextParser.VerifyStructure">[docs]</a>  <span class="k">def</span> <span class="nf">VerifyStructure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parser_mediator</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Verify the structure of the file and return boolean based on that check.</span>

<span class="sd">    This function should read enough text from the text file to confirm</span>
<span class="sd">    that the file is the correct one for this particular parser.</span>

<span class="sd">    Args:</span>
<span class="sd">      parser_mediator: a parser mediator object (instance of ParserMediator).</span>
<span class="sd">      line: a single line from the text file.</span>

<span class="sd">    Returns:</span>
<span class="sd">      True if this is the correct parser, False otherwise.</span>
<span class="sd">    &quot;&quot;&quot;</span></div></div>


<div class="viewcode-block" id="EncodedTextReader"><a class="viewcode-back" href="../../../plaso.parsers.html#plaso.parsers.skydrivelog.EncodedTextReader">[docs]</a><span class="k">class</span> <span class="nc">EncodedTextReader</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Class to read simple encoded text.&quot;&quot;&quot;</span>

  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">buffer_size</span><span class="o">=</span><span class="mi">2048</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Initializes the encoded test reader object.</span>

<span class="sd">    Args:</span>
<span class="sd">      buffer_size: optional buffer size.</span>
<span class="sd">      encoding: optional encoding.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">super</span><span class="p">(</span><span class="n">EncodedTextReader</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span> <span class="o">=</span> <span class="n">b</span><span class="s1">&#39;&#39;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_buffer_size</span> <span class="o">=</span> <span class="n">buffer_size</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_current_offset</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_encoding</span> <span class="o">=</span> <span class="n">encoding</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_encoding</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_new_line</span> <span class="o">=</span> <span class="s1">u&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_encoding</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_carriage_return</span> <span class="o">=</span> <span class="s1">u&#39;</span><span class="se">\r</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_encoding</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_new_line</span> <span class="o">=</span> <span class="n">b</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_carriage_return</span> <span class="o">=</span> <span class="n">b</span><span class="s1">&#39;</span><span class="se">\r</span><span class="s1">&#39;</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_new_line_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_new_line</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_carriage_return_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_carriage_return</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">lines</span> <span class="o">=</span> <span class="s1">u&#39;&#39;</span>

  <span class="k">def</span> <span class="nf">_ReadLine</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Reads a line from the file object.</span>

<span class="sd">    Args:</span>
<span class="sd">      file_object: the file-like object.</span>

<span class="sd">    Returns:</span>
<span class="sd">      A string containing the line.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_buffer_size</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span> <span class="o">=</span> <span class="n">b</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span><span class="p">,</span> <span class="n">file_object</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_buffer_size</span><span class="p">)])</span>

    <span class="n">line</span><span class="p">,</span> <span class="n">new_line</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_new_line</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">new_line</span><span class="p">:</span>
      <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span> <span class="o">=</span> <span class="n">b</span><span class="s1">&#39;&#39;</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_current_offset</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

    <span class="c1"># Strip carriage returns from the text.</span>
    <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_carriage_return</span><span class="p">):</span>
      <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="p">[:</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">_carriage_return_length</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">new_line</span><span class="p">:</span>
      <span class="n">line</span> <span class="o">=</span> <span class="n">b</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">line</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_new_line</span><span class="p">])</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_current_offset</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_new_line_length</span>

    <span class="c1"># If a parser specifically indicates specific encoding we need</span>
    <span class="c1"># to handle the buffer as it is an encoded string.</span>
    <span class="c1"># If it fails we fail back to the original raw string.</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_encoding</span><span class="p">:</span>
      <span class="k">try</span><span class="p">:</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_encoding</span><span class="p">)</span>
      <span class="k">except</span> <span class="ne">UnicodeDecodeError</span><span class="p">:</span>
        <span class="c1"># TODO: it might be better to raise here.</span>
        <span class="k">pass</span>

    <span class="k">return</span> <span class="n">line</span>

<div class="viewcode-block" id="EncodedTextReader.ReadLine"><a class="viewcode-back" href="../../../plaso.parsers.html#plaso.parsers.skydrivelog.EncodedTextReader.ReadLine">[docs]</a>  <span class="k">def</span> <span class="nf">ReadLine</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Reads a line.</span>

<span class="sd">    Args:</span>
<span class="sd">      file_object: the file-like object.</span>

<span class="sd">    Returns:</span>
<span class="sd">      A single line read from the lines buffer.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">line</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="s1">u&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">ReadLines</span><span class="p">(</span><span class="n">file_object</span><span class="p">)</span>
      <span class="n">line</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="s1">u&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">line</span></div>

<div class="viewcode-block" id="EncodedTextReader.ReadLines"><a class="viewcode-back" href="../../../plaso.parsers.html#plaso.parsers.skydrivelog.EncodedTextReader.ReadLines">[docs]</a>  <span class="k">def</span> <span class="nf">ReadLines</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Reads lines into the lines buffer.</span>

<span class="sd">    Args:</span>
<span class="sd">      file_object: the file-like object.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">lines_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">lines_size</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_buffer_size</span><span class="p">:</span>
      <span class="n">lines_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_buffer_size</span> <span class="o">-</span> <span class="n">lines_size</span>
      <span class="k">while</span> <span class="n">lines_size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ReadLine</span><span class="p">(</span><span class="n">file_object</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span>
          <span class="k">break</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">lines</span> <span class="o">=</span> <span class="s1">u&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="p">,</span> <span class="n">line</span><span class="p">])</span>
        <span class="n">lines_size</span> <span class="o">-=</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></div>

<div class="viewcode-block" id="EncodedTextReader.Reset"><a class="viewcode-back" href="../../../plaso.parsers.html#plaso.parsers.skydrivelog.EncodedTextReader.Reset">[docs]</a>  <span class="k">def</span> <span class="nf">Reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Resets the encoded text reader.&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span> <span class="o">=</span> <span class="n">b</span><span class="s1">&#39;&#39;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_current_offset</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">lines</span> <span class="o">=</span> <span class="s1">u&#39;&#39;</span></div>

<div class="viewcode-block" id="EncodedTextReader.SkipAhead"><a class="viewcode-back" href="../../../plaso.parsers.html#plaso.parsers.skydrivelog.EncodedTextReader.SkipAhead">[docs]</a>  <span class="k">def</span> <span class="nf">SkipAhead</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_object</span><span class="p">,</span> <span class="n">number_of_characters</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Skips ahead a number of characters.</span>

<span class="sd">    Args:</span>
<span class="sd">      file_object: the file-like object.</span>
<span class="sd">      number_of_characters: the number of characters.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">lines_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="p">)</span>
    <span class="k">while</span> <span class="n">number_of_characters</span> <span class="o">&gt;=</span> <span class="n">lines_size</span><span class="p">:</span>
      <span class="n">number_of_characters</span> <span class="o">-=</span> <span class="n">lines_size</span>

      <span class="bp">self</span><span class="o">.</span><span class="n">lines</span> <span class="o">=</span> <span class="s1">u&#39;&#39;</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">ReadLines</span><span class="p">(</span><span class="n">file_object</span><span class="p">)</span>
      <span class="n">lines_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">lines_size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">lines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="p">[</span><span class="n">number_of_characters</span><span class="p">:]</span></div></div>


<div class="viewcode-block" id="PyparsingMultiLineTextParser"><a class="viewcode-back" href="../../../plaso.parsers.html#plaso.parsers.skydrivelog.PyparsingMultiLineTextParser">[docs]</a><span class="k">class</span> <span class="nc">PyparsingMultiLineTextParser</span><span class="p">(</span><span class="n">PyparsingSingleLineTextParser</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Multi line text parser based on the pyparsing library.&quot;&quot;&quot;</span>

  <span class="n">BUFFER_SIZE</span> <span class="o">=</span> <span class="mi">2048</span>

  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Initializes a parser object.&quot;&quot;&quot;</span>
    <span class="nb">super</span><span class="p">(</span><span class="n">PyparsingMultiLineTextParser</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_buffer_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BUFFER_SIZE</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_text_reader</span> <span class="o">=</span> <span class="n">EncodedTextReader</span><span class="p">(</span>
        <span class="n">buffer_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">BUFFER_SIZE</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_ENCODING</span><span class="p">)</span>

<div class="viewcode-block" id="PyparsingMultiLineTextParser.ParseFileObject"><a class="viewcode-back" href="../../../plaso.parsers.html#plaso.parsers.skydrivelog.PyparsingMultiLineTextParser.ParseFileObject">[docs]</a>  <span class="k">def</span> <span class="nf">ParseFileObject</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parser_mediator</span><span class="p">,</span> <span class="n">file_object</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Parses a text file-like object using a pyparsing definition.</span>

<span class="sd">    Args:</span>
<span class="sd">      parser_mediator: a parser mediator object (instance of ParserMediator).</span>
<span class="sd">      file_object: a file-like object.</span>

<span class="sd">    Raises:</span>
<span class="sd">      UnableToParseFile: when the file cannot be parsed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">LINE_STRUCTURES</span><span class="p">:</span>
      <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">UnableToParseFile</span><span class="p">(</span><span class="s1">u&#39;Missing line structures.&#39;</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_text_reader</span><span class="o">.</span><span class="n">Reset</span><span class="p">()</span>

    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_text_reader</span><span class="o">.</span><span class="n">ReadLines</span><span class="p">(</span><span class="n">file_object</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">UnicodeDecodeError</span> <span class="k">as</span> <span class="n">exception</span><span class="p">:</span>
      <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">UnableToParseFile</span><span class="p">(</span>
          <span class="s1">u&#39;Not a text file, with error: {0:s}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">exception</span><span class="p">))</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">utils</span><span class="o">.</span><span class="n">IsText</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_text_reader</span><span class="o">.</span><span class="n">lines</span><span class="p">):</span>
      <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">UnableToParseFile</span><span class="p">(</span><span class="s1">u&#39;Not a text file, unable to proceed.&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">VerifyStructure</span><span class="p">(</span><span class="n">parser_mediator</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_text_reader</span><span class="o">.</span><span class="n">lines</span><span class="p">):</span>
      <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">UnableToParseFile</span><span class="p">(</span><span class="s1">u&#39;Wrong file structure.&#39;</span><span class="p">)</span>

    <span class="c1"># Using parseWithTabs() overrides Pyparsing&#39;s default replacement of tabs</span>
    <span class="c1"># with spaces to SkipAhead() the correct number of bytes after a match.</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">structure</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">LINE_STRUCTURES</span><span class="p">:</span>
      <span class="n">structure</span><span class="o">.</span><span class="n">parseWithTabs</span><span class="p">()</span>

    <span class="c1"># Read every line in the text file.</span>
    <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">_text_reader</span><span class="o">.</span><span class="n">lines</span><span class="p">:</span>
      <span class="c1"># Initialize pyparsing objects.</span>
      <span class="n">tokens</span> <span class="o">=</span> <span class="bp">None</span>
      <span class="n">start</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="n">end</span> <span class="o">=</span> <span class="mi">0</span>

      <span class="n">key</span> <span class="o">=</span> <span class="bp">None</span>

      <span class="c1"># Try to parse the line using all the line structures.</span>
      <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">structure</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">LINE_STRUCTURES</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
          <span class="n">parsed_structure</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span>
              <span class="n">structure</span><span class="o">.</span><span class="n">scanString</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_text_reader</span><span class="o">.</span><span class="n">lines</span><span class="p">,</span> <span class="n">maxMatches</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">pyparsing</span><span class="o">.</span><span class="n">ParseException</span><span class="p">:</span>
          <span class="k">continue</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">parsed_structure</span><span class="p">:</span>
          <span class="k">continue</span>

        <span class="n">tokens</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="n">parsed_structure</span>

        <span class="c1"># Only want to parse the structure if it starts</span>
        <span class="c1"># at the beginning of the buffer.</span>
        <span class="k">if</span> <span class="n">start</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
          <span class="k">break</span>

      <span class="k">if</span> <span class="n">tokens</span> <span class="ow">and</span> <span class="n">start</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ParseRecord</span><span class="p">(</span><span class="n">parser_mediator</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">tokens</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_text_reader</span><span class="o">.</span><span class="n">SkipAhead</span><span class="p">(</span><span class="n">file_object</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>

      <span class="k">else</span><span class="p">:</span>
        <span class="n">odd_line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_text_reader</span><span class="o">.</span><span class="n">ReadLine</span><span class="p">(</span><span class="n">file_object</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">odd_line</span><span class="p">:</span>
          <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">odd_line</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">80</span><span class="p">:</span>
            <span class="n">odd_line</span> <span class="o">=</span> <span class="s1">u&#39;{0:s}...&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">odd_line</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">77</span><span class="p">])</span>
          <span class="n">parser_mediator</span><span class="o">.</span><span class="n">ProduceParseError</span><span class="p">(</span>
              <span class="s1">u&#39;Unable to parse log line: {0:s}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">odd_line</span><span class="p">)))</span>

      <span class="k">try</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_text_reader</span><span class="o">.</span><span class="n">ReadLines</span><span class="p">(</span><span class="n">file_object</span><span class="p">)</span>
      <span class="k">except</span> <span class="ne">UnicodeDecodeError</span> <span class="k">as</span> <span class="n">exception</span><span class="p">:</span>
        <span class="n">parser_mediator</span><span class="o">.</span><span class="n">ProduceParseError</span><span class="p">(</span>
            <span class="s1">u&#39;Unable to read lines from file with error: {0:s}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">exception</span><span class="p">))</span></div></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">Plaso 1.4.1_20160603 documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &raquo;</li>
          <li class="nav-item nav-item-2"><a href="../../plaso.html" >plaso</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &copy; Copyright The Plaso Project Authors.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.4.2.
    </div>
  </body>
</html>