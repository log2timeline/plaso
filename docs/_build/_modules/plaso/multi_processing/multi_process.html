<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>plaso.multi_processing.multi_process &mdash; Plaso 1.4.1_20160603 documentation</title>
    
    <link rel="stylesheet" href="../../../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '1.4.1_20160603',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <link rel="top" title="Plaso 1.4.1_20160603 documentation" href="../../../index.html" />
    <link rel="up" title="plaso" href="../../plaso.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">Plaso 1.4.1_20160603 documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &raquo;</li>
          <li class="nav-item nav-item-2"><a href="../../plaso.html" accesskey="U">plaso</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for plaso.multi_processing.multi_process</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;The multi-process processing engine.&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">abc</span>
<span class="kn">import</span> <span class="nn">ctypes</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">multiprocessing</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">Queue</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">signal</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="kn">from</span> <span class="nn">dfvfs.resolver</span> <span class="kn">import</span> <span class="n">context</span>

<span class="kn">from</span> <span class="nn">plaso.containers</span> <span class="kn">import</span> <span class="n">event_sources</span>
<span class="kn">from</span> <span class="nn">plaso.engine</span> <span class="kn">import</span> <span class="n">engine</span>
<span class="kn">from</span> <span class="nn">plaso.engine</span> <span class="kn">import</span> <span class="n">extractors</span>
<span class="kn">from</span> <span class="nn">plaso.engine</span> <span class="kn">import</span> <span class="n">plaso_queue</span>
<span class="kn">from</span> <span class="nn">plaso.engine</span> <span class="kn">import</span> <span class="n">worker</span>
<span class="kn">from</span> <span class="nn">plaso.engine</span> <span class="kn">import</span> <span class="n">zeromq_queue</span>
<span class="kn">from</span> <span class="nn">plaso.lib</span> <span class="kn">import</span> <span class="n">definitions</span>
<span class="kn">from</span> <span class="nn">plaso.lib</span> <span class="kn">import</span> <span class="n">errors</span>
<span class="kn">from</span> <span class="nn">plaso.multi_processing</span> <span class="kn">import</span> <span class="n">process_info</span>
<span class="kn">from</span> <span class="nn">plaso.multi_processing</span> <span class="kn">import</span> <span class="n">xmlrpc</span>
<span class="kn">from</span> <span class="nn">plaso.parsers</span> <span class="kn">import</span> <span class="n">mediator</span> <span class="k">as</span> <span class="n">parsers_mediator</span>


<div class="viewcode-block" id="MultiProcessBaseProcess"><a class="viewcode-back" href="../../../plaso.multi_processing.html#plaso.multi_processing.multi_process.MultiProcessBaseProcess">[docs]</a><span class="k">class</span> <span class="nc">MultiProcessBaseProcess</span><span class="p">(</span><span class="n">multiprocessing</span><span class="o">.</span><span class="n">Process</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Class that defines the multi-processing process interface.</span>

<span class="sd">  Attributes:</span>
<span class="sd">    rpc_port: the port number of the process status RPC server.</span>
<span class="sd">  &quot;&quot;&quot;</span>

  <span class="n">_NUMBER_OF_RPC_SERVER_START_ATTEMPTS</span> <span class="o">=</span> <span class="mi">14</span>
  <span class="n">_PROCESS_JOIN_TIMEOUT</span> <span class="o">=</span> <span class="mf">5.0</span>

  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">process_type</span><span class="p">,</span> <span class="n">enable_sigsegv_handler</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Initializes the process object.</span>

<span class="sd">    Args:</span>
<span class="sd">      process_type: the process type.</span>
<span class="sd">      enable_sigsegv_handler: optional boolean value to indicate the SIGSEGV</span>
<span class="sd">                              handler should be enabled.</span>
<span class="sd">      kwargs: keyword arguments to pass to multiprocessing.Process.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">super</span><span class="p">(</span><span class="n">MultiProcessBaseProcess</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_enable_sigsegv_handler</span> <span class="o">=</span> <span class="n">enable_sigsegv_handler</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_original_sigsegv_handler</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="c1"># TODO: check if this can be replaced by self.pid or does this only apply</span>
    <span class="c1"># to the parent process?</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_pid</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_rpc_server</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_status_is_running</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_type</span> <span class="o">=</span> <span class="n">process_type</span>

    <span class="c1"># We need to share the RPC port number with the engine process.</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">rpc_port</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Value</span><span class="p">(</span><span class="s1">&#39;I&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

  <span class="nd">@abc.abstractmethod</span>
  <span class="k">def</span> <span class="nf">_GetStatus</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns a status dictionary.&quot;&quot;&quot;</span>

  <span class="nd">@abc.abstractmethod</span>
  <span class="k">def</span> <span class="nf">_Main</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The process main loop.</span>

<span class="sd">    This method is called when the process is ready to start. A sub class</span>
<span class="sd">    should override this method to do the necessary actions in the main loop.</span>
<span class="sd">    &quot;&quot;&quot;</span>

  <span class="k">def</span> <span class="nf">_OnCriticalError</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The process on critical error handler.</span>

<span class="sd">    This method is called when the process encountered a critical error e.g.</span>
<span class="sd">    a segfault. A sub class should override this method to do the necessary</span>
<span class="sd">    actions before the original critical error signal handler it called.</span>

<span class="sd">    Be aware that the state of the process should not be trusted a significant</span>
<span class="sd">    part of memory could have been overwritten before a segfault. This callback</span>
<span class="sd">    is primarily intended to salvage what we need to troubleshoot the error.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span>

  <span class="k">def</span> <span class="nf">_SigSegvHandler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">unused_signal_number</span><span class="p">,</span> <span class="n">unused_stack_frame</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Signal handler for the SIGSEGV signal.</span>

<span class="sd">    Args:</span>
<span class="sd">      signal_number: Numeric representation of the signal.</span>
<span class="sd">      stack_frame: The current stack frame (instance of frame object) or None.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_OnCriticalError</span><span class="p">()</span>

    <span class="c1"># Note that the original SIGSEGV handler can be 0.</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_original_sigsegv_handler</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
      <span class="c1"># Let the original SIGSEGV handler take over.</span>
      <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGSEGV</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_original_sigsegv_handler</span><span class="p">)</span>
      <span class="n">os</span><span class="o">.</span><span class="n">kill</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pid</span><span class="p">,</span> <span class="n">signal</span><span class="o">.</span><span class="n">SIGSEGV</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">_SigTermHandler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">unused_signal_number</span><span class="p">,</span> <span class="n">unused_stack_frame</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Signal handler for the SIGTERM signal.</span>

<span class="sd">    Args:</span>
<span class="sd">      signal_number: Numeric representation of the signal.</span>
<span class="sd">      stack_frame: The current stack frame (instance of frame object) or None.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">SignalAbort</span><span class="p">()</span>

  <span class="k">def</span> <span class="nf">_StartProcessStatusRPCServer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Starts the process status RPC server.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rpc_server</span><span class="p">:</span>
      <span class="k">return</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_rpc_server</span> <span class="o">=</span> <span class="n">xmlrpc</span><span class="o">.</span><span class="n">XMLProcessStatusRPCServer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_GetStatus</span><span class="p">)</span>

    <span class="n">hostname</span> <span class="o">=</span> <span class="s1">u&#39;localhost&#39;</span>

    <span class="c1"># Try the PID as port number first otherwise pick something random</span>
    <span class="c1"># between 1024 and 60000.</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pid</span> <span class="o">&lt;</span> <span class="mi">1024</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pid</span> <span class="o">&gt;</span> <span class="mi">60000</span><span class="p">:</span>
      <span class="n">port</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1024</span><span class="p">,</span> <span class="mi">60000</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">port</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pid</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rpc_server</span><span class="o">.</span><span class="n">Start</span><span class="p">(</span><span class="n">hostname</span><span class="p">,</span> <span class="n">port</span><span class="p">):</span>
      <span class="n">port</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_NUMBER_OF_RPC_SERVER_START_ATTEMPTS</span><span class="p">):</span>
        <span class="n">port</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1024</span><span class="p">,</span> <span class="mi">60000</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rpc_server</span><span class="o">.</span><span class="n">Start</span><span class="p">(</span><span class="n">hostname</span><span class="p">,</span> <span class="n">port</span><span class="p">):</span>
          <span class="k">break</span>

        <span class="n">port</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">port</span><span class="p">:</span>
      <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">((</span>
          <span class="s1">u&#39;Unable to start a process status RPC server for {0!s} &#39;</span>
          <span class="s1">u&#39;(PID: {1:d})&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pid</span><span class="p">))</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_rpc_server</span> <span class="o">=</span> <span class="bp">None</span>
      <span class="k">return</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">rpc_port</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">port</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
        <span class="s1">u&#39;Process: {0!s} process status RPC server started&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">))</span>

  <span class="k">def</span> <span class="nf">_StopProcessStatusRPCServer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Stops the process status RPC server.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rpc_server</span><span class="p">:</span>
      <span class="k">return</span>

    <span class="c1"># Make sure the engine gets one more status update so it knows</span>
    <span class="c1"># the worker has completed.</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_WaitForStatusNotRunning</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_rpc_server</span><span class="o">.</span><span class="n">Stop</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_rpc_server</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">rpc_port</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
        <span class="s1">u&#39;Process: {0!s} process status RPC server stopped&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">))</span>

  <span class="k">def</span> <span class="nf">_WaitForStatusNotRunning</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Waits for the status is running to change to false.&quot;&quot;&quot;</span>
    <span class="c1"># We wait slightly longer than the status check sleep time.</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">2.0</span><span class="p">)</span>
    <span class="n">time_slept</span> <span class="o">=</span> <span class="mf">2.0</span>
    <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">_status_is_running</span><span class="p">:</span>
      <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
      <span class="n">time_slept</span> <span class="o">+=</span> <span class="mf">0.5</span>
      <span class="k">if</span> <span class="n">time_slept</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_PROCESS_JOIN_TIMEOUT</span><span class="p">:</span>
        <span class="k">break</span>

  <span class="nd">@property</span>
  <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The process name.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span>

  <span class="nd">@property</span>
  <span class="k">def</span> <span class="nf">type</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The process type.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_type</span>

  <span class="c1"># This method is part of the multiprocessing.Process interface hence</span>
  <span class="c1"># its name does not follow the style guide.</span>
<div class="viewcode-block" id="MultiProcessBaseProcess.run"><a class="viewcode-back" href="../../../plaso.multi_processing.html#plaso.multi_processing.multi_process.MultiProcessBaseProcess.run">[docs]</a>  <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Runs the process.&quot;&quot;&quot;</span>
    <span class="c1"># Prevent the KeyboardInterrupt being raised inside the process.</span>
    <span class="c1"># This will prevent a process to generate a traceback when interrupted.</span>
    <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGINT</span><span class="p">,</span> <span class="n">signal</span><span class="o">.</span><span class="n">SIG_IGN</span><span class="p">)</span>

    <span class="c1"># A SIGTERM signal handler is necessary to make sure IPC is cleaned up</span>
    <span class="c1"># correctly on terminate.</span>
    <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGTERM</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_SigTermHandler</span><span class="p">)</span>

    <span class="c1"># A SIGSEGV signal handler is necessary to try to indicate where</span>
    <span class="c1"># worker failed.</span>
    <span class="c1"># WARNING the SIGSEGV handler will deadlock the process on a real segfault.</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_enable_sigsegv_handler</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_original_sigsegv_handler</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span>
          <span class="n">signal</span><span class="o">.</span><span class="n">SIGSEGV</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_SigSegvHandler</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_pid</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">()</span>

    <span class="c1"># We need to set the is running status explicitly to True in case</span>
    <span class="c1"># the process completes before the engine is able to determine</span>
    <span class="c1"># the status of the process, e.g. in the unit tests.</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_status_is_running</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
        <span class="s1">u&#39;Process: {0!s} (PID: {1:d}) started&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pid</span><span class="p">))</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_StartProcessStatusRPCServer</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_Main</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_StopProcessStatusRPCServer</span><span class="p">()</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
        <span class="s1">u&#39;Process: {0!s} (PID: {1:d}) stopped&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pid</span><span class="p">))</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_status_is_running</span> <span class="o">=</span> <span class="bp">False</span></div>

  <span class="nd">@abc.abstractmethod</span>
<div class="viewcode-block" id="MultiProcessBaseProcess.SignalAbort"><a class="viewcode-back" href="../../../plaso.multi_processing.html#plaso.multi_processing.multi_process.MultiProcessBaseProcess.SignalAbort">[docs]</a>  <span class="k">def</span> <span class="nf">SignalAbort</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Signals the process to abort.&quot;&quot;&quot;</span></div></div>


<div class="viewcode-block" id="MultiProcessCollectorProcess"><a class="viewcode-back" href="../../../plaso.multi_processing.html#plaso.multi_processing.multi_process.MultiProcessCollectorProcess">[docs]</a><span class="k">class</span> <span class="nc">MultiProcessCollectorProcess</span><span class="p">(</span><span class="n">MultiProcessBaseProcess</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Class that defines a multi-processing collector process.&quot;&quot;&quot;</span>

  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span>
      <span class="bp">self</span><span class="p">,</span> <span class="n">stop_collector_event</span><span class="p">,</span> <span class="n">storage_writer</span><span class="p">,</span> <span class="n">path_spec_queue</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Initializes the process object.</span>

<span class="sd">    Args:</span>
<span class="sd">      stop_collector_event: the stop process event (instance of</span>
<span class="sd">                            multiprocessing.Event). The collector</span>
<span class="sd">                            should exit after this event is set.</span>
<span class="sd">      storage_writer: a storage writer object (instance of StorageWriter).</span>
<span class="sd">      path_spec_queue: the path specification queue object (instance of</span>
<span class="sd">                       MultiProcessingQueue).</span>
<span class="sd">      kwargs: keyword arguments to pass to multiprocessing.Process.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">super</span><span class="p">(</span><span class="n">MultiProcessCollectorProcess</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span>
        <span class="n">definitions</span><span class="o">.</span><span class="n">PROCESS_TYPE_COLLECTOR</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_path_spec_queue</span> <span class="o">=</span> <span class="n">path_spec_queue</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_path_spec_queue_port</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_path_spec_producer</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">PathSpecQueueProducer</span><span class="p">(</span>
        <span class="n">path_spec_queue</span><span class="p">,</span> <span class="n">storage_writer</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_stop_collector_event</span> <span class="o">=</span> <span class="n">stop_collector_event</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_storage_writer</span> <span class="o">=</span> <span class="n">storage_writer</span>

  <span class="k">def</span> <span class="nf">_GetStatus</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns a status dictionary.&quot;&quot;&quot;</span>
    <span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_path_spec_producer</span><span class="o">.</span><span class="n">GetStatus</span><span class="p">()</span>
    <span class="n">status</span><span class="p">[</span><span class="s1">u&#39;path_spec_queue_port&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_path_spec_queue_port</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_status_is_running</span> <span class="o">=</span> <span class="n">status</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">u&#39;is_running&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">status</span>

  <span class="k">def</span> <span class="nf">_Main</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The main loop.&quot;&quot;&quot;</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">u&#39;Collector (PID: {0:d}) started&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pid</span><span class="p">))</span>

    <span class="c1"># The ZeroMQ backed queue must be started first, so we can save its port.</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_path_spec_queue</span><span class="p">,</span> <span class="n">zeromq_queue</span><span class="o">.</span><span class="n">ZeroMQQueue</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_path_spec_queue</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">u&#39;Collector pathspec&#39;</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_path_spec_queue</span><span class="o">.</span><span class="n">Open</span><span class="p">()</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_path_spec_queue_port</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_path_spec_queue</span><span class="o">.</span><span class="n">port</span>

    <span class="c1"># Remove this during phased processing refactor.</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_storage_writer</span><span class="o">.</span><span class="n">Open</span><span class="p">()</span>

    <span class="n">abort</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">u&#39;Collector starting collection.&#39;</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_path_spec_producer</span><span class="o">.</span><span class="n">Run</span><span class="p">()</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exception</span><span class="p">:</span>  <span class="c1"># pylint: disable=broad-except</span>
      <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
          <span class="s1">u&#39;Unhandled exception in collector (PID: {0:d}).&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pid</span><span class="p">))</span>
      <span class="n">logging</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">exception</span><span class="p">)</span>
      <span class="n">abort</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">finally</span><span class="p">:</span>
      <span class="c1"># Remove this during phased processing refactor.</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_storage_writer</span><span class="o">.</span><span class="n">ForceClose</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_path_spec_queue</span><span class="o">.</span><span class="n">Close</span><span class="p">()</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">u&#39;Collector (PID: {0:d}) stopped&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pid</span><span class="p">))</span>

    <span class="c1"># The collector will typically collect the path specifications and</span>
    <span class="c1"># exit. However multiprocessing.Queue will start a separate thread</span>
    <span class="c1"># that blocks on close until every item is read from the queue. This</span>
    <span class="c1"># is necessary since the queue uses a pipe under the hood. However</span>
    <span class="c1"># this behavior causes unwanted side effect for the abort code paths</span>
    <span class="c1"># hence we have the process wait for the stop process event and then</span>
    <span class="c1"># close the queue without the separate blocking thread.</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">abort</span><span class="p">:</span>
      <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">u&#39;Collector waiting for stop event.&#39;</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_stop_collector_event</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_path_spec_queue</span><span class="o">.</span><span class="n">Close</span><span class="p">(</span><span class="n">abort</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<div class="viewcode-block" id="MultiProcessCollectorProcess.SignalAbort"><a class="viewcode-back" href="../../../plaso.multi_processing.html#plaso.multi_processing.multi_process.MultiProcessCollectorProcess.SignalAbort">[docs]</a>  <span class="k">def</span> <span class="nf">SignalAbort</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Signals the process to abort.&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_path_spec_producer</span><span class="o">.</span><span class="n">SignalAbort</span><span class="p">()</span></div></div>


<div class="viewcode-block" id="MultiProcessEngine"><a class="viewcode-back" href="../../../plaso.multi_processing.html#plaso.multi_processing.multi_process.MultiProcessEngine">[docs]</a><span class="k">class</span> <span class="nc">MultiProcessEngine</span><span class="p">(</span><span class="n">engine</span><span class="o">.</span><span class="n">BaseEngine</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Class that defines the multi-process engine.</span>

<span class="sd">  The engine monitors the extraction of events. It monitors:</span>
<span class="sd">  * the current file entry a worker is processing;</span>
<span class="sd">  * the number of events extracted by each worker;</span>
<span class="sd">  * an indicator whether a process is alive or not;</span>
<span class="sd">  * the memory consumption of the processes.</span>
<span class="sd">  &quot;&quot;&quot;</span>

  <span class="n">_PROCESS_ABORT_TIMEOUT</span> <span class="o">=</span> <span class="mf">2.0</span>
  <span class="n">_PROCESS_JOIN_TIMEOUT</span> <span class="o">=</span> <span class="mf">5.0</span>
  <span class="n">_PROCESS_TERMINATION_SLEEP</span> <span class="o">=</span> <span class="mf">0.5</span>

  <span class="n">_QUEUE_START_WAIT</span> <span class="o">=</span> <span class="mf">0.3</span>
  <span class="n">_QUEUE_START_WAIT_ATTEMPTS_MAXIMUM</span> <span class="o">=</span> <span class="mi">3</span>

  <span class="c1"># Note that on average Windows seems to require a bit longer wait</span>
  <span class="c1"># than 5 seconds.</span>
  <span class="n">_RPC_SERVER_TIMEOUT</span> <span class="o">=</span> <span class="mf">8.0</span>
  <span class="n">_MAXIMUM_RPC_ERRORS</span> <span class="o">=</span> <span class="mi">10</span>

  <span class="n">_STATUS_CHECK_SLEEP</span> <span class="o">=</span> <span class="mf">1.5</span>

  <span class="n">_WORKER_PROCESSES_MINIMUM</span> <span class="o">=</span> <span class="mi">2</span>
  <span class="n">_WORKER_PROCESSES_MAXIMUM</span> <span class="o">=</span> <span class="mi">15</span>

  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">maximum_number_of_queued_items</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">use_zeromq</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Initialize the multi-process engine object.</span>

<span class="sd">    Args:</span>
<span class="sd">      maximum_number_of_queued_items: Optional maximum number of queued items.</span>
<span class="sd">                                      The default is 0, which represents</span>
<span class="sd">                                      no limit.</span>
<span class="sd">      use_zeromq: Optional boolean to indicate whether to use ZeroMQ for</span>
<span class="sd">                  queuing. If False, the multiprocessing queue will be used.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_use_zeromq</span> <span class="o">=</span> <span class="n">use_zeromq</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_use_zeromq</span><span class="p">:</span>
      <span class="n">path_spec_outbound_queue</span> <span class="o">=</span> <span class="n">zeromq_queue</span><span class="o">.</span><span class="n">ZeroMQBufferedReplyBindQueue</span><span class="p">(</span>
          <span class="n">delay_open</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">u&#39;Pathspec inbound&#39;</span><span class="p">,</span> <span class="n">buffer_timeout_seconds</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
      <span class="n">path_spec_queue</span> <span class="o">=</span> <span class="n">path_spec_outbound_queue</span>
      <span class="n">event_object_inbound_queue</span> <span class="o">=</span> <span class="n">zeromq_queue</span><span class="o">.</span><span class="n">ZeroMQBufferedPullBindQueue</span><span class="p">(</span>
          <span class="n">delay_open</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">u&#39;Event object inbound&#39;</span><span class="p">,</span> <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span>
          <span class="n">buffer_max_size</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span> <span class="n">linger_seconds</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
      <span class="n">event_object_queue</span> <span class="o">=</span> <span class="n">event_object_inbound_queue</span>
      <span class="n">parse_error_inbound_queue</span> <span class="o">=</span> <span class="n">zeromq_queue</span><span class="o">.</span><span class="n">ZeroMQBufferedPullBindQueue</span><span class="p">(</span>
          <span class="n">delay_open</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">u&#39;Parse error inbound&#39;</span><span class="p">,</span> <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span>
          <span class="n">buffer_max_size</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span> <span class="n">linger_seconds</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
      <span class="n">parse_error_queue</span> <span class="o">=</span> <span class="n">parse_error_inbound_queue</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">path_spec_queue</span> <span class="o">=</span> <span class="n">MultiProcessingQueue</span><span class="p">(</span>
          <span class="n">maximum_number_of_queued_items</span><span class="o">=</span><span class="n">maximum_number_of_queued_items</span><span class="p">)</span>
      <span class="n">event_object_queue</span> <span class="o">=</span> <span class="n">MultiProcessingQueue</span><span class="p">(</span>
          <span class="n">maximum_number_of_queued_items</span><span class="o">=</span><span class="n">maximum_number_of_queued_items</span><span class="p">)</span>
      <span class="n">parse_error_queue</span> <span class="o">=</span> <span class="n">MultiProcessingQueue</span><span class="p">(</span>
          <span class="n">maximum_number_of_queued_items</span><span class="o">=</span><span class="n">maximum_number_of_queued_items</span><span class="p">)</span>

    <span class="nb">super</span><span class="p">(</span><span class="n">MultiProcessEngine</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span>
        <span class="n">path_spec_queue</span><span class="p">,</span> <span class="n">event_object_queue</span><span class="p">,</span> <span class="n">parse_error_queue</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_enable_sigsegv_handler</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_event_object_queue_port</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_extraction_complete_event</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_filter_find_specs</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_filter_object</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_hasher_names_string</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_last_worker_number</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_mount_path</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_number_of_extraction_workers</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_parse_error_queue_port</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_parser_filter_expression</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_path_spec_queue_port</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_process_archive_files</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_process_information_per_pid</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_processes_per_pid</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_rpc_clients_per_pid</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_rpc_errors_per_pid</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_show_memory_usage</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_storage_writer_complete_event</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_stop_collector_event</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_text_prepend</span> <span class="o">=</span> <span class="bp">None</span>

  <span class="k">def</span> <span class="nf">_AbortJoin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Aborts all registered processes by joining with the parent process.</span>

<span class="sd">    Args:</span>
<span class="sd">      timeout: the process join timeout. The default is None meaning no timeout.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">pid</span><span class="p">,</span> <span class="n">process</span> <span class="ow">in</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_processes_per_pid</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
      <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">u&#39;Waiting for process: {0:s} (PID: {1:d}).&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
          <span class="n">process</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">pid</span><span class="p">))</span>
      <span class="n">process</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="n">process</span><span class="o">.</span><span class="n">is_alive</span><span class="p">():</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">u&#39;Process {0:s} (PID: {1:d}) stopped.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">process</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">pid</span><span class="p">))</span>

  <span class="k">def</span> <span class="nf">_AbortKill</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Aborts all registered processes by sending a SIGKILL or equivalent.&quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">pid</span><span class="p">,</span> <span class="n">process</span> <span class="ow">in</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_processes_per_pid</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="n">process</span><span class="o">.</span><span class="n">is_alive</span><span class="p">():</span>
        <span class="k">continue</span>

      <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">u&#39;Killing process: {0:s} (PID: {1:d}).&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
          <span class="n">process</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">pid</span><span class="p">))</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_KillProcess</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">_AbortTerminate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Aborts all registered processes by sending a SIGTERM or equivalent.&quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">pid</span><span class="p">,</span> <span class="n">process</span> <span class="ow">in</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_processes_per_pid</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="n">process</span><span class="o">.</span><span class="n">is_alive</span><span class="p">():</span>
        <span class="k">continue</span>

      <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">u&#39;Terminating process: {0:s} (PID: {1:d}).&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
          <span class="n">process</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">pid</span><span class="p">))</span>
      <span class="n">process</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>

  <span class="k">def</span> <span class="nf">_CheckStatus</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Checks status of the monitored processes.</span>

<span class="sd">    Returns:</span>
<span class="sd">      A boolean indicating whether processing is complete.</span>

<span class="sd">    Raises:</span>
<span class="sd">      EngineAbort: when all the worker are idle.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">pid</span> <span class="ow">in</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_process_information_per_pid</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_CheckProcessStatus</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>

    <span class="n">extraction_completed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_processing_status</span><span class="o">.</span><span class="n">GetExtractionCompleted</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">extraction_completed</span><span class="p">:</span>
      <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">u&#39;Extraction completed.&#39;</span><span class="p">)</span>

    <span class="n">processing_completed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_processing_status</span><span class="o">.</span><span class="n">GetProcessingCompleted</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">processing_completed</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_processing_status</span><span class="o">.</span><span class="n">error_detected</span><span class="p">:</span>
      <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">u&#39;Processing completed.&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_processing_status</span><span class="o">.</span><span class="n">WorkersIdle</span><span class="p">()</span> <span class="ow">and</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_processing_status</span><span class="o">.</span><span class="n">StorageWriterIdle</span><span class="p">()):</span>
      <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">u&#39;Workers idle for too long&#39;</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_processing_status</span><span class="o">.</span><span class="n">error_detected</span> <span class="o">=</span> <span class="bp">True</span>
      <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">EngineAbort</span><span class="p">(</span><span class="s1">u&#39;Workers idle for too long&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">extraction_completed</span><span class="p">,</span> <span class="n">processing_completed</span>

  <span class="k">def</span> <span class="nf">_CheckProcessStatus</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pid</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Check status of a specific monitored process and take action on it.</span>

<span class="sd">    This method examines the status of a process, and then terminates it,</span>
<span class="sd">    signals other processes to terminate or starts a replacement process as</span>
<span class="sd">    appropriate.</span>

<span class="sd">    Args:</span>
<span class="sd">      pid: The process ID (PID).</span>

<span class="sd">    Raises:</span>
<span class="sd">      EngineAbort: when the collector or storage worker process</span>
<span class="sd">                   unexpectedly terminates.</span>
<span class="sd">      KeyError: if the process is not registered with the engine.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># TODO: Refactor this method, simplify and separate concerns (monitoring</span>
    <span class="c1"># vs management).</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_RaiseIfNotRegistered</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>

    <span class="n">process</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_processes_per_pid</span><span class="p">[</span><span class="n">pid</span><span class="p">]</span>

    <span class="n">process_status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_GetProcessStatus</span><span class="p">(</span><span class="n">process</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">process_status</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
      <span class="n">process_is_alive</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">process_is_alive</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">process_status</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_rpc_errors_per_pid</span><span class="p">[</span><span class="n">pid</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="n">status_indicator</span> <span class="o">=</span> <span class="n">process_status</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">u&#39;processing_status&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
      <span class="n">rpc_errors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rpc_errors_per_pid</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_rpc_errors_per_pid</span><span class="p">[</span><span class="n">pid</span><span class="p">]</span> <span class="o">=</span> <span class="n">rpc_errors</span>

      <span class="k">if</span> <span class="n">rpc_errors</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_MAXIMUM_RPC_ERRORS</span><span class="p">:</span>
        <span class="n">process_is_alive</span> <span class="o">=</span> <span class="bp">False</span>

      <span class="k">if</span> <span class="n">process_is_alive</span><span class="p">:</span>
        <span class="n">rpc_port</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">rpc_port</span><span class="o">.</span><span class="n">value</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">((</span>
            <span class="s1">u&#39;Unable to retrieve process: {0:s} (PID: {1:d}) status via &#39;</span>
            <span class="s1">u&#39;RPC socket: http://localhost:{2:d}&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">process</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">rpc_port</span><span class="p">))</span>

        <span class="n">processing_status_string</span> <span class="o">=</span> <span class="s1">u&#39;RPC error&#39;</span>
        <span class="n">status_indicator</span> <span class="o">=</span> <span class="n">definitions</span><span class="o">.</span><span class="n">PROCESSING_STATUS_RUNNING</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">processing_status_string</span> <span class="o">=</span> <span class="s1">u&#39;killed&#39;</span>
        <span class="n">status_indicator</span> <span class="o">=</span> <span class="n">definitions</span><span class="o">.</span><span class="n">PROCESSING_STATUS_KILLED</span>

      <span class="n">process_status</span> <span class="o">=</span> <span class="p">{</span>
          <span class="s1">u&#39;processing_status&#39;</span><span class="p">:</span> <span class="n">processing_status_string</span><span class="p">,</span>
          <span class="s1">u&#39;type&#39;</span><span class="p">:</span> <span class="n">process</span><span class="o">.</span><span class="n">type</span><span class="p">,</span>
      <span class="p">}</span>

    <span class="k">if</span> <span class="n">status_indicator</span> <span class="o">==</span> <span class="n">definitions</span><span class="o">.</span><span class="n">PROCESSING_STATUS_ERROR</span><span class="p">:</span>
      <span class="n">path_spec</span> <span class="o">=</span> <span class="n">process_status</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">u&#39;path_spec&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">path_spec</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_processing_status</span><span class="o">.</span><span class="n">error_path_specs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">path_spec</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_UpdateProcessingStatus</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="n">process_status</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">status_indicator</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span>
        <span class="n">definitions</span><span class="o">.</span><span class="n">PROCESSING_STATUS_COMPLETED</span><span class="p">,</span>
        <span class="n">definitions</span><span class="o">.</span><span class="n">PROCESSING_STATUS_INITIALIZED</span><span class="p">,</span>
        <span class="n">definitions</span><span class="o">.</span><span class="n">PROCESSING_STATUS_RUNNING</span><span class="p">,</span>
        <span class="n">definitions</span><span class="o">.</span><span class="n">PROCESSING_STATUS_PARSING</span><span class="p">,</span>
        <span class="n">definitions</span><span class="o">.</span><span class="n">PROCESSING_STATUS_HASHING</span><span class="p">):</span>

      <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
          <span class="p">(</span><span class="s1">u&#39;Process {0:s} (PID: {1:d}) is not functioning correctly. &#39;</span>
           <span class="s1">u&#39;Status code {2!s}.&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
               <span class="n">process</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">status_indicator</span><span class="p">))</span>

      <span class="bp">self</span><span class="o">.</span><span class="n">_processing_status</span><span class="o">.</span><span class="n">error_detected</span> <span class="o">=</span> <span class="bp">True</span>

      <span class="k">if</span> <span class="n">process</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">definitions</span><span class="o">.</span><span class="n">PROCESS_TYPE_COLLECTOR</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">EngineAbort</span><span class="p">(</span><span class="s1">u&#39;Collector unexpectedly terminated&#39;</span><span class="p">)</span>

      <span class="k">if</span> <span class="n">process</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">definitions</span><span class="o">.</span><span class="n">PROCESS_TYPE_STORAGE_WRITER</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">EngineAbort</span><span class="p">(</span><span class="s1">u&#39;Storage writer unexpectedly terminated&#39;</span><span class="p">)</span>

      <span class="bp">self</span><span class="o">.</span><span class="n">_TerminateProcess</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>

      <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">u&#39;Starting replacement worker process for {0:s}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
          <span class="n">process</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
      <span class="n">worker_process</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_StartExtractionWorkerProcess</span><span class="p">()</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_StartMonitoringProcess</span><span class="p">(</span><span class="n">worker_process</span><span class="o">.</span><span class="n">pid</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">status_indicator</span> <span class="o">==</span> <span class="n">definitions</span><span class="o">.</span><span class="n">PROCESSING_STATUS_COMPLETED</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">process</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">definitions</span><span class="o">.</span><span class="n">PROCESS_TYPE_WORKER</span><span class="p">:</span>
        <span class="n">number_of_events</span> <span class="o">=</span> <span class="n">process_status</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">u&#39;number_of_events&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">number_of_pathspecs</span> <span class="o">=</span> <span class="n">process_status</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s1">u&#39;consumed_number_of_path_specs&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">((</span>
            <span class="s1">u&#39;Process {0:s} (PID: {1:d}) has completed its processing. &#39;</span>
            <span class="s1">u&#39;Total of {2:d} events extracted from {3:d} pathspecs&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">process</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">number_of_events</span><span class="p">,</span> <span class="n">number_of_pathspecs</span><span class="p">))</span>
      <span class="k">elif</span> <span class="n">process</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">definitions</span><span class="o">.</span><span class="n">PROCESS_TYPE_COLLECTOR</span><span class="p">:</span>
        <span class="n">number_of_pathspecs</span> <span class="o">=</span> <span class="n">process_status</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s1">u&#39;produced_number_of_path_specs&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">((</span>
            <span class="s1">u&#39;Process {0:s} (PID: {1:d}) has completed its processing. &#39;</span>
            <span class="s1">u&#39;Total of {2:d} pathspecs extracted&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">process</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">number_of_pathspecs</span><span class="p">))</span>
      <span class="k">elif</span> <span class="n">process</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">definitions</span><span class="o">.</span><span class="n">PROCESS_TYPE_STORAGE_WRITER</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">((</span>
            <span class="s1">u&#39;Process {0:s} (PID: {1:d}) has completed its processing. &#39;</span>
            <span class="s1">u&#39;Total of {2:d} events written&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">process</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">process_status</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">u&#39;number_of_events&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)))</span>

      <span class="bp">self</span><span class="o">.</span><span class="n">_StopMonitoringProcess</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>

    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_show_memory_usage</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_LogMemoryUsage</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">_CloseStorageZeroMQQueues</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Closes all ZeroMQ queues being used by the storage writer.&quot;&quot;&quot;</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">u&#39;Closing ZeroMQ storage queues.&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">port</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_event_object_queue_port</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_error_queue_port</span><span class="p">):</span>
      <span class="n">terminate_queue</span> <span class="o">=</span> <span class="n">zeromq_queue</span><span class="o">.</span><span class="n">ZeroMQPushConnectQueue</span><span class="p">(</span>
          <span class="n">linger_seconds</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="n">port</span><span class="p">,</span> <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">u&#39;Termination&#39;</span><span class="p">)</span>
      <span class="n">terminate_queue</span><span class="o">.</span><span class="n">PushItem</span><span class="p">(</span><span class="n">plaso_queue</span><span class="o">.</span><span class="n">QueueAbort</span><span class="p">(),</span> <span class="n">block</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
      <span class="n">terminate_queue</span><span class="o">.</span><span class="n">Close</span><span class="p">()</span>

  <span class="k">def</span> <span class="nf">_ExtractEventSources</span><span class="p">(</span>
      <span class="bp">self</span><span class="p">,</span> <span class="n">source_path_specs</span><span class="p">,</span> <span class="n">storage_writer</span><span class="p">,</span> <span class="n">filter_find_specs</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
      <span class="n">resolver_context</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Processes the sources and extract event sources.</span>

<span class="sd">    Args:</span>
<span class="sd">      source_path_specs: a list of path specifications (instances of</span>
<span class="sd">                         dfvfs.PathSpec) of the sources to process.</span>
<span class="sd">      resolver_context: resolver context (instance of dfvfs.Context).</span>
<span class="sd">      storage_writer: a storage writer object (instance of StorageWriter).</span>
<span class="sd">      filter_find_specs: optional list of filter find specifications (instances</span>
<span class="sd">                         of dfvfs.FindSpec).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">path_spec_extractor</span> <span class="o">=</span> <span class="n">extractors</span><span class="o">.</span><span class="n">PathSpecExtractor</span><span class="p">(</span><span class="n">resolver_context</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">path_spec</span> <span class="ow">in</span> <span class="n">path_spec_extractor</span><span class="o">.</span><span class="n">ExtractPathSpecs</span><span class="p">(</span>
        <span class="n">source_path_specs</span><span class="p">,</span> <span class="n">find_specs</span><span class="o">=</span><span class="n">filter_find_specs</span><span class="p">):</span>

      <span class="c1"># TODO: determine if event sources should be DataStream or FileEntry</span>
      <span class="c1"># or both.</span>
      <span class="n">event_source</span> <span class="o">=</span> <span class="n">event_sources</span><span class="o">.</span><span class="n">FileEntryEventSource</span><span class="p">(</span><span class="n">path_spec</span><span class="o">=</span><span class="n">path_spec</span><span class="p">)</span>
      <span class="n">storage_writer</span><span class="o">.</span><span class="n">AddEventSource</span><span class="p">(</span><span class="n">event_source</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">_GetPathSpecQueuePort</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">collector_process</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Retrieves the path specification queue port number.</span>

<span class="sd">    Args:</span>
<span class="sd">      collector_process: the collector process object (instance of</span>
<span class="sd">                         MultiProcessCollectorProcess).</span>

<span class="sd">    Returns:</span>
<span class="sd">      An integer containing the path specification queue port number.</span>

<span class="sd">    Raises:</span>
<span class="sd">      RuntimeError: if the collector is not able to start its queue before the</span>
<span class="sd">                    the timeout is reached.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">path_spec_queue_port</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">queue_start_wait_attempts</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">path_spec_queue_port</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span>
           <span class="n">queue_start_wait_attempts</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_QUEUE_START_WAIT_ATTEMPTS_MAXIMUM</span><span class="p">):</span>
      <span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_GetProcessStatus</span><span class="p">(</span><span class="n">collector_process</span><span class="p">)</span>
      <span class="n">path_spec_queue_port</span> <span class="o">=</span> <span class="n">status</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">u&#39;path_spec_queue_port&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

      <span class="n">queue_start_wait_attempts</span> <span class="o">+=</span> <span class="mi">1</span>
      <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_QUEUE_START_WAIT</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">path_spec_queue_port</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">u&#39;Collector queue did not bind in time.&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">path_spec_queue_port</span>

  <span class="k">def</span> <span class="nf">_GetProcessStatus</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">process</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Queries a process to determine its status.</span>

<span class="sd">    Args:</span>
<span class="sd">      process: The handle to the process to query (instance of</span>
<span class="sd">               MultiProcessBaseProcess).</span>

<span class="sd">    Returns:</span>
<span class="sd">      A dictionary containing the process status.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">process_is_alive</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">is_alive</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">process_is_alive</span><span class="p">:</span>
      <span class="n">rpc_client</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rpc_clients_per_pid</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">process</span><span class="o">.</span><span class="n">pid</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
      <span class="n">process_status</span> <span class="o">=</span> <span class="n">rpc_client</span><span class="o">.</span><span class="n">CallFunction</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">process_status</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">return</span> <span class="n">process_status</span>

  <span class="k">def</span> <span class="nf">_GetStorageQueuePorts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">storage_writer_process</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Ensures that port numbers for the storage writer queues are captured.</span>

<span class="sd">    Args:</span>
<span class="sd">      storage_writer_process: the storage writer process object (instance of</span>
<span class="sd">                              MultiProcessStorageWriterProcess).</span>

<span class="sd">    Raises:</span>
<span class="sd">      RuntimeError: if the storage writer process is not able to starts its</span>
<span class="sd">                    queues before the timeout is reached.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">queue_start_wait_attempts</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_StorageQueuesBound</span><span class="p">()</span> <span class="ow">and</span>
           <span class="n">queue_start_wait_attempts</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_QUEUE_START_WAIT_ATTEMPTS_MAXIMUM</span><span class="p">):</span>
      <span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_GetProcessStatus</span><span class="p">(</span><span class="n">storage_writer_process</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_event_object_queue_port</span> <span class="o">=</span> <span class="n">status</span><span class="p">[</span><span class="s1">u&#39;event_object_queue_port&#39;</span><span class="p">]</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_parse_error_queue_port</span> <span class="o">=</span> <span class="n">status</span><span class="p">[</span><span class="s1">u&#39;parse_error_queue_port&#39;</span><span class="p">]</span>
      <span class="n">queue_start_wait_attempts</span> <span class="o">+=</span> <span class="mi">1</span>
      <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_QUEUE_START_WAIT</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_StorageQueuesBound</span><span class="p">():</span>
      <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">u&#39;Storage queues did not bind in time.&#39;</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">_KillProcess</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pid</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Issues a SIGKILL or equivalent to the process.</span>

<span class="sd">    Args:</span>
<span class="sd">      pid: The process identifier.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">u&#39;win&#39;</span><span class="p">):</span>
      <span class="n">process_terminate</span> <span class="o">=</span> <span class="mi">1</span>
      <span class="n">handle</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">windll</span><span class="o">.</span><span class="n">kernel32</span><span class="o">.</span><span class="n">OpenProcess</span><span class="p">(</span>
          <span class="n">process_terminate</span><span class="p">,</span> <span class="bp">False</span><span class="p">,</span> <span class="n">pid</span><span class="p">)</span>
      <span class="n">ctypes</span><span class="o">.</span><span class="n">windll</span><span class="o">.</span><span class="n">kernel32</span><span class="o">.</span><span class="n">TerminateProcess</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
      <span class="n">ctypes</span><span class="o">.</span><span class="n">windll</span><span class="o">.</span><span class="n">kernel32</span><span class="o">.</span><span class="n">CloseHandle</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
      <span class="k">try</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">kill</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="n">signal</span><span class="o">.</span><span class="n">SIGKILL</span><span class="p">)</span>
      <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">exception</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">u&#39;Unable to kill process {0:d} with error: {1:s}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">pid</span><span class="p">,</span> <span class="n">exception</span><span class="p">))</span>

  <span class="k">def</span> <span class="nf">_LogMemoryUsage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pid</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Logs memory information gathered from a process.</span>

<span class="sd">    Args:</span>
<span class="sd">      pid: The process ID (PID).</span>

<span class="sd">    Raises:</span>
<span class="sd">      KeyError: if the process is not registered with the engine.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_RaiseIfNotRegistered</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_RaiseIfNotMonitored</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>

    <span class="n">process</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_processes_per_pid</span><span class="p">[</span><span class="n">pid</span><span class="p">]</span>
    <span class="n">process_information</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_information_per_pid</span><span class="p">[</span><span class="n">pid</span><span class="p">]</span>
    <span class="n">memory_info</span> <span class="o">=</span> <span class="n">process_information</span><span class="o">.</span><span class="n">GetMemoryInformation</span><span class="p">()</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">((</span>
        <span class="s1">u&#39;{0:s} - RSS: {1:d}, VMS: {2:d}, Shared: {3:d}, Text: {4:d}, lib: &#39;</span>
        <span class="s1">u&#39;{5:d}, data: {6:d}, dirty: {7:d}, Memory Percent: {8:0.2f}%&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">process</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">memory_info</span><span class="o">.</span><span class="n">rss</span><span class="p">,</span> <span class="n">memory_info</span><span class="o">.</span><span class="n">vms</span><span class="p">,</span>
            <span class="n">memory_info</span><span class="o">.</span><span class="n">shared</span><span class="p">,</span> <span class="n">memory_info</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="n">memory_info</span><span class="o">.</span><span class="n">lib</span><span class="p">,</span>
            <span class="n">memory_info</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">memory_info</span><span class="o">.</span><span class="n">dirty</span><span class="p">,</span> <span class="n">memory_info</span><span class="o">.</span><span class="n">percent</span> <span class="o">*</span> <span class="mi">100</span><span class="p">))</span>

  <span class="k">def</span> <span class="nf">_RaiseIfNotMonitored</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pid</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Raises if the process is not monitored by the engine.</span>

<span class="sd">    Args:</span>
<span class="sd">      pid: The process identifier.</span>

<span class="sd">    Raises:</span>
<span class="sd">      KeyError: if the process is not monitored by the engine.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">pid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_information_per_pid</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span>
          <span class="s1">u&#39;Process (PID: {0:d}) not monitored by engine.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pid</span><span class="p">))</span>

  <span class="k">def</span> <span class="nf">_RaiseIfNotRegistered</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pid</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Raises if the process is not registered with the engine.</span>

<span class="sd">    Args:</span>
<span class="sd">      pid: The process identifier.</span>

<span class="sd">    Raises:</span>
<span class="sd">      KeyError: if the process is not registered with the engine.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">pid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_processes_per_pid</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span>
          <span class="s1">u&#39;Process (PID: {0:d}) not registered with engine&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pid</span><span class="p">))</span>

  <span class="k">def</span> <span class="nf">_RegisterProcess</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">process</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Registers a process with the engine.</span>

<span class="sd">    Args:</span>
<span class="sd">      process: The process object (instance of MultiProcessBaseProcess).</span>

<span class="sd">    Raises:</span>
<span class="sd">      KeyError: if the process is already registered with the engine.</span>
<span class="sd">      ValueError: if the process object is missing.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">process</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">u&#39;Missing process object.&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">process</span><span class="o">.</span><span class="n">pid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_processes_per_pid</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span>
          <span class="s1">u&#39;Already managing process: {0!s} (PID: {1:d})&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
              <span class="n">process</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">process</span><span class="o">.</span><span class="n">pid</span><span class="p">))</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_processes_per_pid</span><span class="p">[</span><span class="n">process</span><span class="o">.</span><span class="n">pid</span><span class="p">]</span> <span class="o">=</span> <span class="n">process</span>

  <span class="k">def</span> <span class="nf">_StartExtractionWorkerProcess</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Creates, starts and registers an extraction worker process.</span>

<span class="sd">    Returns:</span>
<span class="sd">      An extraction worker process (instance of</span>
<span class="sd">      MultiProcessEventExtractionWorkerProcess).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">process_name</span> <span class="o">=</span> <span class="s1">u&#39;Worker_{0:02d}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_last_worker_number</span><span class="p">)</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_use_zeromq</span><span class="p">:</span>
      <span class="n">path_spec_queue</span> <span class="o">=</span> <span class="n">zeromq_queue</span><span class="o">.</span><span class="n">ZeroMQRequestConnectQueue</span><span class="p">(</span>
          <span class="n">delay_open</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_path_spec_queue_port</span><span class="p">,</span>
          <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
          <span class="n">name</span><span class="o">=</span><span class="s1">u&#39;{0:s} pathspec&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">process_name</span><span class="p">),</span>
          <span class="n">linger_seconds</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
      <span class="c1"># The high water mark is set to 2 for these queues so that data</span>
      <span class="c1"># doesn&#39;t build up in the workers, to prevent data loss in the case</span>
      <span class="c1"># that they crash.</span>
      <span class="n">parse_error_queue</span> <span class="o">=</span> <span class="n">zeromq_queue</span><span class="o">.</span><span class="n">ZeroMQPushConnectQueue</span><span class="p">(</span>
          <span class="n">delay_open</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_parse_error_queue_port</span><span class="p">,</span>
          <span class="n">name</span><span class="o">=</span><span class="s1">u&#39;{0:s} parse error&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">process_name</span><span class="p">),</span>
          <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">maximum_items</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
      <span class="n">event_object_queue</span> <span class="o">=</span> <span class="n">zeromq_queue</span><span class="o">.</span><span class="n">ZeroMQPushConnectQueue</span><span class="p">(</span>
          <span class="n">delay_open</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_event_object_queue_port</span><span class="p">,</span>
          <span class="n">name</span><span class="o">=</span><span class="s1">u&#39;{0:s} event object&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">process_name</span><span class="p">),</span>
          <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">maximum_items</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">parse_error_queue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_error_queue</span>
      <span class="n">path_spec_queue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_path_spec_queue</span>
      <span class="n">event_object_queue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_event_object_queue</span>

    <span class="n">worker_process</span> <span class="o">=</span> <span class="n">MultiProcessEventExtractionWorkerProcess</span><span class="p">(</span>
        <span class="n">path_spec_queue</span><span class="p">,</span> <span class="n">event_object_queue</span><span class="p">,</span>
        <span class="n">parse_error_queue</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">knowledge_base</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_worker_number</span><span class="p">,</span>
        <span class="n">enable_debug_output</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_enable_debug_output</span><span class="p">,</span>
        <span class="n">enable_profiling</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_enable_profiling</span><span class="p">,</span>
        <span class="n">enable_sigsegv_handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_enable_sigsegv_handler</span><span class="p">,</span>
        <span class="n">filter_object</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_filter_object</span><span class="p">,</span>
        <span class="n">hasher_names_string</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_hasher_names_string</span><span class="p">,</span>
        <span class="n">mount_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_mount_path</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">process_name</span><span class="p">,</span>
        <span class="n">parser_filter_expression</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_parser_filter_expression</span><span class="p">,</span>
        <span class="n">process_archive_files</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_process_archive_files</span><span class="p">,</span>
        <span class="n">profiling_sample_rate</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_profiling_sample_rate</span><span class="p">,</span>
        <span class="n">profiling_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_profiling_type</span><span class="p">,</span> <span class="n">text_prepend</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_text_prepend</span><span class="p">)</span>

    <span class="n">worker_process</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_last_worker_number</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_RegisterProcess</span><span class="p">(</span><span class="n">worker_process</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">worker_process</span>

  <span class="k">def</span> <span class="nf">_StopExtractionProcesses</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">abort</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Stops the extraction processes.</span>

<span class="sd">    Args:</span>
<span class="sd">      abort: optional boolean to indicate the stop is issued on abort.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">u&#39;Stopping extraction processes.&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_StopProcessMonitoring</span><span class="p">()</span>
    <span class="c1"># We can stop the collector and storage writer now.</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_stop_collector_event</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_extraction_complete_event</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>

    <span class="c1"># Note that multiprocessing.Queue is very sensitive regarding</span>
    <span class="c1"># blocking on either a get or a put. So we try to prevent using</span>
    <span class="c1"># any blocking behavior.</span>

    <span class="k">if</span> <span class="n">abort</span><span class="p">:</span>
      <span class="c1"># Signal all the processes to abort.</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_AbortTerminate</span><span class="p">()</span>

    <span class="c1"># Wake the processes to make sure that they are not blocking</span>
    <span class="c1"># waiting for the queue not to be full.</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_use_zeromq</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_CloseStorageZeroMQQueues</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">u&#39;Emptying queues.&#39;</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_path_spec_queue</span><span class="o">.</span><span class="n">Empty</span><span class="p">()</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_event_object_queue</span><span class="o">.</span><span class="n">Empty</span><span class="p">()</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_parse_error_queue</span><span class="o">.</span><span class="n">Empty</span><span class="p">()</span>

      <span class="c1"># Wake the processes to make sure that they are not blocking</span>
      <span class="c1"># waiting for new items.</span>
      <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_number_of_extraction_workers</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_path_spec_queue</span><span class="o">.</span><span class="n">PushItem</span><span class="p">(</span><span class="n">plaso_queue</span><span class="o">.</span><span class="n">QueueAbort</span><span class="p">(),</span> <span class="n">block</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_event_object_queue</span><span class="o">.</span><span class="n">PushItem</span><span class="p">(</span><span class="n">plaso_queue</span><span class="o">.</span><span class="n">QueueAbort</span><span class="p">(),</span> <span class="n">block</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

      <span class="c1"># TODO: The following line is commented out as a work around for</span>
      <span class="c1"># infinite blocking wait in storage writer process. Fix this by</span>
      <span class="c1"># using a phased processing approach. For now we remove the parse</span>
      <span class="c1"># error queue from the storage writer.</span>
      <span class="c1"># self._parse_error_queue.PushItem(queue.QueueAbort(), block=False)</span>

    <span class="c1"># Try waiting for the processes to exit normally.</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_AbortJoin</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_PROCESS_JOIN_TIMEOUT</span><span class="p">)</span>

    <span class="c1"># The storage writer process sometimes needs some additional time to</span>
    <span class="c1"># close the storage file.</span>
    <span class="k">while</span> <span class="ow">not</span> <span class="n">abort</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_storage_writer_complete_event</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
      <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">u&#39;Waiting for storage writer to close storage file.&#39;</span><span class="p">)</span>
      <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_STATUS_CHECK_SLEEP</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">abort</span><span class="p">:</span>
      <span class="c1"># Check if the processes are still alive and terminate them if necessary.</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_AbortTerminate</span><span class="p">()</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_AbortJoin</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_PROCESS_JOIN_TIMEOUT</span><span class="p">)</span>

    <span class="c1"># For Multiprocessing queues, set abort to True to stop queue.join_thread()</span>
    <span class="c1"># from blocking.</span>
    <span class="n">extraction_queues</span> <span class="o">=</span> <span class="p">[</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_path_spec_queue</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_event_object_queue</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_parse_error_queue</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">extraction_queue</span> <span class="ow">in</span> <span class="n">extraction_queues</span><span class="p">:</span>
      <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">extraction_queue</span><span class="p">,</span> <span class="n">MultiProcessingQueue</span><span class="p">):</span>
        <span class="n">extraction_queue</span><span class="o">.</span><span class="n">Close</span><span class="p">(</span><span class="n">abort</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">abort</span><span class="p">:</span>
      <span class="c1"># Kill any remaining processes, which can be necessary if</span>
      <span class="c1"># the collector dies.</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_AbortKill</span><span class="p">()</span>

  <span class="k">def</span> <span class="nf">_StopMonitoringProcess</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pid</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Stops monitoring a process.</span>

<span class="sd">    Args:</span>
<span class="sd">      pid: The process identifier.</span>

<span class="sd">    Raises:</span>
<span class="sd">      KeyError: if the process is not registered with the engine or</span>
<span class="sd">                if the process is registered, but not monitored.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_RaiseIfNotRegistered</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_RaiseIfNotMonitored</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>

    <span class="n">process</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_processes_per_pid</span><span class="p">[</span><span class="n">pid</span><span class="p">]</span>
    <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_information_per_pid</span><span class="p">[</span><span class="n">pid</span><span class="p">]</span>

    <span class="n">rpc_client</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rpc_clients_per_pid</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">rpc_client</span><span class="p">:</span>
      <span class="n">rpc_client</span><span class="o">.</span><span class="n">Close</span><span class="p">()</span>
      <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rpc_clients_per_pid</span><span class="p">[</span><span class="n">pid</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">pid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rpc_errors_per_pid</span><span class="p">:</span>
      <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rpc_errors_per_pid</span><span class="p">[</span><span class="n">pid</span><span class="p">]</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">((</span>
        <span class="s1">u&#39;Process: {0:s} (PID: {1:d}) has been removed from the monitoring &#39;</span>
        <span class="s1">u&#39;list.&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">process</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">pid</span><span class="p">))</span>

  <span class="k">def</span> <span class="nf">_StartMonitoringProcess</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pid</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Starts monitoring a process.</span>

<span class="sd">    Args:</span>
<span class="sd">      pid: The process identifier.</span>

<span class="sd">    Raises:</span>
<span class="sd">      KeyError: if the process is not registered with the engine or</span>
<span class="sd">                if the process if the processed is already being monitored.</span>
<span class="sd">      IOError: if the RPC client cannot connect to the server.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_RaiseIfNotRegistered</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">pid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_information_per_pid</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span>
          <span class="s1">u&#39;Process (PID: {0:d}) already in monitoring list.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pid</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">pid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rpc_clients_per_pid</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span>
          <span class="s1">u&#39;RPC client (PID: {0:d}) already exists&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pid</span><span class="p">))</span>

    <span class="n">process</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_processes_per_pid</span><span class="p">[</span><span class="n">pid</span><span class="p">]</span>
    <span class="n">rpc_client</span> <span class="o">=</span> <span class="n">xmlrpc</span><span class="o">.</span><span class="n">XMLProcessStatusRPCClient</span><span class="p">()</span>

    <span class="c1"># Make sure that a process has started its RPC server. RPC port will</span>
    <span class="c1"># be 0 if no server is available.</span>
    <span class="n">rpc_port</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">rpc_port</span><span class="o">.</span><span class="n">value</span>
    <span class="n">time_waited_for_process</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="k">while</span> <span class="ow">not</span> <span class="n">rpc_port</span><span class="p">:</span>
      <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
      <span class="n">rpc_port</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">rpc_port</span><span class="o">.</span><span class="n">value</span>
      <span class="n">time_waited_for_process</span> <span class="o">+=</span> <span class="mf">0.1</span>

      <span class="k">if</span> <span class="n">time_waited_for_process</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_RPC_SERVER_TIMEOUT</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span>
            <span class="s1">u&#39;RPC client unable to determine server (PID: {0:d}) port.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">pid</span><span class="p">))</span>

    <span class="n">hostname</span> <span class="o">=</span> <span class="s1">u&#39;localhost&#39;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">rpc_client</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="n">hostname</span><span class="p">,</span> <span class="n">rpc_port</span><span class="p">):</span>
      <span class="k">raise</span> <span class="ne">IOError</span><span class="p">((</span>
          <span class="s1">u&#39;RPC client unable to connect to server (PID: {0:d}) &#39;</span>
          <span class="s1">u&#39;http://{1:s}:{2:d}&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="n">hostname</span><span class="p">,</span> <span class="n">rpc_port</span><span class="p">))</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_rpc_clients_per_pid</span><span class="p">[</span><span class="n">pid</span><span class="p">]</span> <span class="o">=</span> <span class="n">rpc_client</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_process_information_per_pid</span><span class="p">[</span><span class="n">pid</span><span class="p">]</span> <span class="o">=</span> <span class="n">process_info</span><span class="o">.</span><span class="n">ProcessInfo</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">_StopProcessMonitoring</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Stops monitoring processes.&quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">pid</span> <span class="ow">in</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_process_information_per_pid</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_StopMonitoringProcess</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">_StorageQueuesBound</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Checks if the storage queues are bound to ports.</span>

<span class="sd">    Returns:</span>
<span class="sd">      True if both the event_object queue and the parse_error queues are bound</span>
<span class="sd">      to ports. False otherwise.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_event_object_queue_port</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_parse_error_queue_port</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">_TerminateProcess</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pid</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Terminate a process.</span>

<span class="sd">    Args:</span>
<span class="sd">      pid: The process identifier.</span>

<span class="sd">    Raises:</span>
<span class="sd">      KeyError: if the process is not registered with the engine.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_RaiseIfNotRegistered</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>

    <span class="n">process</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_processes_per_pid</span><span class="p">[</span><span class="n">pid</span><span class="p">]</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">u&#39;Terminating process: (PID: {0:d}).&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pid</span><span class="p">))</span>
    <span class="n">process</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">process</span><span class="o">.</span><span class="n">is_alive</span><span class="p">():</span>
      <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">u&#39;Killing process: (PID: {0:d}).&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pid</span><span class="p">))</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_KillProcess</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_StopMonitoringProcess</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">_UpdateProcessingStatus</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">process_status</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Updates the processing status.</span>

<span class="sd">    Args:</span>
<span class="sd">      pid: The process identifier.</span>
<span class="sd">      process_status: A process status dictionary.</span>

<span class="sd">    Raises:</span>
<span class="sd">      KeyError: if the process is not registered with the engine.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_RaiseIfNotRegistered</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">process_status</span><span class="p">:</span>
      <span class="k">return</span>

    <span class="n">process</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_processes_per_pid</span><span class="p">[</span><span class="n">pid</span><span class="p">]</span>
    <span class="n">process_information</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_information_per_pid</span><span class="p">[</span><span class="n">pid</span><span class="p">]</span>

    <span class="n">process_type</span> <span class="o">=</span> <span class="n">process_status</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">u&#39;type&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
    <span class="n">status_indicator</span> <span class="o">=</span> <span class="n">process_status</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">u&#39;processing_status&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">process_type</span> <span class="o">==</span> <span class="n">definitions</span><span class="o">.</span><span class="n">PROCESS_TYPE_COLLECTOR</span><span class="p">:</span>
      <span class="n">produced_number_of_path_specs</span> <span class="o">=</span> <span class="n">process_status</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
          <span class="s1">u&#39;produced_number_of_path_specs&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

      <span class="bp">self</span><span class="o">.</span><span class="n">_processing_status</span><span class="o">.</span><span class="n">UpdateCollectorStatus</span><span class="p">(</span>
          <span class="n">process</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">produced_number_of_path_specs</span><span class="p">,</span> <span class="n">status_indicator</span><span class="p">,</span>
          <span class="n">process_information</span><span class="o">.</span><span class="n">status</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">process_type</span> <span class="o">==</span> <span class="n">definitions</span><span class="o">.</span><span class="n">PROCESS_TYPE_STORAGE_WRITER</span><span class="p">:</span>
      <span class="n">number_of_events</span> <span class="o">=</span> <span class="n">process_status</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">u&#39;number_of_events&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

      <span class="bp">self</span><span class="o">.</span><span class="n">_processing_status</span><span class="o">.</span><span class="n">UpdateStorageWriterStatus</span><span class="p">(</span>
          <span class="n">process</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">number_of_events</span><span class="p">,</span> <span class="n">status_indicator</span><span class="p">,</span>
          <span class="n">process_information</span><span class="o">.</span><span class="n">status</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">process_type</span> <span class="o">==</span> <span class="n">definitions</span><span class="o">.</span><span class="n">PROCESS_TYPE_WORKER</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_RaiseIfNotMonitored</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>

      <span class="n">consumed_number_of_path_specs</span> <span class="o">=</span> <span class="n">process_status</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
          <span class="s1">u&#39;consumed_number_of_path_specs&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
      <span class="n">display_name</span> <span class="o">=</span> <span class="n">process_status</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">u&#39;display_name&#39;</span><span class="p">,</span> <span class="s1">u&#39;&#39;</span><span class="p">)</span>
      <span class="n">number_of_events</span> <span class="o">=</span> <span class="n">process_status</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">u&#39;number_of_events&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
      <span class="n">produced_number_of_path_specs</span> <span class="o">=</span> <span class="n">process_status</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
          <span class="s1">u&#39;produced_number_of_path_specs&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

      <span class="bp">self</span><span class="o">.</span><span class="n">_processing_status</span><span class="o">.</span><span class="n">UpdateExtractionWorkerStatus</span><span class="p">(</span>
          <span class="n">process</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">display_name</span><span class="p">,</span> <span class="n">number_of_events</span><span class="p">,</span>
          <span class="n">consumed_number_of_path_specs</span><span class="p">,</span> <span class="n">produced_number_of_path_specs</span><span class="p">,</span>
          <span class="n">status_indicator</span><span class="p">,</span> <span class="n">process_information</span><span class="o">.</span><span class="n">status</span><span class="p">)</span>

<div class="viewcode-block" id="MultiProcessEngine.ProcessSources"><a class="viewcode-back" href="../../../plaso.multi_processing.html#plaso.multi_processing.multi_process.MultiProcessEngine.ProcessSources">[docs]</a>  <span class="k">def</span> <span class="nf">ProcessSources</span><span class="p">(</span>
      <span class="bp">self</span><span class="p">,</span> <span class="n">source_path_specs</span><span class="p">,</span> <span class="n">storage_writer</span><span class="p">,</span> <span class="n">preprocess_object</span><span class="p">,</span>
      <span class="n">enable_sigsegv_handler</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">filter_find_specs</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">filter_object</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
      <span class="n">hasher_names_string</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">mount_path</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">number_of_extraction_workers</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
      <span class="n">parser_filter_expression</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">process_archive_files</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
      <span class="n">status_update_callback</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">show_memory_usage</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">text_prepend</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Processes the sources and extract event objects.</span>

<span class="sd">    Args:</span>
<span class="sd">      source_path_specs: list of path specifications (instances of</span>
<span class="sd">                         dfvfs.PathSpec) to process.</span>
<span class="sd">      storage_writer: a storage writer object (instance of BaseStorageWriter).</span>
<span class="sd">      preprocess_object: a preprocess object (instance of PreprocessObject).</span>
<span class="sd">      enable_sigsegv_handler: optional boolean value to indicate the SIGSEGV</span>
<span class="sd">                              handler should be enabled.</span>
<span class="sd">      filter_find_specs: optional list of filter find specifications (instances</span>
<span class="sd">                         of dfvfs.FindSpec).</span>
<span class="sd">      filter_object: optional filter object (instance of objectfilter.Filter).</span>
<span class="sd">      hasher_names_string: optional comma separated string of names of</span>
<span class="sd">                           hashers to enable enable.</span>
<span class="sd">      mount_path: optional string containing the mount path. The default</span>
<span class="sd">                  is None.</span>
<span class="sd">      number_of_extraction_workers: optional number of extraction worker</span>
<span class="sd">                                    processes. The default is 0 which means</span>
<span class="sd">                                    the function will determine the suitable</span>
<span class="sd">                                    number.</span>
<span class="sd">      parser_filter_expression: optional string containing the parser filter</span>
<span class="sd">                                expression, where None represents all parsers</span>
<span class="sd">                                and plugins.</span>
<span class="sd">      process_archive_files: optional boolean value to indicate if the worker</span>
<span class="sd">                             should scan for file entries inside files.</span>
<span class="sd">      status_update_callback: optional callback function for status updates.</span>
<span class="sd">      show_memory_usage: optional boolean value to indicate memory information</span>
<span class="sd">                         should be included in logging.</span>
<span class="sd">      text_prepend: optional string that contains the text to prepend to every</span>
<span class="sd">                    event object.</span>

<span class="sd">    Returns:</span>
<span class="sd">      The processing status (instance of ProcessingStatus).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">number_of_extraction_workers</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
      <span class="c1"># One worker for each &quot;available&quot; CPU (minus other processes).</span>
      <span class="c1"># The number here is derived from the fact that the engine starts up:</span>
      <span class="c1"># * A collector process.</span>
      <span class="c1"># * A storage process.</span>
      <span class="c1">#</span>
      <span class="c1"># If we want to utilize all CPUs on the system we therefore need to start</span>
      <span class="c1"># up workers that amounts to the total number of CPUs - the other</span>
      <span class="c1"># processes.</span>
      <span class="n">cpu_count</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span> <span class="o">-</span> <span class="mi">2</span>

      <span class="k">if</span> <span class="n">cpu_count</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_WORKER_PROCESSES_MINIMUM</span><span class="p">:</span>
        <span class="n">cpu_count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_WORKER_PROCESSES_MINIMUM</span>

      <span class="k">elif</span> <span class="n">cpu_count</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_WORKER_PROCESSES_MAXIMUM</span><span class="p">:</span>
        <span class="n">cpu_count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_WORKER_PROCESSES_MAXIMUM</span>

      <span class="n">number_of_extraction_workers</span> <span class="o">=</span> <span class="n">cpu_count</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_enable_sigsegv_handler</span> <span class="o">=</span> <span class="n">enable_sigsegv_handler</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_number_of_extraction_workers</span> <span class="o">=</span> <span class="n">number_of_extraction_workers</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_show_memory_usage</span> <span class="o">=</span> <span class="n">show_memory_usage</span>

    <span class="c1"># Keep track of certain values so we can spawn new extraction workers.</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_filter_find_specs</span> <span class="o">=</span> <span class="n">filter_find_specs</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_filter_object</span> <span class="o">=</span> <span class="n">filter_object</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_hasher_names_string</span> <span class="o">=</span> <span class="n">hasher_names_string</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_mount_path</span> <span class="o">=</span> <span class="n">mount_path</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_parser_filter_expression</span> <span class="o">=</span> <span class="n">parser_filter_expression</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_process_archive_files</span> <span class="o">=</span> <span class="n">process_archive_files</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_text_prepend</span> <span class="o">=</span> <span class="n">text_prepend</span>

    <span class="n">resolver_context</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">Context</span><span class="p">()</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">u&#39;Starting processes.&#39;</span><span class="p">)</span>

    <span class="c1"># TODO: pass status update callback.</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_ExtractEventSources</span><span class="p">(</span>
        <span class="n">source_path_specs</span><span class="p">,</span> <span class="n">storage_writer</span><span class="p">,</span> <span class="n">filter_find_specs</span><span class="o">=</span><span class="n">filter_find_specs</span><span class="p">,</span>
        <span class="n">resolver_context</span><span class="o">=</span><span class="n">resolver_context</span><span class="p">)</span>

    <span class="c1"># TODO: closing the storage writer here for now to make sure it re-opens</span>
    <span class="c1"># in another process. Remove this during phased processing refactor.</span>
    <span class="n">storage_writer</span><span class="o">.</span><span class="n">ForceClose</span><span class="p">()</span>

    <span class="c1"># Start the storage writer first, as we need it to start up and bind its</span>
    <span class="c1"># queues to ports before we can start the workers.</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_extraction_complete_event</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_storage_writer_complete_event</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_use_zeromq</span><span class="p">:</span>
      <span class="n">parse_error_queue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_error_queue</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="c1"># TODO: This is a work around for infinite blocking wait in storage</span>
      <span class="c1"># writer process. Fix this by using a phased processing approach.</span>
      <span class="c1"># For now we remove the parse error queue from the storage writer.</span>
      <span class="n">parse_error_queue</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="n">storage_writer_process</span> <span class="o">=</span> <span class="n">MultiProcessStorageWriterProcess</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_event_object_queue</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extraction_complete_event</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_storage_writer_complete_event</span><span class="p">,</span> <span class="n">parse_error_queue</span><span class="p">,</span>
        <span class="n">storage_writer</span><span class="p">,</span> <span class="n">preprocess_object</span><span class="p">,</span>
        <span class="n">enable_sigsegv_handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_enable_sigsegv_handler</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">u&#39;StorageWriter&#39;</span><span class="p">)</span>
    <span class="n">storage_writer_process</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_RegisterProcess</span><span class="p">(</span><span class="n">storage_writer_process</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_StartMonitoringProcess</span><span class="p">(</span><span class="n">storage_writer_process</span><span class="o">.</span><span class="n">pid</span><span class="p">)</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_use_zeromq</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_GetStorageQueuePorts</span><span class="p">(</span><span class="n">storage_writer_process</span><span class="p">)</span>

    <span class="c1"># Next start the collector, as we needs its port number for the workers as</span>
    <span class="c1"># well.</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_stop_collector_event</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>
    <span class="n">collector_process</span> <span class="o">=</span> <span class="n">MultiProcessCollectorProcess</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stop_collector_event</span><span class="p">,</span> <span class="n">storage_writer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_path_spec_queue</span><span class="p">,</span>
        <span class="n">enable_sigsegv_handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_enable_sigsegv_handler</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">u&#39;Collector&#39;</span><span class="p">)</span>
    <span class="n">collector_process</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_RegisterProcess</span><span class="p">(</span><span class="n">collector_process</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_StartMonitoringProcess</span><span class="p">(</span><span class="n">collector_process</span><span class="o">.</span><span class="n">pid</span><span class="p">)</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_use_zeromq</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_path_spec_queue_port</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_GetPathSpecQueuePort</span><span class="p">(</span>
          <span class="n">collector_process</span><span class="p">)</span>

    <span class="c1"># Finally, start the workers.</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">number_of_extraction_workers</span><span class="p">):</span>
      <span class="n">extraction_process</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_StartExtractionWorkerProcess</span><span class="p">()</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_StartMonitoringProcess</span><span class="p">(</span><span class="n">extraction_process</span><span class="o">.</span><span class="n">pid</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
      <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">u&#39;Processing started.&#39;</span><span class="p">)</span>

      <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_STATUS_CHECK_SLEEP</span><span class="p">)</span>
      <span class="n">extraction_completed</span><span class="p">,</span> <span class="n">processing_completed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_CheckStatus</span><span class="p">()</span>
      <span class="k">while</span> <span class="ow">not</span> <span class="n">processing_completed</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">status_update_callback</span><span class="p">:</span>
          <span class="n">status_update_callback</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_processing_status</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">extraction_completed</span><span class="p">:</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">_extraction_complete_event</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>

        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_STATUS_CHECK_SLEEP</span><span class="p">)</span>
        <span class="n">extraction_completed</span><span class="p">,</span> <span class="n">processing_completed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_CheckStatus</span><span class="p">()</span>

      <span class="c1"># If the storage writer finishes writing very soon after the workers,</span>
      <span class="c1"># we may not set the event before the storage writer finishes, so set it</span>
      <span class="c1"># explicitly here.</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_extraction_complete_event</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>

      <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">u&#39;Processing stopped.&#39;</span><span class="p">)</span>

    <span class="k">except</span> <span class="n">errors</span><span class="o">.</span><span class="n">EngineAbort</span> <span class="k">as</span> <span class="n">exception</span><span class="p">:</span>
      <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
          <span class="s1">u&#39;Processing aborted with engine error: {0:s}.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">exception</span><span class="p">))</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exception</span><span class="p">:</span>  <span class="c1"># pylint: disable=broad-except</span>
      <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
          <span class="s1">u&#39;Processing aborted with error: {0:s}.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">exception</span><span class="p">))</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_processing_status</span><span class="o">.</span><span class="n">error_detected</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_StopExtractionProcesses</span><span class="p">(</span><span class="n">abort</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_processing_status</span><span class="o">.</span><span class="n">error_detected</span><span class="p">)</span>

    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_processing_status</span></div>

<div class="viewcode-block" id="MultiProcessEngine.SignalAbort"><a class="viewcode-back" href="../../../plaso.multi_processing.html#plaso.multi_processing.multi_process.MultiProcessEngine.SignalAbort">[docs]</a>  <span class="k">def</span> <span class="nf">SignalAbort</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Signals the engine to abort.&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_StopExtractionProcesses</span><span class="p">(</span><span class="n">abort</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_AbortKill</span><span class="p">()</span>

      <span class="c1"># The abort can leave the main process unresponsive</span>
      <span class="c1"># due to incorrectly finalized IPC.</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_KillProcess</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">())</span></div></div>


<div class="viewcode-block" id="MultiProcessEventExtractionWorkerProcess"><a class="viewcode-back" href="../../../plaso.multi_processing.html#plaso.multi_processing.multi_process.MultiProcessEventExtractionWorkerProcess">[docs]</a><span class="k">class</span> <span class="nc">MultiProcessEventExtractionWorkerProcess</span><span class="p">(</span><span class="n">MultiProcessBaseProcess</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Class that defines a multi-processing event extraction worker process.&quot;&quot;&quot;</span>

  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span>
      <span class="bp">self</span><span class="p">,</span> <span class="n">path_spec_queue</span><span class="p">,</span> <span class="n">event_object_queue</span><span class="p">,</span> <span class="n">parse_error_queue</span><span class="p">,</span>
      <span class="n">knowledge_base</span><span class="p">,</span> <span class="n">worker_number</span><span class="p">,</span> <span class="n">enable_debug_output</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
      <span class="n">enable_profiling</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">filter_object</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">hasher_names_string</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
      <span class="n">mount_path</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">parser_filter_expression</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
      <span class="n">process_archive_files</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">profiling_sample_rate</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
      <span class="n">profiling_type</span><span class="o">=</span><span class="s1">u&#39;all&#39;</span><span class="p">,</span> <span class="n">text_prepend</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Initializes the process object.</span>

<span class="sd">    Args:</span>
<span class="sd">      path_spec_queue: the path specification queue object (instance of</span>
<span class="sd">                       MultiProcessingQueue).</span>
<span class="sd">      event_object_queue: the event object queue object (instance of</span>
<span class="sd">                          MultiProcessingQueue).</span>
<span class="sd">      parse_error_queue: the parser error queue object (instance of</span>
<span class="sd">                         MultiProcessingQueue).</span>
<span class="sd">      knowledge_base: a knowledge base object (instance of KnowledgeBase),</span>
<span class="sd">                      which contains information from the source data needed</span>
<span class="sd">                      for parsing.</span>
<span class="sd">      worker_number: a number that identifies the worker.</span>
<span class="sd">      enable_debug_output: optional boolean value to indicate if the debug</span>
<span class="sd">                           output should be enabled.</span>
<span class="sd">      enable_profiling: optional boolean value to indicate if profiling should</span>
<span class="sd">                        be enabled.</span>
<span class="sd">      filter_object: optional filter object (instance of objectfilter.Filter).</span>
<span class="sd">      hasher_names_string: optional comma separated string of names of</span>
<span class="sd">                           hashers to enable enable.</span>
<span class="sd">      mount_path: optional string containing the mount path. The default</span>
<span class="sd">                  is None.</span>
<span class="sd">      parser_filter_expression: optional string containing the parser filter</span>
<span class="sd">                                expression, where None represents all parsers</span>
<span class="sd">                                and plugins.</span>
<span class="sd">      process_archive_files: optional boolean value to indicate if the worker</span>
<span class="sd">                             should scan for file entries inside files.</span>
<span class="sd">      profiling_sample_rate: optional integer indicating the profiling sample</span>
<span class="sd">                             rate. The value contains the number of files</span>
<span class="sd">                             processed. The default value is 1000.</span>
<span class="sd">      profiling_type: optional profiling type.</span>
<span class="sd">      text_prepend: optional string that contains the text to prepend to every</span>
<span class="sd">                    event object.</span>
<span class="sd">      kwargs: keyword arguments to pass to multiprocessing.Process.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">super</span><span class="p">(</span><span class="n">MultiProcessEventExtractionWorkerProcess</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span>
        <span class="n">definitions</span><span class="o">.</span><span class="n">PROCESS_TYPE_WORKER</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_critical_error</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_enable_debug_output</span> <span class="o">=</span> <span class="n">enable_debug_output</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_event_object_queue</span> <span class="o">=</span> <span class="n">event_object_queue</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_event_queue_producer</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_extraction_worker</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_knowledge_base</span> <span class="o">=</span> <span class="n">knowledge_base</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_parse_error_queue</span> <span class="o">=</span> <span class="n">parse_error_queue</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_path_spec_queue</span> <span class="o">=</span> <span class="n">path_spec_queue</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_parse_error_queue_producer</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_worker_number</span> <span class="o">=</span> <span class="n">worker_number</span>

    <span class="c1"># Attributes for profiling.</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_enable_profiling</span> <span class="o">=</span> <span class="n">enable_profiling</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_profiling_sample_rate</span> <span class="o">=</span> <span class="n">profiling_sample_rate</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_profiling_type</span> <span class="o">=</span> <span class="n">profiling_type</span>

    <span class="c1"># TODO: clean this up with the implementation of a task based</span>
    <span class="c1"># multi-processing approach.</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_filter_object</span> <span class="o">=</span> <span class="n">filter_object</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_hasher_names_string</span> <span class="o">=</span> <span class="n">hasher_names_string</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_mount_path</span> <span class="o">=</span> <span class="n">mount_path</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_process_archive_files</span> <span class="o">=</span> <span class="n">process_archive_files</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_parser_filter_expression</span> <span class="o">=</span> <span class="n">parser_filter_expression</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_text_prepend</span> <span class="o">=</span> <span class="n">text_prepend</span>

  <span class="k">def</span> <span class="nf">_GetStatus</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns a status dictionary.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extraction_worker</span><span class="p">:</span>
      <span class="n">status</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extraction_worker</span><span class="o">.</span><span class="n">GetStatus</span><span class="p">()</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_critical_error</span><span class="p">:</span>
      <span class="c1"># Note seem unable to pass objects here.</span>
      <span class="n">current_path_spec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extraction_worker</span><span class="o">.</span><span class="n">current_path_spec</span>
      <span class="n">status</span><span class="p">[</span><span class="s1">u&#39;path_spec&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">current_path_spec</span><span class="o">.</span><span class="n">comparable</span>
      <span class="n">status</span><span class="p">[</span><span class="s1">u&#39;processing_status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">definitions</span><span class="o">.</span><span class="n">PROCESSING_STATUS_ERROR</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_status_is_running</span> <span class="o">=</span> <span class="n">status</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">u&#39;is_running&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">status</span>

  <span class="k">def</span> <span class="nf">_Main</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The main loop.&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_event_queue_producer</span> <span class="o">=</span> <span class="n">plaso_queue</span><span class="o">.</span><span class="n">ItemQueueProducer</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_event_object_queue</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_parse_error_queue_producer</span> <span class="o">=</span> <span class="n">plaso_queue</span><span class="o">.</span><span class="n">ItemQueueProducer</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_parse_error_queue</span><span class="p">)</span>

    <span class="n">parser_mediator</span> <span class="o">=</span> <span class="n">parsers_mediator</span><span class="o">.</span><span class="n">ParserMediator</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_event_queue_producer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_error_queue_producer</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_knowledge_base</span><span class="p">)</span>

    <span class="c1"># We need a resolver context per process to prevent multi processing</span>
    <span class="c1"># issues with file objects stored in images.</span>
    <span class="n">resolver_context</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">Context</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_extraction_worker</span> <span class="o">=</span> <span class="n">worker</span><span class="o">.</span><span class="n">BaseEventExtractionWorker</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_worker_number</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_path_spec_queue</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_event_queue_producer</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_parse_error_queue_producer</span><span class="p">,</span> <span class="n">parser_mediator</span><span class="p">,</span>
        <span class="n">resolver_context</span><span class="o">=</span><span class="n">resolver_context</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_extraction_worker</span><span class="o">.</span><span class="n">SetEnableProfiling</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_enable_profiling</span><span class="p">,</span>
        <span class="n">profiling_sample_rate</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_profiling_sample_rate</span><span class="p">,</span>
        <span class="n">profiling_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_profiling_type</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_extraction_worker</span><span class="o">.</span><span class="n">SetProcessArchiveFiles</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_process_archive_files</span><span class="p">)</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filter_object</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_extraction_worker</span><span class="o">.</span><span class="n">SetFilterObject</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_filter_object</span><span class="p">)</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mount_path</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_extraction_worker</span><span class="o">.</span><span class="n">SetMountPath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_mount_path</span><span class="p">)</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_text_prepend</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_extraction_worker</span><span class="o">.</span><span class="n">SetTextPrepend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_text_prepend</span><span class="p">)</span>

    <span class="c1"># We need to initialize the parser and hasher objects after the process</span>
    <span class="c1"># has forked otherwise on Windows the &quot;fork&quot; will fail with</span>
    <span class="c1"># a PickleError for Python modules that cannot be pickled.</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_extraction_worker</span><span class="o">.</span><span class="n">InitializeParserObjects</span><span class="p">(</span>
        <span class="n">parser_filter_expression</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_parser_filter_expression</span><span class="p">)</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hasher_names_string</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_extraction_worker</span><span class="o">.</span><span class="n">SetHashers</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_hasher_names_string</span><span class="p">)</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">u&#39;Extraction worker: {0!s} (PID: {1:d}) started&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pid</span><span class="p">))</span>

    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_extraction_worker</span><span class="o">.</span><span class="n">Run</span><span class="p">()</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exception</span><span class="p">:</span>  <span class="c1"># pylint: disable=broad-except</span>
      <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">((</span>
          <span class="s1">u&#39;Unhandled exception in extraction worker {0!s} &#39;</span>
          <span class="s1">u&#39;(PID: {1:d}).&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pid</span><span class="p">))</span>
      <span class="n">logging</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">exception</span><span class="p">)</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">u&#39;Extraction worker: {0!s} (PID: {1:d}) stopped&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pid</span><span class="p">))</span>

    <span class="n">worker_queues</span> <span class="o">=</span> <span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_path_spec_queue</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_event_object_queue</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_parse_error_queue</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">worker_queue</span> <span class="ow">in</span> <span class="n">worker_queues</span><span class="p">:</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">worker_queue</span><span class="p">,</span> <span class="n">MultiProcessingQueue</span><span class="p">):</span>
        <span class="n">worker_queue</span><span class="o">.</span><span class="n">Close</span><span class="p">()</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">worker_queue</span><span class="o">.</span><span class="n">Close</span><span class="p">(</span><span class="n">abort</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">_OnCriticalError</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The process on critical error handler.&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_critical_error</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_WaitForStatusNotRunning</span><span class="p">()</span>

<div class="viewcode-block" id="MultiProcessEventExtractionWorkerProcess.SignalAbort"><a class="viewcode-back" href="../../../plaso.multi_processing.html#plaso.multi_processing.multi_process.MultiProcessEventExtractionWorkerProcess.SignalAbort">[docs]</a>  <span class="k">def</span> <span class="nf">SignalAbort</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Signals the process to abort.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_event_queue_producer</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_event_queue_producer</span><span class="o">.</span><span class="n">SignalAbort</span><span class="p">()</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_error_queue_producer</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_parse_error_queue_producer</span><span class="o">.</span><span class="n">SignalAbort</span><span class="p">()</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extraction_worker</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_extraction_worker</span><span class="o">.</span><span class="n">SignalAbort</span><span class="p">()</span></div></div>


<div class="viewcode-block" id="MultiProcessStorageWriterProcess"><a class="viewcode-back" href="../../../plaso.multi_processing.html#plaso.multi_processing.multi_process.MultiProcessStorageWriterProcess">[docs]</a><span class="k">class</span> <span class="nc">MultiProcessStorageWriterProcess</span><span class="p">(</span><span class="n">MultiProcessBaseProcess</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Class that defines a multi-processing storage writer process.&quot;&quot;&quot;</span>

  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span>
      <span class="bp">self</span><span class="p">,</span> <span class="n">event_object_queue</span><span class="p">,</span> <span class="n">extraction_complete_event</span><span class="p">,</span>
      <span class="n">storage_writer_complete_event</span><span class="p">,</span> <span class="n">parse_error_queue</span><span class="p">,</span> <span class="n">storage_writer</span><span class="p">,</span>
      <span class="n">preprocess_object</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Initializes the process object.</span>

<span class="sd">    Args:</span>
<span class="sd">      event_object_queue: the event object queue object (instance of</span>
<span class="sd">                          MultiProcessingQueue).</span>
<span class="sd">      extraction_complete_event: a multi processing event (instance of</span>
<span class="sd">                                 multiprocessing.Event) that, when set,</span>
<span class="sd">                                 indicates that extraction is complete.</span>
<span class="sd">      storage_writer_complete_event: a multi processing event (instance of</span>
<span class="sd">                                     multiprocessing.Event) that, when set,</span>
<span class="sd">                                     indicates that the storage writer is</span>
<span class="sd">                                     complete.</span>
<span class="sd">      parse_error_queue: the parser error queue object (instance of Queue).</span>
<span class="sd">      storage_writer: a storage writer object (instance of BaseStorageWriter).</span>
<span class="sd">      preprocess_object: a preprocess object (instance of PreprocessObject).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">super</span><span class="p">(</span><span class="n">MultiProcessStorageWriterProcess</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span>
        <span class="n">definitions</span><span class="o">.</span><span class="n">PROCESS_TYPE_STORAGE_WRITER</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_extraction_complete_event</span> <span class="o">=</span> <span class="n">extraction_complete_event</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_event_object_consumer</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">EventObjectQueueConsumer</span><span class="p">(</span>
        <span class="n">event_object_queue</span><span class="p">,</span> <span class="n">storage_writer</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_event_object_queue</span> <span class="o">=</span> <span class="n">event_object_queue</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_event_object_queue_port</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_parse_error_queue</span> <span class="o">=</span> <span class="n">parse_error_queue</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_parse_error_queue_port</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_preprocess_object</span> <span class="o">=</span> <span class="n">preprocess_object</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_storage_writer</span> <span class="o">=</span> <span class="n">storage_writer</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_storage_writer_complete_event</span> <span class="o">=</span> <span class="n">storage_writer_complete_event</span>

  <span class="k">def</span> <span class="nf">_GetStatus</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns a status dictionary.&quot;&quot;&quot;</span>
    <span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_event_object_consumer</span><span class="o">.</span><span class="n">GetStatus</span><span class="p">()</span>
    <span class="n">status</span><span class="p">[</span><span class="s1">u&#39;event_object_queue_port&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_event_object_queue_port</span>
    <span class="n">status</span><span class="p">[</span><span class="s1">u&#39;parse_error_queue_port&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_error_queue_port</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_status_is_running</span> <span class="o">=</span> <span class="n">status</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">u&#39;is_running&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">status</span>

  <span class="k">def</span> <span class="nf">_Main</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The main loop.&quot;&quot;&quot;</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">u&#39;Storage writer (PID: {0:d}) started.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pid</span><span class="p">))</span>

    <span class="n">event_queue_is_zeromq</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_event_object_queue</span><span class="p">,</span> <span class="n">zeromq_queue</span><span class="o">.</span><span class="n">ZeroMQQueue</span><span class="p">)</span>
    <span class="n">error_queue_is_zeromq</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_parse_error_queue</span><span class="p">,</span> <span class="n">zeromq_queue</span><span class="o">.</span><span class="n">ZeroMQQueue</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">event_queue_is_zeromq</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_event_object_queue</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">u&#39;Storage writer event&#39;</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_event_object_queue</span><span class="o">.</span><span class="n">Open</span><span class="p">()</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_event_object_queue_port</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_event_object_queue</span><span class="o">.</span><span class="n">port</span>

    <span class="k">if</span> <span class="n">error_queue_is_zeromq</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_parse_error_queue</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">u&#39;Storage writer error&#39;</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_parse_error_queue</span><span class="o">.</span><span class="n">Open</span><span class="p">()</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_parse_error_queue_port</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_error_queue</span><span class="o">.</span><span class="n">port</span>

    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_storage_writer</span><span class="o">.</span><span class="n">Open</span><span class="p">()</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_event_object_consumer</span><span class="o">.</span><span class="n">Run</span><span class="p">()</span>
      <span class="k">while</span> <span class="p">(</span><span class="n">event_queue_is_zeromq</span> <span class="ow">and</span>
             <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extraction_complete_event</span><span class="o">.</span><span class="n">is_set</span><span class="p">()):</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s1">u&#39;Storage writer event queue stalled - restarting and waiting for &#39;</span>
            <span class="s1">u&#39;extraction to complete.&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_event_object_consumer</span><span class="o">.</span><span class="n">Run</span><span class="p">()</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exception</span><span class="p">:</span>  <span class="c1"># pylint: disable=broad-except</span>
      <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
          <span class="s1">u&#39;Unhandled exception in storage writer (PID: {0:d}).&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
              <span class="bp">self</span><span class="o">.</span><span class="n">_pid</span><span class="p">))</span>
      <span class="n">logging</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">exception</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_event_object_consumer</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_storage_writer</span><span class="o">.</span><span class="n">WritePreprocessObject</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_preprocess_object</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_storage_writer</span><span class="o">.</span><span class="n">WriteSessionCompletion</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_storage_writer</span><span class="o">.</span><span class="n">Close</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_storage_writer</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="c1"># Set the storage writer completion event to indicate that it is complete</span>
    <span class="c1"># and the process can be terminated.</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_storage_writer_complete_event</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_event_object_queue</span><span class="o">.</span><span class="n">Close</span><span class="p">()</span>

    <span class="c1"># TODO: This is a work around for infinite blocking wait in storage</span>
    <span class="c1"># writer process. Fix this by using a phased processing approach.</span>
    <span class="c1"># For now we remove the parse error queue from the storage writer.</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_error_queue</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_parse_error_queue</span><span class="o">.</span><span class="n">Close</span><span class="p">()</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">u&#39;Storage writer (PID: {0:d}) stopped.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pid</span><span class="p">))</span>

<div class="viewcode-block" id="MultiProcessStorageWriterProcess.SignalAbort"><a class="viewcode-back" href="../../../plaso.multi_processing.html#plaso.multi_processing.multi_process.MultiProcessStorageWriterProcess.SignalAbort">[docs]</a>  <span class="k">def</span> <span class="nf">SignalAbort</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Signals the process to abort.&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_event_object_consumer</span><span class="o">.</span><span class="n">SignalAbort</span><span class="p">()</span></div></div>


<div class="viewcode-block" id="MultiProcessingQueue"><a class="viewcode-back" href="../../../plaso.multi_processing.html#plaso.multi_processing.multi_process.MultiProcessingQueue">[docs]</a><span class="k">class</span> <span class="nc">MultiProcessingQueue</span><span class="p">(</span><span class="n">plaso_queue</span><span class="o">.</span><span class="n">Queue</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Class that defines the multi-processing queue.&quot;&quot;&quot;</span>

  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">maximum_number_of_queued_items</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Initializes the multi-processing queue object.</span>

<span class="sd">    Args:</span>
<span class="sd">      maximum_number_of_queued_items: The maximum number of queued items.</span>
<span class="sd">                                      The default is 0, which represents</span>
<span class="sd">                                      no limit.</span>
<span class="sd">      timeout: Optional floating point number of seconds for the get to</span>
<span class="sd">               time out. The default is None, which means the get will</span>
<span class="sd">               block until a new item is put onto the queue.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">super</span><span class="p">(</span><span class="n">MultiProcessingQueue</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_timeout</span> <span class="o">=</span> <span class="n">timeout</span>

    <span class="c1"># maxsize contains the maximum number of items allowed to be queued,</span>
    <span class="c1"># where 0 represents unlimited.</span>

    <span class="c1"># We need to check that we aren&#39;t asking for a bigger queue than the</span>
    <span class="c1"># platform supports, which requires access to this protected member.</span>
    <span class="c1"># pylint: disable=protected-access</span>
    <span class="n">queue_max_length</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">_multiprocessing</span><span class="o">.</span><span class="n">SemLock</span><span class="o">.</span><span class="n">SEM_VALUE_MAX</span>
    <span class="c1"># pylint: enable=protected-access</span>

    <span class="k">if</span> <span class="n">maximum_number_of_queued_items</span> <span class="o">&gt;</span> <span class="n">queue_max_length</span><span class="p">:</span>
      <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">((</span>
          <span class="s1">u&#39;Requested maximum queue size: {0:d} is larger than the maximum &#39;</span>
          <span class="s1">u&#39;size supported by the system. Defaulting to: {1:d}&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
              <span class="n">maximum_number_of_queued_items</span><span class="p">,</span> <span class="n">queue_max_length</span><span class="p">))</span>
      <span class="n">maximum_number_of_queued_items</span> <span class="o">=</span> <span class="n">queue_max_length</span>

    <span class="c1"># This queue appears not to be FIFO.</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_queue</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Queue</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="n">maximum_number_of_queued_items</span><span class="p">)</span>

<div class="viewcode-block" id="MultiProcessingQueue.Open"><a class="viewcode-back" href="../../../plaso.multi_processing.html#plaso.multi_processing.multi_process.MultiProcessingQueue.Open">[docs]</a>  <span class="k">def</span> <span class="nf">Open</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Opens the queue.&quot;&quot;&quot;</span>
    <span class="k">pass</span></div>

  <span class="c1"># pylint: disable=arguments-differ</span>
<div class="viewcode-block" id="MultiProcessingQueue.Close"><a class="viewcode-back" href="../../../plaso.multi_processing.html#plaso.multi_processing.multi_process.MultiProcessingQueue.Close">[docs]</a>  <span class="k">def</span> <span class="nf">Close</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">abort</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Closes the queue.</span>

<span class="sd">    This needs to be called from any process or thread putting items onto</span>
<span class="sd">    the queue.</span>

<span class="sd">    Args:</span>
<span class="sd">      abort: optional boolean to indicate the close is issued on abort.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">abort</span><span class="p">:</span>
      <span class="c1"># Prevent join_thread() from blocking.</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_queue</span><span class="o">.</span><span class="n">cancel_join_thread</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_queue</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_queue</span><span class="o">.</span><span class="n">join_thread</span><span class="p">()</span></div>

<div class="viewcode-block" id="MultiProcessingQueue.Empty"><a class="viewcode-back" href="../../../plaso.multi_processing.html#plaso.multi_processing.multi_process.MultiProcessingQueue.Empty">[docs]</a>  <span class="k">def</span> <span class="nf">Empty</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Empties the queue.&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_queue</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">Queue</span><span class="o">.</span><span class="n">Empty</span><span class="p">:</span>
      <span class="k">pass</span></div>

<div class="viewcode-block" id="MultiProcessingQueue.IsEmpty"><a class="viewcode-back" href="../../../plaso.multi_processing.html#plaso.multi_processing.multi_process.MultiProcessingQueue.IsEmpty">[docs]</a>  <span class="k">def</span> <span class="nf">IsEmpty</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Determines if the queue is empty.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_queue</span><span class="o">.</span><span class="n">empty</span><span class="p">()</span></div>

<div class="viewcode-block" id="MultiProcessingQueue.PushItem"><a class="viewcode-back" href="../../../plaso.multi_processing.html#plaso.multi_processing.multi_process.MultiProcessingQueue.PushItem">[docs]</a>  <span class="k">def</span> <span class="nf">PushItem</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">block</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Pushes an item onto the queue.</span>

<span class="sd">    Args:</span>
<span class="sd">      block: boolean value to indicate put should block</span>
<span class="sd">             if the queue is full.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">block</span><span class="o">=</span><span class="n">block</span><span class="p">)</span>

    <span class="c1"># Queue.Full can be raised if block is False.</span>
    <span class="c1"># Since this should only be used in the abort code path</span>
    <span class="c1"># the exception is ignored.</span>
    <span class="k">except</span> <span class="n">Queue</span><span class="o">.</span><span class="n">Full</span><span class="p">:</span>
      <span class="k">pass</span></div>

<div class="viewcode-block" id="MultiProcessingQueue.PopItem"><a class="viewcode-back" href="../../../plaso.multi_processing.html#plaso.multi_processing.multi_process.MultiProcessingQueue.PopItem">[docs]</a>  <span class="k">def</span> <span class="nf">PopItem</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Pops an item off the queue.</span>

<span class="sd">    Raises:</span>
<span class="sd">      QueueClose: if the queue has already been closed.</span>
<span class="sd">      QueueEmpty: if no item could be retrieved from the queue within the</span>
<span class="sd">                  specified timeout.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="c1"># If no timeout is specified the queue will block if empty otherwise</span>
      <span class="c1"># a Queue.Empty exception is raised.</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_queue</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_timeout</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
      <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">QueueClose</span>
    <span class="c1"># If close() is called on the multiprocessing.Queue while it is blocking</span>
    <span class="c1"># on get() it will raise IOError.</span>
    <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
      <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">QueueClose</span>
    <span class="k">except</span> <span class="n">Queue</span><span class="o">.</span><span class="n">Empty</span><span class="p">:</span>
      <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">QueueEmpty</span></div></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">Plaso 1.4.1_20160603 documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &raquo;</li>
          <li class="nav-item nav-item-2"><a href="../../plaso.html" >plaso</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &copy; Copyright The Plaso Project Authors.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.4.2.
    </div>
  </body>
</html>