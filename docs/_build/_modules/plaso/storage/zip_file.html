<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>plaso.storage.zip_file &mdash; Plaso 1.4.1_20160603 documentation</title>
    
    <link rel="stylesheet" href="../../../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '1.4.1_20160603',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <link rel="top" title="Plaso 1.4.1_20160603 documentation" href="../../../index.html" />
    <link rel="up" title="plaso" href="../../plaso.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">Plaso 1.4.1_20160603 documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &raquo;</li>
          <li class="nav-item nav-item-2"><a href="../../plaso.html" accesskey="U">plaso</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for plaso.storage.zip_file</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;The ZIP-based storage.</span>

<span class="sd">The ZIP-based storage can be described as a collection of storage files</span>
<span class="sd">(named streams) bundled in a single ZIP archive file.</span>

<span class="sd">There are multiple types of streams:</span>
<span class="sd">* error_data.#</span>
<span class="sd">  The error data streams contain the serialized error objects.</span>
<span class="sd">* error_index.#</span>
<span class="sd">  The error index streams contain the stream offset to the serialized</span>
<span class="sd">  error objects.</span>
<span class="sd">* event_data.#</span>
<span class="sd">  The event data streams contain the serialized event objects.</span>
<span class="sd">* event_index.#</span>
<span class="sd">  The event index streams contain the stream offset to the serialized</span>
<span class="sd">  event objects.</span>
<span class="sd">* event_source_data.#</span>
<span class="sd">  The event source data streams contain the serialized event source objects.</span>
<span class="sd">* event_source_index.#</span>
<span class="sd">  The event source index streams contain the stream offset to the serialized</span>
<span class="sd">  event source objects.</span>
<span class="sd">* event_tag_data.#</span>
<span class="sd">  The event tag data streams contain the serialized event tag objects.</span>
<span class="sd">* event_tag_index.#</span>
<span class="sd">  The event tag index streams contain the stream offset to the serialized</span>
<span class="sd">  event tag objects.</span>
<span class="sd">* event_timestamps.#</span>
<span class="sd">  The event timestamps streams contain the timestamp of the serialized</span>
<span class="sd">  event objects.</span>
<span class="sd">* information.dump</span>
<span class="sd">  The serialized preprocessing object.</span>
<span class="sd">* metadata.txt</span>
<span class="sd">  Stream that contains the storage metadata.</span>
<span class="sd">* session_completion.#</span>
<span class="sd">  Stream that contains information about the completion of a session.</span>
<span class="sd">* session_start.#</span>
<span class="sd">  Stream that contains information about the start of a session.</span>

<span class="sd">The # in a stream name is referred to as the &quot;store number&quot;. Streams with</span>
<span class="sd">the same prefix e.g. &quot;event_&quot; and &quot;store number&quot; are related.</span>

<span class="sd">+ The event data streams</span>

<span class="sd">The event data streams contain the serialized event objects. The serialized</span>
<span class="sd">events are stored in ascending timestamp order within an individual event data</span>
<span class="sd">stream. Note that the event data streams themselves are not ordered.</span>

<span class="sd">The event data streams were previously referred to as &quot;proto files&quot; because</span>
<span class="sd">historically the event data was serialized as protocol buffers (protobufs).</span>

<span class="sd">An event data stream consists of:</span>
<span class="sd">+------+-----------------+------+-...-+</span>
<span class="sd">| size | serialized data | size | ... |</span>
<span class="sd">+------+-----------------+------+-...-+</span>

<span class="sd">Where size is a 32-bit integer.</span>

<span class="sd">+ The event index stream</span>

<span class="sd">The event index streams contain the stream offset to the serialized event</span>
<span class="sd">objects stored in the corresponding event data stream.</span>

<span class="sd">An event data stream consists of an array of 32-bit integers:</span>
<span class="sd">+-----+-----+-...-+</span>
<span class="sd">| int | int | ... |</span>
<span class="sd">+-----+-----+-...-+</span>

<span class="sd">+ The event timestamps stream</span>

<span class="sd">The event timestamps streams contain the timestamp of the serialized</span>
<span class="sd">event objects.</span>

<span class="sd">An event data stream consists of an array of 64-bit integers:</span>
<span class="sd">+-----------+-----------+-...-+</span>
<span class="sd">| timestamp | timestamp | ... |</span>
<span class="sd">+-----------+-----------+-...-+</span>

<span class="sd">+ The event tag index stream</span>

<span class="sd">The event tag index streams contain information about the event object</span>
<span class="sd">the tag applies to.</span>

<span class="sd">An event data stream consists of an array of event tag index values.</span>
<span class="sd">+--------+--------+-...-+</span>
<span class="sd">| struct | struct | ... |</span>
<span class="sd">+--------+--------+-...-+</span>

<span class="sd">See the _SerializedEventTagIndexTable class for more information about</span>
<span class="sd">the actual structure of an event tag index value.</span>

<span class="sd">+ Version information</span>

<span class="sd">Deprecated in version 20160501:</span>
<span class="sd">* serializer.txt</span>
<span class="sd">  Stream that contains the serializer format.</span>

<span class="sd">Deprecated in version 20160511:</span>
<span class="sd">* plaso_index.#</span>
<span class="sd">  The event index streams contain the stream offset to the serialized</span>
<span class="sd">  event objects.</span>
<span class="sd">* plaso_proto.#</span>
<span class="sd">  The event data streams contain the serialized event objects.</span>
<span class="sd">* plaso_report.#</span>
<span class="sd">* plaso_tagging.#</span>
<span class="sd">  The event tag data streams contain the serialized event tag objects.</span>
<span class="sd">* plaso_tag_index.#</span>
<span class="sd">  The event tag index streams contain the stream offset to the serialized</span>
<span class="sd">  event tag objects.</span>
<span class="sd">* plaso_timestamps.#</span>
<span class="sd">  The event timestamps streams contain the timestamp of the serialized</span>
<span class="sd">  event objects.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">heapq</span>
<span class="kn">import</span> <span class="nn">io</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">zipfile</span>

<span class="k">try</span><span class="p">:</span>
  <span class="kn">import</span> <span class="nn">ConfigParser</span> <span class="kn">as</span> <span class="nn">configparser</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
  <span class="kn">import</span> <span class="nn">configparser</span>  <span class="c1"># pylint: disable=import-error</span>

<span class="kn">import</span> <span class="nn">construct</span>

<span class="kn">from</span> <span class="nn">plaso.containers</span> <span class="kn">import</span> <span class="n">sessions</span>
<span class="kn">from</span> <span class="nn">plaso.lib</span> <span class="kn">import</span> <span class="n">definitions</span>
<span class="kn">from</span> <span class="nn">plaso.lib</span> <span class="kn">import</span> <span class="n">errors</span>
<span class="kn">from</span> <span class="nn">plaso.serializer</span> <span class="kn">import</span> <span class="n">json_serializer</span>
<span class="kn">from</span> <span class="nn">plaso.storage</span> <span class="kn">import</span> <span class="n">interface</span>


<span class="k">class</span> <span class="nc">_EventsHeap</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Class that defines the event objects heap.&quot;&quot;&quot;</span>

  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Initializes an event objects heap.&quot;&quot;&quot;</span>
    <span class="nb">super</span><span class="p">(</span><span class="n">_EventsHeap</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_heap</span> <span class="o">=</span> <span class="p">[]</span>

  <span class="nd">@property</span>
  <span class="k">def</span> <span class="nf">number_of_events</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The number of serialized event objects on the heap.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_heap</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">PopEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Pops an event object from the heap.</span>

<span class="sd">    Returns:</span>
<span class="sd">      A tuple containing an event object (instance of EventObject),</span>
<span class="sd">      an integer containing the number of the stream.</span>
<span class="sd">      If the heap is empty the values in the tuple will be None.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="n">_</span><span class="p">,</span> <span class="n">stream_number</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">event_object</span> <span class="o">=</span> <span class="n">heapq</span><span class="o">.</span><span class="n">heappop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_heap</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">event_object</span><span class="p">,</span> <span class="n">stream_number</span>

    <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
      <span class="k">return</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span>

  <span class="k">def</span> <span class="nf">PushEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event_object</span><span class="p">,</span> <span class="n">stream_number</span><span class="p">,</span> <span class="n">entry_index</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Pushes an event object onto the heap.</span>

<span class="sd">    Args:</span>
<span class="sd">      event_object: an event object (instance of EventObject).</span>
<span class="sd">      stream_number: an integer containing the number of the stream.</span>
<span class="sd">      entry_index: an integer containing the serialized data stream entry index.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">heap_values</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">event_object</span><span class="o">.</span><span class="n">timestamp</span><span class="p">,</span> <span class="n">stream_number</span><span class="p">,</span> <span class="n">entry_index</span><span class="p">,</span> <span class="n">event_object</span><span class="p">)</span>
    <span class="n">heapq</span><span class="o">.</span><span class="n">heappush</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_heap</span><span class="p">,</span> <span class="n">heap_values</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">_SerializedEventsHeap</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Class that defines the serialized event objects heap.</span>

<span class="sd">  Attributes:</span>
<span class="sd">    data_size: an integer containing the total data size of the serialized</span>
<span class="sd">               event objects on the heap.</span>
<span class="sd">  &quot;&quot;&quot;</span>

  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Initializes a serialized event objects heap.&quot;&quot;&quot;</span>
    <span class="nb">super</span><span class="p">(</span><span class="n">_SerializedEventsHeap</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_heap</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">data_size</span> <span class="o">=</span> <span class="mi">0</span>

  <span class="nd">@property</span>
  <span class="k">def</span> <span class="nf">number_of_events</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The number of serialized event objects on the heap.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_heap</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">Empty</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Empties the heap.&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_heap</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">data_size</span> <span class="o">=</span> <span class="mi">0</span>

  <span class="k">def</span> <span class="nf">PopEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Pops an event object from the heap.</span>

<span class="sd">    Returns:</span>
<span class="sd">      A tuple containing an integer containing the event timestamp and</span>
<span class="sd">      a binary string containing the serialized event object data.</span>
<span class="sd">      If the heap is empty the values in the tuple will be None.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="n">timestamp</span><span class="p">,</span> <span class="n">event_object_data</span> <span class="o">=</span> <span class="n">heapq</span><span class="o">.</span><span class="n">heappop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_heap</span><span class="p">)</span>

      <span class="bp">self</span><span class="o">.</span><span class="n">data_size</span> <span class="o">-=</span> <span class="nb">len</span><span class="p">(</span><span class="n">event_object_data</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">timestamp</span><span class="p">,</span> <span class="n">event_object_data</span>

    <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
      <span class="k">return</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span>

  <span class="k">def</span> <span class="nf">PushEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">,</span> <span class="n">event_object_data</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Pushes a serialized event object onto the heap.</span>

<span class="sd">    Args:</span>
<span class="sd">      timestamp: an integer containing the event timestamp.</span>
<span class="sd">      event_object_data: binary string containing the serialized</span>
<span class="sd">                         event object data.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">heap_values</span> <span class="o">=</span> <span class="p">(</span><span class="n">timestamp</span><span class="p">,</span> <span class="n">event_object_data</span><span class="p">)</span>
    <span class="n">heapq</span><span class="o">.</span><span class="n">heappush</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_heap</span><span class="p">,</span> <span class="n">heap_values</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">data_size</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">event_object_data</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">_EventTagIndexValue</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Class that defines the event tag index value.</span>

<span class="sd">  Attributes:</span>
<span class="sd">    event_uuid: a string containing the event identifier (UUID) or None.</span>
<span class="sd">    offset: an integer containing the serialized event tag data offset.</span>
<span class="sd">    store_number: optional integer containing the store number.</span>
<span class="sd">    store_index: optional integer containing the index relative</span>
<span class="sd">                  to the start of the store.</span>
<span class="sd">    tag_type: an integer containing the tag type.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">TAG_TYPE_UNDEFINED</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="n">TAG_TYPE_NUMERIC</span> <span class="o">=</span> <span class="mi">1</span>
  <span class="n">TAG_TYPE_UUID</span> <span class="o">=</span> <span class="mi">2</span>

  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span>
      <span class="bp">self</span><span class="p">,</span> <span class="n">tag_type</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">event_uuid</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">store_number</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
      <span class="n">store_index</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Initializes the tag index value.</span>

<span class="sd">    Args:</span>
<span class="sd">      tag_type: an integer containing the tag type.</span>
<span class="sd">      offset: an integer containing the serialized event tag data offset.</span>
<span class="sd">      event_uuid: optional string containing the event identifier (UUID).</span>
<span class="sd">      store_number: optional integer containing the store number.</span>
<span class="sd">      store_index: optional integer containing the index relative</span>
<span class="sd">                    to the start of the store.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">super</span><span class="p">(</span><span class="n">_EventTagIndexValue</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_identifier</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">event_uuid</span> <span class="o">=</span> <span class="n">event_uuid</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">offset</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">store_number</span> <span class="o">=</span> <span class="n">store_number</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">store_index</span> <span class="o">=</span> <span class="n">store_index</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">tag_type</span> <span class="o">=</span> <span class="n">tag_type</span>

  <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Retrieve a string representation of the event tag identifier.&quot;&quot;&quot;</span>
    <span class="n">string</span> <span class="o">=</span> <span class="s1">u&#39;tag_type: {0:d} offset: 0x{1:08x}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tag_type</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">offset</span><span class="p">)</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tag_type</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">TAG_TYPE_NUMERIC</span><span class="p">:</span>
      <span class="k">return</span> <span class="s1">u&#39;{0:s} store_number: {1:d} store_index: {2:d}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
          <span class="n">string</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">store_number</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">store_index</span><span class="p">)</span>

    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">tag_type</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">TAG_TYPE_UUID</span><span class="p">:</span>
      <span class="k">return</span> <span class="s1">u&#39;{0:s} event_uuid: {1:s}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">event_uuid</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">string</span>

  <span class="nd">@property</span>
  <span class="k">def</span> <span class="nf">identifier</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A string containing the event object identifier.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_identifier</span><span class="p">:</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tag_type</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">TAG_TYPE_NUMERIC</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_identifier</span> <span class="o">=</span> <span class="s1">u&#39;{0:d}:{1:d}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">store_number</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">store_index</span><span class="p">)</span>

      <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">tag_type</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">TAG_TYPE_UUID</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_identifier</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">event_uuid</span>

    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_identifier</span>

  <span class="nd">@property</span>
  <span class="k">def</span> <span class="nf">tag</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The tag property to support construct.build().&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span>


<span class="k">class</span> <span class="nc">_SerializedDataStream</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Class that defines a serialized data stream.&quot;&quot;&quot;</span>

  <span class="n">_DATA_ENTRY</span> <span class="o">=</span> <span class="n">construct</span><span class="o">.</span><span class="n">Struct</span><span class="p">(</span>
      <span class="s1">u&#39;data_entry&#39;</span><span class="p">,</span>
      <span class="n">construct</span><span class="o">.</span><span class="n">ULInt32</span><span class="p">(</span><span class="s1">u&#39;size&#39;</span><span class="p">))</span>
  <span class="n">_DATA_ENTRY_SIZE</span> <span class="o">=</span> <span class="n">_DATA_ENTRY</span><span class="o">.</span><span class="n">sizeof</span><span class="p">()</span>

  <span class="c1"># The maximum serialized data size (40 MiB).</span>
  <span class="n">_MAXIMUM_DATA_SIZE</span> <span class="o">=</span> <span class="mi">40</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span>

  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zip_file</span><span class="p">,</span> <span class="n">storage_file_path</span><span class="p">,</span> <span class="n">stream_name</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Initializes a serialized data stream object.</span>

<span class="sd">    Args:</span>
<span class="sd">      zip_file: the ZIP file object that contains the stream.</span>
<span class="sd">      storage_file_path: string containing the path of the storage file.</span>
<span class="sd">      stream_name: string containing the name of the stream.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">super</span><span class="p">(</span><span class="n">_SerializedDataStream</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_entry_index</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_file_object</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">storage_file_path</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_stream_name</span> <span class="o">=</span> <span class="n">stream_name</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_stream_offset</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_zip_file</span> <span class="o">=</span> <span class="n">zip_file</span>

  <span class="nd">@property</span>
  <span class="k">def</span> <span class="nf">entry_index</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The entry index.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_entry_index</span>

  <span class="k">def</span> <span class="nf">_OpenFileObject</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Opens the file-like object (instance of ZipExtFile).</span>

<span class="sd">    Raises:</span>
<span class="sd">      IOError: if the file-like object cannot be opened.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_file_object</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_zip_file</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_stream_name</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">exception</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span>
          <span class="s1">u&#39;Unable to open stream with error: {0:s}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">exception</span><span class="p">))</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_stream_offset</span> <span class="o">=</span> <span class="mi">0</span>

  <span class="k">def</span> <span class="nf">_ReOpenFileObject</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Reopens the file-like object (instance of ZipExtFile).&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file_object</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_file_object</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_file_object</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_file_object</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_zip_file</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_stream_name</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_stream_offset</span> <span class="o">=</span> <span class="mi">0</span>

  <span class="k">def</span> <span class="nf">ReadEntry</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Reads an entry from the data stream.</span>

<span class="sd">    Returns:</span>
<span class="sd">      A binary string containing the data or None if there is no data</span>
<span class="sd">      remaining.</span>

<span class="sd">    Raises:</span>
<span class="sd">      IOError: if the entry cannot be read.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file_object</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_OpenFileObject</span><span class="p">()</span>

    <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file_object</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_DATA_ENTRY_SIZE</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="p">:</span>
      <span class="k">return</span>

    <span class="k">try</span><span class="p">:</span>
      <span class="n">data_entry</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_ENTRY</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">construct</span><span class="o">.</span><span class="n">FieldError</span> <span class="k">as</span> <span class="n">exception</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span>
          <span class="s1">u&#39;Unable to read data entry with error: {0:s}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">exception</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">data_entry</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_MAXIMUM_DATA_SIZE</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span>
          <span class="s1">u&#39;Unable to read data entry size value out of bounds.&#39;</span><span class="p">)</span>

    <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file_object</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">data_entry</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">!=</span> <span class="n">data_entry</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s1">u&#39;Unable to read data.&#39;</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_stream_offset</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_ENTRY_SIZE</span> <span class="o">+</span> <span class="n">data_entry</span><span class="o">.</span><span class="n">size</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_entry_index</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">return</span> <span class="n">data</span>

  <span class="k">def</span> <span class="nf">SeekEntryAtOffset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entry_index</span><span class="p">,</span> <span class="n">stream_offset</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Seeks a specific serialized data stream entry at a specific offset.</span>

<span class="sd">    Args:</span>
<span class="sd">      entry_index: an integer containing the serialized data stream entry index.</span>
<span class="sd">      stream_offset: an integer containing the data stream offset.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file_object</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_OpenFileObject</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">stream_offset</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stream_offset</span><span class="p">:</span>
      <span class="c1"># Since zipfile.ZipExtFile is not seekable we need to close the stream</span>
      <span class="c1"># and reopen it to fake a seek.</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_ReOpenFileObject</span><span class="p">()</span>

      <span class="n">skip_read_size</span> <span class="o">=</span> <span class="n">stream_offset</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">skip_read_size</span> <span class="o">=</span> <span class="n">stream_offset</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stream_offset</span>

    <span class="k">if</span> <span class="n">skip_read_size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
      <span class="c1"># Since zipfile.ZipExtFile is not seekable we need to read upto</span>
      <span class="c1"># the stream offset.</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_file_object</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">skip_read_size</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_stream_offset</span> <span class="o">+=</span> <span class="n">skip_read_size</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_entry_index</span> <span class="o">=</span> <span class="n">entry_index</span>

  <span class="k">def</span> <span class="nf">WriteAbort</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Aborts the write of a serialized data stream.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file_object</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_file_object</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_file_object</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_stream_name</span><span class="p">):</span>
      <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_stream_name</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">WriteEntry</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Writes an entry to the file-like object.</span>

<span class="sd">    Args:</span>
<span class="sd">      data: a binary string containing the data.</span>

<span class="sd">    Returns:</span>
<span class="sd">      An integer containing the offset of the temporary file.</span>

<span class="sd">    Raises:</span>
<span class="sd">      IOError: if the entry cannot be written.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">data_size</span> <span class="o">=</span> <span class="n">construct</span><span class="o">.</span><span class="n">ULInt32</span><span class="p">(</span><span class="s1">u&#39;size&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_file_object</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data_size</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_file_object</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file_object</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>

  <span class="k">def</span> <span class="nf">WriteFinalize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Finalize the write of a serialized data stream.</span>

<span class="sd">    Writes the temporary file with the serialized data to the zip file.</span>

<span class="sd">    Returns:</span>
<span class="sd">      An integer containing the offset of the temporary file.</span>

<span class="sd">    Raises:</span>
<span class="sd">      IOError: if the serialized data stream cannot be written.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">offset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file_object</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_file_object</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_file_object</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="n">current_working_directory</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_path</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_zip_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_stream_name</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
      <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_stream_name</span><span class="p">)</span>
      <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">current_working_directory</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">offset</span>

  <span class="k">def</span> <span class="nf">WriteInitialize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Initializes the write of a serialized data stream.</span>

<span class="sd">    Creates a temporary file to store the serialized data.</span>

<span class="sd">    Returns:</span>
<span class="sd">      An integer containing the offset of the temporary file.</span>

<span class="sd">    Raises:</span>
<span class="sd">      IOError: if the serialized data stream cannot be written.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">stream_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stream_name</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_file_object</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">stream_file_path</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file_object</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">_SerializedDataOffsetTable</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Class that defines a serialized data offset table.&quot;&quot;&quot;</span>

  <span class="n">_TABLE</span> <span class="o">=</span> <span class="n">construct</span><span class="o">.</span><span class="n">GreedyRange</span><span class="p">(</span>
      <span class="n">construct</span><span class="o">.</span><span class="n">ULInt32</span><span class="p">(</span><span class="s1">u&#39;offset&#39;</span><span class="p">))</span>

  <span class="n">_TABLE_ENTRY</span> <span class="o">=</span> <span class="n">construct</span><span class="o">.</span><span class="n">Struct</span><span class="p">(</span>
      <span class="s1">u&#39;table_entry&#39;</span><span class="p">,</span>
      <span class="n">construct</span><span class="o">.</span><span class="n">ULInt32</span><span class="p">(</span><span class="s1">u&#39;offset&#39;</span><span class="p">))</span>
  <span class="n">_TABLE_ENTRY_SIZE</span> <span class="o">=</span> <span class="n">_TABLE_ENTRY</span><span class="o">.</span><span class="n">sizeof</span><span class="p">()</span>

  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zip_file</span><span class="p">,</span> <span class="n">stream_name</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Initializes a serialized data offset table object.</span>

<span class="sd">    Args:</span>
<span class="sd">      zip_file: the ZIP file object that contains the stream.</span>
<span class="sd">      stream_name: string containing the name of the stream.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">super</span><span class="p">(</span><span class="n">_SerializedDataOffsetTable</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_offsets</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_stream_name</span> <span class="o">=</span> <span class="n">stream_name</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_zip_file</span> <span class="o">=</span> <span class="n">zip_file</span>

  <span class="k">def</span> <span class="nf">AddOffset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">offset</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Adds an offset.</span>

<span class="sd">    Args:</span>
<span class="sd">      offset: an integer containing the offset.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_offsets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">GetOffset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entry_index</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Retrieves a specific serialized data offset.</span>

<span class="sd">    Args:</span>
<span class="sd">      entry_index: an integer containing the table entry index.</span>

<span class="sd">    Returns:</span>
<span class="sd">      An integer containing the serialized data offset.</span>

<span class="sd">    Raises:</span>
<span class="sd">      IndexError: if the table entry index is out of bounds.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_offsets</span><span class="p">[</span><span class="n">entry_index</span><span class="p">]</span>

  <span class="k">def</span> <span class="nf">Read</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Reads the serialized data offset table.</span>

<span class="sd">    Raises:</span>
<span class="sd">      IOError: if the offset table cannot be read.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="n">file_object</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_zip_file</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_stream_name</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">exception</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span>
          <span class="s1">u&#39;Unable to open stream with error: {0:s}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">exception</span><span class="p">))</span>

    <span class="k">try</span><span class="p">:</span>
      <span class="n">entry_data</span> <span class="o">=</span> <span class="n">file_object</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_TABLE_ENTRY_SIZE</span><span class="p">)</span>
      <span class="k">while</span> <span class="n">entry_data</span><span class="p">:</span>
        <span class="n">table_entry</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_TABLE_ENTRY</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">entry_data</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_offsets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">table_entry</span><span class="o">.</span><span class="n">offset</span><span class="p">)</span>
        <span class="n">entry_data</span> <span class="o">=</span> <span class="n">file_object</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_TABLE_ENTRY_SIZE</span><span class="p">)</span>

    <span class="k">except</span> <span class="n">construct</span><span class="o">.</span><span class="n">FieldError</span> <span class="k">as</span> <span class="n">exception</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span>
          <span class="s1">u&#39;Unable to read table entry with error: {0:s}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">exception</span><span class="p">))</span>

    <span class="k">finally</span><span class="p">:</span>
      <span class="n">file_object</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

  <span class="k">def</span> <span class="nf">Write</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Writes the offset table.</span>

<span class="sd">    Raises:</span>
<span class="sd">      IOError: if the offset table cannot be written.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">table_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_TABLE</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_offsets</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_zip_file</span><span class="o">.</span><span class="n">writestr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_stream_name</span><span class="p">,</span> <span class="n">table_data</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">_SerializedDataTimestampTable</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Class that defines a serialized data timestamp table.&quot;&quot;&quot;</span>

  <span class="n">_TABLE</span> <span class="o">=</span> <span class="n">construct</span><span class="o">.</span><span class="n">GreedyRange</span><span class="p">(</span>
      <span class="n">construct</span><span class="o">.</span><span class="n">SLInt64</span><span class="p">(</span><span class="s1">u&#39;timestamp&#39;</span><span class="p">))</span>

  <span class="n">_TABLE_ENTRY</span> <span class="o">=</span> <span class="n">construct</span><span class="o">.</span><span class="n">Struct</span><span class="p">(</span>
      <span class="s1">u&#39;table_entry&#39;</span><span class="p">,</span>
      <span class="n">construct</span><span class="o">.</span><span class="n">SLInt64</span><span class="p">(</span><span class="s1">u&#39;timestamp&#39;</span><span class="p">))</span>
  <span class="n">_TABLE_ENTRY_SIZE</span> <span class="o">=</span> <span class="n">_TABLE_ENTRY</span><span class="o">.</span><span class="n">sizeof</span><span class="p">()</span>

  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zip_file</span><span class="p">,</span> <span class="n">stream_name</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Initializes a serialized data timestamp table object.</span>

<span class="sd">    Args:</span>
<span class="sd">      zip_file: the ZIP file object that contains the stream.</span>
<span class="sd">      stream_name: string containing the name of the stream.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">super</span><span class="p">(</span><span class="n">_SerializedDataTimestampTable</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_timestamps</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_stream_name</span> <span class="o">=</span> <span class="n">stream_name</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_zip_file</span> <span class="o">=</span> <span class="n">zip_file</span>

  <span class="nd">@property</span>
  <span class="k">def</span> <span class="nf">number_of_timestamps</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The number of timestamps.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_timestamps</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">AddTimestamp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Adds a timestamp.</span>

<span class="sd">    Args:</span>
<span class="sd">      timestamp: an integer containing the timestamp.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_timestamps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">timestamp</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">GetTimestamp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entry_index</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Retrieves a specific timestamp.</span>

<span class="sd">    Args:</span>
<span class="sd">      entry_index: an integer containing the table entry index.</span>

<span class="sd">    Returns:</span>
<span class="sd">      An integer containing the timestamp.</span>

<span class="sd">    Raises:</span>
<span class="sd">      IndexError: if the table entry index is out of bounds.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_timestamps</span><span class="p">[</span><span class="n">entry_index</span><span class="p">]</span>

  <span class="k">def</span> <span class="nf">Read</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Reads the serialized data timestamp table.</span>

<span class="sd">    Raises:</span>
<span class="sd">      IOError: if the timestamp table cannot be read.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="n">file_object</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_zip_file</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_stream_name</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">exception</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span>
          <span class="s1">u&#39;Unable to open stream with error: {0:s}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">exception</span><span class="p">))</span>

    <span class="k">try</span><span class="p">:</span>
      <span class="n">entry_data</span> <span class="o">=</span> <span class="n">file_object</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_TABLE_ENTRY_SIZE</span><span class="p">)</span>
      <span class="k">while</span> <span class="n">entry_data</span><span class="p">:</span>
        <span class="n">table_entry</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_TABLE_ENTRY</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">entry_data</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_timestamps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">table_entry</span><span class="o">.</span><span class="n">timestamp</span><span class="p">)</span>
        <span class="n">entry_data</span> <span class="o">=</span> <span class="n">file_object</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_TABLE_ENTRY_SIZE</span><span class="p">)</span>

    <span class="k">except</span> <span class="n">construct</span><span class="o">.</span><span class="n">FieldError</span> <span class="k">as</span> <span class="n">exception</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span>
          <span class="s1">u&#39;Unable to read table entry with error: {0:s}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">exception</span><span class="p">))</span>

    <span class="k">finally</span><span class="p">:</span>
      <span class="n">file_object</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

  <span class="k">def</span> <span class="nf">Write</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Writes the timestamp table.</span>

<span class="sd">    Raises:</span>
<span class="sd">      IOError: if the timestamp table cannot be written.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">table_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_TABLE</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_timestamps</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_zip_file</span><span class="o">.</span><span class="n">writestr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_stream_name</span><span class="p">,</span> <span class="n">table_data</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">_SerializedEventTagIndexTable</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Class that defines a serialized event tag index table.&quot;&quot;&quot;</span>

  <span class="n">_TAG_STORE_STRUCT</span> <span class="o">=</span> <span class="n">construct</span><span class="o">.</span><span class="n">Struct</span><span class="p">(</span>
      <span class="s1">u&#39;tag_store&#39;</span><span class="p">,</span>
      <span class="n">construct</span><span class="o">.</span><span class="n">ULInt32</span><span class="p">(</span><span class="s1">u&#39;store_number&#39;</span><span class="p">),</span>
      <span class="n">construct</span><span class="o">.</span><span class="n">ULInt32</span><span class="p">(</span><span class="s1">u&#39;store_index&#39;</span><span class="p">))</span>

  <span class="n">_TAG_UUID_STRUCT</span> <span class="o">=</span> <span class="n">construct</span><span class="o">.</span><span class="n">Struct</span><span class="p">(</span>
      <span class="s1">u&#39;tag_uuid&#39;</span><span class="p">,</span>
      <span class="n">construct</span><span class="o">.</span><span class="n">PascalString</span><span class="p">(</span><span class="s1">u&#39;event_uuid&#39;</span><span class="p">))</span>

  <span class="n">_TAG_INDEX_STRUCT</span> <span class="o">=</span> <span class="n">construct</span><span class="o">.</span><span class="n">Struct</span><span class="p">(</span>
      <span class="s1">u&#39;tag_index&#39;</span><span class="p">,</span>
      <span class="n">construct</span><span class="o">.</span><span class="n">Byte</span><span class="p">(</span><span class="s1">u&#39;tag_type&#39;</span><span class="p">),</span>
      <span class="n">construct</span><span class="o">.</span><span class="n">ULInt32</span><span class="p">(</span><span class="s1">u&#39;offset&#39;</span><span class="p">),</span>
      <span class="n">construct</span><span class="o">.</span><span class="n">IfThenElse</span><span class="p">(</span>
          <span class="s1">u&#39;tag&#39;</span><span class="p">,</span>
          <span class="k">lambda</span> <span class="n">ctx</span><span class="p">:</span> <span class="n">ctx</span><span class="p">[</span><span class="s1">u&#39;tag_type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span>
          <span class="n">_TAG_STORE_STRUCT</span><span class="p">,</span>
          <span class="n">_TAG_UUID_STRUCT</span><span class="p">))</span>

  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zip_file</span><span class="p">,</span> <span class="n">stream_name</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Initializes a serialized event tag index table object.</span>

<span class="sd">    Args:</span>
<span class="sd">      zip_file: the ZIP file object that contains the stream.</span>
<span class="sd">      stream_name: string containing the name of the stream.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">super</span><span class="p">(</span><span class="n">_SerializedEventTagIndexTable</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_event_tag_indexes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_stream_name</span> <span class="o">=</span> <span class="n">stream_name</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_zip_file</span> <span class="o">=</span> <span class="n">zip_file</span>

  <span class="nd">@property</span>
  <span class="k">def</span> <span class="nf">number_of_entries</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The number of event tag index entries.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_event_tag_indexes</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">AddEventTagIndex</span><span class="p">(</span>
      <span class="bp">self</span><span class="p">,</span> <span class="n">tag_type</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">event_uuid</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">store_number</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
      <span class="n">store_index</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Adds an event tag index.</span>

<span class="sd">    Args:</span>
<span class="sd">      tag_type: an integer containing the tag type.</span>
<span class="sd">      offset: an integer containing the serialized event tag data offset.</span>
<span class="sd">      event_uuid: optional string containing the event identifier (UUID).</span>
<span class="sd">      store_number: optional integer containing the store number.</span>
<span class="sd">      store_index: optional integer containing the index relative</span>
<span class="sd">                    to the start of the store.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">event_tag_index</span> <span class="o">=</span> <span class="n">_EventTagIndexValue</span><span class="p">(</span>
        <span class="n">tag_type</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">event_uuid</span><span class="o">=</span><span class="n">event_uuid</span><span class="p">,</span> <span class="n">store_number</span><span class="o">=</span><span class="n">store_number</span><span class="p">,</span>
        <span class="n">store_index</span><span class="o">=</span><span class="n">store_index</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_event_tag_indexes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">event_tag_index</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">GetEventTagIndex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entry_index</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Retrieves a specific event tag index.</span>

<span class="sd">    Args:</span>
<span class="sd">      entry_index: an integer containing the table entry index.</span>

<span class="sd">    Returns:</span>
<span class="sd">      An event tag index object (instance of _EventTagIndexValue).</span>

<span class="sd">    Raises:</span>
<span class="sd">      IndexError: if the table entry index is out of bounds.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_event_tag_indexes</span><span class="p">[</span><span class="n">entry_index</span><span class="p">]</span>

  <span class="k">def</span> <span class="nf">Read</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Reads the serialized event tag index table.</span>

<span class="sd">    Raises:</span>
<span class="sd">      IOError: if the event tag index table cannot be read.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">stream_store_number</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stream_name</span><span class="o">.</span><span class="n">rpartition</span><span class="p">(</span><span class="s1">u&#39;.&#39;</span><span class="p">)</span>
      <span class="n">stream_store_number</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">stream_store_number</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">exception</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">IOError</span><span class="p">((</span>
          <span class="s1">u&#39;Unable to determine store number of stream: {0:s} &#39;</span>
          <span class="s1">u&#39;with error: {1:s}&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_stream_name</span><span class="p">,</span> <span class="n">exception</span><span class="p">))</span>

    <span class="k">try</span><span class="p">:</span>
      <span class="n">file_object</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_zip_file</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_stream_name</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">exception</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span>
          <span class="s1">u&#39;Unable to open stream with error: {0:s}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">exception</span><span class="p">))</span>

    <span class="k">try</span><span class="p">:</span>
      <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
          <span class="n">tag_index_struct</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_TAG_INDEX_STRUCT</span><span class="o">.</span><span class="n">parse_stream</span><span class="p">(</span><span class="n">file_object</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="n">construct</span><span class="o">.</span><span class="n">FieldError</span><span class="p">,</span> <span class="ne">AttributeError</span><span class="p">):</span>
          <span class="k">break</span>

        <span class="n">tag_type</span> <span class="o">=</span> <span class="n">tag_index_struct</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s1">u&#39;tag_type&#39;</span><span class="p">,</span> <span class="n">_EventTagIndexValue</span><span class="o">.</span><span class="n">TAG_TYPE_UNDEFINED</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">tag_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span>
            <span class="n">_EventTagIndexValue</span><span class="o">.</span><span class="n">TAG_TYPE_NUMERIC</span><span class="p">,</span>
            <span class="n">_EventTagIndexValue</span><span class="o">.</span><span class="n">TAG_TYPE_UUID</span><span class="p">):</span>
          <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">u&#39;Unsupported tag type: {0:d}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tag_type</span><span class="p">))</span>
          <span class="k">break</span>

        <span class="n">offset</span> <span class="o">=</span> <span class="n">tag_index_struct</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">u&#39;offset&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="n">tag_index</span> <span class="o">=</span> <span class="n">tag_index_struct</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">u&#39;tag&#39;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">event_uuid</span> <span class="o">=</span> <span class="n">tag_index</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">u&#39;event_uuid&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="n">store_number</span> <span class="o">=</span> <span class="n">tag_index</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">u&#39;store_number&#39;</span><span class="p">,</span> <span class="n">stream_store_number</span><span class="p">)</span>
        <span class="n">store_index</span> <span class="o">=</span> <span class="n">tag_index</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">u&#39;store_index&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

        <span class="n">event_tag_index</span> <span class="o">=</span> <span class="n">_EventTagIndexValue</span><span class="p">(</span>
            <span class="n">tag_type</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">event_uuid</span><span class="o">=</span><span class="n">event_uuid</span><span class="p">,</span> <span class="n">store_number</span><span class="o">=</span><span class="n">store_number</span><span class="p">,</span>
            <span class="n">store_index</span><span class="o">=</span><span class="n">store_index</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_event_tag_indexes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">event_tag_index</span><span class="p">)</span>

    <span class="k">finally</span><span class="p">:</span>
      <span class="n">file_object</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

  <span class="k">def</span> <span class="nf">Write</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Writes the event tag index table.</span>

<span class="sd">    Raises:</span>
<span class="sd">      IOError: if the event tag index table cannot be written.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">serialized_entries</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">event_tag_index</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_event_tag_indexes</span><span class="p">:</span>
      <span class="n">entry_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_TAG_INDEX_STRUCT</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">event_tag_index</span><span class="p">)</span>
      <span class="n">serialized_entries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entry_data</span><span class="p">)</span>

    <span class="n">table_data</span> <span class="o">=</span> <span class="n">b</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">serialized_entries</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_zip_file</span><span class="o">.</span><span class="n">writestr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_stream_name</span><span class="p">,</span> <span class="n">table_data</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">_StorageMetadata</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Class that implements storage metadata.</span>

<span class="sd">  Attributes:</span>
<span class="sd">    format_version: an integer containing the storage format version.</span>
<span class="sd">    serialization_format: a string containing the serialization format.</span>
<span class="sd">  &quot;&quot;&quot;</span>

  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Initializes storage metadata.&quot;&quot;&quot;</span>
    <span class="nb">super</span><span class="p">(</span><span class="n">_StorageMetadata</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">format_version</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">serialization_format</span> <span class="o">=</span> <span class="bp">None</span>


<span class="k">class</span> <span class="nc">_StorageMetadataReader</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Class that implements a storage metadata reader.&quot;&quot;&quot;</span>

  <span class="k">def</span> <span class="nf">_GetConfigValue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config_parser</span><span class="p">,</span> <span class="n">section_name</span><span class="p">,</span> <span class="n">value_name</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Retrieves a value from the config parser.</span>

<span class="sd">    Args:</span>
<span class="sd">      config_parser: the configuration parser (instance of ConfigParser).</span>
<span class="sd">      section_name: the name of the section that contains the value.</span>
<span class="sd">      value_name: the name of the value.</span>

<span class="sd">    Returns:</span>
<span class="sd">      An object containing the value or None if the value does not exists.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">config_parser</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">section_name</span><span class="p">,</span> <span class="n">value_name</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
    <span class="k">except</span> <span class="p">(</span><span class="n">configparser</span><span class="o">.</span><span class="n">NoOptionError</span><span class="p">,</span> <span class="n">configparser</span><span class="o">.</span><span class="n">NoSectionError</span><span class="p">):</span>
      <span class="k">return</span>

  <span class="k">def</span> <span class="nf">Read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stream_data</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Reads the storage metadata.</span>

<span class="sd">    Args:</span>
<span class="sd">      stream_data: a byte string containing the data of the steam.</span>

<span class="sd">    Returns:</span>
<span class="sd">      The storeage metadata (instance of _StorageMetadata).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">config_parser</span> <span class="o">=</span> <span class="n">configparser</span><span class="o">.</span><span class="n">RawConfigParser</span><span class="p">()</span>
    <span class="n">config_parser</span><span class="o">.</span><span class="n">readfp</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">stream_data</span><span class="p">))</span>

    <span class="n">section_name</span> <span class="o">=</span> <span class="s1">u&#39;plaso_storage_file&#39;</span>

    <span class="n">storage_metadata</span> <span class="o">=</span> <span class="n">_StorageMetadata</span><span class="p">()</span>

    <span class="n">format_version</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_GetConfigValue</span><span class="p">(</span>
        <span class="n">config_parser</span><span class="p">,</span> <span class="n">section_name</span><span class="p">,</span> <span class="s1">u&#39;format_version&#39;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
      <span class="n">storage_metadata</span><span class="o">.</span><span class="n">format_version</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">format_version</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
      <span class="n">storage_metadata</span><span class="o">.</span><span class="n">format_version</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="n">storage_metadata</span><span class="o">.</span><span class="n">serialization_format</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_GetConfigValue</span><span class="p">(</span>
        <span class="n">config_parser</span><span class="p">,</span> <span class="n">section_name</span><span class="p">,</span> <span class="s1">u&#39;serialization_format&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">storage_metadata</span>


<span class="c1"># TODO: merge ZIPStorageFile and StorageFile.</span>
<div class="viewcode-block" id="ZIPStorageFile"><a class="viewcode-back" href="../../../plaso.storage.html#plaso.storage.zip_file.ZIPStorageFile">[docs]</a><span class="k">class</span> <span class="nc">ZIPStorageFile</span><span class="p">(</span><span class="n">interface</span><span class="o">.</span><span class="n">BaseStorage</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Class that defines the ZIP-based storage file.</span>

<span class="sd">  This class contains the lower-level stream management functionality.</span>

<span class="sd">  The ZIP-based storage file contains several streams (files) that contain</span>
<span class="sd">  serialized attribute containers. E.g. event objects:</span>

<span class="sd">        event_data.#</span>

<span class="sd">  Where # is an increasing integer that starts at 1.</span>
<span class="sd">  &quot;&quot;&quot;</span>

  <span class="c1"># TODO: remove after merge of ZIPStorageFile and StorageFile.</span>
  <span class="c1"># pylint: disable=abstract-method</span>

  <span class="c1"># The format version.</span>
  <span class="n">_FORMAT_VERSION</span> <span class="o">=</span> <span class="mi">20160516</span>

  <span class="c1"># The earliest format version, stored in-file, that this class</span>
  <span class="c1"># is able to read.</span>
  <span class="n">_COMPATIBLE_FORMAT_VERSION</span> <span class="o">=</span> <span class="mi">20160501</span>

  <span class="c1"># The format version used for storage files predating storing</span>
  <span class="c1"># a format version.</span>
  <span class="n">_LEGACY_FORMAT_VERSION</span> <span class="o">=</span> <span class="mi">20160431</span>

  <span class="c1"># The maximum buffer size of serialized data before triggering</span>
  <span class="c1"># a flush to disk (196 MiB).</span>
  <span class="n">_MAXIMUM_BUFFER_SIZE</span> <span class="o">=</span> <span class="mi">196</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span>

  <span class="c1"># The maximum number of cached tables.</span>
  <span class="n">_MAXIMUM_NUMBER_OF_CACHED_TABLES</span> <span class="o">=</span> <span class="mi">5</span>

  <span class="c1"># The maximum serialized report size (24 MiB).</span>
  <span class="n">_MAXIMUM_SERIALIZED_REPORT_SIZE</span> <span class="o">=</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span>

  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Initializes a ZIP-based storage file object.&quot;&quot;&quot;</span>
    <span class="nb">super</span><span class="p">(</span><span class="n">ZIPStorageFile</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_error_stream_number</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_event_offset_tables</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_event_offset_tables_lfu</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_event_stream_number</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_event_streams</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_event_source_stream_number</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_event_source_offset_tables</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_event_source_offset_tables_lfu</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_event_source_streams</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_event_tag_index</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_event_tag_stream_number</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_event_timestamp_tables</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_event_timestamp_tables_lfu</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_event_heap</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_format_version</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_FORMAT_VERSION</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_is_open</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_last_session</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_maximum_buffer_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_MAXIMUM_BUFFER_SIZE</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_read_only</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_serialized_errors</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_serialized_errors_size</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_serialized_event_sources</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_serialized_event_sources_size</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_serialized_event_tags</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_serialized_event_tags_size</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_serialized_events</span> <span class="o">=</span> <span class="n">_SerializedEventsHeap</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_serializer</span> <span class="o">=</span> <span class="n">json_serializer</span><span class="o">.</span><span class="n">JSONAttributeContainerSerializer</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_serializer_format</span> <span class="o">=</span> <span class="n">definitions</span><span class="o">.</span><span class="n">SERIALIZER_FORMAT_JSON</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_path</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_zipfile</span> <span class="o">=</span> <span class="bp">None</span>

  <span class="nd">@property</span>
  <span class="k">def</span> <span class="nf">serialization_format</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The serialization format.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_serializer_format</span>

  <span class="k">def</span> <span class="nf">_BuildTagIndex</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Builds the tag index that contains the offsets for each tag.</span>

<span class="sd">    Raises:</span>
<span class="sd">      IOError: if the stream cannot be opened.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format_version</span> <span class="o">&lt;=</span> <span class="mi">20160501</span><span class="p">:</span>
      <span class="n">stream_name_prefix</span> <span class="o">=</span> <span class="s1">u&#39;plaso_tag_index.&#39;</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">stream_name_prefix</span> <span class="o">=</span> <span class="s1">u&#39;event_tag_index.&#39;</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_event_tag_index</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">stream_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_GetStreamNames</span><span class="p">():</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="n">stream_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">stream_name_prefix</span><span class="p">):</span>
        <span class="k">continue</span>

      <span class="n">event_tag_index_table</span> <span class="o">=</span> <span class="n">_SerializedEventTagIndexTable</span><span class="p">(</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">_zipfile</span><span class="p">,</span> <span class="n">stream_name</span><span class="p">)</span>
      <span class="n">event_tag_index_table</span><span class="o">.</span><span class="n">Read</span><span class="p">()</span>

      <span class="k">for</span> <span class="n">entry_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">event_tag_index_table</span><span class="o">.</span><span class="n">number_of_entries</span><span class="p">):</span>
        <span class="n">tag_index_value</span> <span class="o">=</span> <span class="n">event_tag_index_table</span><span class="o">.</span><span class="n">GetEventTagIndex</span><span class="p">(</span><span class="n">entry_index</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_event_tag_index</span><span class="p">[</span><span class="n">tag_index_value</span><span class="o">.</span><span class="n">identifier</span><span class="p">]</span> <span class="o">=</span> <span class="n">tag_index_value</span>

  <span class="k">def</span> <span class="nf">_GetEventObject</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stream_number</span><span class="p">,</span> <span class="n">entry_index</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Reads an event object from a specific stream.</span>

<span class="sd">    Args:</span>
<span class="sd">      stream_number: an integer containing the number of the serialized event</span>
<span class="sd">                     object stream.</span>
<span class="sd">      entry_index: an optional integer containing the number of the serialized</span>
<span class="sd">                   event object within the stream. Where -1 represents the next</span>
<span class="sd">                   available event object.</span>

<span class="sd">    Returns:</span>
<span class="sd">      An event object (instance of EventObject) or None.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">event_object_data</span><span class="p">,</span> <span class="n">entry_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_GetEventObjectSerializedData</span><span class="p">(</span>
        <span class="n">stream_number</span><span class="p">,</span> <span class="n">entry_index</span><span class="o">=</span><span class="n">entry_index</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">event_object_data</span><span class="p">:</span>
      <span class="k">return</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_serializers_profiler</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_serializers_profiler</span><span class="o">.</span><span class="n">StartTiming</span><span class="p">(</span><span class="s1">u&#39;event_object&#39;</span><span class="p">)</span>

    <span class="n">event_object</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_serializer</span><span class="o">.</span><span class="n">ReadSerialized</span><span class="p">(</span><span class="n">event_object_data</span><span class="p">)</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_serializers_profiler</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_serializers_profiler</span><span class="o">.</span><span class="n">StopTiming</span><span class="p">(</span><span class="s1">u&#39;event_object&#39;</span><span class="p">)</span>

    <span class="n">event_object</span><span class="o">.</span><span class="n">store_number</span> <span class="o">=</span> <span class="n">stream_number</span>
    <span class="n">event_object</span><span class="o">.</span><span class="n">store_index</span> <span class="o">=</span> <span class="n">entry_index</span>

    <span class="k">return</span> <span class="n">event_object</span>

  <span class="k">def</span> <span class="nf">_GetEventObjectSerializedData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stream_number</span><span class="p">,</span> <span class="n">entry_index</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Retrieves specific event object serialized data.</span>

<span class="sd">    By default the first available entry in the specific serialized stream</span>
<span class="sd">    is read, however any entry can be read using the index stream.</span>

<span class="sd">    Args:</span>
<span class="sd">      stream_number: an integer containing the number of the stream.</span>
<span class="sd">      entry_index: an optional integer containing the number of the serialized</span>
<span class="sd">                   event object within the stream. Where -1 represents the next</span>
<span class="sd">                   available event object.</span>

<span class="sd">    Returns:</span>
<span class="sd">      A tuple containing the event object serialized data and the entry index</span>
<span class="sd">      of the event object within the storage file.</span>

<span class="sd">    Raises:</span>
<span class="sd">      IOError: if the stream cannot be opened.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="n">data_stream</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_GetSerializedEventStream</span><span class="p">(</span><span class="n">stream_number</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">IOError</span> <span class="k">as</span> <span class="n">exception</span><span class="p">:</span>
      <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">((</span>
          <span class="s1">u&#39;Unable to retrieve serialized data steam: {0:d} &#39;</span>
          <span class="s1">u&#39;with error: {1:s}.&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">stream_number</span><span class="p">,</span> <span class="n">exception</span><span class="p">))</span>
      <span class="k">return</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span>

    <span class="k">if</span> <span class="n">entry_index</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
      <span class="k">try</span><span class="p">:</span>
        <span class="n">offset_table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_GetSerializedEventOffsetTable</span><span class="p">(</span><span class="n">stream_number</span><span class="p">)</span>
        <span class="n">stream_offset</span> <span class="o">=</span> <span class="n">offset_table</span><span class="o">.</span><span class="n">GetOffset</span><span class="p">(</span><span class="n">entry_index</span><span class="p">)</span>
      <span class="k">except</span> <span class="p">(</span><span class="ne">IOError</span><span class="p">,</span> <span class="ne">IndexError</span><span class="p">):</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">((</span>
            <span class="s1">u&#39;Unable to read entry index: {0:d} from serialized data stream: &#39;</span>
            <span class="s1">u&#39;{1:d}&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">entry_index</span><span class="p">,</span> <span class="n">stream_number</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span>

      <span class="n">data_stream</span><span class="o">.</span><span class="n">SeekEntryAtOffset</span><span class="p">(</span><span class="n">entry_index</span><span class="p">,</span> <span class="n">stream_offset</span><span class="p">)</span>

    <span class="n">event_object_entry_index</span> <span class="o">=</span> <span class="n">data_stream</span><span class="o">.</span><span class="n">entry_index</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="n">event_object_data</span> <span class="o">=</span> <span class="n">data_stream</span><span class="o">.</span><span class="n">ReadEntry</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">IOError</span> <span class="k">as</span> <span class="n">exception</span><span class="p">:</span>
      <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">((</span>
          <span class="s1">u&#39;Unable to read entry from serialized data steam: {0:d} &#39;</span>
          <span class="s1">u&#39;with error: {1:s}.&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">stream_number</span><span class="p">,</span> <span class="n">exception</span><span class="p">))</span>
      <span class="k">return</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span>

    <span class="k">return</span> <span class="n">event_object_data</span><span class="p">,</span> <span class="n">event_object_entry_index</span>

  <span class="k">def</span> <span class="nf">_GetEventSource</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stream_number</span><span class="p">,</span> <span class="n">entry_index</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Reads an event source from a specific stream.</span>

<span class="sd">    Args:</span>
<span class="sd">      stream_number: an integer containing the number of the serialized event</span>
<span class="sd">                     object stream.</span>
<span class="sd">      entry_index: an optional integer containing the number of the serialized</span>
<span class="sd">                   event source within the stream. Where -1 represents the next</span>
<span class="sd">                   available event source.</span>

<span class="sd">    Returns:</span>
<span class="sd">      An event source (instance of EventSource) or None.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">event_source_data</span><span class="p">,</span> <span class="n">entry_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_GetEventSourceSerializedData</span><span class="p">(</span>
        <span class="n">stream_number</span><span class="p">,</span> <span class="n">entry_index</span><span class="o">=</span><span class="n">entry_index</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">event_source_data</span><span class="p">:</span>
      <span class="k">return</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_serializers_profiler</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_serializers_profiler</span><span class="o">.</span><span class="n">StartTiming</span><span class="p">(</span><span class="s1">u&#39;event_source&#39;</span><span class="p">)</span>

    <span class="n">event_source</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_serializer</span><span class="o">.</span><span class="n">ReadSerialized</span><span class="p">(</span><span class="n">event_source_data</span><span class="p">)</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_serializers_profiler</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_serializers_profiler</span><span class="o">.</span><span class="n">StopTiming</span><span class="p">(</span><span class="s1">u&#39;event_source&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">event_source</span>

  <span class="k">def</span> <span class="nf">_GetEventSourceSerializedData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stream_number</span><span class="p">,</span> <span class="n">entry_index</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Retrieves specific event source serialized data.</span>

<span class="sd">    By default the first available entry in the specific serialized stream</span>
<span class="sd">    is read, however any entry can be read using the index stream.</span>

<span class="sd">    Args:</span>
<span class="sd">      stream_number: an integer containing the number of the stream.</span>
<span class="sd">      entry_index: an optional integer containing the number of the serialized</span>
<span class="sd">                   event source within the stream. Where -1 represents the next</span>
<span class="sd">                   available event source.</span>

<span class="sd">    Returns:</span>
<span class="sd">      A tuple containing the event source serialized data and the entry index</span>
<span class="sd">      of the event source within the storage file.</span>

<span class="sd">    Raises:</span>
<span class="sd">      IOError: if the stream cannot be opened.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="n">data_stream</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_GetSerializedEventStream</span><span class="p">(</span><span class="n">stream_number</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">IOError</span> <span class="k">as</span> <span class="n">exception</span><span class="p">:</span>
      <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">((</span>
          <span class="s1">u&#39;Unable to retrieve serialized data steam: {0:d} &#39;</span>
          <span class="s1">u&#39;with error: {1:s}.&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">stream_number</span><span class="p">,</span> <span class="n">exception</span><span class="p">))</span>
      <span class="k">return</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span>

    <span class="k">if</span> <span class="n">entry_index</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
      <span class="k">try</span><span class="p">:</span>
        <span class="n">offset_table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_GetSerializedEventSourceOffsetTable</span><span class="p">(</span><span class="n">stream_number</span><span class="p">)</span>
        <span class="n">stream_offset</span> <span class="o">=</span> <span class="n">offset_table</span><span class="o">.</span><span class="n">GetOffset</span><span class="p">(</span><span class="n">entry_index</span><span class="p">)</span>
      <span class="k">except</span> <span class="p">(</span><span class="ne">IOError</span><span class="p">,</span> <span class="ne">IndexError</span><span class="p">):</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">((</span>
            <span class="s1">u&#39;Unable to read entry index: {0:d} from serialized data stream: &#39;</span>
            <span class="s1">u&#39;{1:d}&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">entry_index</span><span class="p">,</span> <span class="n">stream_number</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span>

      <span class="n">data_stream</span><span class="o">.</span><span class="n">SeekEntryAtOffset</span><span class="p">(</span><span class="n">entry_index</span><span class="p">,</span> <span class="n">stream_offset</span><span class="p">)</span>

    <span class="n">event_source_entry_index</span> <span class="o">=</span> <span class="n">data_stream</span><span class="o">.</span><span class="n">entry_index</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="n">event_source_data</span> <span class="o">=</span> <span class="n">data_stream</span><span class="o">.</span><span class="n">ReadEntry</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">IOError</span> <span class="k">as</span> <span class="n">exception</span><span class="p">:</span>
      <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">((</span>
          <span class="s1">u&#39;Unable to read entry from serialized data steam: {0:d} &#39;</span>
          <span class="s1">u&#39;with error: {1:s}.&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">stream_number</span><span class="p">,</span> <span class="n">exception</span><span class="p">))</span>
      <span class="k">return</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span>

    <span class="k">return</span> <span class="n">event_source_data</span><span class="p">,</span> <span class="n">event_source_entry_index</span>

  <span class="k">def</span> <span class="nf">_GetEventTagIndexValue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">store_number</span><span class="p">,</span> <span class="n">entry_index</span><span class="p">,</span> <span class="n">uuid</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Retrieves an event tag index value.</span>

<span class="sd">    Args:</span>
<span class="sd">      store_number: the store number.</span>
<span class="sd">      entry_index: an integer containing the serialized data stream entry index.</span>
<span class="sd">      uuid: the UUID string.</span>

<span class="sd">    Returns:</span>
<span class="sd">      An event tag index value (instance of _EventTagIndexValue).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_event_tag_index</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_BuildTagIndex</span><span class="p">()</span>

    <span class="c1"># Try looking up event tag by numeric identifier.</span>
    <span class="n">tag_identifier</span> <span class="o">=</span> <span class="s1">u&#39;{0:d}:{1:d}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">store_number</span><span class="p">,</span> <span class="n">entry_index</span><span class="p">)</span>
    <span class="n">tag_index_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_event_tag_index</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">tag_identifier</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

    <span class="c1"># Try looking up event tag by UUID.</span>
    <span class="k">if</span> <span class="n">tag_index_value</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
      <span class="n">tag_index_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_event_tag_index</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">uuid</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">tag_index_value</span>

  <span class="k">def</span> <span class="nf">_GetLastStreamNumber</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stream_name_prefix</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Retrieves the last stream number.</span>

<span class="sd">    Args:</span>
<span class="sd">      stream_name_prefix: a string containing the stream name prefix.</span>

<span class="sd">    Returns:</span>
<span class="sd">      An integer containing the last stream number.</span>

<span class="sd">    Raises:</span>
<span class="sd">      IOError: if the stream number format is not supported.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">last_stream_number</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">stream_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_GetStreamNames</span><span class="p">():</span>
      <span class="k">if</span> <span class="n">stream_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">stream_name_prefix</span><span class="p">):</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">stream_number</span> <span class="o">=</span> <span class="n">stream_name</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="s1">u&#39;.&#39;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
          <span class="n">stream_number</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">stream_number</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
          <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span>
              <span class="s1">u&#39;Unsupported stream number: {0:s}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">stream_number</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">stream_number</span> <span class="o">&gt;</span> <span class="n">last_stream_number</span><span class="p">:</span>
          <span class="n">last_stream_number</span> <span class="o">=</span> <span class="n">stream_number</span>

    <span class="k">return</span> <span class="n">last_stream_number</span> <span class="o">+</span> <span class="mi">1</span>

  <span class="k">def</span> <span class="nf">_InitializeMergeBuffer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">time_range</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Initializes the event objects into the merge buffer.</span>

<span class="sd">    This function fills the merge buffer with the first relevant event object</span>
<span class="sd">    from each stream.</span>

<span class="sd">    Args:</span>
<span class="sd">      time_range: an optional time range object (instance of TimeRange).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format_version</span> <span class="o">&lt;=</span> <span class="mi">20160501</span><span class="p">:</span>
      <span class="n">stream_name_prefix</span> <span class="o">=</span> <span class="s1">u&#39;plaso_timestamps&#39;</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">stream_name_prefix</span> <span class="o">=</span> <span class="s1">u&#39;event_timestamps&#39;</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_event_heap</span> <span class="o">=</span> <span class="n">_EventsHeap</span><span class="p">()</span>

    <span class="n">number_range</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_GetSerializedEventStreamNumbers</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">stream_number</span> <span class="ow">in</span> <span class="n">number_range</span><span class="p">:</span>
      <span class="n">entry_index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
      <span class="k">if</span> <span class="n">time_range</span><span class="p">:</span>
        <span class="n">stream_name</span> <span class="o">=</span> <span class="s1">u&#39;{0:s}.{1:06d}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">stream_name_prefix</span><span class="p">,</span> <span class="n">stream_number</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_HasStream</span><span class="p">(</span><span class="n">stream_name</span><span class="p">):</span>
          <span class="k">try</span><span class="p">:</span>
            <span class="n">timestamp_table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_GetSerializedEventTimestampTable</span><span class="p">(</span>
                <span class="n">stream_number</span><span class="p">)</span>
          <span class="k">except</span> <span class="ne">IOError</span> <span class="k">as</span> <span class="n">exception</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">((</span>
                <span class="s1">u&#39;Unable to read timestamp table from stream: {0:s} &#39;</span>
                <span class="s1">u&#39;with error: {1:s}.&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">stream_name</span><span class="p">,</span> <span class="n">exception</span><span class="p">))</span>

          <span class="c1"># If the start timestamp of the time range filter is larger than the</span>
          <span class="c1"># last timestamp in the timestamp table skip this stream.</span>
          <span class="n">timestamp_compare</span> <span class="o">=</span> <span class="n">timestamp_table</span><span class="o">.</span><span class="n">GetTimestamp</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
          <span class="k">if</span> <span class="n">time_range</span><span class="o">.</span><span class="n">start_timestamp</span> <span class="o">&gt;</span> <span class="n">timestamp_compare</span><span class="p">:</span>
            <span class="k">continue</span>

          <span class="k">for</span> <span class="n">table_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">timestamp_table</span><span class="o">.</span><span class="n">number_of_timestamps</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">timestamp_compare</span> <span class="o">=</span> <span class="n">timestamp_table</span><span class="o">.</span><span class="n">GetTimestamp</span><span class="p">(</span><span class="n">table_index</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">time_range</span><span class="o">.</span><span class="n">start_timestamp</span> <span class="o">&gt;=</span> <span class="n">timestamp_compare</span><span class="p">:</span>
              <span class="n">entry_index</span> <span class="o">=</span> <span class="n">table_index</span>
              <span class="k">break</span>

      <span class="n">event_object</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_GetEventObject</span><span class="p">(</span>
          <span class="n">stream_number</span><span class="p">,</span> <span class="n">entry_index</span><span class="o">=</span><span class="n">entry_index</span><span class="p">)</span>
      <span class="c1"># Check the lower bound in case no timestamp table was available.</span>
      <span class="k">while</span> <span class="p">(</span><span class="n">event_object</span> <span class="ow">and</span> <span class="n">time_range</span> <span class="ow">and</span>
             <span class="n">event_object</span><span class="o">.</span><span class="n">timestamp</span> <span class="o">&lt;</span> <span class="n">time_range</span><span class="o">.</span><span class="n">start_timestamp</span><span class="p">):</span>
        <span class="n">event_object</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_GetEventObject</span><span class="p">(</span><span class="n">stream_number</span><span class="p">)</span>

      <span class="k">if</span> <span class="n">event_object</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">time_range</span> <span class="ow">and</span> <span class="n">event_object</span><span class="o">.</span><span class="n">timestamp</span> <span class="o">&gt;</span> <span class="n">time_range</span><span class="o">.</span><span class="n">end_timestamp</span><span class="p">:</span>
          <span class="k">continue</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_event_heap</span><span class="o">.</span><span class="n">PushEvent</span><span class="p">(</span>
            <span class="n">event_object</span><span class="p">,</span> <span class="n">stream_number</span><span class="p">,</span> <span class="n">event_object</span><span class="o">.</span><span class="n">store_number</span><span class="p">)</span>

        <span class="n">reference_timestamp</span> <span class="o">=</span> <span class="n">event_object</span><span class="o">.</span><span class="n">timestamp</span>
        <span class="k">while</span> <span class="n">event_object</span><span class="o">.</span><span class="n">timestamp</span> <span class="o">==</span> <span class="n">reference_timestamp</span><span class="p">:</span>
          <span class="n">event_object</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_GetEventObject</span><span class="p">(</span><span class="n">stream_number</span><span class="p">)</span>
          <span class="k">if</span> <span class="ow">not</span> <span class="n">event_object</span><span class="p">:</span>
            <span class="k">break</span>

          <span class="bp">self</span><span class="o">.</span><span class="n">_event_heap</span><span class="o">.</span><span class="n">PushEvent</span><span class="p">(</span>
              <span class="n">event_object</span><span class="p">,</span> <span class="n">stream_number</span><span class="p">,</span> <span class="n">event_object</span><span class="o">.</span><span class="n">store_number</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">_GetSerializedDataStream</span><span class="p">(</span>
      <span class="bp">self</span><span class="p">,</span> <span class="n">streams_cache</span><span class="p">,</span> <span class="n">stream_name_prefix</span><span class="p">,</span> <span class="n">stream_number</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Retrieves the serialized data stream.</span>

<span class="sd">    Args:</span>
<span class="sd">      streams_cache: a dictionary containing the streams cache.</span>
<span class="sd">      stream_name_prefix: a string containing the stream name prefix.</span>
<span class="sd">      stream_number: an integer containing the number of the stream.</span>

<span class="sd">    Returns:</span>
<span class="sd">      A serialized data stream object (instance of _SerializedDataStream).</span>

<span class="sd">    Raises:</span>
<span class="sd">      IOError: if the stream cannot be opened.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">data_stream</span> <span class="o">=</span> <span class="n">streams_cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">stream_number</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">data_stream</span><span class="p">:</span>
      <span class="n">stream_name</span> <span class="o">=</span> <span class="s1">u&#39;{0:s}.{1:06d}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">stream_name_prefix</span><span class="p">,</span> <span class="n">stream_number</span><span class="p">)</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_HasStream</span><span class="p">(</span><span class="n">stream_name</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s1">u&#39;No such stream: {0:s}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">stream_name</span><span class="p">))</span>

      <span class="n">data_stream</span> <span class="o">=</span> <span class="n">_SerializedDataStream</span><span class="p">(</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">_zipfile</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_path</span><span class="p">,</span> <span class="n">stream_name</span><span class="p">)</span>
      <span class="n">streams_cache</span><span class="p">[</span><span class="n">stream_number</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_stream</span>

    <span class="k">return</span> <span class="n">data_stream</span>

  <span class="k">def</span> <span class="nf">_GetSerializedDataOffsetTable</span><span class="p">(</span>
      <span class="bp">self</span><span class="p">,</span> <span class="n">offset_tables_cache</span><span class="p">,</span> <span class="n">offset_tables_lfu</span><span class="p">,</span> <span class="n">stream_name_prefix</span><span class="p">,</span>
      <span class="n">stream_number</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Retrieves the serialized data offset table.</span>

<span class="sd">    Args:</span>
<span class="sd">      offset_tables_cache: a dictionary containing the offset tables cache.</span>
<span class="sd">      offset_tables_lfu: a list containing the the least frequently used (LFU)</span>
<span class="sd">                         offset tables.</span>
<span class="sd">      stream_name_prefix: a string containing the stream name prefix.</span>
<span class="sd">      stream_number: an integer containing the number of the stream.</span>

<span class="sd">    Returns:</span>
<span class="sd">      A serialized data offset table (instance of _SerializedDataOffsetTable).</span>

<span class="sd">    Raises:</span>
<span class="sd">      IOError: if the stream cannot be opened.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">offset_table</span> <span class="o">=</span> <span class="n">offset_tables_cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">stream_number</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">offset_table</span><span class="p">:</span>
      <span class="n">stream_name</span> <span class="o">=</span> <span class="s1">u&#39;{0:s}.{1:06d}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">stream_name_prefix</span><span class="p">,</span> <span class="n">stream_number</span><span class="p">)</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_HasStream</span><span class="p">(</span><span class="n">stream_name</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s1">u&#39;No such stream: {0:s}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">stream_name</span><span class="p">))</span>

      <span class="n">offset_table</span> <span class="o">=</span> <span class="n">_SerializedDataOffsetTable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_zipfile</span><span class="p">,</span> <span class="n">stream_name</span><span class="p">)</span>
      <span class="n">offset_table</span><span class="o">.</span><span class="n">Read</span><span class="p">()</span>

      <span class="n">number_of_tables</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">offset_tables_cache</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">number_of_tables</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_MAXIMUM_NUMBER_OF_CACHED_TABLES</span><span class="p">:</span>
        <span class="n">lfu_stream_number</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_event_offset_tables_lfu</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="k">del</span> <span class="n">offset_tables_cache</span><span class="p">[</span><span class="n">lfu_stream_number</span><span class="p">]</span>

      <span class="n">offset_tables_cache</span><span class="p">[</span><span class="n">stream_number</span><span class="p">]</span> <span class="o">=</span> <span class="n">offset_table</span>

    <span class="k">if</span> <span class="n">stream_number</span> <span class="ow">in</span> <span class="n">offset_tables_lfu</span><span class="p">:</span>
      <span class="n">lfu_index</span> <span class="o">=</span> <span class="n">offset_tables_lfu</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">stream_number</span><span class="p">)</span>
      <span class="n">offset_tables_lfu</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">lfu_index</span><span class="p">)</span>

    <span class="n">offset_tables_lfu</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">stream_number</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">offset_table</span>

  <span class="k">def</span> <span class="nf">_GetSerializedDataStreamNumbers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stream_name_prefix</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Retrieves the available serialized data stream numbers.</span>

<span class="sd">    Args:</span>
<span class="sd">      stream_name_prefix: a string containing the stream name prefix.</span>

<span class="sd">    Returns:</span>
<span class="sd">      A sorted list of integers of the available serialized data stream numbers.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">stream_numbers</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">stream_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_zipfile</span><span class="o">.</span><span class="n">namelist</span><span class="p">():</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="n">stream_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">stream_name_prefix</span><span class="p">):</span>
        <span class="k">continue</span>

      <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">stream_number</span> <span class="o">=</span> <span class="n">stream_name</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="s1">u&#39;.&#39;</span><span class="p">)</span>
      <span class="k">try</span><span class="p">:</span>
        <span class="n">stream_number</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">stream_number</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
        <span class="n">stream_numbers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">stream_number</span><span class="p">)</span>
      <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
            <span class="s1">u&#39;Unable to determine stream number from stream: {0:s}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">stream_name</span><span class="p">))</span>

    <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">stream_numbers</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">_GetSerializedEventOffsetTable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stream_number</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Retrieves the serialized event stream offset table.</span>

<span class="sd">    Args:</span>
<span class="sd">      stream_number: an integer containing the number of the stream.</span>

<span class="sd">    Returns:</span>
<span class="sd">      A serialized data offset table (instance of _SerializedDataOffsetTable).</span>

<span class="sd">    Raises:</span>
<span class="sd">      IOError: if the stream cannot be opened.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format_version</span> <span class="o">&lt;=</span> <span class="mi">20160501</span><span class="p">:</span>
      <span class="n">stream_name_prefix</span> <span class="o">=</span> <span class="s1">u&#39;plaso_index&#39;</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">stream_name_prefix</span> <span class="o">=</span> <span class="s1">u&#39;event_index&#39;</span>

    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_GetSerializedDataOffsetTable</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_event_offset_tables</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_event_offset_tables_lfu</span><span class="p">,</span>
        <span class="n">stream_name_prefix</span><span class="p">,</span> <span class="n">stream_number</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">_GetSerializedEventSourceOffsetTable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stream_number</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Retrieves the serialized event source stream offset table.</span>

<span class="sd">    Args:</span>
<span class="sd">      stream_number: an integer containing the number of the stream.</span>

<span class="sd">    Returns:</span>
<span class="sd">      A serialized data offset table (instance of _SerializedDataOffsetTable).</span>

<span class="sd">    Raises:</span>
<span class="sd">      IOError: if the stream cannot be opened.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_GetSerializedDataOffsetTable</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_event_source_offset_tables</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_event_source_offset_tables_lfu</span><span class="p">,</span>
        <span class="s1">u&#39;event_source_index&#39;</span><span class="p">,</span> <span class="n">stream_number</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">_GetSerializedEventSourceStream</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stream_number</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Retrieves the serialized event source stream.</span>

<span class="sd">    Args:</span>
<span class="sd">      stream_number: an integer containing the number of the stream.</span>

<span class="sd">    Returns:</span>
<span class="sd">      A serialized data stream object (instance of _SerializedDataStream).</span>

<span class="sd">    Raises:</span>
<span class="sd">      IOError: if the stream cannot be opened.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_GetSerializedDataStream</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_event_streams</span><span class="p">,</span> <span class="s1">u&#39;event_source_data&#39;</span><span class="p">,</span> <span class="n">stream_number</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">_GetSerializedEventStream</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stream_number</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Retrieves the serialized event stream.</span>

<span class="sd">    Args:</span>
<span class="sd">      stream_number: an integer containing the number of the stream.</span>

<span class="sd">    Returns:</span>
<span class="sd">      A serialized data stream object (instance of _SerializedDataStream).</span>

<span class="sd">    Raises:</span>
<span class="sd">      IOError: if the stream cannot be opened.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format_version</span> <span class="o">&lt;=</span> <span class="mi">20160501</span><span class="p">:</span>
      <span class="n">stream_name_prefix</span> <span class="o">=</span> <span class="s1">u&#39;plaso_proto&#39;</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">stream_name_prefix</span> <span class="o">=</span> <span class="s1">u&#39;event_data&#39;</span>

    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_GetSerializedDataStream</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_event_streams</span><span class="p">,</span> <span class="n">stream_name_prefix</span><span class="p">,</span> <span class="n">stream_number</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">_GetSerializedEventSourceStreamNumbers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Retrieves the available serialized event source stream numbers.</span>

<span class="sd">    Returns:</span>
<span class="sd">      A sorted list of integers of the available serialized data stream numbers.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_GetSerializedDataStreamNumbers</span><span class="p">(</span><span class="s1">u&#39;event_source_data.&#39;</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">_GetSerializedEventStreamNumbers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Retrieves the available serialized event stream numbers.</span>

<span class="sd">    Returns:</span>
<span class="sd">      A sorted list of integers of the available serialized data stream numbers.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format_version</span> <span class="o">&lt;=</span> <span class="mi">20160501</span><span class="p">:</span>
      <span class="n">stream_name_prefix</span> <span class="o">=</span> <span class="s1">u&#39;plaso_proto.&#39;</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">stream_name_prefix</span> <span class="o">=</span> <span class="s1">u&#39;event_data.&#39;</span>

    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_GetSerializedDataStreamNumbers</span><span class="p">(</span><span class="n">stream_name_prefix</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">_GetSerializedEventTimestampTable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stream_number</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Retrieves the serialized event stream timestamp table.</span>

<span class="sd">    Args:</span>
<span class="sd">      stream_number: an integer containing the number of the stream.</span>

<span class="sd">    Returns:</span>
<span class="sd">      A serialized data timestamp table (instance of</span>
<span class="sd">       _SerializedDataTimestampTable).</span>

<span class="sd">    Raises:</span>
<span class="sd">      IOError: if the stream cannot be opened.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format_version</span> <span class="o">&lt;=</span> <span class="mi">20160501</span><span class="p">:</span>
      <span class="n">stream_name_prefix</span> <span class="o">=</span> <span class="s1">u&#39;plaso_timestamps&#39;</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">stream_name_prefix</span> <span class="o">=</span> <span class="s1">u&#39;event_timestamps&#39;</span>

    <span class="n">timestamp_table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_event_timestamp_tables</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">stream_number</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">timestamp_table</span><span class="p">:</span>
      <span class="n">stream_name</span> <span class="o">=</span> <span class="s1">u&#39;{0:s}.{1:06d}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">stream_name_prefix</span><span class="p">,</span> <span class="n">stream_number</span><span class="p">)</span>
      <span class="n">timestamp_table</span> <span class="o">=</span> <span class="n">_SerializedDataTimestampTable</span><span class="p">(</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">_zipfile</span><span class="p">,</span> <span class="n">stream_name</span><span class="p">)</span>
      <span class="n">timestamp_table</span><span class="o">.</span><span class="n">Read</span><span class="p">()</span>

      <span class="n">number_of_tables</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_event_timestamp_tables</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">number_of_tables</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_MAXIMUM_NUMBER_OF_CACHED_TABLES</span><span class="p">:</span>
        <span class="n">lfu_stream_number</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_event_timestamp_tables_lfu</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_event_timestamp_tables</span><span class="p">[</span><span class="n">lfu_stream_number</span><span class="p">]</span>

      <span class="bp">self</span><span class="o">.</span><span class="n">_event_timestamp_tables</span><span class="p">[</span><span class="n">stream_number</span><span class="p">]</span> <span class="o">=</span> <span class="n">timestamp_table</span>

    <span class="k">if</span> <span class="n">stream_number</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_event_timestamp_tables_lfu</span><span class="p">:</span>
      <span class="n">lfu_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_event_timestamp_tables_lfu</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">stream_number</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_event_timestamp_tables_lfu</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">lfu_index</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_event_timestamp_tables_lfu</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">stream_number</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">timestamp_table</span>

  <span class="k">def</span> <span class="nf">_GetStreamNames</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Retrieves the stream names.</span>

<span class="sd">    Yields:</span>
<span class="sd">      A string containing the stream name.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_zipfile</span><span class="p">:</span>
      <span class="k">for</span> <span class="n">stream_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_zipfile</span><span class="o">.</span><span class="n">namelist</span><span class="p">():</span>
        <span class="k">yield</span> <span class="n">stream_name</span>

  <span class="k">def</span> <span class="nf">_HasStream</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stream_name</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Determines if the ZIP file contains a specific stream.</span>

<span class="sd">    Args:</span>
<span class="sd">      stream_name: string containing the name of the stream.</span>

<span class="sd">    Returns:</span>
<span class="sd">      A boolean indicating if the ZIP file contains the stream.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="n">file_object</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_zipfile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">stream_name</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
      <span class="k">return</span> <span class="bp">False</span>

    <span class="n">file_object</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="bp">True</span>

  <span class="k">def</span> <span class="nf">_OpenRead</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Opens the storage file for reading.&quot;&quot;&quot;</span>
    <span class="n">has_storage_metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ReadStorageMetadata</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">has_storage_metadata</span><span class="p">:</span>
      <span class="c1"># TODO: remove serializer.txt stream support in favor</span>
      <span class="c1"># of storage metatdata.</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_only</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">u&#39;Storage file does not contain a metadata stream.&#39;</span><span class="p">)</span>

      <span class="n">stored_serializer_format</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ReadSerializerStream</span><span class="p">()</span>
      <span class="k">if</span> <span class="n">stored_serializer_format</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_format_version</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_LEGACY_FORMAT_VERSION</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_serializer_format</span> <span class="o">=</span> <span class="n">stored_serializer_format</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_serializer_format</span> <span class="o">!=</span> <span class="n">definitions</span><span class="o">.</span><span class="n">SERIALIZER_FORMAT_JSON</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s1">u&#39;Unsupported serializer format: {0:s}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">_serializer_format</span><span class="p">))</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_serializer</span> <span class="o">=</span> <span class="n">json_serializer</span><span class="o">.</span><span class="n">JSONAttributeContainerSerializer</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format_version</span> <span class="o">&lt;=</span> <span class="mi">20160501</span><span class="p">:</span>
      <span class="n">stream_name_prefix</span> <span class="o">=</span> <span class="s1">u&#39;plaso_proto.&#39;</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">stream_name_prefix</span> <span class="o">=</span> <span class="s1">u&#39;event_data.&#39;</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_error_stream_number</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_GetLastStreamNumber</span><span class="p">(</span><span class="s1">u&#39;error_data.&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_event_stream_number</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_GetLastStreamNumber</span><span class="p">(</span><span class="n">stream_name_prefix</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_event_source_stream_number</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_GetLastStreamNumber</span><span class="p">(</span>
        <span class="s1">u&#39;event_source_data.&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format_version</span> <span class="o">&lt;=</span> <span class="mi">20160501</span><span class="p">:</span>
      <span class="n">stream_name_prefix</span> <span class="o">=</span> <span class="s1">u&#39;plaso_tagging.&#39;</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">stream_name_prefix</span> <span class="o">=</span> <span class="s1">u&#39;event_tag_data.&#39;</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_event_tag_stream_number</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_GetLastStreamNumber</span><span class="p">(</span>
        <span class="n">stream_name_prefix</span><span class="p">)</span>

    <span class="n">last_session_start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_GetLastStreamNumber</span><span class="p">(</span><span class="s1">u&#39;session_start.&#39;</span><span class="p">)</span>
    <span class="n">last_session_completion</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_GetLastStreamNumber</span><span class="p">(</span><span class="s1">u&#39;session_completion.&#39;</span><span class="p">)</span>

    <span class="c1"># TODO: handle open sessions.</span>
    <span class="k">if</span> <span class="n">last_session_start</span> <span class="o">!=</span> <span class="n">last_session_completion</span><span class="p">:</span>
      <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">u&#39;Detected unclosed session.&#39;</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_last_session</span> <span class="o">=</span> <span class="n">last_session_completion</span>

  <span class="k">def</span> <span class="nf">_OpenStream</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stream_name</span><span class="p">,</span> <span class="n">access_mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Opens a stream.</span>

<span class="sd">    Args:</span>
<span class="sd">      stream_name: string containing the name of the stream.</span>
<span class="sd">      access_mode: optional string indicating the access mode.</span>

<span class="sd">    Returns:</span>
<span class="sd">      The stream file-like object (instance of zipfile.ZipExtFile) or None.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_zipfile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">stream_name</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">access_mode</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
      <span class="k">return</span>

  <span class="k">def</span> <span class="nf">_OpenWrite</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Opens the storage file for writing.&quot;&quot;&quot;</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">u&#39;Writing to ZIP file with buffer size: {0:d}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_maximum_buffer_size</span><span class="p">))</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_event_stream_number</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_WriteStorageMetadata</span><span class="p">()</span>

  <span class="k">def</span> <span class="nf">_OpenZIPFile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">read_only</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Opens the ZIP file.</span>

<span class="sd">    Args:</span>
<span class="sd">      path: a string containing the path of the ZIP file.</span>
<span class="sd">      read_only: boolean value to indicate if the file should be</span>
<span class="sd">                 opened in read-only mode.</span>

<span class="sd">    Raises:</span>
<span class="sd">      IOError: if the ZIP file is already opened or if the ZIP file cannot</span>
<span class="sd">               be opened.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_zipfile</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s1">u&#39;ZIP file already opened.&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">read_only</span><span class="p">:</span>
      <span class="n">access_mode</span> <span class="o">=</span> <span class="s1">&#39;r&#39;</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">access_mode</span> <span class="o">=</span> <span class="s1">&#39;a&#39;</span>

    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_zipfile</span> <span class="o">=</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span>
          <span class="n">path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">access_mode</span><span class="p">,</span> <span class="n">compression</span><span class="o">=</span><span class="n">zipfile</span><span class="o">.</span><span class="n">ZIP_DEFLATED</span><span class="p">,</span>
          <span class="n">allowZip64</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="k">except</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">BadZipfile</span> <span class="k">as</span> <span class="n">exception</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s1">u&#39;Unable to open ZIP file: {0:s} with error: {1:s}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
          <span class="n">path</span><span class="p">,</span> <span class="n">exception</span><span class="p">))</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_is_open</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_path</span> <span class="o">=</span> <span class="n">path</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_read_only</span> <span class="o">=</span> <span class="n">read_only</span>

  <span class="k">def</span> <span class="nf">_ReadAttributeContainer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">container_data</span><span class="p">,</span> <span class="n">container_type</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Reads an attribute container.</span>

<span class="sd">    Args:</span>
<span class="sd">      container_data: a binary string containing the serialized attribute</span>
<span class="sd">                      container data.</span>
<span class="sd">      container_type: a string containing the attribute container type.</span>

<span class="sd">    Returns:</span>
<span class="sd">      An attribute container (instance of AttributeContainer) or None.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">container_data</span><span class="p">:</span>
      <span class="k">return</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_serializers_profiler</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_serializers_profiler</span><span class="o">.</span><span class="n">StartTiming</span><span class="p">(</span><span class="n">container_type</span><span class="p">)</span>

    <span class="n">attribute_container</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_serializer</span><span class="o">.</span><span class="n">ReadSerialized</span><span class="p">(</span><span class="n">container_data</span><span class="p">)</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_serializers_profiler</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_serializers_profiler</span><span class="o">.</span><span class="n">StopTiming</span><span class="p">(</span><span class="n">container_type</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">attribute_container</span>

  <span class="k">def</span> <span class="nf">_ReadAttributeContainerFromStreamEntry</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_stream</span><span class="p">,</span> <span class="n">container_type</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Reads an attribute container entry from a data stream.</span>

<span class="sd">    Args:</span>
<span class="sd">      data_stream: the data stream object (instance of _SerializedDataStream).</span>
<span class="sd">      container_type: a string containing the attribute container type.</span>

<span class="sd">    Returns:</span>
<span class="sd">      An attribute container (instance of AttributeContainer) or None.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">entry_data</span> <span class="o">=</span> <span class="n">data_stream</span><span class="o">.</span><span class="n">ReadEntry</span><span class="p">()</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ReadAttributeContainer</span><span class="p">(</span><span class="n">entry_data</span><span class="p">,</span> <span class="n">container_type</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">_ReadAttributeContainersFromStream</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_stream</span><span class="p">,</span> <span class="n">container_type</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Reads attribute containers from a data stream.</span>

<span class="sd">    Args:</span>
<span class="sd">      data_stream: the data stream object (instance of _SerializedDataStream).</span>
<span class="sd">      container_type: a string containing the attribute container type.</span>

<span class="sd">    Yields:</span>
<span class="sd">      Attribute containers (instances of AttributeContainer).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">attribute_container</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ReadAttributeContainerFromStreamEntry</span><span class="p">(</span>
        <span class="n">data_stream</span><span class="p">,</span> <span class="n">container_type</span><span class="p">)</span>

    <span class="k">while</span> <span class="n">attribute_container</span><span class="p">:</span>
      <span class="k">yield</span> <span class="n">attribute_container</span>

      <span class="n">attribute_container</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ReadAttributeContainerFromStreamEntry</span><span class="p">(</span>
          <span class="n">data_stream</span><span class="p">,</span> <span class="n">container_type</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">_ReadEventTagByIdentifier</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">store_number</span><span class="p">,</span> <span class="n">entry_index</span><span class="p">,</span> <span class="n">uuid</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Reads an event tag by identifier.</span>

<span class="sd">    Args:</span>
<span class="sd">      store_number: the store number.</span>
<span class="sd">      entry_index: an integer containing the serialized data stream entry index.</span>
<span class="sd">      uuid: the UUID string.</span>

<span class="sd">    Returns:</span>
<span class="sd">      The event tag (instance of EventTag) or None.</span>

<span class="sd">    Raises:</span>
<span class="sd">      IOError: if the event tag data stream cannot be opened.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tag_index_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_GetEventTagIndexValue</span><span class="p">(</span>
        <span class="n">store_number</span><span class="p">,</span> <span class="n">entry_index</span><span class="p">,</span> <span class="n">uuid</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">tag_index_value</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
      <span class="k">return</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format_version</span> <span class="o">&lt;=</span> <span class="mi">20160501</span><span class="p">:</span>
      <span class="n">stream_name_prefix</span> <span class="o">=</span> <span class="s1">u&#39;plaso_tagging&#39;</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">stream_name_prefix</span> <span class="o">=</span> <span class="s1">u&#39;event_tag_data&#39;</span>

    <span class="n">stream_name</span> <span class="o">=</span> <span class="s1">u&#39;{0:s}.{1:06d}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">stream_name_prefix</span><span class="p">,</span> <span class="n">tag_index_value</span><span class="o">.</span><span class="n">store_number</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_HasStream</span><span class="p">(</span><span class="n">stream_name</span><span class="p">):</span>
      <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s1">u&#39;No such stream: {0:s}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">stream_name</span><span class="p">))</span>

    <span class="n">data_stream</span> <span class="o">=</span> <span class="n">_SerializedDataStream</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_zipfile</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_path</span><span class="p">,</span> <span class="n">stream_name</span><span class="p">)</span>
    <span class="n">data_stream</span><span class="o">.</span><span class="n">SeekEntryAtOffset</span><span class="p">(</span><span class="n">entry_index</span><span class="p">,</span> <span class="n">tag_index_value</span><span class="o">.</span><span class="n">store_index</span><span class="p">)</span>

    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ReadAttributeContainerFromStreamEntry</span><span class="p">(</span><span class="n">data_stream</span><span class="p">,</span> <span class="s1">u&#39;event&#39;</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">_ReadSerializerStream</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Reads the serializer stream.</span>

<span class="sd">    Note that the serializer stream has been deprecated in format version</span>
<span class="sd">    20160501 in favor of the the store metadata stream.</span>

<span class="sd">    Returns:</span>
<span class="sd">      The stored serializer format.</span>

<span class="sd">    Raises:</span>
<span class="sd">      ValueError: if the serializer format is not supported.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">stream_name</span> <span class="o">=</span> <span class="s1">u&#39;serializer.txt&#39;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_HasStream</span><span class="p">(</span><span class="n">stream_name</span><span class="p">):</span>
      <span class="k">return</span>

    <span class="n">serializer_format</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ReadStream</span><span class="p">(</span><span class="n">stream_name</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">serializer_format</span> <span class="o">!=</span> <span class="n">definitions</span><span class="o">.</span><span class="n">SERIALIZER_FORMAT_JSON</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
          <span class="s1">u&#39;Unsupported stored serializer format: {0:s}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
              <span class="n">serializer_format</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">serializer_format</span>

  <span class="k">def</span> <span class="nf">_ReadStorageMetadata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Reads the storage metadata.</span>

<span class="sd">    Returns:</span>
<span class="sd">      A boolean value to indicate if the storage metadata was read.</span>

<span class="sd">    Raises:</span>
<span class="sd">      IOError: if the format version or the serializer format is not supported.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">stream_name</span> <span class="o">=</span> <span class="s1">u&#39;metadata.txt&#39;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_HasStream</span><span class="p">(</span><span class="n">stream_name</span><span class="p">):</span>
      <span class="k">return</span> <span class="bp">False</span>

    <span class="n">storage_metadata_reader</span> <span class="o">=</span> <span class="n">_StorageMetadataReader</span><span class="p">()</span>
    <span class="n">stream_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ReadStream</span><span class="p">(</span><span class="n">stream_name</span><span class="p">)</span>
    <span class="n">storage_metadata</span> <span class="o">=</span> <span class="n">storage_metadata_reader</span><span class="o">.</span><span class="n">Read</span><span class="p">(</span><span class="n">stream_data</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">storage_metadata</span><span class="o">.</span><span class="n">format_version</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s1">u&#39;Missing format version.&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">storage_metadata</span><span class="o">.</span><span class="n">format_version</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_COMPATIBLE_FORMAT_VERSION</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span>
          <span class="s1">u&#39;Format version: {0:d} is too old and no longer supported.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
              <span class="n">storage_metadata</span><span class="o">.</span><span class="n">format_version</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">storage_metadata</span><span class="o">.</span><span class="n">format_version</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_FORMAT_VERSION</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span>
          <span class="s1">u&#39;Format version: {0:d} is too new and not yet supported.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
              <span class="n">storage_metadata</span><span class="o">.</span><span class="n">format_version</span><span class="p">))</span>

    <span class="n">serialization_format</span> <span class="o">=</span> <span class="n">storage_metadata</span><span class="o">.</span><span class="n">serialization_format</span>
    <span class="k">if</span> <span class="n">serialization_format</span> <span class="o">!=</span> <span class="n">definitions</span><span class="o">.</span><span class="n">SERIALIZER_FORMAT_JSON</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span>
          <span class="s1">u&#39;Unsupported serialization format: {0:s}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
              <span class="n">serialization_format</span><span class="p">))</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_format_version</span> <span class="o">=</span> <span class="n">storage_metadata</span><span class="o">.</span><span class="n">format_version</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_serializer_format</span> <span class="o">=</span> <span class="n">serialization_format</span>

    <span class="k">return</span> <span class="bp">True</span>

  <span class="k">def</span> <span class="nf">_ReadStream</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stream_name</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Reads data from a stream.</span>

<span class="sd">    Args:</span>
<span class="sd">      stream_name: string containing the name of the stream.</span>

<span class="sd">    Returns:</span>
<span class="sd">      A byte string containing the data of the stream.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">file_object</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_OpenStream</span><span class="p">(</span><span class="n">stream_name</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">file_object</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">b</span><span class="s1">&#39;&#39;</span>

    <span class="k">try</span><span class="p">:</span>
      <span class="n">data</span> <span class="o">=</span> <span class="n">file_object</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="k">finally</span><span class="p">:</span>
      <span class="n">file_object</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">data</span>

  <span class="k">def</span> <span class="nf">_WriteAttributeContainer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attribute_container</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Writes an attribute container.</span>

<span class="sd">    Args:</span>
<span class="sd">      attribute_container: an attribute container ((instance of</span>
<span class="sd">                           AttributeContainer).</span>

<span class="sd">    Returns:</span>
<span class="sd">      A binary string containing the serialized attribute container.</span>

<span class="sd">    Raises:</span>
<span class="sd">      IOError: if the attribute container cannot be serialized.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_serializers_profiler</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_serializers_profiler</span><span class="o">.</span><span class="n">StartTiming</span><span class="p">(</span>
          <span class="n">attribute_container</span><span class="o">.</span><span class="n">CONTAINER_TYPE</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
      <span class="n">attribute_container_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_serializer</span><span class="o">.</span><span class="n">WriteSerialized</span><span class="p">(</span>
          <span class="n">attribute_container</span><span class="p">)</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="n">attribute_container_data</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span>
            <span class="s1">u&#39;Unable to serialize attribute container: {0:s}.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">attribute_container</span><span class="o">.</span><span class="n">CONTAINER_TYPE</span><span class="p">))</span>

    <span class="k">finally</span><span class="p">:</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_serializers_profiler</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_serializers_profiler</span><span class="o">.</span><span class="n">StopTiming</span><span class="p">(</span>
            <span class="n">attribute_container</span><span class="o">.</span><span class="n">CONTAINER_TYPE</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">attribute_container_data</span>

  <span class="k">def</span> <span class="nf">_WriteSerializedErrors</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Writes the buffered serialized errors to the storage file.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_serialized_errors_size</span><span class="p">:</span>
      <span class="k">return</span>

    <span class="n">stream_name</span> <span class="o">=</span> <span class="s1">u&#39;error_index.{0:06d}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_error_stream_number</span><span class="p">)</span>
    <span class="n">offset_table</span> <span class="o">=</span> <span class="n">_SerializedDataOffsetTable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_zipfile</span><span class="p">,</span> <span class="n">stream_name</span><span class="p">)</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_serializers_profiler</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_serializers_profiler</span><span class="o">.</span><span class="n">StartTiming</span><span class="p">(</span><span class="s1">u&#39;write&#39;</span><span class="p">)</span>

    <span class="n">stream_name</span> <span class="o">=</span> <span class="s1">u&#39;error_data.{0:06d}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_error_stream_number</span><span class="p">)</span>
    <span class="n">data_stream</span> <span class="o">=</span> <span class="n">_SerializedDataStream</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_zipfile</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_path</span><span class="p">,</span> <span class="n">stream_name</span><span class="p">)</span>
    <span class="n">entry_data_offset</span> <span class="o">=</span> <span class="n">data_stream</span><span class="o">.</span><span class="n">WriteInitialize</span><span class="p">()</span>

    <span class="k">try</span><span class="p">:</span>
      <span class="k">for</span> <span class="n">entry_data</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_serialized_errors</span><span class="p">:</span>
        <span class="n">offset_table</span><span class="o">.</span><span class="n">AddOffset</span><span class="p">(</span><span class="n">entry_data_offset</span><span class="p">)</span>
        <span class="n">entry_data_offset</span> <span class="o">=</span> <span class="n">data_stream</span><span class="o">.</span><span class="n">WriteEntry</span><span class="p">(</span><span class="n">entry_data</span><span class="p">)</span>

    <span class="k">except</span><span class="p">:</span>
      <span class="n">data_stream</span><span class="o">.</span><span class="n">WriteAbort</span><span class="p">()</span>

      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_serializers_profiler</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_serializers_profiler</span><span class="o">.</span><span class="n">StopTiming</span><span class="p">(</span><span class="s1">u&#39;write&#39;</span><span class="p">)</span>

      <span class="k">raise</span>

    <span class="n">offset_table</span><span class="o">.</span><span class="n">Write</span><span class="p">()</span>
    <span class="n">data_stream</span><span class="o">.</span><span class="n">WriteFinalize</span><span class="p">()</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_serializers_profiler</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_serializers_profiler</span><span class="o">.</span><span class="n">StopTiming</span><span class="p">(</span><span class="s1">u&#39;write&#39;</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_error_stream_number</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_serialized_errors</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_serialized_errors_size</span> <span class="o">=</span> <span class="mi">0</span>

  <span class="k">def</span> <span class="nf">_WriteSerializedEvents</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Writes the serialized events to the storage file.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_serialized_events</span><span class="o">.</span><span class="n">data_size</span><span class="p">:</span>
      <span class="k">return</span>

    <span class="n">stream_name</span> <span class="o">=</span> <span class="s1">u&#39;event_index.{0:06d}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_event_stream_number</span><span class="p">)</span>
    <span class="n">offset_table</span> <span class="o">=</span> <span class="n">_SerializedDataOffsetTable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_zipfile</span><span class="p">,</span> <span class="n">stream_name</span><span class="p">)</span>

    <span class="n">stream_name</span> <span class="o">=</span> <span class="s1">u&#39;event_timestamps.{0:06d}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_event_stream_number</span><span class="p">)</span>
    <span class="n">timestamp_table</span> <span class="o">=</span> <span class="n">_SerializedDataTimestampTable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_zipfile</span><span class="p">,</span> <span class="n">stream_name</span><span class="p">)</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_serializers_profiler</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_serializers_profiler</span><span class="o">.</span><span class="n">StartTiming</span><span class="p">(</span><span class="s1">u&#39;write&#39;</span><span class="p">)</span>

    <span class="n">stream_name</span> <span class="o">=</span> <span class="s1">u&#39;event_data.{0:06d}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_event_stream_number</span><span class="p">)</span>
    <span class="n">data_stream</span> <span class="o">=</span> <span class="n">_SerializedDataStream</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_zipfile</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_path</span><span class="p">,</span> <span class="n">stream_name</span><span class="p">)</span>
    <span class="n">entry_data_offset</span> <span class="o">=</span> <span class="n">data_stream</span><span class="o">.</span><span class="n">WriteInitialize</span><span class="p">()</span>

    <span class="k">try</span><span class="p">:</span>
      <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_serialized_events</span><span class="o">.</span><span class="n">number_of_events</span><span class="p">):</span>
        <span class="n">timestamp</span><span class="p">,</span> <span class="n">entry_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_serialized_events</span><span class="o">.</span><span class="n">PopEvent</span><span class="p">()</span>

        <span class="n">timestamp_table</span><span class="o">.</span><span class="n">AddTimestamp</span><span class="p">(</span><span class="n">timestamp</span><span class="p">)</span>
        <span class="n">offset_table</span><span class="o">.</span><span class="n">AddOffset</span><span class="p">(</span><span class="n">entry_data_offset</span><span class="p">)</span>

        <span class="n">entry_data_offset</span> <span class="o">=</span> <span class="n">data_stream</span><span class="o">.</span><span class="n">WriteEntry</span><span class="p">(</span><span class="n">entry_data</span><span class="p">)</span>

    <span class="k">except</span><span class="p">:</span>
      <span class="n">data_stream</span><span class="o">.</span><span class="n">WriteAbort</span><span class="p">()</span>

      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_serializers_profiler</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_serializers_profiler</span><span class="o">.</span><span class="n">StopTiming</span><span class="p">(</span><span class="s1">u&#39;write&#39;</span><span class="p">)</span>

      <span class="k">raise</span>

    <span class="n">offset_table</span><span class="o">.</span><span class="n">Write</span><span class="p">()</span>
    <span class="n">data_stream</span><span class="o">.</span><span class="n">WriteFinalize</span><span class="p">()</span>
    <span class="n">timestamp_table</span><span class="o">.</span><span class="n">Write</span><span class="p">()</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_serializers_profiler</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_serializers_profiler</span><span class="o">.</span><span class="n">StopTiming</span><span class="p">(</span><span class="s1">u&#39;write&#39;</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_event_stream_number</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_serialized_events</span><span class="o">.</span><span class="n">Empty</span><span class="p">()</span>

  <span class="k">def</span> <span class="nf">_WriteSerializedEventSources</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Writes the serialized event sources to the storage file.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_serialized_event_sources_size</span><span class="p">:</span>
      <span class="k">return</span>

    <span class="n">stream_name</span> <span class="o">=</span> <span class="s1">u&#39;event_source_index.{0:06d}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_event_source_stream_number</span><span class="p">)</span>
    <span class="n">offset_table</span> <span class="o">=</span> <span class="n">_SerializedDataOffsetTable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_zipfile</span><span class="p">,</span> <span class="n">stream_name</span><span class="p">)</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_serializers_profiler</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_serializers_profiler</span><span class="o">.</span><span class="n">StartTiming</span><span class="p">(</span><span class="s1">u&#39;write&#39;</span><span class="p">)</span>

    <span class="n">stream_name</span> <span class="o">=</span> <span class="s1">u&#39;event_source_data.{0:06d}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_event_source_stream_number</span><span class="p">)</span>
    <span class="n">data_stream</span> <span class="o">=</span> <span class="n">_SerializedDataStream</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_zipfile</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_path</span><span class="p">,</span> <span class="n">stream_name</span><span class="p">)</span>
    <span class="n">entry_data_offset</span> <span class="o">=</span> <span class="n">data_stream</span><span class="o">.</span><span class="n">WriteInitialize</span><span class="p">()</span>

    <span class="k">try</span><span class="p">:</span>
      <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_serialized_event_sources</span><span class="p">)):</span>
        <span class="n">entry_data</span> <span class="o">=</span> <span class="n">heapq</span><span class="o">.</span><span class="n">heappop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_serialized_event_sources</span><span class="p">)</span>

        <span class="n">offset_table</span><span class="o">.</span><span class="n">AddOffset</span><span class="p">(</span><span class="n">entry_data_offset</span><span class="p">)</span>

        <span class="n">entry_data_offset</span> <span class="o">=</span> <span class="n">data_stream</span><span class="o">.</span><span class="n">WriteEntry</span><span class="p">(</span><span class="n">entry_data</span><span class="p">)</span>

    <span class="k">except</span><span class="p">:</span>
      <span class="n">data_stream</span><span class="o">.</span><span class="n">WriteAbort</span><span class="p">()</span>

      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_serializers_profiler</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_serializers_profiler</span><span class="o">.</span><span class="n">StopTiming</span><span class="p">(</span><span class="s1">u&#39;write&#39;</span><span class="p">)</span>

      <span class="k">raise</span>

    <span class="n">offset_table</span><span class="o">.</span><span class="n">Write</span><span class="p">()</span>
    <span class="n">data_stream</span><span class="o">.</span><span class="n">WriteFinalize</span><span class="p">()</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_serializers_profiler</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_serializers_profiler</span><span class="o">.</span><span class="n">StopTiming</span><span class="p">(</span><span class="s1">u&#39;write&#39;</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_event_source_stream_number</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_serialized_event_sources_size</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_serialized_event_sources</span> <span class="o">=</span> <span class="p">[]</span>

  <span class="k">def</span> <span class="nf">_WriteSerializedEventTags</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Writes the serialized event tags to the storage file.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_serialized_event_tags_size</span><span class="p">:</span>
      <span class="k">return</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format_version</span> <span class="o">&lt;=</span> <span class="mi">20160501</span><span class="p">:</span>
      <span class="n">stream_name_prefix</span> <span class="o">=</span> <span class="s1">u&#39;plaso_tag_index&#39;</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">stream_name_prefix</span> <span class="o">=</span> <span class="s1">u&#39;event_tag_index&#39;</span>

    <span class="n">stream_name</span> <span class="o">=</span> <span class="s1">u&#39;{0:s}.{1:06d}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">stream_name_prefix</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_event_tag_stream_number</span><span class="p">)</span>
    <span class="n">event_tag_index_table</span> <span class="o">=</span> <span class="n">_SerializedEventTagIndexTable</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_zipfile</span><span class="p">,</span> <span class="n">stream_name</span><span class="p">)</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_serializers_profiler</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_serializers_profiler</span><span class="o">.</span><span class="n">StartTiming</span><span class="p">(</span><span class="s1">u&#39;write&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format_version</span> <span class="o">&lt;=</span> <span class="mi">20160501</span><span class="p">:</span>
      <span class="n">stream_name_prefix</span> <span class="o">=</span> <span class="s1">u&#39;plaso_tagging&#39;</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">stream_name_prefix</span> <span class="o">=</span> <span class="s1">u&#39;event_tag_data&#39;</span>

    <span class="n">stream_name</span> <span class="o">=</span> <span class="s1">u&#39;{0:s}.{1:06d}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">stream_name_prefix</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_event_tag_stream_number</span><span class="p">)</span>
    <span class="n">data_stream</span> <span class="o">=</span> <span class="n">_SerializedDataStream</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_zipfile</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_path</span><span class="p">,</span> <span class="n">stream_name</span><span class="p">)</span>
    <span class="n">entry_data_offset</span> <span class="o">=</span> <span class="n">data_stream</span><span class="o">.</span><span class="n">WriteInitialize</span><span class="p">()</span>

    <span class="k">try</span><span class="p">:</span>
      <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_serialized_event_tags</span><span class="p">)):</span>
        <span class="n">heap_values</span> <span class="o">=</span> <span class="n">heapq</span><span class="o">.</span><span class="n">heappop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_serialized_event_tags</span><span class="p">)</span>
        <span class="n">store_number</span><span class="p">,</span> <span class="n">store_index</span><span class="p">,</span> <span class="n">event_uuid</span><span class="p">,</span> <span class="n">entry_data</span> <span class="o">=</span> <span class="n">heap_values</span>

        <span class="k">if</span> <span class="n">event_uuid</span><span class="p">:</span>
          <span class="n">tag_type</span> <span class="o">=</span> <span class="n">_EventTagIndexValue</span><span class="o">.</span><span class="n">TAG_TYPE_UUID</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="n">tag_type</span> <span class="o">=</span> <span class="n">_EventTagIndexValue</span><span class="o">.</span><span class="n">TAG_TYPE_NUMERIC</span>

        <span class="n">event_tag_index_table</span><span class="o">.</span><span class="n">AddEventTagIndex</span><span class="p">(</span>
            <span class="n">tag_type</span><span class="p">,</span> <span class="n">entry_data_offset</span><span class="p">,</span> <span class="n">event_uuid</span><span class="o">=</span><span class="n">event_uuid</span><span class="p">,</span>
            <span class="n">store_number</span><span class="o">=</span><span class="n">store_number</span><span class="p">,</span> <span class="n">store_index</span><span class="o">=</span><span class="n">store_index</span><span class="p">)</span>

        <span class="n">entry_data_offset</span> <span class="o">=</span> <span class="n">data_stream</span><span class="o">.</span><span class="n">WriteEntry</span><span class="p">(</span><span class="n">entry_data</span><span class="p">)</span>

    <span class="k">except</span><span class="p">:</span>
      <span class="n">data_stream</span><span class="o">.</span><span class="n">WriteAbort</span><span class="p">()</span>

      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_serializers_profiler</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_serializers_profiler</span><span class="o">.</span><span class="n">StopTiming</span><span class="p">(</span><span class="s1">u&#39;write&#39;</span><span class="p">)</span>

      <span class="k">raise</span>

    <span class="n">event_tag_index_table</span><span class="o">.</span><span class="n">Write</span><span class="p">()</span>
    <span class="n">data_stream</span><span class="o">.</span><span class="n">WriteFinalize</span><span class="p">()</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_serializers_profiler</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_serializers_profiler</span><span class="o">.</span><span class="n">StopTiming</span><span class="p">(</span><span class="s1">u&#39;write&#39;</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_event_tag_stream_number</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_serialized_event_tags_size</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_serialized_event_tags</span> <span class="o">=</span> <span class="p">[]</span>

  <span class="k">def</span> <span class="nf">_WriteStorageMetadata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Writes the storage metadata.&quot;&quot;&quot;</span>
    <span class="n">stream_name</span> <span class="o">=</span> <span class="s1">u&#39;metadata.txt&#39;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_HasStream</span><span class="p">(</span><span class="n">stream_name</span><span class="p">):</span>
      <span class="k">return</span>

    <span class="n">stream_data</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">b</span><span class="s1">&#39;[plaso_storage_file]</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="n">b</span><span class="s1">&#39;format_version: {0:d}</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="n">b</span><span class="s1">&#39;serialization_format: {1:s}</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="n">b</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_FORMAT_VERSION</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_serializer_format</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_WriteStream</span><span class="p">(</span><span class="n">stream_name</span><span class="p">,</span> <span class="n">stream_data</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">_WriteSessionCompletion</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session_completion</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Writes session completion information.</span>

<span class="sd">    Args:</span>
<span class="sd">      session_completion: the session completion information (instance of</span>
<span class="sd">                          SessionCompletion).</span>

<span class="sd">    Raises:</span>
<span class="sd">      IOError: if the session completion already exists.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">stream_name</span> <span class="o">=</span> <span class="s1">u&#39;session_completion.{0:06d}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_last_session</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_HasStream</span><span class="p">(</span><span class="n">stream_name</span><span class="p">):</span>
      <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s1">u&#39;Session completion: {0:06d} already exists.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">_last_session</span><span class="p">))</span>

    <span class="n">session_completion_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_WriteAttributeContainer</span><span class="p">(</span><span class="n">session_completion</span><span class="p">)</span>

    <span class="n">data_stream</span> <span class="o">=</span> <span class="n">_SerializedDataStream</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_zipfile</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_path</span><span class="p">,</span> <span class="n">stream_name</span><span class="p">)</span>
    <span class="n">data_stream</span><span class="o">.</span><span class="n">WriteInitialize</span><span class="p">()</span>
    <span class="n">data_stream</span><span class="o">.</span><span class="n">WriteEntry</span><span class="p">(</span><span class="n">session_completion_data</span><span class="p">)</span>
    <span class="n">data_stream</span><span class="o">.</span><span class="n">WriteFinalize</span><span class="p">()</span>

  <span class="k">def</span> <span class="nf">_WriteSessionStart</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session_start</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Writes session start information.</span>

<span class="sd">    Args:</span>
<span class="sd">      session_start: the session start information (instance of SessionStart).</span>

<span class="sd">    Raises:</span>
<span class="sd">      IOError: if the session start already exists.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">stream_name</span> <span class="o">=</span> <span class="s1">u&#39;session_start.{0:06d}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_last_session</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_HasStream</span><span class="p">(</span><span class="n">stream_name</span><span class="p">):</span>
      <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s1">u&#39;Session start: {0:06d} already exists.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">_last_session</span><span class="p">))</span>

    <span class="n">session_start_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_WriteAttributeContainer</span><span class="p">(</span><span class="n">session_start</span><span class="p">)</span>

    <span class="n">data_stream</span> <span class="o">=</span> <span class="n">_SerializedDataStream</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_zipfile</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_path</span><span class="p">,</span> <span class="n">stream_name</span><span class="p">)</span>
    <span class="n">data_stream</span><span class="o">.</span><span class="n">WriteInitialize</span><span class="p">()</span>
    <span class="n">data_stream</span><span class="o">.</span><span class="n">WriteEntry</span><span class="p">(</span><span class="n">session_start_data</span><span class="p">)</span>
    <span class="n">data_stream</span><span class="o">.</span><span class="n">WriteFinalize</span><span class="p">()</span>

  <span class="k">def</span> <span class="nf">_WriteStream</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stream_name</span><span class="p">,</span> <span class="n">stream_data</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Writes data to a stream.</span>

<span class="sd">    Args:</span>
<span class="sd">      stream_name: a string containing the name of the stream.</span>
<span class="sd">      stream_data: a byte string containing the data of the steam.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># TODO: this can raise an IOError e.g. &quot;Stale NFS file handle&quot;.</span>
    <span class="c1"># Determine if this be handled more error resiliently.</span>

    <span class="c1"># Prevent zipfile from generating &quot;UserWarning: Duplicate name:&quot;.</span>
    <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
      <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s1">u&#39;ignore&#39;</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_zipfile</span><span class="o">.</span><span class="n">writestr</span><span class="p">(</span><span class="n">stream_name</span><span class="p">,</span> <span class="n">stream_data</span><span class="p">)</span>

<div class="viewcode-block" id="ZIPStorageFile.AddAnalysisReport"><a class="viewcode-back" href="../../../plaso.storage.html#plaso.storage.zip_file.ZIPStorageFile.AddAnalysisReport">[docs]</a>  <span class="k">def</span> <span class="nf">AddAnalysisReport</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">analysis_report</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Adds an analysis report to the storage.</span>

<span class="sd">    Args:</span>
<span class="sd">      analysis_report: an analysis report object (instance of AnalysisReport).</span>

<span class="sd">    Raises:</span>
<span class="sd">      IOError: when the storage file is closed or read-only.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_open</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s1">u&#39;Unable to write to closed storage file.&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_only</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s1">u&#39;Unable to write to read-only storage file.&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format_version</span> <span class="o">&lt;=</span> <span class="mi">20160501</span><span class="p">:</span>
      <span class="n">stream_name_prefix</span> <span class="o">=</span> <span class="s1">u&#39;plaso_report.&#39;</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">stream_name_prefix</span> <span class="o">=</span> <span class="s1">u&#39;analysis_report_data.&#39;</span>

    <span class="n">report_number</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_GetStreamNames</span><span class="p">():</span>
      <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">stream_name_prefix</span><span class="p">):</span>

        <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">number_string</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="s1">u&#39;.&#39;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
          <span class="n">number</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">number_string</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
          <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">u&#39;Unable to read in report number.&#39;</span><span class="p">)</span>
          <span class="n">number</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">number</span> <span class="o">&gt;=</span> <span class="n">report_number</span><span class="p">:</span>
          <span class="n">report_number</span> <span class="o">=</span> <span class="n">number</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format_version</span> <span class="o">&lt;=</span> <span class="mi">20160501</span><span class="p">:</span>
      <span class="n">stream_name_prefix</span> <span class="o">=</span> <span class="s1">u&#39;plaso_report&#39;</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">stream_name_prefix</span> <span class="o">=</span> <span class="s1">u&#39;analysis_report_data&#39;</span>

    <span class="n">stream_name</span> <span class="o">=</span> <span class="s1">u&#39;{0:s}.{1:06}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">stream_name_prefix</span><span class="p">,</span> <span class="n">report_number</span><span class="p">)</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_serializers_profiler</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_serializers_profiler</span><span class="o">.</span><span class="n">StartTiming</span><span class="p">(</span><span class="s1">u&#39;analysis_report&#39;</span><span class="p">)</span>

    <span class="n">serialized_report</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_serializer</span><span class="o">.</span><span class="n">WriteSerialized</span><span class="p">(</span><span class="n">analysis_report</span><span class="p">)</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_serializers_profiler</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_serializers_profiler</span><span class="o">.</span><span class="n">StopTiming</span><span class="p">(</span><span class="s1">u&#39;analysis_report&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format_version</span> <span class="o">&lt;=</span> <span class="mi">20160501</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_WriteStream</span><span class="p">(</span><span class="n">stream_name</span><span class="p">,</span> <span class="n">serialized_report</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">data_stream</span> <span class="o">=</span> <span class="n">_SerializedDataStream</span><span class="p">(</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">_zipfile</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_path</span><span class="p">,</span> <span class="n">stream_name</span><span class="p">)</span>
      <span class="n">data_stream</span><span class="o">.</span><span class="n">WriteInitialize</span><span class="p">()</span>
      <span class="n">data_stream</span><span class="o">.</span><span class="n">WriteEntry</span><span class="p">(</span><span class="n">serialized_report</span><span class="p">)</span>
      <span class="n">data_stream</span><span class="o">.</span><span class="n">WriteFinalize</span><span class="p">()</span></div>

<div class="viewcode-block" id="ZIPStorageFile.AddError"><a class="viewcode-back" href="../../../plaso.storage.html#plaso.storage.zip_file.ZIPStorageFile.AddError">[docs]</a>  <span class="k">def</span> <span class="nf">AddError</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">error</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Adds an error to the storage.</span>

<span class="sd">    Args:</span>
<span class="sd">      error: an error (instance of AnalysisError or ExtractionError).</span>

<span class="sd">    Raises:</span>
<span class="sd">      IOError: when the storage file is closed or read-only or</span>
<span class="sd">               if the error cannot be serialized.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">error</span><span class="o">.</span><span class="n">storage_session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_session</span>

    <span class="c1"># We try to serialize the error first, so we can skip some</span>
    <span class="c1"># processing if it is invalid.</span>
    <span class="n">error_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_WriteAttributeContainer</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_serialized_errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">error_data</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_serialized_errors_size</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">error_data</span><span class="p">)</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_serialized_errors_size</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_max_buffer_size</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_WriteSerializedErrors</span><span class="p">()</span></div>

<div class="viewcode-block" id="ZIPStorageFile.AddEvent"><a class="viewcode-back" href="../../../plaso.storage.html#plaso.storage.zip_file.ZIPStorageFile.AddEvent">[docs]</a>  <span class="k">def</span> <span class="nf">AddEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event_object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Adds an event to the storage.</span>

<span class="sd">    Args:</span>
<span class="sd">      event_object: an event object (instance of EventObject).</span>

<span class="sd">    Raises:</span>
<span class="sd">      IOError: when the storage file is closed or read-only or</span>
<span class="sd">               if the event object cannot be serialized.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_open</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s1">u&#39;Unable to write to closed storage file.&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_only</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s1">u&#39;Unable to write to read-only storage file.&#39;</span><span class="p">)</span>

    <span class="c1"># We try to serialize the event object first, so we can skip some</span>
    <span class="c1"># processing if it is invalid.</span>
    <span class="n">event_object_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_WriteAttributeContainer</span><span class="p">(</span><span class="n">event_object</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_serialized_events</span><span class="o">.</span><span class="n">PushEvent</span><span class="p">(</span>
        <span class="n">event_object</span><span class="o">.</span><span class="n">timestamp</span><span class="p">,</span> <span class="n">event_object_data</span><span class="p">)</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_serialized_events</span><span class="o">.</span><span class="n">data_size</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_maximum_buffer_size</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_WriteSerializedEvents</span><span class="p">()</span></div>

<div class="viewcode-block" id="ZIPStorageFile.AddEventSource"><a class="viewcode-back" href="../../../plaso.storage.html#plaso.storage.zip_file.ZIPStorageFile.AddEventSource">[docs]</a>  <span class="k">def</span> <span class="nf">AddEventSource</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event_source</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Adds an event source to the storage.</span>

<span class="sd">    Args:</span>
<span class="sd">      event_source: an event source (instance of EventSource).</span>

<span class="sd">    Raises:</span>
<span class="sd">      IOError: when the storage file is closed or read-only or</span>
<span class="sd">               if the event source cannot be serialized.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_open</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s1">u&#39;Unable to write to closed storage file.&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_only</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s1">u&#39;Unable to write to read-only storage file.&#39;</span><span class="p">)</span>

    <span class="n">event_source</span><span class="o">.</span><span class="n">storage_session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_session</span>

    <span class="c1"># We try to serialize the event source first, so we can skip some</span>
    <span class="c1"># processing if it is invalid.</span>
    <span class="n">event_source_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_WriteAttributeContainer</span><span class="p">(</span><span class="n">event_source</span><span class="p">)</span>

    <span class="n">heapq</span><span class="o">.</span><span class="n">heappush</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_serialized_event_sources</span><span class="p">,</span> <span class="n">event_source_data</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_serialized_event_sources_size</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">event_source_data</span><span class="p">)</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_serialized_event_sources_size</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_maximum_buffer_size</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_WriteSerializedEventSources</span><span class="p">()</span></div>

<div class="viewcode-block" id="ZIPStorageFile.AddEventTag"><a class="viewcode-back" href="../../../plaso.storage.html#plaso.storage.zip_file.ZIPStorageFile.AddEventTag">[docs]</a>  <span class="k">def</span> <span class="nf">AddEventTag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event_tag</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Adds an event tag to the storage.</span>

<span class="sd">    Args:</span>
<span class="sd">      event_tag: an event tag (instance of EventTag).</span>

<span class="sd">    Raises:</span>
<span class="sd">      IOError: when the storage file is closed or read-only or</span>
<span class="sd">               if the event tag cannot be serialized.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_open</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s1">u&#39;Unable to write to closed storage file.&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_only</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s1">u&#39;Unable to write to read-only storage file.&#39;</span><span class="p">)</span>

    <span class="c1"># We try to serialize the event tag first, so we can skip some</span>
    <span class="c1"># processing if it is invalid.</span>
    <span class="n">event_tag_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_WriteAttributeContainer</span><span class="p">(</span><span class="n">event_tag</span><span class="p">)</span>

    <span class="n">event_uuid</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">event_tag</span><span class="p">,</span> <span class="s1">u&#39;event_uuid&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
    <span class="n">store_index</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">event_tag</span><span class="p">,</span> <span class="s1">u&#39;store_index&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
    <span class="n">store_number</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">event_tag</span><span class="p">,</span> <span class="s1">u&#39;store_number&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

    <span class="n">heap_values</span> <span class="o">=</span> <span class="p">(</span><span class="n">store_number</span><span class="p">,</span> <span class="n">store_index</span><span class="p">,</span> <span class="n">event_uuid</span><span class="p">,</span> <span class="n">event_tag_data</span><span class="p">)</span>
    <span class="n">heapq</span><span class="o">.</span><span class="n">heappush</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_serialized_event_tags</span><span class="p">,</span> <span class="n">heap_values</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_serialized_event_tags_size</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">event_tag_data</span><span class="p">)</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_serialized_event_tags_size</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_maximum_buffer_size</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_WriteSerializedEventSources</span><span class="p">()</span></div>

<div class="viewcode-block" id="ZIPStorageFile.AddEventTags"><a class="viewcode-back" href="../../../plaso.storage.html#plaso.storage.zip_file.ZIPStorageFile.AddEventTags">[docs]</a>  <span class="k">def</span> <span class="nf">AddEventTags</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event_tags</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Adds event tags to the storage.</span>

<span class="sd">    Args:</span>
<span class="sd">      event_tags: a list of event tags (instances of EventTag).</span>

<span class="sd">    Raises:</span>
<span class="sd">      IOError: when the storage file is closed or read-only or</span>
<span class="sd">               if the stream cannot be opened.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_open</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s1">u&#39;Unable to write to closed storage file.&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_only</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s1">u&#39;Unable to write to read-only storage file.&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_event_tag_index</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_BuildTagIndex</span><span class="p">()</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format_version</span> <span class="o">&lt;=</span> <span class="mi">20160501</span><span class="p">:</span>
      <span class="n">stream_name_prefix</span> <span class="o">=</span> <span class="s1">u&#39;plaso_tagging&#39;</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">stream_name_prefix</span> <span class="o">=</span> <span class="s1">u&#39;event_tag_data&#39;</span>

    <span class="k">for</span> <span class="n">event_tag</span> <span class="ow">in</span> <span class="n">event_tags</span><span class="p">:</span>
      <span class="n">tag_index_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_event_tag_index</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">event_tag</span><span class="o">.</span><span class="n">string_key</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

      <span class="c1"># This particular event has already been tagged on a previous occasion,</span>
      <span class="c1"># we need to make sure we are appending to that particular event tag.</span>
      <span class="k">if</span> <span class="n">tag_index_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">stream_name</span> <span class="o">=</span> <span class="s1">u&#39;{0:s}.{1:06d}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">stream_name_prefix</span><span class="p">,</span> <span class="n">tag_index_value</span><span class="o">.</span><span class="n">store_number</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_HasStream</span><span class="p">(</span><span class="n">stream_name</span><span class="p">):</span>
          <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s1">u&#39;No such stream: {0:s}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">stream_name</span><span class="p">))</span>

        <span class="n">data_stream</span> <span class="o">=</span> <span class="n">_SerializedDataStream</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_zipfile</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_path</span><span class="p">,</span> <span class="n">stream_name</span><span class="p">)</span>
        <span class="c1"># TODO: replace 0 by the actual event tag entry index.</span>
        <span class="c1"># This is for code consistency rather then a functional purpose.</span>
        <span class="n">data_stream</span><span class="o">.</span><span class="n">SeekEntryAtOffset</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">tag_index_value</span><span class="o">.</span><span class="n">offset</span><span class="p">)</span>

        <span class="c1"># TODO: if stored_event_tag is cached make sure to update cache</span>
        <span class="c1"># after write.</span>
        <span class="n">stored_event_tag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ReadAttributeContainerFromStreamEntry</span><span class="p">(</span>
            <span class="n">data_stream</span><span class="p">,</span> <span class="s1">u&#39;event_tag&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">stored_event_tag</span><span class="p">:</span>
          <span class="k">continue</span>

        <span class="n">event_tag</span><span class="o">.</span><span class="n">AddComment</span><span class="p">(</span><span class="n">stored_event_tag</span><span class="o">.</span><span class="n">comment</span><span class="p">)</span>
        <span class="n">event_tag</span><span class="o">.</span><span class="n">AddLabels</span><span class="p">(</span><span class="n">stored_event_tag</span><span class="o">.</span><span class="n">labels</span><span class="p">)</span>

      <span class="bp">self</span><span class="o">.</span><span class="n">AddEventTag</span><span class="p">(</span><span class="n">event_tag</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_WriteSerializedEventTags</span><span class="p">()</span>

    <span class="c1"># TODO: Update the tags that have changed in the index instead</span>
    <span class="c1"># of flushing the index.</span>

    <span class="c1"># If we already built a list of tag in memory we need to clear that</span>
    <span class="c1"># since the tags have changed.</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_event_tag_index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_event_tag_index</span> <span class="o">=</span> <span class="bp">None</span></div>

<div class="viewcode-block" id="ZIPStorageFile.Close"><a class="viewcode-back" href="../../../plaso.storage.html#plaso.storage.zip_file.ZIPStorageFile.Close">[docs]</a>  <span class="k">def</span> <span class="nf">Close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Closes the storage file.</span>

<span class="sd">    Buffered attribute containers are written to file.</span>

<span class="sd">    Raises:</span>
<span class="sd">      IOError: when trying to write to a closed storage file or</span>
<span class="sd">               if the event source cannot be serialized.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_open</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s1">u&#39;Unable to flush a closed storage file.&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_only</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">Flush</span><span class="p">()</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_serializers_profiler</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_serializers_profiler</span><span class="o">.</span><span class="n">Write</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_event_streams</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_event_offset_tables</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_event_offset_tables_lfu</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_event_timestamp_tables</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_event_timestamp_tables_lfu</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_zipfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_zipfile</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_is_open</span> <span class="o">=</span> <span class="bp">False</span></div>

<div class="viewcode-block" id="ZIPStorageFile.Flush"><a class="viewcode-back" href="../../../plaso.storage.html#plaso.storage.zip_file.ZIPStorageFile.Flush">[docs]</a>  <span class="k">def</span> <span class="nf">Flush</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Forces the serialized attribute containers to be written to file.</span>

<span class="sd">    Raises:</span>
<span class="sd">      IOError: when trying to write to a closed storage file or</span>
<span class="sd">               if the event source cannot be serialized.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_open</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s1">u&#39;Unable to flush a closed storage file.&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_only</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_WriteSerializedEventSources</span><span class="p">()</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_WriteSerializedEvents</span><span class="p">()</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_WriteSerializedEventTags</span><span class="p">()</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_WriteSerializedErrors</span><span class="p">()</span></div>

<div class="viewcode-block" id="ZIPStorageFile.GetAnalysisReports"><a class="viewcode-back" href="../../../plaso.storage.html#plaso.storage.zip_file.ZIPStorageFile.GetAnalysisReports">[docs]</a>  <span class="k">def</span> <span class="nf">GetAnalysisReports</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Retrieves the analysis reports.</span>

<span class="sd">    Yields:</span>
<span class="sd">      Analysis reports (instances of AnalysisReport).</span>

<span class="sd">    Raises:</span>
<span class="sd">      IOError: if the stream cannot be opened.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format_version</span> <span class="o">&lt;=</span> <span class="mi">20160501</span><span class="p">:</span>
      <span class="n">stream_name_prefix</span> <span class="o">=</span> <span class="s1">u&#39;plaso_report.&#39;</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">stream_name_prefix</span> <span class="o">=</span> <span class="s1">u&#39;analysis_report_data.&#39;</span>

    <span class="k">for</span> <span class="n">stream_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_GetStreamNames</span><span class="p">():</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="n">stream_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">stream_name_prefix</span><span class="p">):</span>
        <span class="k">continue</span>

      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format_version</span> <span class="o">&lt;=</span> <span class="mi">20160501</span><span class="p">:</span>
        <span class="n">file_object</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_OpenStream</span><span class="p">(</span><span class="n">stream_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">file_object</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
          <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s1">u&#39;Unable to open stream: {0:s}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">stream_name</span><span class="p">))</span>

        <span class="n">report_string</span> <span class="o">=</span> <span class="n">file_object</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_MAXIMUM_SERIALIZED_REPORT_SIZE</span><span class="p">)</span>
        <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">_serializer</span><span class="o">.</span><span class="n">ReadSerialized</span><span class="p">(</span><span class="n">report_string</span><span class="p">)</span>

      <span class="k">else</span><span class="p">:</span>
        <span class="n">data_stream</span> <span class="o">=</span> <span class="n">_SerializedDataStream</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_zipfile</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_path</span><span class="p">,</span> <span class="n">stream_name</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">analysis_report</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ReadAttributeContainersFromStream</span><span class="p">(</span>
            <span class="n">data_stream</span><span class="p">,</span> <span class="s1">u&#39;analysis_report&#39;</span><span class="p">):</span>
          <span class="k">yield</span> <span class="n">analysis_report</span></div>

<div class="viewcode-block" id="ZIPStorageFile.GetEventSources"><a class="viewcode-back" href="../../../plaso.storage.html#plaso.storage.zip_file.ZIPStorageFile.GetEventSources">[docs]</a>  <span class="k">def</span> <span class="nf">GetEventSources</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Retrieves the event sources.</span>

<span class="sd">    Yields:</span>
<span class="sd">      Event sources (instances of EventSource).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">stream_name_prefix</span> <span class="o">=</span> <span class="s1">u&#39;event_source_data.&#39;</span>

    <span class="k">for</span> <span class="n">stream_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_GetStreamNames</span><span class="p">():</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="n">stream_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">stream_name_prefix</span><span class="p">):</span>
        <span class="k">continue</span>

      <span class="n">data_stream</span> <span class="o">=</span> <span class="n">_SerializedDataStream</span><span class="p">(</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">_zipfile</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_path</span><span class="p">,</span> <span class="n">stream_name</span><span class="p">)</span>

      <span class="k">for</span> <span class="n">event_source</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ReadAttributeContainersFromStream</span><span class="p">(</span>
          <span class="n">data_stream</span><span class="p">,</span> <span class="s1">u&#39;event_source&#39;</span><span class="p">):</span>
        <span class="k">yield</span> <span class="n">event_source</span></div>

<div class="viewcode-block" id="ZIPStorageFile.GetEventSourcesCurrentSession"><a class="viewcode-back" href="../../../plaso.storage.html#plaso.storage.zip_file.ZIPStorageFile.GetEventSourcesCurrentSession">[docs]</a>  <span class="k">def</span> <span class="nf">GetEventSourcesCurrentSession</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Retrieves the event sources of the current session.</span>

<span class="sd">    Yields:</span>
<span class="sd">      Event sources (instances of EventSource).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">stream_name_prefix</span> <span class="o">=</span> <span class="s1">u&#39;event_source_data.&#39;</span>

    <span class="k">for</span> <span class="n">stream_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_GetStreamNames</span><span class="p">():</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="n">stream_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">stream_name_prefix</span><span class="p">):</span>
        <span class="k">continue</span>

      <span class="n">data_stream</span> <span class="o">=</span> <span class="n">_SerializedDataStream</span><span class="p">(</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">_zipfile</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_path</span><span class="p">,</span> <span class="n">stream_name</span><span class="p">)</span>

      <span class="k">for</span> <span class="n">event_source</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ReadAttributeContainersFromStream</span><span class="p">(</span>
          <span class="n">data_stream</span><span class="p">,</span> <span class="s1">u&#39;event_source&#39;</span><span class="p">):</span>
        <span class="k">yield</span> <span class="n">event_source</span></div>

<div class="viewcode-block" id="ZIPStorageFile.GetEventTags"><a class="viewcode-back" href="../../../plaso.storage.html#plaso.storage.zip_file.ZIPStorageFile.GetEventTags">[docs]</a>  <span class="k">def</span> <span class="nf">GetEventTags</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Retrieves the event tags.</span>

<span class="sd">    Yields:</span>
<span class="sd">      Event tags (instances of EventTag).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format_version</span> <span class="o">&lt;=</span> <span class="mi">20160501</span><span class="p">:</span>
      <span class="n">stream_name_prefix</span> <span class="o">=</span> <span class="s1">u&#39;plaso_tagging.&#39;</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">stream_name_prefix</span> <span class="o">=</span> <span class="s1">u&#39;event_tag_data.&#39;</span>

    <span class="k">for</span> <span class="n">stream_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_GetStreamNames</span><span class="p">():</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="n">stream_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">stream_name_prefix</span><span class="p">):</span>
        <span class="k">continue</span>

      <span class="n">data_stream</span> <span class="o">=</span> <span class="n">_SerializedDataStream</span><span class="p">(</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">_zipfile</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_path</span><span class="p">,</span> <span class="n">stream_name</span><span class="p">)</span>

      <span class="k">for</span> <span class="n">event_tag</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ReadAttributeContainersFromStream</span><span class="p">(</span>
          <span class="n">data_stream</span><span class="p">,</span> <span class="s1">u&#39;event_tag&#39;</span><span class="p">):</span>
        <span class="k">yield</span> <span class="n">event_tag</span></div>

<div class="viewcode-block" id="ZIPStorageFile.GetSessions"><a class="viewcode-back" href="../../../plaso.storage.html#plaso.storage.zip_file.ZIPStorageFile.GetSessions">[docs]</a>  <span class="k">def</span> <span class="nf">GetSessions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Retrieves the sessions.</span>

<span class="sd">    Yields:</span>
<span class="sd">      Tuples of a session start (instance of SessionStart) and</span>
<span class="sd">      a session completion (instance of SessionCompletion) object.</span>
<span class="sd">      The session completion value can be None if not available.</span>

<span class="sd">    Raises:</span>
<span class="sd">      IOError: if a session start stream is missing.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">stream_number</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_session</span><span class="p">):</span>
      <span class="n">stream_name</span> <span class="o">=</span> <span class="s1">u&#39;session_start.{0:06d}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">stream_number</span><span class="p">)</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_HasStream</span><span class="p">(</span><span class="n">stream_name</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s1">u&#39;No such stream: {0:s}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">stream_name</span><span class="p">))</span>

      <span class="n">data_stream</span> <span class="o">=</span> <span class="n">_SerializedDataStream</span><span class="p">(</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">_zipfile</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_path</span><span class="p">,</span> <span class="n">stream_name</span><span class="p">)</span>

      <span class="n">session_start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ReadAttributeContainerFromStreamEntry</span><span class="p">(</span>
          <span class="n">data_stream</span><span class="p">,</span> <span class="s1">u&#39;session_start&#39;</span><span class="p">)</span>

      <span class="n">session_completion</span> <span class="o">=</span> <span class="bp">None</span>
      <span class="n">stream_name</span> <span class="o">=</span> <span class="s1">u&#39;session_completion.{0:06d}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">stream_number</span><span class="p">)</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_HasStream</span><span class="p">(</span><span class="n">stream_name</span><span class="p">):</span>
        <span class="n">data_stream</span> <span class="o">=</span> <span class="n">_SerializedDataStream</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_zipfile</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_path</span><span class="p">,</span> <span class="n">stream_name</span><span class="p">)</span>

        <span class="n">session_completion</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ReadAttributeContainerFromStreamEntry</span><span class="p">(</span>
            <span class="n">data_stream</span><span class="p">,</span> <span class="s1">u&#39;session_completion&#39;</span><span class="p">)</span>

        <span class="k">yield</span> <span class="n">session_start</span><span class="p">,</span> <span class="n">session_completion</span></div>

<div class="viewcode-block" id="ZIPStorageFile.GetSortedEntry"><a class="viewcode-back" href="../../../plaso.storage.html#plaso.storage.zip_file.ZIPStorageFile.GetSortedEntry">[docs]</a>  <span class="k">def</span> <span class="nf">GetSortedEntry</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">time_range</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Retrieves a sorted entry.</span>

<span class="sd">    Args:</span>
<span class="sd">      time_range: an optional time range object (instance of TimeRange).</span>

<span class="sd">    Returns:</span>
<span class="sd">      An event object (instance of EventObject).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_event_heap</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_InitializeMergeBuffer</span><span class="p">(</span><span class="n">time_range</span><span class="o">=</span><span class="n">time_range</span><span class="p">)</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_event_heap</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="n">event_object</span><span class="p">,</span> <span class="n">stream_number</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_event_heap</span><span class="o">.</span><span class="n">PopEvent</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">event_object</span><span class="p">:</span>
      <span class="k">return</span>

    <span class="c1"># Stop as soon as we hit the upper bound.</span>
    <span class="k">if</span> <span class="n">time_range</span> <span class="ow">and</span> <span class="n">event_object</span><span class="o">.</span><span class="n">timestamp</span> <span class="o">&gt;</span> <span class="n">time_range</span><span class="o">.</span><span class="n">end_timestamp</span><span class="p">:</span>
      <span class="k">return</span>

    <span class="n">next_event_object</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_GetEventObject</span><span class="p">(</span><span class="n">stream_number</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">next_event_object</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_event_heap</span><span class="o">.</span><span class="n">PushEvent</span><span class="p">(</span>
          <span class="n">next_event_object</span><span class="p">,</span> <span class="n">stream_number</span><span class="p">,</span> <span class="n">event_object</span><span class="o">.</span><span class="n">store_index</span><span class="p">)</span>

      <span class="n">reference_timestamp</span> <span class="o">=</span> <span class="n">next_event_object</span><span class="o">.</span><span class="n">timestamp</span>
      <span class="k">while</span> <span class="n">next_event_object</span><span class="o">.</span><span class="n">timestamp</span> <span class="o">==</span> <span class="n">reference_timestamp</span><span class="p">:</span>
        <span class="n">next_event_object</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_GetEventObject</span><span class="p">(</span><span class="n">stream_number</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">next_event_object</span><span class="p">:</span>
          <span class="k">break</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_event_heap</span><span class="o">.</span><span class="n">PushEvent</span><span class="p">(</span>
            <span class="n">next_event_object</span><span class="p">,</span> <span class="n">stream_number</span><span class="p">,</span> <span class="n">event_object</span><span class="o">.</span><span class="n">store_index</span><span class="p">)</span>

    <span class="n">event_object</span><span class="o">.</span><span class="n">tag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ReadEventTagByIdentifier</span><span class="p">(</span>
        <span class="n">event_object</span><span class="o">.</span><span class="n">store_number</span><span class="p">,</span> <span class="n">event_object</span><span class="o">.</span><span class="n">store_index</span><span class="p">,</span> <span class="n">event_object</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">event_object</span></div>

<div class="viewcode-block" id="ZIPStorageFile.HasAnalysisReports"><a class="viewcode-back" href="../../../plaso.storage.html#plaso.storage.zip_file.ZIPStorageFile.HasAnalysisReports">[docs]</a>  <span class="k">def</span> <span class="nf">HasAnalysisReports</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Determines if a storage contains analysis reports.</span>

<span class="sd">    Returns:</span>
<span class="sd">      A boolean value indicating if the storage contains analysis reports.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format_version</span> <span class="o">&lt;=</span> <span class="mi">20160501</span><span class="p">:</span>
      <span class="n">stream_name_prefix</span> <span class="o">=</span> <span class="s1">u&#39;plaso_report.&#39;</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">stream_name_prefix</span> <span class="o">=</span> <span class="s1">u&#39;analysis_report_data.&#39;</span>

    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_GetStreamNames</span><span class="p">():</span>
      <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">stream_name_prefix</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">True</span>

    <span class="k">return</span> <span class="bp">False</span></div>

<div class="viewcode-block" id="ZIPStorageFile.HasEventTags"><a class="viewcode-back" href="../../../plaso.storage.html#plaso.storage.zip_file.ZIPStorageFile.HasEventTags">[docs]</a>  <span class="k">def</span> <span class="nf">HasEventTags</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Determines if a storage contains event tags.</span>

<span class="sd">    Returns:</span>
<span class="sd">      A boolean value indicating if the storage contains event tags.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format_version</span> <span class="o">&lt;=</span> <span class="mi">20160501</span><span class="p">:</span>
      <span class="n">stream_name_prefix</span> <span class="o">=</span> <span class="s1">u&#39;plaso_tagging.&#39;</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">stream_name_prefix</span> <span class="o">=</span> <span class="s1">u&#39;event_tag_data.&#39;</span>

    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_GetStreamNames</span><span class="p">():</span>
      <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">stream_name_prefix</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">True</span>

    <span class="k">return</span> <span class="bp">False</span></div>

<div class="viewcode-block" id="ZIPStorageFile.Open"><a class="viewcode-back" href="../../../plaso.storage.html#plaso.storage.zip_file.ZIPStorageFile.Open">[docs]</a>  <span class="k">def</span> <span class="nf">Open</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">read_only</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="o">**</span><span class="n">unused_kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Opens the storage file.</span>

<span class="sd">    Args:</span>
<span class="sd">      path: optional string containing the path of the storage file.</span>
<span class="sd">      read_only: optional boolean value to indicate if the file should be</span>
<span class="sd">                 opened in read-only mode.</span>

<span class="sd">    Raises:</span>
<span class="sd">      ValueError: if path is missing.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">u&#39;Missing path.&#39;</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_OpenZIPFile</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">read_only</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_OpenRead</span><span class="p">()</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">read_only</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_OpenWrite</span><span class="p">()</span></div>

<div class="viewcode-block" id="ZIPStorageFile.WriteSessionCompletion"><a class="viewcode-back" href="../../../plaso.storage.html#plaso.storage.zip_file.ZIPStorageFile.WriteSessionCompletion">[docs]</a>  <span class="k">def</span> <span class="nf">WriteSessionCompletion</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session_completion</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Writes session completion information.</span>

<span class="sd">    Args:</span>
<span class="sd">      session_completion: the session completion information (instance of</span>
<span class="sd">                          SessionCompletion).</span>

<span class="sd">    Raises:</span>
<span class="sd">      IOError: when the storage file is closed or read-only.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_open</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s1">u&#39;Unable to write to closed storage file.&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_only</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s1">u&#39;Unable to write to read-only storage file.&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format_version</span> <span class="o">&lt;</span> <span class="mi">20160511</span><span class="p">:</span>
      <span class="k">return</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">Flush</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_WriteSessionCompletion</span><span class="p">(</span><span class="n">session_completion</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_last_session</span> <span class="o">+=</span> <span class="mi">1</span></div>

<div class="viewcode-block" id="ZIPStorageFile.WriteSessionStart"><a class="viewcode-back" href="../../../plaso.storage.html#plaso.storage.zip_file.ZIPStorageFile.WriteSessionStart">[docs]</a>  <span class="k">def</span> <span class="nf">WriteSessionStart</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session_start</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Writes session start information.</span>

<span class="sd">    Args:</span>
<span class="sd">      session_start: the session start information (instance of SessionStart).</span>

<span class="sd">    Raises:</span>
<span class="sd">      IOError: when the storage file is closed or read-only.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_open</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s1">u&#39;Unable to write to closed storage file.&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_only</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s1">u&#39;Unable to write to read-only storage file.&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format_version</span> <span class="o">&lt;</span> <span class="mi">20160511</span><span class="p">:</span>
      <span class="k">return</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_WriteSessionStart</span><span class="p">(</span><span class="n">session_start</span><span class="p">)</span></div></div>


<span class="c1"># TODO: remove StorageFile.</span>
<div class="viewcode-block" id="StorageFile"><a class="viewcode-back" href="../../../plaso.storage.html#plaso.storage.zip_file.StorageFile">[docs]</a><span class="k">class</span> <span class="nc">StorageFile</span><span class="p">(</span><span class="n">ZIPStorageFile</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Class that defines the ZIP-based storage file.&quot;&quot;&quot;</span>

  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_file</span><span class="p">,</span> <span class="n">buffer_size</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">read_only</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Initializes the storage file.</span>

<span class="sd">    Args:</span>
<span class="sd">      output_file: a string containing the name of the output file.</span>
<span class="sd">      buffer_size: optional maximum size of a single storage file.</span>
<span class="sd">                   The default is 0, which indicates the limit is</span>
<span class="sd">                   _MAXIMUM_BUFFER_SIZE.</span>
<span class="sd">      read_only: optional boolean to indicate we are opening the storage file</span>
<span class="sd">                 for reading only.</span>

<span class="sd">    Raises:</span>
<span class="sd">      IOError: if we open the file in read only mode and the file does</span>
<span class="sd">               not exist.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">super</span><span class="p">(</span><span class="n">StorageFile</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_maximum_buffer_size</span> <span class="o">=</span> <span class="n">buffer_size</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_MAXIMUM_BUFFER_SIZE</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_preprocess_object_serializer</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">json_serializer</span><span class="o">.</span><span class="n">JSONPreprocessObjectSerializer</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="n">read_only</span><span class="o">=</span><span class="n">read_only</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">_ReadPreprocessObject</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_stream</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Reads a preprocessing object.</span>

<span class="sd">    Args:</span>
<span class="sd">      data_stream: the data stream object (instance of _SerializedDataStream).</span>

<span class="sd">    Returns:</span>
<span class="sd">      An preprocessing object (instance of PreprocessObject) or None if the</span>
<span class="sd">      preprocessing object cannot be read.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">preprocess_data</span> <span class="o">=</span> <span class="n">data_stream</span><span class="o">.</span><span class="n">ReadEntry</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">preprocess_data</span><span class="p">:</span>
      <span class="k">return</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_serializers_profiler</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_serializers_profiler</span><span class="o">.</span><span class="n">StartTiming</span><span class="p">(</span><span class="s1">u&#39;preprocess_object&#39;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
      <span class="n">preprocess_object</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_preprocess_object_serializer</span><span class="o">.</span><span class="n">ReadSerialized</span><span class="p">(</span>
          <span class="n">preprocess_data</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">errors</span><span class="o">.</span><span class="n">SerializationError</span> <span class="k">as</span> <span class="n">exception</span><span class="p">:</span>
      <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">exception</span><span class="p">)</span>
      <span class="n">preprocess_object</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_serializers_profiler</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_serializers_profiler</span><span class="o">.</span><span class="n">StopTiming</span><span class="p">(</span><span class="s1">u&#39;preprocess_object&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">preprocess_object</span>

<div class="viewcode-block" id="StorageFile.GetStorageInformation"><a class="viewcode-back" href="../../../plaso.storage.html#plaso.storage.zip_file.StorageFile.GetStorageInformation">[docs]</a>  <span class="k">def</span> <span class="nf">GetStorageInformation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Retrieves storage (preprocessing) information stored in the storage file.</span>

<span class="sd">    Returns:</span>
<span class="sd">      A list of preprocessing objects (instances of PreprocessingObject)</span>
<span class="sd">      that contain the storage information.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">stream_name</span> <span class="o">=</span> <span class="s1">u&#39;information.dump&#39;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_HasStream</span><span class="p">(</span><span class="n">stream_name</span><span class="p">):</span>
      <span class="k">return</span> <span class="p">[]</span>

    <span class="n">data_stream</span> <span class="o">=</span> <span class="n">_SerializedDataStream</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_zipfile</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_path</span><span class="p">,</span> <span class="n">stream_name</span><span class="p">)</span>

    <span class="n">information</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">preprocess_object</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ReadPreprocessObject</span><span class="p">(</span><span class="n">data_stream</span><span class="p">)</span>
    <span class="k">while</span> <span class="n">preprocess_object</span><span class="p">:</span>
      <span class="n">information</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">preprocess_object</span><span class="p">)</span>
      <span class="n">preprocess_object</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ReadPreprocessObject</span><span class="p">(</span><span class="n">data_stream</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">information</span></div>

<div class="viewcode-block" id="StorageFile.WritePreprocessObject"><a class="viewcode-back" href="../../../plaso.storage.html#plaso.storage.zip_file.StorageFile.WritePreprocessObject">[docs]</a>  <span class="k">def</span> <span class="nf">WritePreprocessObject</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">preprocess_object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Writes a preprocess object to the storage file.</span>

<span class="sd">    Args:</span>
<span class="sd">      preprocess_object: the preprocess object (instance of PreprocessObject).</span>

<span class="sd">    Raises:</span>
<span class="sd">      IOError: when the storage file is closed or read-only or</span>
<span class="sd">               if the stream cannot be opened.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_open</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s1">u&#39;Unable to write to closed storage file.&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_only</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s1">u&#39;Unable to write to read-only storage file.&#39;</span><span class="p">)</span>

    <span class="n">stream_name</span> <span class="o">=</span> <span class="s1">u&#39;information.dump&#39;</span>
    <span class="n">existing_stream_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ReadStream</span><span class="p">(</span><span class="n">stream_name</span><span class="p">)</span>

    <span class="c1"># Store information about store range for this particular</span>
    <span class="c1"># preprocessing object. This will determine which stores</span>
    <span class="c1"># this information is applicable for.</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_serializers_profiler</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_serializers_profiler</span><span class="o">.</span><span class="n">StartTiming</span><span class="p">(</span><span class="s1">u&#39;preprocess_object&#39;</span><span class="p">)</span>

    <span class="n">preprocess_object_data</span> <span class="o">=</span> <span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_preprocess_object_serializer</span><span class="o">.</span><span class="n">WriteSerialized</span><span class="p">(</span><span class="n">preprocess_object</span><span class="p">))</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_serializers_profiler</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_serializers_profiler</span><span class="o">.</span><span class="n">StopTiming</span><span class="p">(</span><span class="s1">u&#39;preprocess_object&#39;</span><span class="p">)</span>

    <span class="c1"># TODO: use _SerializedDataStream.</span>
    <span class="n">preprocess_object_data_size</span> <span class="o">=</span> <span class="n">construct</span><span class="o">.</span><span class="n">ULInt32</span><span class="p">(</span><span class="s1">u&#39;size&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">build</span><span class="p">(</span>
        <span class="nb">len</span><span class="p">(</span><span class="n">preprocess_object_data</span><span class="p">))</span>
    <span class="n">stream_data</span> <span class="o">=</span> <span class="n">b</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span>
        <span class="n">existing_stream_data</span><span class="p">,</span> <span class="n">preprocess_object_data_size</span><span class="p">,</span>
        <span class="n">preprocess_object_data</span><span class="p">])</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_WriteStream</span><span class="p">(</span><span class="n">stream_name</span><span class="p">,</span> <span class="n">stream_data</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="ZIPStorageFileReader"><a class="viewcode-back" href="../../../plaso.storage.html#plaso.storage.zip_file.ZIPStorageFileReader">[docs]</a><span class="k">class</span> <span class="nc">ZIPStorageFileReader</span><span class="p">(</span><span class="n">interface</span><span class="o">.</span><span class="n">StorageReader</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Class that implements the ZIP-based storage file reader.&quot;&quot;&quot;</span>

  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zip_storage_file</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Initializes a storage reader object.</span>

<span class="sd">    Args:</span>
<span class="sd">      zip_storage_file: a ZIP-based storage file (instance of ZIPStorageFile).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">super</span><span class="p">(</span><span class="n">ZIPStorageFileReader</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_zip_storage_file</span> <span class="o">=</span> <span class="n">zip_storage_file</span>

<div class="viewcode-block" id="ZIPStorageFileReader.__exit__"><a class="viewcode-back" href="../../../plaso.storage.html#plaso.storage.zip_file.ZIPStorageFileReader.__exit__">[docs]</a>  <span class="k">def</span> <span class="nf">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">unused_type</span><span class="p">,</span> <span class="n">unused_value</span><span class="p">,</span> <span class="n">unused_traceback</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Make usable with &quot;with&quot; statement.&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_zip_storage_file</span><span class="o">.</span><span class="n">Close</span><span class="p">()</span></div>

<div class="viewcode-block" id="ZIPStorageFileReader.GetEvents"><a class="viewcode-back" href="../../../plaso.storage.html#plaso.storage.zip_file.ZIPStorageFileReader.GetEvents">[docs]</a>  <span class="k">def</span> <span class="nf">GetEvents</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">time_range</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Retrieves events.</span>

<span class="sd">    Args:</span>
<span class="sd">      time_range: an optional time range object (instance of TimeRange).</span>

<span class="sd">    Yields:</span>
<span class="sd">      Event objects (instances of EventObject).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">event_object</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_zip_storage_file</span><span class="o">.</span><span class="n">GetSortedEntry</span><span class="p">(</span>
        <span class="n">time_range</span><span class="o">=</span><span class="n">time_range</span><span class="p">)</span>

    <span class="k">while</span> <span class="n">event_object</span><span class="p">:</span>
      <span class="k">yield</span> <span class="n">event_object</span>
      <span class="n">event_object</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_zip_storage_file</span><span class="o">.</span><span class="n">GetSortedEntry</span><span class="p">(</span>
          <span class="n">time_range</span><span class="o">=</span><span class="n">time_range</span><span class="p">)</span></div>

<div class="viewcode-block" id="ZIPStorageFileReader.GetEventSources"><a class="viewcode-back" href="../../../plaso.storage.html#plaso.storage.zip_file.ZIPStorageFileReader.GetEventSources">[docs]</a>  <span class="k">def</span> <span class="nf">GetEventSources</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Retrieves event sources.</span>

<span class="sd">    Returns:</span>
<span class="sd">      A generator of event source objects (instances of EventSourceObject).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_zip_storage_file</span><span class="o">.</span><span class="n">GetEventSources</span><span class="p">()</span></div></div>


<div class="viewcode-block" id="ZIPStorageFileWriter"><a class="viewcode-back" href="../../../plaso.storage.html#plaso.storage.zip_file.ZIPStorageFileWriter">[docs]</a><span class="k">class</span> <span class="nc">ZIPStorageFileWriter</span><span class="p">(</span><span class="n">interface</span><span class="o">.</span><span class="n">StorageWriter</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Class that implements the ZIP-based storage file writer.</span>

<span class="sd">  Attributes:</span>
<span class="sd">    reports_counter: a counter containing the number of reports (instance of</span>
<span class="sd">                     collections.Counter).</span>
<span class="sd">  &quot;&quot;&quot;</span>

  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_file</span><span class="p">,</span> <span class="n">buffer_size</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Initializes a storage writer object.</span>

<span class="sd">    Args:</span>
<span class="sd">      output_file: a string containing the path to the output file.</span>
<span class="sd">      buffer_size: optional integer containing the estimated size of</span>
<span class="sd">                   a protobuf file.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">super</span><span class="p">(</span><span class="n">ZIPStorageFileWriter</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_buffer_size</span> <span class="o">=</span> <span class="n">buffer_size</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_event_tags</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_output_file</span> <span class="o">=</span> <span class="n">output_file</span>
    <span class="c1"># Counter containing the number of events per parser.</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_parsers_counter</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">Counter</span><span class="p">()</span>
    <span class="c1"># Counter containing the number of events per parser plugin.</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_parser_plugins_counter</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">Counter</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_session_identifier</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_storage_file</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="c1"># Counter containing the number of tags per label.</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_tags_counter</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">Counter</span><span class="p">()</span>

    <span class="c1"># Counter containing the number of reports.</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">reports_counter</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">Counter</span><span class="p">()</span>

  <span class="k">def</span> <span class="nf">_UpdateCounters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event_object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Updates the counters.</span>

<span class="sd">    Args:</span>
<span class="sd">      event_object: an event object (instance of EventObject).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_parsers_counter</span><span class="p">[</span><span class="s1">u&#39;total&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="n">parser_name</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">event_object</span><span class="p">,</span> <span class="s1">u&#39;parser&#39;</span><span class="p">,</span> <span class="s1">u&#39;N/A&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_parsers_counter</span><span class="p">[</span><span class="n">parser_name</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="c1"># TODO: remove plugin, add parser chain.</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">event_object</span><span class="p">,</span> <span class="s1">u&#39;plugin&#39;</span><span class="p">):</span>
      <span class="n">plugin_name</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">event_object</span><span class="p">,</span> <span class="s1">u&#39;plugin&#39;</span><span class="p">,</span> <span class="s1">u&#39;N/A&#39;</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_parser_plugins_counter</span><span class="p">[</span><span class="n">plugin_name</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

<div class="viewcode-block" id="ZIPStorageFileWriter.AddAnalysisReport"><a class="viewcode-back" href="../../../plaso.storage.html#plaso.storage.zip_file.ZIPStorageFileWriter.AddAnalysisReport">[docs]</a>  <span class="k">def</span> <span class="nf">AddAnalysisReport</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">analysis_report</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Adds an analysis report to the storage.</span>

<span class="sd">    Args:</span>
<span class="sd">      analysis_report: an analysis report object (instance of AnalysisReport).</span>

<span class="sd">    Raises:</span>
<span class="sd">      IOError: when the storage writer is closed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_storage_file</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s1">u&#39;Unable to write to closed storage writer.&#39;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">event_tag</span> <span class="ow">in</span> <span class="n">analysis_report</span><span class="o">.</span><span class="n">GetTags</span><span class="p">():</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">AddEventTag</span><span class="p">(</span><span class="n">event_tag</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_storage_file</span><span class="o">.</span><span class="n">AddAnalysisReport</span><span class="p">(</span><span class="n">analysis_report</span><span class="p">)</span>

    <span class="n">report_identifier</span> <span class="o">=</span> <span class="s1">u&#39;Report: {0:s}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">analysis_report</span><span class="o">.</span><span class="n">plugin_name</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">reports_counter</span><span class="p">[</span><span class="s1">u&#39;Total Reports&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">reports_counter</span><span class="p">[</span><span class="n">report_identifier</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span></div>

<div class="viewcode-block" id="ZIPStorageFileWriter.AddError"><a class="viewcode-back" href="../../../plaso.storage.html#plaso.storage.zip_file.ZIPStorageFileWriter.AddError">[docs]</a>  <span class="k">def</span> <span class="nf">AddError</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">error</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Adds an error to the storage.</span>

<span class="sd">    Args:</span>
<span class="sd">      error: an error object (instance of AnalysisError or ExtractionError).</span>

<span class="sd">    Raises:</span>
<span class="sd">      IOError: when the storage writer is closed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_storage_file</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s1">u&#39;Unable to write to closed storage writer.&#39;</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_storage_file</span><span class="o">.</span><span class="n">AddError</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">number_of_errors</span> <span class="o">+=</span> <span class="mi">1</span></div>

<div class="viewcode-block" id="ZIPStorageFileWriter.AddEvent"><a class="viewcode-back" href="../../../plaso.storage.html#plaso.storage.zip_file.ZIPStorageFileWriter.AddEvent">[docs]</a>  <span class="k">def</span> <span class="nf">AddEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event_object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Adds an event to the storage.</span>

<span class="sd">    Args:</span>
<span class="sd">      event_object: an event object (instance of EventObject).</span>

<span class="sd">    Raises:</span>
<span class="sd">      IOError: when the storage writer is closed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_storage_file</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s1">u&#39;Unable to write to closed storage writer.&#39;</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_storage_file</span><span class="o">.</span><span class="n">AddEvent</span><span class="p">(</span><span class="n">event_object</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">number_of_events</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_UpdateCounters</span><span class="p">(</span><span class="n">event_object</span><span class="p">)</span></div>

<div class="viewcode-block" id="ZIPStorageFileWriter.AddEventSource"><a class="viewcode-back" href="../../../plaso.storage.html#plaso.storage.zip_file.ZIPStorageFileWriter.AddEventSource">[docs]</a>  <span class="k">def</span> <span class="nf">AddEventSource</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event_source</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Adds an event source to the storage.</span>

<span class="sd">    Args:</span>
<span class="sd">      event_source: an event source object (instance of EventSource).</span>

<span class="sd">    Raises:</span>
<span class="sd">      IOError: when the storage writer is closed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_storage_file</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s1">u&#39;Unable to write to closed storage writer.&#39;</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_storage_file</span><span class="o">.</span><span class="n">AddEventSource</span><span class="p">(</span><span class="n">event_source</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">number_of_event_sources</span> <span class="o">+=</span> <span class="mi">1</span></div>

<div class="viewcode-block" id="ZIPStorageFileWriter.AddEventTag"><a class="viewcode-back" href="../../../plaso.storage.html#plaso.storage.zip_file.ZIPStorageFileWriter.AddEventTag">[docs]</a>  <span class="k">def</span> <span class="nf">AddEventTag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event_tag</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Adds an event tag to the storage.</span>

<span class="sd">    Args:</span>
<span class="sd">      event_tag: an event tag object (instance of EventTag).</span>

<span class="sd">    Raises:</span>
<span class="sd">      IOError: when the storage writer is closed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_storage_file</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s1">u&#39;Unable to write to closed storage writer.&#39;</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_event_tags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">event_tag</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_tags_counter</span><span class="p">[</span><span class="s1">u&#39;Total Tags&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">event_tag</span><span class="o">.</span><span class="n">labels</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_tags_counter</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span></div>

<div class="viewcode-block" id="ZIPStorageFileWriter.Close"><a class="viewcode-back" href="../../../plaso.storage.html#plaso.storage.zip_file.ZIPStorageFileWriter.Close">[docs]</a>  <span class="k">def</span> <span class="nf">Close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Closes the storage writer.</span>

<span class="sd">    Raises:</span>
<span class="sd">      IOError: when the storage writer is closed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_storage_file</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s1">u&#39;Unable to write to closed storage writer.&#39;</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_storage_file</span><span class="o">.</span><span class="n">Close</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_storage_file</span> <span class="o">=</span> <span class="bp">None</span></div>

  <span class="c1"># TODO: remove during phased processing refactor.</span>
<div class="viewcode-block" id="ZIPStorageFileWriter.ForceClose"><a class="viewcode-back" href="../../../plaso.storage.html#plaso.storage.zip_file.ZIPStorageFileWriter.ForceClose">[docs]</a>  <span class="k">def</span> <span class="nf">ForceClose</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Forces the storage writer to close.</span>

<span class="sd">    Raises:</span>
<span class="sd">      IOError: when the storage writer is closed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_storage_file</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s1">u&#39;Unable to write to closed storage writer.&#39;</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_storage_file</span><span class="o">.</span><span class="n">Close</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_storage_file</span> <span class="o">=</span> <span class="bp">None</span></div>

  <span class="c1"># TODO: remove during phased processing refactor.</span>
<div class="viewcode-block" id="ZIPStorageFileWriter.ForceFlush"><a class="viewcode-back" href="../../../plaso.storage.html#plaso.storage.zip_file.ZIPStorageFileWriter.ForceFlush">[docs]</a>  <span class="k">def</span> <span class="nf">ForceFlush</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Forces the storage writer to flush.</span>

<span class="sd">    Raises:</span>
<span class="sd">      IOError: when the storage writer is closed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_storage_file</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s1">u&#39;Unable to write to closed storage writer.&#39;</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_storage_file</span><span class="o">.</span><span class="n">Flush</span><span class="p">()</span></div>

<div class="viewcode-block" id="ZIPStorageFileWriter.GetEventSources"><a class="viewcode-back" href="../../../plaso.storage.html#plaso.storage.zip_file.ZIPStorageFileWriter.GetEventSources">[docs]</a>  <span class="k">def</span> <span class="nf">GetEventSources</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Retrieves the event sources.</span>

<span class="sd">    Returns:</span>
<span class="sd">      A generator of event source objects (instances of EventSourceObject).</span>

<span class="sd">    Raises:</span>
<span class="sd">      IOError: when the storage writer is closed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_storage_file</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s1">u&#39;Unable to write to closed storage writer.&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_storage_file</span><span class="o">.</span><span class="n">GetEventSourcesCurrentSession</span><span class="p">()</span></div>

<div class="viewcode-block" id="ZIPStorageFileWriter.Open"><a class="viewcode-back" href="../../../plaso.storage.html#plaso.storage.zip_file.ZIPStorageFileWriter.Open">[docs]</a>  <span class="k">def</span> <span class="nf">Open</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Opens the storage writer.</span>

<span class="sd">    Raises:</span>
<span class="sd">      IOError: if the storage writer is already opened.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_storage_file</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s1">u&#39;Storage writer already opened.&#39;</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_storage_file</span> <span class="o">=</span> <span class="n">StorageFile</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_output_file</span><span class="p">,</span> <span class="n">buffer_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_buffer_size</span><span class="p">)</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_enable_profiling</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_storage_file</span><span class="o">.</span><span class="n">EnableProfiling</span><span class="p">(</span><span class="n">profiling_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_profiling_type</span><span class="p">)</span></div>

  <span class="c1"># TODO: remove during phased processing refactor.</span>
<div class="viewcode-block" id="ZIPStorageFileWriter.WritePreprocessObject"><a class="viewcode-back" href="../../../plaso.storage.html#plaso.storage.zip_file.ZIPStorageFileWriter.WritePreprocessObject">[docs]</a>  <span class="k">def</span> <span class="nf">WritePreprocessObject</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">preprocess_object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Writes a preprocessing object.</span>

<span class="sd">    Args:</span>
<span class="sd">      preprocess_object: a preprocess object (instance of PreprocessObject).</span>

<span class="sd">    Raises:</span>
<span class="sd">      IOError: when the storage writer is closed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_storage_file</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s1">u&#39;Unable to write to closed storage writer.&#39;</span><span class="p">)</span>

    <span class="c1"># TODO: write the tags incrementally instead of buffering them</span>
    <span class="c1"># into a list.</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_event_tags</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_storage_file</span><span class="o">.</span><span class="n">AddEventTags</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_event_tags</span><span class="p">)</span>
      <span class="c1"># TODO: move the counters out of preprocessing object.</span>
      <span class="c1"># Kept for backwards compatibility for now.</span>
      <span class="n">preprocess_object</span><span class="o">.</span><span class="n">counter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tags_counter</span>

    <span class="c1"># TODO: refactor this currently create a preprocessing object</span>
    <span class="c1"># for every sync in single processing.</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_storage_file</span><span class="o">.</span><span class="n">WritePreprocessObject</span><span class="p">(</span><span class="n">preprocess_object</span><span class="p">)</span></div>

<div class="viewcode-block" id="ZIPStorageFileWriter.WriteSessionCompletion"><a class="viewcode-back" href="../../../plaso.storage.html#plaso.storage.zip_file.ZIPStorageFileWriter.WriteSessionCompletion">[docs]</a>  <span class="k">def</span> <span class="nf">WriteSessionCompletion</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Writes session completion information.</span>

<span class="sd">    Raises:</span>
<span class="sd">      IOError: when the storage writer is closed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_storage_file</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s1">u&#39;Unable to write to closed storage writer.&#39;</span><span class="p">)</span>

    <span class="n">session_completion</span> <span class="o">=</span> <span class="n">sessions</span><span class="o">.</span><span class="n">SessionCompletion</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_session_identifier</span><span class="p">)</span>
    <span class="n">session_completion</span><span class="o">.</span><span class="n">parsers_counter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsers_counter</span>
    <span class="n">session_completion</span><span class="o">.</span><span class="n">parser_plugins_counter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parser_plugins_counter</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_storage_file</span><span class="o">.</span><span class="n">WriteSessionCompletion</span><span class="p">(</span><span class="n">session_completion</span><span class="p">)</span></div>

<div class="viewcode-block" id="ZIPStorageFileWriter.WriteSessionStart"><a class="viewcode-back" href="../../../plaso.storage.html#plaso.storage.zip_file.ZIPStorageFileWriter.WriteSessionStart">[docs]</a>  <span class="k">def</span> <span class="nf">WriteSessionStart</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session_start</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Writes session start information.</span>

<span class="sd">    Args:</span>
<span class="sd">      session_start: the session start information (instance of SessionStart).</span>

<span class="sd">    Raises:</span>
<span class="sd">      IOError: when the storage writer is closed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_storage_file</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s1">u&#39;Unable to write to closed storage writer.&#39;</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_storage_file</span><span class="o">.</span><span class="n">WriteSessionStart</span><span class="p">(</span><span class="n">session_start</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_session_identifier</span> <span class="o">=</span> <span class="n">session_start</span><span class="o">.</span><span class="n">identifier</span></div></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">Plaso 1.4.1_20160603 documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &raquo;</li>
          <li class="nav-item nav-item-2"><a href="../../plaso.html" >plaso</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &copy; Copyright The Plaso Project Authors.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.4.2.
    </div>
  </body>
</html>