<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>construct.core &mdash; Plaso 1.4.1_20160603 documentation</title>
    
    <link rel="stylesheet" href="../../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '1.4.1_20160603',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="top" title="Plaso 1.4.1_20160603 documentation" href="../../index.html" />
    <link rel="up" title="Module code" href="../index.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Plaso 1.4.1_20160603 documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for construct.core</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">struct</span> <span class="kn">import</span> <span class="n">Struct</span> <span class="k">as</span> <span class="n">Packer</span>

<span class="kn">from</span> <span class="nn">construct.lib.py3compat</span> <span class="kn">import</span> <span class="n">BytesIO</span><span class="p">,</span> <span class="n">advance_iterator</span><span class="p">,</span> <span class="n">bchr</span>
<span class="kn">from</span> <span class="nn">construct.lib</span> <span class="kn">import</span> <span class="n">Container</span><span class="p">,</span> <span class="n">ListContainer</span><span class="p">,</span> <span class="n">LazyContainer</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">six</span>

<span class="k">try</span><span class="p">:</span>
    <span class="nb">bytes</span>
<span class="k">except</span> <span class="ne">NameError</span><span class="p">:</span>
    <span class="nb">bytes</span> <span class="o">=</span> <span class="nb">str</span>

<span class="c1">#===============================================================================</span>
<span class="c1"># exceptions</span>
<span class="c1">#===============================================================================</span>
<span class="k">class</span> <span class="nc">ConstructError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span>
<span class="k">class</span> <span class="nc">FieldError</span><span class="p">(</span><span class="n">ConstructError</span><span class="p">):</span>
    <span class="k">pass</span>
<span class="k">class</span> <span class="nc">SizeofError</span><span class="p">(</span><span class="n">ConstructError</span><span class="p">):</span>
    <span class="k">pass</span>
<span class="k">class</span> <span class="nc">AdaptationError</span><span class="p">(</span><span class="n">ConstructError</span><span class="p">):</span>
    <span class="k">pass</span>
<span class="k">class</span> <span class="nc">ArrayError</span><span class="p">(</span><span class="n">ConstructError</span><span class="p">):</span>
    <span class="k">pass</span>
<span class="k">class</span> <span class="nc">RangeError</span><span class="p">(</span><span class="n">ConstructError</span><span class="p">):</span>
    <span class="k">pass</span>
<span class="k">class</span> <span class="nc">SwitchError</span><span class="p">(</span><span class="n">ConstructError</span><span class="p">):</span>
    <span class="k">pass</span>
<span class="k">class</span> <span class="nc">SelectError</span><span class="p">(</span><span class="n">ConstructError</span><span class="p">):</span>
    <span class="k">pass</span>
<span class="k">class</span> <span class="nc">TerminatorError</span><span class="p">(</span><span class="n">ConstructError</span><span class="p">):</span>
    <span class="k">pass</span>
<span class="k">class</span> <span class="nc">OverwriteError</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="c1">#===============================================================================</span>
<span class="c1"># abstract constructs</span>
<span class="c1">#===============================================================================</span>
<span class="k">class</span> <span class="nc">Construct</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The mother of all constructs.</span>

<span class="sd">    This object is generally not directly instantiated, and it does not</span>
<span class="sd">    directly implement parsing and building, so it is largely only of interest</span>
<span class="sd">    to subclass implementors.</span>

<span class="sd">    The external user API:</span>

<span class="sd">     * ``parse()``</span>
<span class="sd">     * ``parse_stream()``</span>
<span class="sd">     * ``build()``</span>
<span class="sd">     * ``build_stream()``</span>
<span class="sd">     * ``sizeof()``</span>

<span class="sd">    Subclass authors should not override the external methods. Instead,</span>
<span class="sd">    another API is available:</span>

<span class="sd">     * ``_parse()``</span>
<span class="sd">     * ``_build()``</span>
<span class="sd">     * ``_sizeof()``</span>

<span class="sd">    There is also a flag API:</span>

<span class="sd">     * ``_set_flag()``</span>
<span class="sd">     * ``_clear_flag()``</span>
<span class="sd">     * ``_inherit_flags()``</span>
<span class="sd">     * ``_is_flag()``</span>

<span class="sd">    And stateful copying:</span>

<span class="sd">     * ``__getstate__()``</span>
<span class="sd">     * ``__setstate__()``</span>

<span class="sd">    Attributes and Inheritance</span>
<span class="sd">    ==========================</span>

<span class="sd">    All constructs have a name and flags. The name is used for naming struct</span>
<span class="sd">    members and context dictionaries. Note that the name can either be a</span>
<span class="sd">    string, or None if the name is not needed. A single underscore (&quot;_&quot;) is a</span>
<span class="sd">    reserved name, and so are names starting with a less-than character (&quot;&lt;&quot;).</span>
<span class="sd">    The name should be descriptive, short, and valid as a Python identifier,</span>
<span class="sd">    although these rules are not enforced.</span>

<span class="sd">    The flags specify additional behavioral information about this construct.</span>
<span class="sd">    Flags are used by enclosing constructs to determine a proper course of</span>
<span class="sd">    action. Flags are inherited by default, from inner subconstructs to outer</span>
<span class="sd">    constructs. The enclosing construct may set new flags or clear existing</span>
<span class="sd">    ones, as necessary.</span>

<span class="sd">    For example, if ``FLAG_COPY_CONTEXT`` is set, repeaters will pass a copy of</span>
<span class="sd">    the context for each iteration, which is necessary for OnDemand parsing.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">FLAG_COPY_CONTEXT</span>          <span class="o">=</span> <span class="mh">0x0001</span>
    <span class="n">FLAG_DYNAMIC</span>               <span class="o">=</span> <span class="mh">0x0002</span>
    <span class="n">FLAG_EMBED</span>                 <span class="o">=</span> <span class="mh">0x0004</span>
    <span class="n">FLAG_NESTING</span>               <span class="o">=</span> <span class="mh">0x0008</span>

    <span class="n">__slots__</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;conflags&quot;</span><span class="p">]</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;name must be a string or None&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;_&quot;</span> <span class="ow">or</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;&lt;&quot;</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;reserved name&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conflags</span> <span class="o">=</span> <span class="n">flags</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">(</span><span class="si">%r</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_set_flag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flag</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the given flag or flags.</span>

<span class="sd">        :param int flag: flag to set; may be OR&#39;d combination of flags</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">conflags</span> <span class="o">|=</span> <span class="n">flag</span>

    <span class="k">def</span> <span class="nf">_clear_flag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flag</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Clear the given flag or flags.</span>

<span class="sd">        :param int flag: flag to clear; may be OR&#39;d combination of flags</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">conflags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">flag</span>

    <span class="k">def</span> <span class="nf">_inherit_flags</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">subcons</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Pull flags from subconstructs.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">for</span> <span class="n">sc</span> <span class="ow">in</span> <span class="n">subcons</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_flag</span><span class="p">(</span><span class="n">sc</span><span class="o">.</span><span class="n">conflags</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_is_flag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flag</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check whether a given flag is set.</span>

<span class="sd">        :param int flag: flag to check</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conflags</span> <span class="o">&amp;</span> <span class="n">flag</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__getstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Obtain a dictionary representing this construct&#39;s state.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">attrs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;__dict__&quot;</span><span class="p">):</span>
            <span class="n">attrs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__dict__</span><span class="p">)</span>
        <span class="n">slots</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span>
        <span class="k">while</span> <span class="n">c</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="s2">&quot;__slots__&quot;</span><span class="p">):</span>
                <span class="n">slots</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">__slots__</span><span class="p">)</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">__base__</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">slots</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
                <span class="n">attrs</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">attrs</span>

    <span class="k">def</span> <span class="nf">__setstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attrs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set this construct&#39;s state to a given state.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">attrs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__copy__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;returns a copy of this construct&quot;&quot;&quot;</span>
        <span class="n">self2</span> <span class="o">=</span> <span class="nb">object</span><span class="o">.</span><span class="n">__new__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="p">)</span>
        <span class="n">self2</span><span class="o">.</span><span class="n">__setstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__getstate__</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">self2</span>

    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parse an in-memory buffer.</span>

<span class="sd">        Strings, buffers, memoryviews, and other complete buffers can be</span>
<span class="sd">        parsed with this method.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_stream</span><span class="p">(</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">parse_stream</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stream</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parse a stream.</span>

<span class="sd">        Files, pipes, sockets, and other streaming sources of data are handled</span>
<span class="sd">        by this method.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="n">Container</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">_parse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stream</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Override me in your subclass.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Build an object in memory.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">stream</span> <span class="o">=</span> <span class="n">BytesIO</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">build_stream</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">stream</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">stream</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">build_stream</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">stream</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Build an object directly into a stream.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_build</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">stream</span><span class="p">,</span> <span class="n">Container</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">_build</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">stream</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Override me in your subclass.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">sizeof</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate the size of this object, optionally using a context.</span>

<span class="sd">        Some constructs have no fixed size and can only know their size for a</span>
<span class="sd">        given hunk of data; these constructs will raise an error if they are</span>
<span class="sd">        not passed a context.</span>

<span class="sd">        :param context: contextual data</span>

<span class="sd">        :returns: int of the length of this construct</span>
<span class="sd">        :raises SizeofError: the size could not be determined</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">context</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">context</span> <span class="o">=</span> <span class="n">Container</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sizeof</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SizeofError</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">1</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">_sizeof</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Override me in your subclass.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">raise</span> <span class="n">SizeofError</span><span class="p">(</span><span class="s2">&quot;Raw Constructs have no size!&quot;</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">Subconstruct</span><span class="p">(</span><span class="n">Construct</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Abstract subconstruct (wraps an inner construct, inheriting its</span>
<span class="sd">    name and flags).</span>

<span class="sd">    Subconstructs wrap an inner Construct, inheriting its name and flags.</span>

<span class="sd">    :param subcon: the construct to wrap</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">__slots__</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;subcon&quot;</span><span class="p">]</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subcon</span><span class="p">):</span>
        <span class="n">Construct</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subcon</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">subcon</span><span class="o">.</span><span class="n">conflags</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subcon</span> <span class="o">=</span> <span class="n">subcon</span>
    <span class="k">def</span> <span class="nf">_parse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stream</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">subcon</span><span class="o">.</span><span class="n">_parse</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_build</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">stream</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subcon</span><span class="o">.</span><span class="n">_build</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">stream</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_sizeof</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">subcon</span><span class="o">.</span><span class="n">_sizeof</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">Adapter</span><span class="p">(</span><span class="n">Subconstruct</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Abstract adapter parent class.</span>

<span class="sd">    Adapters should implement ``_decode()`` and ``_encode()``.</span>

<span class="sd">    :param subcon: the construct to wrap</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">__slots__</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">def</span> <span class="nf">_parse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stream</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_decode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">subcon</span><span class="o">.</span><span class="n">_parse</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="n">context</span><span class="p">),</span> <span class="n">context</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_build</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">stream</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subcon</span><span class="o">.</span><span class="n">_build</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_encode</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">context</span><span class="p">),</span> <span class="n">stream</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_decode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">_encode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>


<span class="c1">#===============================================================================</span>
<span class="c1"># Fields</span>
<span class="c1">#===============================================================================</span>
<span class="k">def</span> <span class="nf">_read_stream</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="n">length</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">length</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;length must be &gt;= 0&quot;</span><span class="p">,</span> <span class="n">length</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">stream</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">length</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">!=</span> <span class="n">length</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">FieldError</span><span class="p">(</span><span class="s2">&quot;expected </span><span class="si">%d</span><span class="s2">, found </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">length</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">data</span>

<span class="k">def</span> <span class="nf">_write_stream</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">length</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;length must be &gt;= 0&quot;</span><span class="p">,</span> <span class="n">length</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">!=</span> <span class="n">length</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">FieldError</span><span class="p">(</span><span class="s2">&quot;expected </span><span class="si">%d</span><span class="s2">, found </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">length</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)))</span>
    <span class="n">stream</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">StaticField</span><span class="p">(</span><span class="n">Construct</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A fixed-size byte field.</span>

<span class="sd">    :param name: field name</span>
<span class="sd">    :param length: number of bytes in the field</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">__slots__</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;length&quot;</span><span class="p">]</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">length</span><span class="p">):</span>
        <span class="n">Construct</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">length</span>
    <span class="k">def</span> <span class="nf">_parse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stream</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">_read_stream</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">length</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_build</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">stream</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="n">_write_stream</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">length</span><span class="p">,</span> <span class="n">bchr</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="k">else</span> <span class="n">obj</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_sizeof</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">length</span>

<span class="k">class</span> <span class="nc">FormatField</span><span class="p">(</span><span class="n">StaticField</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A field that uses ``struct`` to pack and unpack data.</span>

<span class="sd">    See ``struct`` documentation for instructions on crafting format strings.</span>

<span class="sd">    :param name: name of the field</span>
<span class="sd">    :param endianness: format endianness string; one of &quot;&lt;&quot;, &quot;&gt;&quot;, or &quot;=&quot;</span>
<span class="sd">    :param format: a single format character</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">__slots__</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;packer&quot;</span><span class="p">]</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">endianity</span><span class="p">,</span> <span class="n">format</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">endianity</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;&quot;</span><span class="p">,</span> <span class="s2">&quot;=&quot;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;endianity must be be &#39;=&#39;, &#39;&lt;&#39;, or &#39;&gt;&#39;&quot;</span><span class="p">,</span>
                <span class="n">endianity</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">format</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;must specify one and only one format char&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">packer</span> <span class="o">=</span> <span class="n">Packer</span><span class="p">(</span><span class="n">endianity</span> <span class="o">+</span> <span class="n">format</span><span class="p">)</span>
        <span class="n">StaticField</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">packer</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">__getstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">attrs</span> <span class="o">=</span> <span class="n">StaticField</span><span class="o">.</span><span class="n">__getstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;packer&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;packer&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">format</span>
        <span class="k">return</span> <span class="n">attrs</span>
    <span class="k">def</span> <span class="nf">__setstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attrs</span><span class="p">):</span>
        <span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;packer&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Packer</span><span class="p">(</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;packer&quot;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">StaticField</span><span class="o">.</span><span class="n">__setstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attrs</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_parse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stream</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">packer</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="n">_read_stream</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">length</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">FieldError</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">def</span> <span class="nf">_build</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">stream</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">_write_stream</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">length</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">packer</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">obj</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">FieldError</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">1</span><span class="p">])</span>

<span class="k">class</span> <span class="nc">MetaField</span><span class="p">(</span><span class="n">Construct</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">    A variable-length field. The length is obtained at runtime from a</span>
<span class="sd">    function.</span>

<span class="sd">    :param name: name of the field</span>
<span class="sd">    :param lengthfunc: callable that takes a context and returns length as an int</span>

<span class="sd">    Example::</span>

<span class="sd">        &gt;&gt;&gt; foo = Struct(&quot;foo&quot;,</span>
<span class="sd">        ...     Byte(&quot;length&quot;),</span>
<span class="sd">        ...     MetaField(&quot;data&quot;, lambda ctx: ctx[&quot;length&quot;])</span>
<span class="sd">        ... )</span>
<span class="sd">        &gt;&gt;&gt; foo.parse(&quot;\x03ABC&quot;)</span>
<span class="sd">        Container(data = &#39;ABC&#39;, length = 3)</span>
<span class="sd">        &gt;&gt;&gt; foo.parse(&quot;\x04ABCD&quot;)</span>
<span class="sd">        Container(data = &#39;ABCD&#39;, length = 4)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">__slots__</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;lengthfunc&quot;</span><span class="p">]</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">lengthfunc</span><span class="p">):</span>
        <span class="n">Construct</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lengthfunc</span> <span class="o">=</span> <span class="n">lengthfunc</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_flag</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">FLAG_DYNAMIC</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_parse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stream</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">_read_stream</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lengthfunc</span><span class="p">(</span><span class="n">context</span><span class="p">))</span>
    <span class="k">def</span> <span class="nf">_build</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">stream</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="n">_write_stream</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lengthfunc</span><span class="p">(</span><span class="n">context</span><span class="p">),</span> <span class="n">obj</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_sizeof</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">lengthfunc</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>


<span class="c1">#===============================================================================</span>
<span class="c1"># arrays and repeaters</span>
<span class="c1">#===============================================================================</span>
<span class="k">class</span> <span class="nc">MetaArray</span><span class="p">(</span><span class="n">Subconstruct</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    An array (repeater) of a meta-count. The array will iterate exactly</span>
<span class="sd">    ``countfunc()`` times. Will raise ArrayError if less elements are found.</span>

<span class="sd">    .. seealso::</span>

<span class="sd">        The :func:`~construct.macros.Array` macro, :func:`Range` and :func:`RepeatUntil`.</span>

<span class="sd">    :param countfunc: a function that takes the context as a parameter and returns</span>
<span class="sd">                      the number of elements of the array (count)</span>
<span class="sd">    :param subcon: the subcon to repeat ``countfunc()`` times</span>

<span class="sd">    Example::</span>

<span class="sd">        MetaArray(lambda ctx: 5, UBInt8(&quot;foo&quot;))</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">__slots__</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;countfunc&quot;</span><span class="p">]</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">countfunc</span><span class="p">,</span> <span class="n">subcon</span><span class="p">):</span>
        <span class="n">Subconstruct</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subcon</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">countfunc</span> <span class="o">=</span> <span class="n">countfunc</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_clear_flag</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">FLAG_COPY_CONTEXT</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_flag</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">FLAG_DYNAMIC</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_parse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stream</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">ListContainer</span><span class="p">()</span>
        <span class="n">c</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">countfunc</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">subcon</span><span class="o">.</span><span class="n">conflags</span> <span class="o">&amp;</span> <span class="bp">self</span><span class="o">.</span><span class="n">FLAG_COPY_CONTEXT</span><span class="p">:</span>
                <span class="k">while</span> <span class="n">c</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">:</span>
                    <span class="n">obj</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">subcon</span><span class="o">.</span><span class="n">_parse</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="n">context</span><span class="o">.</span><span class="n">__copy__</span><span class="p">()))</span>
                    <span class="n">c</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">while</span> <span class="n">c</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">:</span>
                    <span class="n">obj</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">subcon</span><span class="o">.</span><span class="n">_parse</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="n">context</span><span class="p">))</span>
                    <span class="n">c</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">except</span> <span class="n">ConstructError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ArrayError</span><span class="p">(</span><span class="s2">&quot;expected </span><span class="si">%d</span><span class="s2">, found </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="n">c</span><span class="p">),</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">obj</span>
    <span class="k">def</span> <span class="nf">_build</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">stream</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="n">count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">countfunc</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="o">!=</span> <span class="n">count</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ArrayError</span><span class="p">(</span><span class="s2">&quot;expected </span><span class="si">%d</span><span class="s2">, found </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">obj</span><span class="p">)))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">subcon</span><span class="o">.</span><span class="n">conflags</span> <span class="o">&amp;</span> <span class="bp">self</span><span class="o">.</span><span class="n">FLAG_COPY_CONTEXT</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">subobj</span> <span class="ow">in</span> <span class="n">obj</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">subcon</span><span class="o">.</span><span class="n">_build</span><span class="p">(</span><span class="n">subobj</span><span class="p">,</span> <span class="n">stream</span><span class="p">,</span> <span class="n">context</span><span class="o">.</span><span class="n">__copy__</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">subobj</span> <span class="ow">in</span> <span class="n">obj</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">subcon</span><span class="o">.</span><span class="n">_build</span><span class="p">(</span><span class="n">subobj</span><span class="p">,</span> <span class="n">stream</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_sizeof</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">subcon</span><span class="o">.</span><span class="n">_sizeof</span><span class="p">(</span><span class="n">context</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">countfunc</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">Range</span><span class="p">(</span><span class="n">Subconstruct</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">    A range-array. The subcon will iterate between ``mincount`` to ``maxcount``</span>
<span class="sd">    times. If less than ``mincount`` elements are found, raises RangeError.</span>

<span class="sd">    .. seealso::</span>

<span class="sd">        The :func:`~construct.macros.GreedyRange` and</span>
<span class="sd">        :func:`~construct.macros.OptionalGreedyRange` macros.</span>

<span class="sd">    The general-case repeater. Repeats the given unit for at least ``mincount``</span>
<span class="sd">    times, and up to ``maxcount`` times. If an exception occurs (EOF, validation</span>
<span class="sd">    error), the repeater exits. If less than ``mincount`` units have been</span>
<span class="sd">    successfully parsed, a RangeError is raised.</span>

<span class="sd">    .. note:: This object requires a seekable stream for parsing.</span>

<span class="sd">    :param mincount: the minimal count</span>
<span class="sd">    :param maxcount: the maximal count</span>
<span class="sd">    :param subcon: the subcon to repeat</span>

<span class="sd">    Example::</span>

<span class="sd">        &gt;&gt;&gt; c = Range(3, 7, UBInt8(&quot;foo&quot;))</span>
<span class="sd">        &gt;&gt;&gt; c.parse(&quot;\x01\x02&quot;)</span>
<span class="sd">        Traceback (most recent call last):</span>
<span class="sd">          ...</span>
<span class="sd">        construct.core.RangeError: expected 3..7, found 2</span>
<span class="sd">        &gt;&gt;&gt; c.parse(&quot;\x01\x02\x03&quot;)</span>
<span class="sd">        [1, 2, 3]</span>
<span class="sd">        &gt;&gt;&gt; c.parse(&quot;\x01\x02\x03\x04\x05\x06&quot;)</span>
<span class="sd">        [1, 2, 3, 4, 5, 6]</span>
<span class="sd">        &gt;&gt;&gt; c.parse(&quot;\x01\x02\x03\x04\x05\x06\x07&quot;)</span>
<span class="sd">        [1, 2, 3, 4, 5, 6, 7]</span>
<span class="sd">        &gt;&gt;&gt; c.parse(&quot;\x01\x02\x03\x04\x05\x06\x07\x08\x09&quot;)</span>
<span class="sd">        [1, 2, 3, 4, 5, 6, 7]</span>
<span class="sd">        &gt;&gt;&gt; c.build([1,2])</span>
<span class="sd">        Traceback (most recent call last):</span>
<span class="sd">          ...</span>
<span class="sd">        construct.core.RangeError: expected 3..7, found 2</span>
<span class="sd">        &gt;&gt;&gt; c.build([1,2,3,4])</span>
<span class="sd">        &#39;\x01\x02\x03\x04&#39;</span>
<span class="sd">        &gt;&gt;&gt; c.build([1,2,3,4,5,6,7,8])</span>
<span class="sd">        Traceback (most recent call last):</span>
<span class="sd">          ...</span>
<span class="sd">        construct.core.RangeError: expected 3..7, found 8</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">__slots__</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;mincount&quot;</span><span class="p">,</span> <span class="s2">&quot;maxcout&quot;</span><span class="p">]</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mincount</span><span class="p">,</span> <span class="n">maxcout</span><span class="p">,</span> <span class="n">subcon</span><span class="p">):</span>
        <span class="n">Subconstruct</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subcon</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mincount</span> <span class="o">=</span> <span class="n">mincount</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">maxcout</span> <span class="o">=</span> <span class="n">maxcout</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_clear_flag</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">FLAG_COPY_CONTEXT</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_flag</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">FLAG_DYNAMIC</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_parse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stream</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">ListContainer</span><span class="p">()</span>
        <span class="n">c</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">subcon</span><span class="o">.</span><span class="n">conflags</span> <span class="o">&amp;</span> <span class="bp">self</span><span class="o">.</span><span class="n">FLAG_COPY_CONTEXT</span><span class="p">:</span>
                <span class="k">while</span> <span class="n">c</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxcout</span><span class="p">:</span>
                    <span class="n">pos</span> <span class="o">=</span> <span class="n">stream</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
                    <span class="n">obj</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">subcon</span><span class="o">.</span><span class="n">_parse</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="n">context</span><span class="o">.</span><span class="n">__copy__</span><span class="p">()))</span>
                    <span class="n">c</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">while</span> <span class="n">c</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxcout</span><span class="p">:</span>
                    <span class="n">pos</span> <span class="o">=</span> <span class="n">stream</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
                    <span class="n">obj</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">subcon</span><span class="o">.</span><span class="n">_parse</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="n">context</span><span class="p">))</span>
                    <span class="n">c</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">except</span> <span class="n">ConstructError</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">c</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">mincount</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">RangeError</span><span class="p">(</span><span class="s2">&quot;expected </span><span class="si">%d</span><span class="s2"> to </span><span class="si">%d</span><span class="s2">, found </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span>
                    <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mincount</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxcout</span><span class="p">,</span> <span class="n">c</span><span class="p">),</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">stream</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">obj</span>
    <span class="k">def</span> <span class="nf">_build</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">stream</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">mincount</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxcout</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">RangeError</span><span class="p">(</span><span class="s2">&quot;expected </span><span class="si">%d</span><span class="s2"> to </span><span class="si">%d</span><span class="s2">, found </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mincount</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxcout</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">obj</span><span class="p">)))</span>
        <span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">subcon</span><span class="o">.</span><span class="n">conflags</span> <span class="o">&amp;</span> <span class="bp">self</span><span class="o">.</span><span class="n">FLAG_COPY_CONTEXT</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">subobj</span> <span class="ow">in</span> <span class="n">obj</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
                        <span class="n">subobj</span> <span class="o">=</span> <span class="n">bchr</span><span class="p">(</span><span class="n">subobj</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">subcon</span><span class="o">.</span><span class="n">_build</span><span class="p">(</span><span class="n">subobj</span><span class="p">,</span> <span class="n">stream</span><span class="p">,</span> <span class="n">context</span><span class="o">.</span><span class="n">__copy__</span><span class="p">())</span>
                    <span class="n">cnt</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">subobj</span> <span class="ow">in</span> <span class="n">obj</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
                        <span class="n">subobj</span> <span class="o">=</span> <span class="n">bchr</span><span class="p">(</span><span class="n">subobj</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">subcon</span><span class="o">.</span><span class="n">_build</span><span class="p">(</span><span class="n">subobj</span><span class="p">,</span> <span class="n">stream</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
                    <span class="n">cnt</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">except</span> <span class="n">ConstructError</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">cnt</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">mincount</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">RangeError</span><span class="p">(</span><span class="s2">&quot;expected </span><span class="si">%d</span><span class="s2"> to </span><span class="si">%d</span><span class="s2">, found </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span>
                    <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mincount</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxcout</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">obj</span><span class="p">)),</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">def</span> <span class="nf">_sizeof</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">SizeofError</span><span class="p">(</span><span class="s2">&quot;can&#39;t calculate size&quot;</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">RepeatUntil</span><span class="p">(</span><span class="n">Subconstruct</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">    An array that repeats until the predicate indicates it to stop. Note that</span>
<span class="sd">    the last element (which caused the repeat to exit) is included in the</span>
<span class="sd">    return value.</span>

<span class="sd">    :param predicate: a predicate function that takes (obj, context) and returns</span>
<span class="sd">      True if the stop-condition is met, or False to continue.</span>
<span class="sd">    :param subcon: the subcon to repeat.</span>

<span class="sd">    Example::</span>

<span class="sd">        # will read chars until &#39;\x00&#39; (inclusive)</span>
<span class="sd">        RepeatUntil(lambda obj, ctx: obj == b&quot;\x00&quot;,</span>
<span class="sd">            Field(&quot;chars&quot;, 1)</span>
<span class="sd">        )</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">__slots__</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;predicate&quot;</span><span class="p">]</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">predicate</span><span class="p">,</span> <span class="n">subcon</span><span class="p">):</span>
        <span class="n">Subconstruct</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subcon</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">predicate</span> <span class="o">=</span> <span class="n">predicate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_clear_flag</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">FLAG_COPY_CONTEXT</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_flag</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">FLAG_DYNAMIC</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_parse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stream</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">subcon</span><span class="o">.</span><span class="n">conflags</span> <span class="o">&amp;</span> <span class="bp">self</span><span class="o">.</span><span class="n">FLAG_COPY_CONTEXT</span><span class="p">:</span>
                <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
                    <span class="n">subobj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subcon</span><span class="o">.</span><span class="n">_parse</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="n">context</span><span class="o">.</span><span class="n">__copy__</span><span class="p">())</span>
                    <span class="n">obj</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">subobj</span><span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">predicate</span><span class="p">(</span><span class="n">subobj</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
                        <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
                    <span class="n">subobj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subcon</span><span class="o">.</span><span class="n">_parse</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
                    <span class="n">obj</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">subobj</span><span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">predicate</span><span class="p">(</span><span class="n">subobj</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
                        <span class="k">break</span>
        <span class="k">except</span> <span class="n">ConstructError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ArrayError</span><span class="p">(</span><span class="s2">&quot;missing terminator&quot;</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">obj</span>
    <span class="k">def</span> <span class="nf">_build</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">stream</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="n">terminated</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">subcon</span><span class="o">.</span><span class="n">conflags</span> <span class="o">&amp;</span> <span class="bp">self</span><span class="o">.</span><span class="n">FLAG_COPY_CONTEXT</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">subobj</span> <span class="ow">in</span> <span class="n">obj</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">subcon</span><span class="o">.</span><span class="n">_build</span><span class="p">(</span><span class="n">subobj</span><span class="p">,</span> <span class="n">stream</span><span class="p">,</span> <span class="n">context</span><span class="o">.</span><span class="n">__copy__</span><span class="p">())</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">predicate</span><span class="p">(</span><span class="n">subobj</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
                    <span class="n">terminated</span> <span class="o">=</span> <span class="bp">True</span>
                    <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">subobj</span> <span class="ow">in</span> <span class="n">obj</span><span class="p">:</span>
                <span class="c1">#subobj = bchr(subobj)  -- WTF is that for?!</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">subcon</span><span class="o">.</span><span class="n">_build</span><span class="p">(</span><span class="n">subobj</span><span class="p">,</span> <span class="n">stream</span><span class="p">,</span> <span class="n">context</span><span class="o">.</span><span class="n">__copy__</span><span class="p">())</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">predicate</span><span class="p">(</span><span class="n">subobj</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
                    <span class="n">terminated</span> <span class="o">=</span> <span class="bp">True</span>
                    <span class="k">break</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">terminated</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ArrayError</span><span class="p">(</span><span class="s2">&quot;missing terminator&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_sizeof</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">SizeofError</span><span class="p">(</span><span class="s2">&quot;can&#39;t calculate size&quot;</span><span class="p">)</span>


<span class="c1">#===============================================================================</span>
<span class="c1"># structures and sequences</span>
<span class="c1">#===============================================================================</span>
<span class="k">class</span> <span class="nc">Struct</span><span class="p">(</span><span class="n">Construct</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A sequence of named constructs, similar to structs in C. The elements are</span>
<span class="sd">    parsed and built in the order they are defined.</span>

<span class="sd">    .. seealso:: The :func:`~construct.macros.Embedded` macro.</span>

<span class="sd">    :param name: the name of the structure</span>
<span class="sd">    :param subcons: a sequence of subconstructs that make up this structure.</span>
<span class="sd">    :param nested: a keyword-only argument that indicates whether this struct</span>
<span class="sd">                   creates a nested context. The default is True. This parameter is</span>
<span class="sd">                   considered &quot;advanced usage&quot;, and may be removed in the future.</span>

<span class="sd">    Example::</span>

<span class="sd">        Struct(&quot;foo&quot;,</span>
<span class="sd">            UBInt8(&quot;first_element&quot;),</span>
<span class="sd">            UBInt16(&quot;second_element&quot;),</span>
<span class="sd">            Padding(2),</span>
<span class="sd">            UBInt8(&quot;third_element&quot;),</span>
<span class="sd">        )</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">__slots__</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;subcons&quot;</span><span class="p">,</span> <span class="s2">&quot;nested&quot;</span><span class="p">,</span> <span class="s2">&quot;allow_overwrite&quot;</span><span class="p">]</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="o">*</span><span class="n">subcons</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nested</span> <span class="o">=</span> <span class="n">kw</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;nested&quot;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">allow_overwrite</span> <span class="o">=</span> <span class="n">kw</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;allow_overwrite&quot;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">kw</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;the only keyword argument accepted is &#39;nested&#39;&quot;</span><span class="p">,</span> <span class="n">kw</span><span class="p">)</span>
        <span class="n">Construct</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subcons</span> <span class="o">=</span> <span class="n">subcons</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_inherit_flags</span><span class="p">(</span><span class="o">*</span><span class="n">subcons</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_clear_flag</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">FLAG_EMBED</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_parse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stream</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="k">if</span> <span class="s2">&quot;&lt;obj&gt;&quot;</span> <span class="ow">in</span> <span class="n">context</span><span class="p">:</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="n">context</span><span class="p">[</span><span class="s2">&quot;&lt;obj&gt;&quot;</span><span class="p">]</span>
            <span class="k">del</span> <span class="n">context</span><span class="p">[</span><span class="s2">&quot;&lt;obj&gt;&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="n">Container</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nested</span><span class="p">:</span>
                <span class="n">context</span> <span class="o">=</span> <span class="n">Container</span><span class="p">(</span><span class="n">_</span> <span class="o">=</span> <span class="n">context</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">sc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">subcons</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">sc</span><span class="o">.</span><span class="n">conflags</span> <span class="o">&amp;</span> <span class="bp">self</span><span class="o">.</span><span class="n">FLAG_EMBED</span><span class="p">:</span>
                <span class="n">context</span><span class="p">[</span><span class="s2">&quot;&lt;obj&gt;&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">obj</span>
                <span class="n">sc</span><span class="o">.</span><span class="n">_parse</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">subobj</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">_parse</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">sc</span><span class="o">.</span><span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">sc</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">obj</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">allow_overwrite</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">OverwriteError</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%r</span><span class="s2"> would be overwritten but allow_overwrite is False&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sc</span><span class="o">.</span><span class="n">name</span><span class="p">,))</span>
                    <span class="n">obj</span><span class="p">[</span><span class="n">sc</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">subobj</span>
                    <span class="n">context</span><span class="p">[</span><span class="n">sc</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">subobj</span>
        <span class="k">return</span> <span class="n">obj</span>
    <span class="k">def</span> <span class="nf">_build</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">stream</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="k">if</span> <span class="s2">&quot;&lt;unnested&gt;&quot;</span> <span class="ow">in</span> <span class="n">context</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">context</span><span class="p">[</span><span class="s2">&quot;&lt;unnested&gt;&quot;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">nested</span><span class="p">:</span>
            <span class="n">context</span> <span class="o">=</span> <span class="n">Container</span><span class="p">(</span><span class="n">_</span> <span class="o">=</span> <span class="n">context</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">sc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">subcons</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">sc</span><span class="o">.</span><span class="n">conflags</span> <span class="o">&amp;</span> <span class="bp">self</span><span class="o">.</span><span class="n">FLAG_EMBED</span><span class="p">:</span>
                <span class="n">context</span><span class="p">[</span><span class="s2">&quot;&lt;unnested&gt;&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="n">subobj</span> <span class="o">=</span> <span class="n">obj</span>
            <span class="k">elif</span> <span class="n">sc</span><span class="o">.</span><span class="n">name</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">subobj</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">subobj</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">sc</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="n">context</span><span class="p">[</span><span class="n">sc</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">subobj</span>
            <span class="n">sc</span><span class="o">.</span><span class="n">_build</span><span class="p">(</span><span class="n">subobj</span><span class="p">,</span> <span class="n">stream</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_sizeof</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="c1">#if self.nested:</span>
        <span class="c1">#    context = Container(_ = context)</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">sc</span><span class="o">.</span><span class="n">_sizeof</span><span class="p">(</span><span class="n">context</span><span class="p">)</span> <span class="k">for</span> <span class="n">sc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">subcons</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">Sequence</span><span class="p">(</span><span class="n">Struct</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A sequence of unnamed constructs. The elements are parsed and built in the</span>
<span class="sd">    order they are defined.</span>

<span class="sd">    .. seealso:: The :func:`~construct.macros.Embedded` macro.</span>

<span class="sd">    :param name: the name of the structure</span>
<span class="sd">    :param subcons: a sequence of subconstructs that make up this structure.</span>
<span class="sd">    :param nested: a keyword-only argument that indicates whether this struct</span>
<span class="sd">                   creates a nested context. The default is True. This parameter is</span>
<span class="sd">                   considered &quot;advanced usage&quot;, and may be removed in the future.</span>

<span class="sd">    Example::</span>

<span class="sd">        Sequence(&quot;foo&quot;,</span>
<span class="sd">            UBInt8(&quot;first_element&quot;),</span>
<span class="sd">            UBInt16(&quot;second_element&quot;),</span>
<span class="sd">            Padding(2),</span>
<span class="sd">            UBInt8(&quot;third_element&quot;),</span>
<span class="sd">        )</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">__slots__</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">def</span> <span class="nf">_parse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stream</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="k">if</span> <span class="s2">&quot;&lt;obj&gt;&quot;</span> <span class="ow">in</span> <span class="n">context</span><span class="p">:</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="n">context</span><span class="p">[</span><span class="s2">&quot;&lt;obj&gt;&quot;</span><span class="p">]</span>
            <span class="k">del</span> <span class="n">context</span><span class="p">[</span><span class="s2">&quot;&lt;obj&gt;&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="n">ListContainer</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nested</span><span class="p">:</span>
                <span class="n">context</span> <span class="o">=</span> <span class="n">Container</span><span class="p">(</span><span class="n">_</span> <span class="o">=</span> <span class="n">context</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">sc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">subcons</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">sc</span><span class="o">.</span><span class="n">conflags</span> <span class="o">&amp;</span> <span class="bp">self</span><span class="o">.</span><span class="n">FLAG_EMBED</span><span class="p">:</span>
                <span class="n">context</span><span class="p">[</span><span class="s2">&quot;&lt;obj&gt;&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">obj</span>
                <span class="n">sc</span><span class="o">.</span><span class="n">_parse</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">subobj</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">_parse</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">sc</span><span class="o">.</span><span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">obj</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">subobj</span><span class="p">)</span>
                    <span class="n">context</span><span class="p">[</span><span class="n">sc</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">subobj</span>
        <span class="k">return</span> <span class="n">obj</span>
    <span class="k">def</span> <span class="nf">_build</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">stream</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="k">if</span> <span class="s2">&quot;&lt;unnested&gt;&quot;</span> <span class="ow">in</span> <span class="n">context</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">context</span><span class="p">[</span><span class="s2">&quot;&lt;unnested&gt;&quot;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">nested</span><span class="p">:</span>
            <span class="n">context</span> <span class="o">=</span> <span class="n">Container</span><span class="p">(</span><span class="n">_</span> <span class="o">=</span> <span class="n">context</span><span class="p">)</span>
        <span class="n">objiter</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">sc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">subcons</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">sc</span><span class="o">.</span><span class="n">conflags</span> <span class="o">&amp;</span> <span class="bp">self</span><span class="o">.</span><span class="n">FLAG_EMBED</span><span class="p">:</span>
                <span class="n">context</span><span class="p">[</span><span class="s2">&quot;&lt;unnested&gt;&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="n">subobj</span> <span class="o">=</span> <span class="n">objiter</span>
            <span class="k">elif</span> <span class="n">sc</span><span class="o">.</span><span class="n">name</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">subobj</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">subobj</span> <span class="o">=</span> <span class="n">advance_iterator</span><span class="p">(</span><span class="n">objiter</span><span class="p">)</span>
                <span class="n">context</span><span class="p">[</span><span class="n">sc</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">subobj</span>
            <span class="n">sc</span><span class="o">.</span><span class="n">_build</span><span class="p">(</span><span class="n">subobj</span><span class="p">,</span> <span class="n">stream</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">Union</span><span class="p">(</span><span class="n">Construct</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    a set of overlapping fields (like unions in C). when parsing,</span>
<span class="sd">    all fields read the same data; when building, only the first subcon</span>
<span class="sd">    (called &quot;master&quot;) is used.</span>

<span class="sd">    :param name: the name of the union</span>
<span class="sd">    :param master: the master subcon, i.e., the subcon used for building and calculating the total size</span>
<span class="sd">    :param subcons: additional subcons</span>

<span class="sd">    Example::</span>

<span class="sd">        Union(&quot;what_are_four_bytes&quot;,</span>
<span class="sd">            UBInt32(&quot;one_dword&quot;),</span>
<span class="sd">            Struct(&quot;two_words&quot;, UBInt16(&quot;first&quot;), UBInt16(&quot;second&quot;)),</span>
<span class="sd">            Struct(&quot;four_bytes&quot;,</span>
<span class="sd">                UBInt8(&quot;a&quot;),</span>
<span class="sd">                UBInt8(&quot;b&quot;),</span>
<span class="sd">                UBInt8(&quot;c&quot;),</span>
<span class="sd">                UBInt8(&quot;d&quot;)</span>
<span class="sd">            ),</span>
<span class="sd">        )</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">__slots__</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;parser&quot;</span><span class="p">,</span> <span class="s2">&quot;builder&quot;</span><span class="p">]</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">master</span><span class="p">,</span> <span class="o">*</span><span class="n">subcons</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="n">Construct</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="n">Peek</span><span class="p">(</span><span class="n">sc</span><span class="p">)</span> <span class="k">for</span> <span class="n">sc</span> <span class="ow">in</span> <span class="n">subcons</span><span class="p">]</span>
        <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">MetaField</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">ctx</span><span class="p">:</span> <span class="n">master</span><span class="o">.</span><span class="n">_sizeof</span><span class="p">(</span><span class="n">ctx</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parser</span> <span class="o">=</span> <span class="n">Struct</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">Peek</span><span class="p">(</span><span class="n">master</span><span class="p">,</span> <span class="n">perform_build</span> <span class="o">=</span> <span class="bp">True</span><span class="p">),</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">builder</span> <span class="o">=</span> <span class="n">Struct</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">master</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_parse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stream</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">_parse</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_build</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">stream</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">builder</span><span class="o">.</span><span class="n">_build</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">stream</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_sizeof</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">builder</span><span class="o">.</span><span class="n">_sizeof</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>

<span class="c1">#===============================================================================</span>
<span class="c1"># conditional</span>
<span class="c1">#===============================================================================</span>
<span class="k">class</span> <span class="nc">Switch</span><span class="p">(</span><span class="n">Construct</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A conditional branch. Switch will choose the case to follow based on</span>
<span class="sd">    the return value of keyfunc. If no case is matched, and no default value</span>
<span class="sd">    is given, SwitchError will be raised.</span>

<span class="sd">    .. seealso:: :func:`Pass`.</span>

<span class="sd">    :param name: the name of the construct</span>
<span class="sd">    :param keyfunc: a function that takes the context and returns a key, which</span>
<span class="sd">                    will be used to choose the relevant case.</span>
<span class="sd">    :param cases: a dictionary mapping keys to constructs. the keys can be any</span>
<span class="sd">                  values that may be returned by keyfunc.</span>
<span class="sd">    :param default: a default value to use when the key is not found in the cases.</span>
<span class="sd">                    if not supplied, an exception will be raised when the key is not found.</span>
<span class="sd">                    You can use the builtin construct Pass for &#39;do-nothing&#39;.</span>
<span class="sd">    :param include_key: whether or not to include the key in the return value</span>
<span class="sd">                        of parsing. defualt is False.</span>

<span class="sd">    Example::</span>

<span class="sd">        Struct(&quot;foo&quot;,</span>
<span class="sd">            UBInt8(&quot;type&quot;),</span>
<span class="sd">            Switch(&quot;value&quot;, lambda ctx: ctx.type, {</span>
<span class="sd">                    1 : UBInt8(&quot;spam&quot;),</span>
<span class="sd">                    2 : UBInt16(&quot;spam&quot;),</span>
<span class="sd">                    3 : UBInt32(&quot;spam&quot;),</span>
<span class="sd">                    4 : UBInt64(&quot;spam&quot;),</span>
<span class="sd">                }</span>
<span class="sd">            ),</span>
<span class="sd">        )</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">class</span> <span class="nc">NoDefault</span><span class="p">(</span><span class="n">Construct</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">_parse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stream</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">SwitchError</span><span class="p">(</span><span class="s2">&quot;no default case defined&quot;</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">_build</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">stream</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">SwitchError</span><span class="p">(</span><span class="s2">&quot;no default case defined&quot;</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">_sizeof</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">SwitchError</span><span class="p">(</span><span class="s2">&quot;no default case defined&quot;</span><span class="p">)</span>
    <span class="n">NoDefault</span> <span class="o">=</span> <span class="n">NoDefault</span><span class="p">(</span><span class="s2">&quot;No default value specified&quot;</span><span class="p">)</span>

    <span class="n">__slots__</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;subcons&quot;</span><span class="p">,</span> <span class="s2">&quot;keyfunc&quot;</span><span class="p">,</span> <span class="s2">&quot;cases&quot;</span><span class="p">,</span> <span class="s2">&quot;default&quot;</span><span class="p">,</span> <span class="s2">&quot;include_key&quot;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">keyfunc</span><span class="p">,</span> <span class="n">cases</span><span class="p">,</span> <span class="n">default</span> <span class="o">=</span> <span class="n">NoDefault</span><span class="p">,</span>
                 <span class="n">include_key</span> <span class="o">=</span> <span class="bp">False</span><span class="p">):</span>
        <span class="n">Construct</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_inherit_flags</span><span class="p">(</span><span class="o">*</span><span class="n">cases</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">keyfunc</span> <span class="o">=</span> <span class="n">keyfunc</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cases</span> <span class="o">=</span> <span class="n">cases</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">default</span> <span class="o">=</span> <span class="n">default</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">include_key</span> <span class="o">=</span> <span class="n">include_key</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_inherit_flags</span><span class="p">(</span><span class="o">*</span><span class="n">cases</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_flag</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">FLAG_DYNAMIC</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_parse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stream</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keyfunc</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cases</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">default</span><span class="p">)</span><span class="o">.</span><span class="n">_parse</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">include_key</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">key</span><span class="p">,</span> <span class="n">obj</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">obj</span>
    <span class="k">def</span> <span class="nf">_build</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">stream</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">include_key</span><span class="p">:</span>
            <span class="n">key</span><span class="p">,</span> <span class="n">obj</span> <span class="o">=</span> <span class="n">obj</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keyfunc</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
        <span class="n">case</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cases</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">default</span><span class="p">)</span>
        <span class="n">case</span><span class="o">.</span><span class="n">_build</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">stream</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_sizeof</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="n">case</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cases</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keyfunc</span><span class="p">(</span><span class="n">context</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">default</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">case</span><span class="o">.</span><span class="n">_sizeof</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">Select</span><span class="p">(</span><span class="n">Construct</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Selects the first matching subconstruct. It will literally try each of</span>
<span class="sd">    the subconstructs, until one matches.</span>

<span class="sd">    .. note:: Requires a seekable stream.</span>

<span class="sd">    :param name: the name of the construct</span>
<span class="sd">    :param subcons: the subcons to try (order-sensitive)</span>
<span class="sd">    :param include_name: a keyword only argument, indicating whether to include</span>
<span class="sd">                         the name of the selected subcon in the return value of parsing. default</span>
<span class="sd">                         is false.</span>

<span class="sd">    Example::</span>

<span class="sd">        Select(&quot;foo&quot;,</span>
<span class="sd">            UBInt64(&quot;large&quot;),</span>
<span class="sd">            UBInt32(&quot;medium&quot;),</span>
<span class="sd">            UBInt16(&quot;small&quot;),</span>
<span class="sd">            UBInt8(&quot;tiny&quot;),</span>
<span class="sd">        )</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">__slots__</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;subcons&quot;</span><span class="p">,</span> <span class="s2">&quot;include_name&quot;</span><span class="p">]</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="o">*</span><span class="n">subcons</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="n">include_name</span> <span class="o">=</span> <span class="n">kw</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;include_name&quot;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">kw</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;the only keyword argument accepted &quot;</span>
                <span class="s2">&quot;is &#39;include_name&#39;&quot;</span><span class="p">,</span> <span class="n">kw</span><span class="p">)</span>
        <span class="n">Construct</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subcons</span> <span class="o">=</span> <span class="n">subcons</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">include_name</span> <span class="o">=</span> <span class="n">include_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_inherit_flags</span><span class="p">(</span><span class="o">*</span><span class="n">subcons</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_flag</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">FLAG_DYNAMIC</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_parse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stream</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">sc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">subcons</span><span class="p">:</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="n">stream</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
            <span class="n">context2</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">__copy__</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">obj</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">_parse</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="n">context2</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">ConstructError</span><span class="p">:</span>
                <span class="n">stream</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">context</span><span class="o">.</span><span class="n">__update__</span><span class="p">(</span><span class="n">context2</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">include_name</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">sc</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">obj</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">obj</span>
        <span class="k">raise</span> <span class="n">SelectError</span><span class="p">(</span><span class="s2">&quot;no subconstruct matched&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_build</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">stream</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">include_name</span><span class="p">:</span>
            <span class="n">name</span><span class="p">,</span> <span class="n">obj</span> <span class="o">=</span> <span class="n">obj</span>
            <span class="k">for</span> <span class="n">sc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">subcons</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">sc</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">name</span><span class="p">:</span>
                    <span class="n">sc</span><span class="o">.</span><span class="n">_build</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">stream</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
                    <span class="k">return</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">sc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">subcons</span><span class="p">:</span>
                <span class="n">stream2</span> <span class="o">=</span> <span class="n">BytesIO</span><span class="p">()</span>
                <span class="n">context2</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">__copy__</span><span class="p">()</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">sc</span><span class="o">.</span><span class="n">_build</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">stream2</span><span class="p">,</span> <span class="n">context2</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">context</span><span class="o">.</span><span class="n">__update__</span><span class="p">(</span><span class="n">context2</span><span class="p">)</span>
                    <span class="n">stream</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">stream2</span><span class="o">.</span><span class="n">getvalue</span><span class="p">())</span>
                    <span class="k">return</span>
        <span class="k">raise</span> <span class="n">SelectError</span><span class="p">(</span><span class="s2">&quot;no subconstruct matched&quot;</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_sizeof</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">SizeofError</span><span class="p">(</span><span class="s2">&quot;can&#39;t calculate size&quot;</span><span class="p">)</span>


<span class="c1">#===============================================================================</span>
<span class="c1"># stream manipulation</span>
<span class="c1">#===============================================================================</span>
<span class="k">class</span> <span class="nc">Pointer</span><span class="p">(</span><span class="n">Subconstruct</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Changes the stream position to a given offset, where the construction</span>
<span class="sd">    should take place, and restores the stream position when finished.</span>

<span class="sd">    .. seealso::</span>
<span class="sd">        :func:`Anchor`, :func:`OnDemand` and the</span>
<span class="sd">        :func:`~construct.macros.OnDemandPointer` macro.</span>

<span class="sd">    .. note:: Requires a seekable stream.</span>

<span class="sd">    :param offsetfunc: a function that takes the context and returns an absolute</span>
<span class="sd">                       stream position, where the construction would take place</span>
<span class="sd">    :param subcon: the subcon to use at ``offsetfunc()``</span>

<span class="sd">    Example::</span>

<span class="sd">        Struct(&quot;foo&quot;,</span>
<span class="sd">            UBInt32(&quot;spam_pointer&quot;),</span>
<span class="sd">            Pointer(lambda ctx: ctx.spam_pointer,</span>
<span class="sd">                Array(5, UBInt8(&quot;spam&quot;))</span>
<span class="sd">            )</span>
<span class="sd">        )</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">__slots__</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;offsetfunc&quot;</span><span class="p">]</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">offsetfunc</span><span class="p">,</span> <span class="n">subcon</span><span class="p">):</span>
        <span class="n">Subconstruct</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subcon</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">offsetfunc</span> <span class="o">=</span> <span class="n">offsetfunc</span>
    <span class="k">def</span> <span class="nf">_parse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stream</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="n">newpos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">offsetfunc</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
        <span class="n">origpos</span> <span class="o">=</span> <span class="n">stream</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
        <span class="n">stream</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">newpos</span><span class="p">,</span> <span class="mi">2</span> <span class="k">if</span> <span class="n">newpos</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subcon</span><span class="o">.</span><span class="n">_parse</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="n">stream</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">origpos</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">obj</span>
    <span class="k">def</span> <span class="nf">_build</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">stream</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="n">newpos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">offsetfunc</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
        <span class="n">origpos</span> <span class="o">=</span> <span class="n">stream</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
        <span class="n">stream</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">newpos</span><span class="p">,</span> <span class="mi">2</span> <span class="k">if</span> <span class="n">newpos</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subcon</span><span class="o">.</span><span class="n">_build</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">stream</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="n">stream</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">origpos</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_sizeof</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="k">return</span> <span class="mi">0</span>

<span class="k">class</span> <span class="nc">Peek</span><span class="p">(</span><span class="n">Subconstruct</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Peeks at the stream: parses without changing the stream position.</span>
<span class="sd">    See also Union. If the end of the stream is reached when peeking,</span>
<span class="sd">    returns None.</span>

<span class="sd">    .. note:: Requires a seekable stream.</span>

<span class="sd">    :param subcon: the subcon to peek at</span>
<span class="sd">    :param perform_build: whether or not to perform building. by default this</span>
<span class="sd">                          parameter is set to False, meaning building is a no-op.</span>

<span class="sd">    Example::</span>

<span class="sd">        Peek(UBInt8(&quot;foo&quot;))</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">__slots__</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;perform_build&quot;</span><span class="p">]</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subcon</span><span class="p">,</span> <span class="n">perform_build</span> <span class="o">=</span> <span class="bp">False</span><span class="p">):</span>
        <span class="n">Subconstruct</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subcon</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">perform_build</span> <span class="o">=</span> <span class="n">perform_build</span>
    <span class="k">def</span> <span class="nf">_parse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stream</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="n">stream</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">subcon</span><span class="o">.</span><span class="n">_parse</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">FieldError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">stream</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_build</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">stream</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">perform_build</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">subcon</span><span class="o">.</span><span class="n">_build</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">stream</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_sizeof</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="k">return</span> <span class="mi">0</span>

<span class="k">class</span> <span class="nc">OnDemand</span><span class="p">(</span><span class="n">Subconstruct</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Allows for on-demand (lazy) parsing. When parsing, it will return a</span>
<span class="sd">    LazyContainer that represents a pointer to the data, but does not actually</span>
<span class="sd">    parses it from stream until it&#39;s &quot;demanded&quot;.</span>
<span class="sd">    By accessing the &#39;value&#39; property of LazyContainers, you will demand the</span>
<span class="sd">    data from the stream. The data will be parsed and cached for later use.</span>
<span class="sd">    You can use the &#39;has_value&#39; property to know whether the data has already</span>
<span class="sd">    been demanded.</span>

<span class="sd">    .. seealso:: The :func:`~construct.macros.OnDemandPointer` macro.</span>

<span class="sd">    .. note:: Requires a seekable stream.</span>

<span class="sd">    :param subcon: the subcon to read/write on demand</span>
<span class="sd">    :param advance_stream: whether or not to advance the stream position. by</span>
<span class="sd">                           default this is True, but if subcon is a pointer, this should be False.</span>
<span class="sd">    :param force_build: whether or not to force build. If set to False, and the</span>
<span class="sd">                        LazyContainer has not been demaned, building is a no-op.</span>

<span class="sd">    Example::</span>

<span class="sd">        OnDemand(Array(10000, UBInt8(&quot;foo&quot;))</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">__slots__</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;advance_stream&quot;</span><span class="p">,</span> <span class="s2">&quot;force_build&quot;</span><span class="p">]</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subcon</span><span class="p">,</span> <span class="n">advance_stream</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span> <span class="n">force_build</span> <span class="o">=</span> <span class="bp">True</span><span class="p">):</span>
        <span class="n">Subconstruct</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subcon</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">advance_stream</span> <span class="o">=</span> <span class="n">advance_stream</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">force_build</span> <span class="o">=</span> <span class="n">force_build</span>
    <span class="k">def</span> <span class="nf">_parse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stream</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">LazyContainer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">subcon</span><span class="p">,</span> <span class="n">stream</span><span class="p">,</span> <span class="n">stream</span><span class="o">.</span><span class="n">tell</span><span class="p">(),</span> <span class="n">context</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">advance_stream</span><span class="p">:</span>
            <span class="n">stream</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">subcon</span><span class="o">.</span><span class="n">_sizeof</span><span class="p">(</span><span class="n">context</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">obj</span>
    <span class="k">def</span> <span class="nf">_build</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">stream</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">LazyContainer</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">subcon</span><span class="o">.</span><span class="n">_build</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">stream</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">force_build</span> <span class="ow">or</span> <span class="n">obj</span><span class="o">.</span><span class="n">has_value</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">subcon</span><span class="o">.</span><span class="n">_build</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">stream</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">advance_stream</span><span class="p">:</span>
            <span class="n">stream</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">subcon</span><span class="o">.</span><span class="n">_sizeof</span><span class="p">(</span><span class="n">context</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">Buffered</span><span class="p">(</span><span class="n">Subconstruct</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creates an in-memory buffered stream, which can undergo encoding and</span>
<span class="sd">    decoding prior to being passed on to the subconstruct.</span>

<span class="sd">    .. seealso:: The :func:`~construct.macros.Bitwise` macro.</span>

<span class="sd">    .. warning:: Do not use pointers inside ``Buffered``.</span>

<span class="sd">    :param subcon: the subcon which will operate on the buffer</span>
<span class="sd">    :param encoder: a function that takes a string and returns an encoded</span>
<span class="sd">                    string (used after building)</span>
<span class="sd">    :param decoder: a function that takes a string and returns a decoded</span>
<span class="sd">                    string (used before parsing)</span>
<span class="sd">    :param resizer: a function that takes the size of the subcon and &quot;adjusts&quot;</span>
<span class="sd">                    or &quot;resizes&quot; it according to the encoding/decoding process.</span>

<span class="sd">    Example::</span>

<span class="sd">        Buffered(BitField(&quot;foo&quot;, 16),</span>
<span class="sd">            encoder = decode_bin,</span>
<span class="sd">            decoder = encode_bin,</span>
<span class="sd">            resizer = lambda size: size / 8,</span>
<span class="sd">        )</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">__slots__</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;encoder&quot;</span><span class="p">,</span> <span class="s2">&quot;decoder&quot;</span><span class="p">,</span> <span class="s2">&quot;resizer&quot;</span><span class="p">]</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subcon</span><span class="p">,</span> <span class="n">decoder</span><span class="p">,</span> <span class="n">encoder</span><span class="p">,</span> <span class="n">resizer</span><span class="p">):</span>
        <span class="n">Subconstruct</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subcon</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span> <span class="o">=</span> <span class="n">encoder</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">decoder</span> <span class="o">=</span> <span class="n">decoder</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resizer</span> <span class="o">=</span> <span class="n">resizer</span>
    <span class="k">def</span> <span class="nf">_parse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stream</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">_read_stream</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sizeof</span><span class="p">(</span><span class="n">context</span><span class="p">))</span>
        <span class="n">stream2</span> <span class="o">=</span> <span class="n">BytesIO</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">decoder</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">subcon</span><span class="o">.</span><span class="n">_parse</span><span class="p">(</span><span class="n">stream2</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_build</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">stream</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="n">size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sizeof</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
        <span class="n">stream2</span> <span class="o">=</span> <span class="n">BytesIO</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subcon</span><span class="o">.</span><span class="n">_build</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">stream2</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span><span class="p">(</span><span class="n">stream2</span><span class="o">.</span><span class="n">getvalue</span><span class="p">())</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">==</span> <span class="n">size</span>
        <span class="n">_write_stream</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sizeof</span><span class="p">(</span><span class="n">context</span><span class="p">),</span> <span class="n">data</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_sizeof</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">resizer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">subcon</span><span class="o">.</span><span class="n">_sizeof</span><span class="p">(</span><span class="n">context</span><span class="p">))</span>

<span class="k">class</span> <span class="nc">Restream</span><span class="p">(</span><span class="n">Subconstruct</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Wraps the stream with a read-wrapper (for parsing) or a</span>
<span class="sd">    write-wrapper (for building). The stream wrapper can buffer the data</span>
<span class="sd">    internally, reading it from- or writing it to the underlying stream</span>
<span class="sd">    as needed. For example, BitStreamReader reads whole bytes from the</span>
<span class="sd">    underlying stream, but returns them as individual bits.</span>

<span class="sd">    .. seealso:: The :func:`~construct.macros.Bitwise` macro.</span>

<span class="sd">    When the parsing or building is done, the stream&#39;s close method</span>
<span class="sd">    will be invoked. It can perform any finalization needed for the stream</span>
<span class="sd">    wrapper, but it must not close the underlying stream.</span>

<span class="sd">    .. warning:: Do not use pointers inside ``Restream``.</span>

<span class="sd">    :param subcon: the subcon</span>
<span class="sd">    :param stream_reader: the read-wrapper</span>
<span class="sd">    :param stream_writer: the write wrapper</span>
<span class="sd">    :param resizer: a function that takes the size of the subcon and &quot;adjusts&quot;</span>
<span class="sd">                    or &quot;resizes&quot; it according to the encoding/decoding process.</span>

<span class="sd">    Example::</span>

<span class="sd">        Restream(BitField(&quot;foo&quot;, 16),</span>
<span class="sd">            stream_reader = BitStreamReader,</span>
<span class="sd">            stream_writer = BitStreamWriter,</span>
<span class="sd">            resizer = lambda size: size / 8,</span>
<span class="sd">        )</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">__slots__</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;stream_reader&quot;</span><span class="p">,</span> <span class="s2">&quot;stream_writer&quot;</span><span class="p">,</span> <span class="s2">&quot;resizer&quot;</span><span class="p">]</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subcon</span><span class="p">,</span> <span class="n">stream_reader</span><span class="p">,</span> <span class="n">stream_writer</span><span class="p">,</span> <span class="n">resizer</span><span class="p">):</span>
        <span class="n">Subconstruct</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subcon</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stream_reader</span> <span class="o">=</span> <span class="n">stream_reader</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stream_writer</span> <span class="o">=</span> <span class="n">stream_writer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resizer</span> <span class="o">=</span> <span class="n">resizer</span>
    <span class="k">def</span> <span class="nf">_parse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stream</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="n">stream2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stream_reader</span><span class="p">(</span><span class="n">stream</span><span class="p">)</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subcon</span><span class="o">.</span><span class="n">_parse</span><span class="p">(</span><span class="n">stream2</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="n">stream2</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">obj</span>
    <span class="k">def</span> <span class="nf">_build</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">stream</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="n">stream2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stream_writer</span><span class="p">(</span><span class="n">stream</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subcon</span><span class="o">.</span><span class="n">_build</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">stream2</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="n">stream2</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">_sizeof</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">resizer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">subcon</span><span class="o">.</span><span class="n">_sizeof</span><span class="p">(</span><span class="n">context</span><span class="p">))</span>


<span class="c1">#===============================================================================</span>
<span class="c1"># miscellaneous</span>
<span class="c1">#===============================================================================</span>
<span class="k">class</span> <span class="nc">Reconfig</span><span class="p">(</span><span class="n">Subconstruct</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reconfigures a subconstruct. Reconfig can be used to change the name and</span>
<span class="sd">    set and clear flags of the inner subcon.</span>

<span class="sd">    :param name: the new name</span>
<span class="sd">    :param subcon: the subcon to reconfigure</span>
<span class="sd">    :param setflags: the flags to set (default is 0)</span>
<span class="sd">    :param clearflags: the flags to clear (default is 0)</span>

<span class="sd">    Example::</span>

<span class="sd">        Reconfig(&quot;foo&quot;, UBInt8(&quot;bar&quot;))</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">__slots__</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">subcon</span><span class="p">,</span> <span class="n">setflags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">clearflags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">):</span>
        <span class="n">Construct</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">subcon</span><span class="o">.</span><span class="n">conflags</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subcon</span> <span class="o">=</span> <span class="n">subcon</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_flag</span><span class="p">(</span><span class="n">setflags</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_clear_flag</span><span class="p">(</span><span class="n">clearflags</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">Anchor</span><span class="p">(</span><span class="n">Construct</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Gets the *anchor* (stream position) at a point in a Construct.</span>

<span class="sd">    Anchors are useful for adjusting relative offsets to absolute positions,</span>
<span class="sd">    or to measure sizes of Constructs.</span>

<span class="sd">    To get an absolute pointer, use an Anchor plus a relative offset. To get a</span>
<span class="sd">    size, place two Anchors and measure their difference.</span>

<span class="sd">    :param name: the name of the anchor</span>

<span class="sd">    .. note::</span>

<span class="sd">       Anchor Requires a seekable stream, or at least a tellable stream; it is</span>
<span class="sd">       implemented using the ``tell()`` method of file-like objects.</span>

<span class="sd">    .. seealso:: :func:`Pointer`</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">__slots__</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">def</span> <span class="nf">_parse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stream</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">stream</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">_build</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">stream</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="n">context</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">stream</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">_sizeof</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="k">return</span> <span class="mi">0</span>

<span class="k">class</span> <span class="nc">Value</span><span class="p">(</span><span class="n">Construct</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A computed value.</span>

<span class="sd">    :param name: the name of the value</span>
<span class="sd">    :param func: a function that takes the context and return the computed value</span>

<span class="sd">    Example::</span>

<span class="sd">        Struct(&quot;foo&quot;,</span>
<span class="sd">            UBInt8(&quot;width&quot;),</span>
<span class="sd">            UBInt8(&quot;height&quot;),</span>
<span class="sd">            Value(&quot;total_pixels&quot;, lambda ctx: ctx.width * ctx.height),</span>
<span class="sd">        )</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">__slots__</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;func&quot;</span><span class="p">]</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">func</span><span class="p">):</span>
        <span class="n">Construct</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">func</span> <span class="o">=</span> <span class="n">func</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_flag</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">FLAG_DYNAMIC</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_parse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stream</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">func</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_build</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">stream</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="n">context</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">func</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_sizeof</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="k">return</span> <span class="mi">0</span>

<span class="c1">#class Dynamic(Construct):</span>
<span class="c1">#    &quot;&quot;&quot;</span>
<span class="c1">#    Dynamically creates a construct and uses it for parsing and building.</span>
<span class="c1">#    This allows you to create change the construction tree on the fly.</span>
<span class="c1">#    Deprecated.</span>
<span class="c1">#</span>
<span class="c1">#    Parameters:</span>
<span class="c1">#    * name - the name of the construct</span>
<span class="c1">#    * factoryfunc - a function that takes the context and returns a new</span>
<span class="c1">#      construct object which will be used for parsing and building.</span>
<span class="c1">#</span>
<span class="c1">#    Example:</span>
<span class="c1">#    def factory(ctx):</span>
<span class="c1">#        if ctx.bar == 8:</span>
<span class="c1">#            return UBInt8(&quot;spam&quot;)</span>
<span class="c1">#        if ctx.bar == 9:</span>
<span class="c1">#            return String(&quot;spam&quot;, 9)</span>
<span class="c1">#</span>
<span class="c1">#    Struct(&quot;foo&quot;,</span>
<span class="c1">#        UBInt8(&quot;bar&quot;),</span>
<span class="c1">#        Dynamic(&quot;spam&quot;, factory),</span>
<span class="c1">#    )</span>
<span class="c1">#    &quot;&quot;&quot;</span>
<span class="c1">#    __slots__ = [&quot;factoryfunc&quot;]</span>
<span class="c1">#    def __init__(self, name, factoryfunc):</span>
<span class="c1">#        Construct.__init__(self, name, self.FLAG_COPY_CONTEXT)</span>
<span class="c1">#        self.factoryfunc = factoryfunc</span>
<span class="c1">#        self._set_flag(self.FLAG_DYNAMIC)</span>
<span class="c1">#    def _parse(self, stream, context):</span>
<span class="c1">#        return self.factoryfunc(context)._parse(stream, context)</span>
<span class="c1">#    def _build(self, obj, stream, context):</span>
<span class="c1">#        return self.factoryfunc(context)._build(obj, stream, context)</span>
<span class="c1">#    def _sizeof(self, context):</span>
<span class="c1">#        return self.factoryfunc(context)._sizeof(context)</span>

<span class="k">class</span> <span class="nc">LazyBound</span><span class="p">(</span><span class="n">Construct</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Lazily bound construct, useful for constructs that need to make cyclic</span>
<span class="sd">    references (linked-lists, expression trees, etc.).</span>

<span class="sd">    :param name: the name of the construct</span>
<span class="sd">    :param bindfunc: the function (called without arguments) returning the bound construct</span>

<span class="sd">    Example::</span>

<span class="sd">        foo = Struct(&quot;foo&quot;,</span>
<span class="sd">            UBInt8(&quot;bar&quot;),</span>
<span class="sd">            LazyBound(&quot;next&quot;, lambda: foo),</span>
<span class="sd">        )</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">__slots__</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;bindfunc&quot;</span><span class="p">,</span> <span class="s2">&quot;bound&quot;</span><span class="p">]</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bindfunc</span><span class="p">):</span>
        <span class="n">Construct</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bound</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bindfunc</span> <span class="o">=</span> <span class="n">bindfunc</span>
    <span class="k">def</span> <span class="nf">_parse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stream</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bound</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bound</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bindfunc</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">bound</span><span class="o">.</span><span class="n">_parse</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_build</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">stream</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bound</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bound</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bindfunc</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bound</span><span class="o">.</span><span class="n">_build</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">stream</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_sizeof</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bound</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bound</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bindfunc</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">bound</span><span class="o">.</span><span class="n">_sizeof</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">Pass</span><span class="p">(</span><span class="n">Construct</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A do-nothing construct, useful as the default case for Switch, or</span>
<span class="sd">    to indicate Enums.</span>

<span class="sd">    .. seealso:: :func:`Switch` and the :func:`~construct.macros.Enum` macro.</span>

<span class="sd">    .. note:: This construct is a singleton. Do not try to instatiate it, as it  will not work.</span>

<span class="sd">    Example::</span>

<span class="sd">        Pass</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">__slots__</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">def</span> <span class="nf">_parse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stream</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="k">pass</span>
    <span class="k">def</span> <span class="nf">_build</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">stream</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">obj</span> <span class="ow">is</span> <span class="bp">None</span>
    <span class="k">def</span> <span class="nf">_sizeof</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="k">return</span> <span class="mi">0</span>

<span class="n">Pass</span> <span class="o">=</span> <span class="n">Pass</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">A do-nothing construct, useful as the default case for Switch, or</span>
<span class="sd">to indicate Enums.</span>

<span class="sd">.. seealso:: :func:`Switch` and the :func:`~construct.macros.Enum` macro.</span>

<span class="sd">.. note:: This construct is a singleton. Do not try to instatiate it, as it  will not work.</span>

<span class="sd">Example::</span>

<span class="sd">    Pass</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="k">class</span> <span class="nc">Terminator</span><span class="p">(</span><span class="n">Construct</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Asserts the end of the stream has been reached at the point it&#39;s placed.</span>
<span class="sd">    You can use this to ensure no more unparsed data follows.</span>

<span class="sd">    .. note::</span>
<span class="sd">        * This construct is only meaningful for parsing. For building, it&#39;s a no-op.</span>
<span class="sd">        * This construct is a singleton. Do not try to instatiate it, as it will not work.</span>

<span class="sd">    Example::</span>

<span class="sd">        Terminator</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">__slots__</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">def</span> <span class="nf">_parse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stream</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">stream</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">TerminatorError</span><span class="p">(</span><span class="s2">&quot;expected end of stream&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_build</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">stream</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">obj</span> <span class="ow">is</span> <span class="bp">None</span>
    <span class="k">def</span> <span class="nf">_sizeof</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="k">return</span> <span class="mi">0</span>

<span class="n">Terminator</span> <span class="o">=</span> <span class="n">Terminator</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Asserts the end of the stream has been reached at the point it&#39;s placed.</span>
<span class="sd">You can use this to ensure no more unparsed data follows.</span>

<span class="sd">.. note::</span>
<span class="sd">    * This construct is only meaningful for parsing. For building, it&#39;s a no-op.</span>
<span class="sd">    * This construct is a singleton. Do not try to instatiate it, as it will not work.</span>

<span class="sd">Example::</span>

<span class="sd">    Terminator</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="c1">#=======================================================================================================================</span>
<span class="c1"># Extra</span>
<span class="c1">#=======================================================================================================================</span>
<span class="k">class</span> <span class="nc">ULInt24</span><span class="p">(</span><span class="n">StaticField</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A custom made construct for handling 3-byte types as used in ancient file formats.</span>
<span class="sd">    A better implementation would be writing a more flexable version of FormatField,</span>
<span class="sd">    rather then specifically implementing it for this case</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">__slots__</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;packer&quot;</span><span class="p">]</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">packer</span> <span class="o">=</span> <span class="n">Packer</span><span class="p">(</span><span class="s2">&quot;&lt;BH&quot;</span><span class="p">)</span>
        <span class="n">StaticField</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">packer</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">__getstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">attrs</span> <span class="o">=</span> <span class="n">StaticField</span><span class="o">.</span><span class="n">__getstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;packer&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;packer&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">format</span>
        <span class="k">return</span> <span class="n">attrs</span>
    <span class="k">def</span> <span class="nf">__setstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attrs</span><span class="p">):</span>
        <span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;packer&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Packer</span><span class="p">(</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;packer&quot;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">StaticField</span><span class="o">.</span><span class="n">__setstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attrs</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_parse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stream</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">vals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">packer</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="n">_read_stream</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">length</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">vals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">ex</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">raise</span> <span class="n">FieldError</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_build</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">stream</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">vals</span> <span class="o">=</span> <span class="p">(</span><span class="n">obj</span><span class="o">%</span><span class="mi">256</span><span class="p">,</span> <span class="n">obj</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span>
            <span class="n">_write_stream</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">length</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">packer</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">vals</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">ex</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">raise</span> <span class="n">FieldError</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>




</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Plaso 1.4.1_20160603 documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &copy; Copyright The Plaso Project Authors.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.4.2.
    </div>
  </body>
</html>