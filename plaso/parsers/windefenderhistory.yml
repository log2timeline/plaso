# dtFabric format specification.
---
name: defenderhistory
type: format
description: Windows Defender History file format.
urls: ["https://github.com/jklepsercyber/defender-detectionhistory-parser"]
---
name: byte
type: integer
attributes:
  format: unsigned
  size: 1
  units: bytes
---
name: wchar16
type: character
attributes:
  size: 2
  units: bytes
---
name: uint16
type: integer
attributes:
  format: unsigned
  size: 2
  units: bytes
---
name: uint32
type: integer
attributes:
  format: unsigned
  size: 4
  units: bytes
---
name: defender_file_header
type: structure
attributes:
  byte_order: little-endian
members:
- name: signature
  type: stream
  element_data_type: byte
  elements_data_size: 5
  value: "\x08\x00\x00\x00\x08"
- name: unknown1
  type: stream
  element_data_type: byte
  elements_data_size: 19
- name: guid
  type: stream
  element_data_type: byte
  elements_data_size: 16
- name: unknown2
  type: stream
  element_data_type: byte
  elements_data_size: 8
- name: magic_version
  type: string
  encoding: utf-16-le
  element_data_type: wchar16
  elements_terminator: "\x00\x00"
---
name: key_value_pair_with_colon
type: structure
attributes:
  byte_order: little-endian
members:
- name: attribute_length
  data_type: uint32
- name: unknown1
  data_type: uint32
- name: key
  type: string
  encoding: utf-16-le
  element_data_type: wchar16
  elements_terminator: ":\x00"
- name: value
  type: string
  encoding: utf-16-le
  element_data_type: wchar16
  elements_terminator: "\x00\x00"
---
name: post_header_block
type: structure
attributes:
  byte_order: little-endian
members:
- name: block
  type: stream
  element_data_type: uint16
  elements_terminator: "\x24\x00"
---
name: file_section
type: structure
attributes:
  byte_order: little-endian
members:
- name: sig_size
  data_type: uint32
- name: sig_type
  data_type: uint32
- name: magic_sig
  type: string
  encoding: utf-16-le
  element_data_type: wchar16
  elements_terminator: "\x00\x00"
  elements_data_size: file_section.sig_size
- name: null1
  type: stream
  element_data_type: byte
  elements_data_size: 4
- name: file_header_length
  data_type: uint32
- name: file_header_type
  data_type: uint32
- name: file_header
  type: stream
  element_data_type: byte
  elements_data_size: file_section.file_header_length-2
- name: webfilenull
  type: stream
  element_data_type: byte
  elements_data_size: 2
  condition: file_section.file_header[0] == 119 # w for webfile
- name: containerfilenull
  type: stream
  element_data_type: byte
  elements_data_size: 6
  condition: file_section.file_header[0] == 99 # c for containerfile
- name: filenull1
  data_type: uint32
  condition: file_section.file_header[0] == 102 # f for file
- name: filenull2
  data_type: uint32
  condition: file_section.file_header[0] == 102
- name: file_value_length
  data_type: uint32
- name: file_value_type
  data_type: uint32
- name: file_value
  type: string
  encoding: utf-16-le
  element_data_type: wchar16
  elements_terminator: "\x00\x00"
  elements_data_size: file_section.file_value_length
- name: null2
  type: stream
  element_data_type: byte
  elements_data_size: 2
---
name: post_file_block
type: structure
attributes:
  byte_order: little-endian
members:
- name: unknown1
  type: stream
  element_data_type: byte
  elements_terminator: "\x2a"
---
name: kv_block_key
type: structure
attributes:
  byte_order: little-endian
members:
- name: element_size
  data_type: uint32
- name: key
  type: string
  encoding: utf-16-le
  element_data_type: wchar16
  elements_data_size: kv_block_key.element_size
- name: value_type
  data_type: uint32
---
name: kv_block_string_value
type: structure
attributes:
  byte_order: little-endian
members:
- name: value_size
  data_type: uint32
- name: value
  type: string
  encoding: utf-16-le
  element_data_type: wchar16
  elements_data_size: kv_block_string_value.value_size
---
name: kv_block_bytes_value
type: structure
attributes:
  byte_order: little-endian
members:
- name: value
  type: sequence
  element_data_type: byte
  elements_data_size: 8
---
name: kv_block_flags_value
type: structure
attributes:
  byte_order: little-endian
members:
- name: value
  type: sequence
  element_data_type: byte
  elements_data_size: 4
---
name: post_kv_block
type: structure
attributes:
  byte_order: little-endian
members:
- name: block
  type: stream
  element_data_type: uint16
  elements_terminator: "\x00\x2c"
---
name: user_and_process
type: structure
attributes:
  byte_order: little-endian
members:
- name: user_size
  data_type: uint32
- name: user
  type: string
  encoding: utf-16-le
  element_data_type: wchar16
  elements_data_size: user_and_process.user_size*2
- name: padding
  type: stream
  element_data_type: uint16
  elements_terminator: "\x15\x00"
- name: null1
  type: string
  encoding: utf-16-le
  element_data_type: wchar16
  elements_terminator: "\x00\x00"
- name: process
  type: string
  encoding: utf-16-le
  element_data_type: wchar16
  elements_terminator: "\x00\x00"